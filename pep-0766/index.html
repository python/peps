
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 766 – Explicit Priority Choices Among Multiple Indexes | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0766/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 766 – Explicit Priority Choices Among Multiple Indexes | peps.python.org'>
    <meta property="og:description" content="Package resolution is a key part of the Python user experience as the means of extending Python’s core functionality. The experience of package resolution is mostly taken for granted until someone encounters a situation where the package installer does ...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0766/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Package resolution is a key part of the Python user experience as the means of extending Python’s core functionality. The experience of package resolution is mostly taken for granted until someone encounters a situation where the package installer does ...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 766</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 766 – Explicit Priority Choices Among Multiple Indexes" data-pagefind-weight="10" class="visually-hidden">PEP 766 – Explicit Priority Choices Among Multiple Indexes</span>
            <section id="pep-content">
<h1 class="page-title">PEP 766 – Explicit Priority Choices Among Multiple Indexes</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Michael Sarahan &lt;msarahan&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Sponsor<span class="colon">:</span></dt>
<dd class="field-even">Barry Warsaw &lt;barry&#32;&#97;t&#32;python.org&gt;</dd>
<dt class="field-odd">PEP-Delegate<span class="colon">:</span></dt>
<dd class="field-odd">Paul Moore &lt;p.f.moore&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Discussions-To<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/pep-for-handling-multiple-indexes-index-priority/71589">Discourse thread</a></dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Non-normative PEP containing background, guidelines or other information relevant to the Python ecosystem">Informational</abbr></dd>
<dt class="field-odd">Topic<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="../topic/packaging/">Packaging</a></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">18-Nov-2024</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/pep-for-handling-multiple-indexes-index-priority/71589" title="Discourse thread">18-Nov-2024</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#version-priority">“Version priority”</a></li>
<li><a class="reference internal" href="#index-priority">“Index priority”</a><ul>
<li><a class="reference internal" href="#cache-keys">Cache keys</a></li>
<li><a class="reference internal" href="#ways-that-a-request-falls-through-to-a-lower-priority-index">Ways that a request falls through to a lower priority index</a></li>
<li><a class="reference internal" href="#mirroring">Mirroring</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a></li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Package resolution is a key part of the Python user experience as the means of
extending Python’s core functionality. The experience of package resolution is
mostly taken for granted until someone encounters a situation where the package
installer does something they don’t expect.  The installer behavior with
multiple indexes has been <a class="reference external" href="https://github.com/pypa/pip/issues/8606">a common source of unexpected behavior</a>.  Through its ubiquity, pip has
long defined the standard expected behavior across other tools in the ecosystem,
but Python installers are diverging with respect to how they handle multiple
indexes. At the core of this divergence is whether index contents are combined
before resolving distributions, or each index is handled individually in order.
pip merges all indexes before matching distributions, while uv matches
distributions on one index before moving on to the next. Each approach has
advantages and disadvantages.  This PEP aims to describe each of these
behaviors, which are referred to as “version priority” and “index priority”
respectively, so that community discussions and troubleshooting can share a
common vocabulary, and so that tools can implement predictable behavior based on
these descriptions.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>Python package users frequently find themselves in need of specifying an index
or package source other than PyPI. There are many reasons for external indexes
to exist:</p>
<ul class="simple">
<li>File size/quota limitations on PyPI</li>
<li>Implementation variants, such as <a class="reference external" href="https://pytorch.org/get-started/locally/">different GPU library builds in PyTorch</a></li>
<li><a class="reference external" href="https://github.com/pypa/pip/issues/8606">Local builds of packages shared internally at an organization</a></li>
<li><a class="reference external" href="https://github.com/pypa/pip/issues/11624">Situations where a local package has remote dependencies</a>, and the user wishes to prioritize
local packages over remote dependencies, while still falling back to remote
dependencies where needed</li>
</ul>
<p>In most of these cases, it is not desirable to completely forego PyPI. Instead,
users generally want PyPI to still be a source of packages, but a lower priority
source. Unfortunately, <a class="reference external" href="https://github.com/pypa/pip/issues/8606">pip’s current design precludes this concept of priority</a>.
Some Python installer tools have developed alternative ways to handle multiple
indexes that incorporate mechanisms to express index priority, such as <a class="reference external" href="https://docs.astral.sh/uv/pip/compatibility/#packages-that-exist-on-multiple-indexes">uv</a>
and <a class="reference external" href="https://pdm-project.org/latest/usage/config/#respect-the-order-of-the-sources">PDM</a>.</p>
<p>The innovation and the potential for customization is exciting, but it comes at
the risk of further fragmenting the python packaging ecosystem, which is already
perceived as one of Python’s weak points. The motivation of this PEP is to encourage
installers to provide more insight into how they handle multiple indexes, and to
provide a vocabulary that can be common to the broader community.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<section id="version-priority">
<h3><a class="toc-backref" href="#version-priority" role="doc-backlink">“Version priority”</a></h3>
<p>This behavior is characterized by the installer always getting the
“best” version of a package, regardless of the index that it comes
from. “Best” is defined by the installer’s algorithm for optimizing
the various traits of a package, also factoring in user input (such as
preferring only binaries, or no binaries). While installers may differ
in their optimization criteria and user options, the general trait that
all version priority installers share is that the index
contents are collated prior to candidate selection.</p>
<p>Version priority is most useful when all configured indexes are equally trusted
and well-behaved regarding the distribution interchangeability assumption.
Mirrors are especially well-behaved in this regard. That interchangeability
assumption is what makes comparing distributions of a given package meaningful.
Without it, the installer is no longer comparing “apples to apples.” In
practice, it is common for different indexes to have files that have different
contents than other indexes, such as builds for special hardware, or differing
metadata for the same package. Version priority behavior can lead to
undesirable, unexpected outcomes in these cases, and this is where <a class="reference external" href="https://github.com/pypa/pip/issues/8606">users
generally look for some kind of index priority</a>. Additionally, when there is a
difference in trust among indexes, version priority does not provide a way to
prefer more trusted indexes over less trusted indexes. This has been exploited by
dependency confusion attacks, and <a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a> was proposed as a way of
hard-coding a notion of trusted external indexes into the index.</p>
<p>The “version priority” name is new, and introduction of new terms should always
be minimized. This PEP looks toward the uv project, which refers to <a class="reference external" href="https://docs.astral.sh/uv/pip/compatibility/#packages-that-exist-on-multiple-indexes">its implementation of the version priority
behavior</a>
as “<code class="docutils literal notranslate"><span class="pre">unsafe-best-match</span></code>.” Naming is really hard here. On one hand, it
isn’t accurate to call pip’s default behavior intrinsically “unsafe.”
The addition of possibly malicious indexes is what
introduces concern with this behavior. <a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a> added a way to restrict
installers from drawing packages from unexpected, potentially insecure
indexes. On the other hand, the term “best-match” is technically
correct, but also misleading. The “best match” varies by user and by
application. “Best” is technically correct in the sense that it is a
global optimum according to the match criteria specified above, but that
is not necessarily what is “best” in a user’s eyes. “Version priority”
is a proposed term that avoids the concerns with the uv terminology,
while approximating the behavior in the most user-identifiable way that
packages are compared.</p>
</section>
<section id="index-priority">
<h3><a class="toc-backref" href="#index-priority" role="doc-backlink">“Index priority”</a></h3>
<p>In index priority, the resolver finds candidates for each index, one at a time.
The resolver proceeds to subsequent indexes only if the current package request
has no viable candidates. Index priority does not combine indexes into one
global, flat namespace. Because indexes are searched in order, the package from
an earlier index will be preferred over a package from a later index,
regardless of whether the later index had a better match with the installer’s
optimization criteria. For a given installer, the optimization criteria and
selection algorithm should be the same for both index priority and version
priority. It is only the treatment of multiple indexes that differs: all
together for version priority, and individually for index priority.</p>
<p>The order of specification of indexes determines their priority in the
finding process. As a result, the way that installers load the index
configuration must be predictable and reproducible. This PEP does not prescribe
any particular mechanism, other than to say that installers should provide
a way of ordering their collection of sources. Installers should also
ideally provide optional debugging output that provides insight into
which index is being considered.</p>
<p>Each package’s finder should start at the beginning of the list of indexes, so each
package starts over with the index list. In other words, if one package has no
valid candidates on the first index, but finds a hit on the second index,
subsequent packages should still start their search on the first index, rather than
starting on the second.</p>
<p>One desirable behavior that the index priority strategy implies is that
there are no “surprise” updates, where a version bump on a
lower-priority index wins out over a curated, approved higher-priority
index. This is related to the security improvement of <a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a>, where
packages can restrict the external indexes that distributions can come
from, but index priority is more configurable by end users. The package installs are
only expected to change when either the higher-priority index or the
index priority configuration change. This stability and predictability
makes it more viable to configure indexes as a more persistent property of an
environment, rather than a one-off argument for one install command.</p>
<section id="cache-keys">
<h4><a class="toc-backref" href="#cache-keys" role="doc-backlink">Cache keys</a></h4>
<p>Because index priority is acknowledging the possibility that different indexes
may have different content for a given package, caching and lockfiles should now
include the index from which distributions were downloaded.  Without this
aspect, it is possible that after changing the list of configured indexes, the
cache or lockfile could provide a similarly-named distribution from a
lower-priority index. If every index follows the recommended behavior of
providing identical files across indexes for a given filename, this is not an
issue. However, that recommendation is not readily enforceable, and augmenting
the cache key with origin index would be a wise defensive change.</p>
</section>
<section id="ways-that-a-request-falls-through-to-a-lower-priority-index">
<h4><a class="toc-backref" href="#ways-that-a-request-falls-through-to-a-lower-priority-index" role="doc-backlink">Ways that a request falls through to a lower priority index</a></h4>
<ul class="simple">
<li>Package name is not present at all in higher priority index</li>
<li>All distributions from higher priority index filtered out due to
version specifier, compatible Python version, platform tag, yanking or otherwise</li>
<li>A denylist configuration for the installer specifies that a particular package
name should be ignored on a given index</li>
<li>A higher priority index is unreachable (e.g. blocked by firewall
rules, temporarily unavailable due to maintenance, other miscellaneous
and temporary networking issues). This is a less clear-cut detail that
should be controllable by users. On one hand, this behavior would lead
to less predictable, likely unreproducible results by unexpectedly
falling through to lower priority indexes. On the other hand, graceful
fallback may be more valuable to some users, especially if they can
safely assume that all of their indexes are equally trusted. pip’s
behavior today is graceful fallback: you see warnings if an index is
having connection issues, but the installation will proceed with any
other available indexes. Because index priority can convey different trust
levels between indexes, installers that implement index priority should
default to raising errors and aborting on network issues. Installers may
choose to provide a flag to allow fall-through to lower-priority indexes in
case of network error.</li>
</ul>
<p>Treatment within a given index follows existing behavior, but stops at
the bounds of one index and moves on to the next index only after all
priority preferences within the one index are exhausted. This means that
existing priorities among the unified collection of packages apply to
each index individually before falling through to a lower priority
index.</p>
<p>There are tradeoffs to make at every level of the optimization criteria:</p>
<ul class="simple">
<li>version: index priority will use an older version from a higher-priority index
even if a newer version is available on another index.</li>
<li>wheel vs sdist: Should the installer use an sdist from a higher-priority
index before trying a wheel from a lower-priority index?</li>
<li>more platform-specific wheels before less specific ones: Should the
installer use less specific wheels from higher-priority indexes
before using more specific wheels from lower priority indexes?</li>
<li>flags such as pip’s <code class="docutils literal notranslate"><span class="pre">--prefer-binary</span></code>: Should the installer use an sdist from a higher
priority index before considering wheels on a lower priority index?</li>
</ul>
<p>Installers are free to implement these priorities in different ways for
themselves, but they should document their optimization criteria and how they
handle fall-through to lower-priority indexes. For example, an installer could
say that <code class="docutils literal notranslate"><span class="pre">--prefer-binary</span></code> should not install an sdist unless it had iterated
through all configured indexes and found no installable binary candidates.</p>
</section>
<section id="mirroring">
<h4><a class="toc-backref" href="#mirroring" role="doc-backlink">Mirroring</a></h4>
<p>As described thus far, the index priority scheme breaks the use case of more
than one index url serving the same content. Such mirrors may be used with the
intent of ameliorating network issues or otherwise improving reliability. One
approach that installers could take to preserve mirroring functionality while
adding index priority would be to add a notion of user-definable index groups,
where each index in the group is assumed to be equivalent. This is related to
<a class="reference external" href="https://python-poetry.org/docs/repositories/">Poetry’s notion of package sources</a>, except that this would allow
arbitrary numbers of prioritizable groups, and that this would assume members of
a group to be mirrors. Within each group, content could be combined, or each
member could be fetched concurrently. The fastest responding index would then
represent the group.</p>
</section>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>This PEP does not prescribe any changes as mandatory for any installer,
so it only introduces compatibility concerns if tools choose to adopt an
index behavior other than the behavior(s) they currently implement.</p>
<p>This PEP’s language does not quite align with existing tools, including
pip and uv. Either this PEP’s language can change during review of this PEP, or if
this PEP’s language is preferred, other projects could conform to it.
The only goal of proposing these terms is to create a central, common vocabulary
that makes it easier for users to learn about other installers.</p>
<p>As some tools rely on one or the other behavior, there are some possible
issues that may emerge, where tailoring available resources/packages for
a particular behavior may detract from the user experience for people
who rely on the other behavior.</p>
<ul class="simple">
<li>Different indexes may have different metadata. For example, one cannot assume
that the metadata for package “something” on index “A” has the same dependencies
as “something” on index “B”. This breaks fundamental assumptions of version
priority, but index priority can handle this. When an installer falls through to a
lower-priority index in the search order, it implies refreshing the package metadata
from the new index. This is both an improvement and a complication. It is a
complication in the sense that a cached metadata entry must be keyed by both
package name and index url, instead of just package name. It is a potential
improvement in that different implementation variants of a package can differ in
dependencies as long as their distributions are separated into different indexes.</li>
<li>Users may not get updates as they expect when using index priority, because some higher priority
index has not updated/synchronized with PyPI to get the latest
packages. If the higher priority index has a valid candidate, newer
packages will not be found. This will need to be communicated
verbosely, because it is counter to pip’s well-established behavior.</li>
<li>By adding index priority, an installer will improve the predictability of
which index will be selected, and index hosts may abuse this as a way of having
similarly named files that have different contents. With version priority,
this violates the key package interchangeability assumption, and insanity will ensue.
Index priority would be more workable, but the situation still
has great potential for confusion. It would be helpful to develop tools that
support installers in identifying these confusing issues.  These tools could
operate independently of the installer process, as a means of validating the
sanity of a set of indexes. Depending on the time cost of these tools, the
installers could run them as part of their process.  Users could, of course,
ignore the recommendations at their own risk.</li>
</ul>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications" role="doc-backlink">Security Implications</a></h2>
<p>Index priority creates a mechanism for users to explicitly specify a trust
hierarchy among their indexes. As such, it limits the potential for dependency
confusion attacks. Index priority was rejected by <a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a> as a solution for
dependency confusion attacks. This PEP requests that the rejection be
reconsidered, with index priority serving a different purpose. This PEP is
primarily motivated by the desire to support implementation variants, which is
the subject of <a class="reference external" href="https://discuss.python.org/t/selecting-variant-wheels-according-to-a-semi-static-specification/53446">another discussion that hopefully leads to a PEP</a>.
It is not mutually exclusive with <a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a>, nor does it suggest reverting or
withdrawing <a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a>. It is an answer to <a class="reference external" href="https://github.com/astral-sh/uv/issues/171#issuecomment-1952291242">how we could allow users to choose
which index to use at a more fine grained level than “per install”.</a></p>
<p>For a more thorough discussion of the <a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a> rejection of index
priority, please see the <a class="reference external" href="https://discuss.python.org/t/pep-766-handling-multiple-indexes-index-priority/71589">discuss.python.org thread for this PEP</a>.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>At the outset, the goal is not to convert pip or any other tool to
change its default priority behavior. The best way to teach is perhaps
to watch message boards, GitHub issue trackers and chat channels,
keeping an eye out for problems that index priority could help solve.
There are <a class="reference external" href="https://github.com/pypa/pip/issues/8606">several</a>
<a class="reference external" href="https://stackoverflow.com/questions/67253141/python-pip-priority-order-with-index-url-and-extra-index-url">long-standing</a>
<a class="reference external" href="https://github.com/pypa/pip/issues/5045">discussions</a>
<a class="reference external" href="https://discuss.python.org/t/dependency-notation-including-the-index-url/5659">that</a>
<a class="reference external" href="https://github.com/pypa/pip/issues/9612">would</a> be good places to
start advertising the concepts. The topics of the two officially
supported behaviors need documentation, and we, the authors of this
PEP, would develop these as part of the review period of this PEP.
These docs would likely consist of additions across several
indexes, cross-linking the concepts between installers. At a
minimum, we expect to add to the
<a class="reference external" href="https://packaging.python.org/en/latest/">PyPUG</a> and to <a class="reference external" href="https://pip.pypa.io/en/stable/cli/pip_install/">pip’s
documentation</a>.</p>
<p>It will be important for installers to advertise the active behavior, especially in
error messaging, and that will provide ways to provide resources to
users about these behaviors.</p>
<p>uv users are already experiencing index priority. uv <a class="reference external" href="https://docs.astral.sh/uv/pip/compatibility/#packages-that-exist-on-multiple-indexes">documents this
behavior</a>
well, but it is always possible to <a class="reference external" href="https://github.com/astral-sh/uv/issues/4389">improve the
discoverability</a> of that
documentation from the command line, <a class="reference external" href="https://github.com/astral-sh/uv/issues/5146">where users will actually
encounter the unexpected
behavior</a>.</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>The uv project demonstrates index priority with its default behavior. uv
is implemented in Rust, though, so if a  reference implementation to a Python-based tool
is necessary, we, the authors of this PEP, will provide one. For pip in
particular, we see the implementation plan as something like:</p>
<ul class="simple">
<li>For users who don’t use <code class="docutils literal notranslate"><span class="pre">--extra-index-url</span></code> or <code class="docutils literal notranslate"><span class="pre">--find-links</span></code>,
there will be no change, and no migration is necessary.</li>
<li>pip users would be able opt in to the index priority behavior with a
new config setting in the CLI and in <code class="docutils literal notranslate"><span class="pre">pip.conf</span></code>. This proposal does not
recommend any strategy as the default for any installer. It only
recommends documenting the strategies that a tool provides.</li>
<li>Enable extra info-level output for any pip operation where more than
one index is used. In this output, state the current strategy setting,
and a terse summary of implied behavior, as well as a link to docs
that describe the different options</li>
<li>Add debugging output that verbosely identifies the index being used at
each step, including where the file is in the configuration hierarchy,
and where it is being included (via config file, env var, or CLI
flag).</li>
<li>Plumb tracking of which index gets used for which
package/distribution through the entire pip install process. Store
this information so that it is available to tools like <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">freeze</span></code></li>
<li>Supplement <a class="pep reference internal" href="../pep-0751/" title="PEP 751 – A file format to record Python dependencies for installation reproducibility">PEP 751</a> (lockfiles) with capture of index where a
package/distribution came from</li>
</ul>
</section>
<section id="rejected-ideas">
<h2><a class="toc-backref" href="#rejected-ideas" role="doc-backlink">Rejected Ideas</a></h2>
<ul>
<li>Tell users to set up a proxy/mirror, such as <a class="reference external" href="https://github.com/devpi/devpi">devpi</a>
or <a class="reference external" href="https://jfrog.com/help/r/jfrog-artifactory-documentation/pypi-repositories">Artifactory</a> that
serves local files if present, and forwards to another server (PyPI)
if no local files match<p>This matches the behavior of this proposal very closely, except that
this method requires hosting some server, and may be inaccessible or
not configurable to users in some environments. It is also important
to consider that for an organization that operates its own index
(for overcoming PyPI size restrictions, for example), this does not
solve the need for <code class="docutils literal notranslate"><span class="pre">--extra-index-url</span></code> or proxy/mirror for end
users. That is, organizations get no improvement from this approach
unless they proxy/mirror PyPI as a whole, and get users to configure
their proxy/mirror as their sole index.</p>
</li>
<li>Are build tags and/or local version specifiers enough?<p>Build tags and local version specifiers will take precedence over
packages without those tags and/or local version specifiers. In a pool
of packages, builds that have these additions hosted on a server other
than PyPI will take priority over packages on PyPI, which rarely use
build tags, and forbid local version specifiers. This approach is
viable when package providers want to provide their own local
override, such as <a class="reference external" href="https://github.com/ComputeCanada/software-stack/blob/main/pip-which-version.md">HPC maintainers who provide optimized builds for
their
users</a>.
It is less viable in some ways, such as build tags not showing up in
<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">freeze</span></code> metadata, and <a class="reference external" href="https://discuss.python.org/t/lets-permit-local-version-label-in-version-specifiers/22781">local version specifiers not being
allowed on
PyPI</a>.
There is also significant work entailed in building and maintaining
package collections with local build tag variants.</p>
<p><a class="reference external" href="https://discuss.python.org/t/dependency-notation-including-the-index-url/5659/21">https://discuss.python.org/t/dependency-notation-including-the-index-url/5659/21</a></p>
</li>
<li>What about <a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a>? Isn’t that
enough?<p><a class="pep reference internal" href="../pep-0708/" title="PEP 708 – Extending the Repository API to Mitigate Dependency Confusion Attacks">PEP 708</a> is aimed specifically at addressing dependency confusion
attacks, and doesn’t address the potential for implementation variants
among indexes. It is a way of filtering external URLs and encoding an
allow-list for external indexes in index metadata. It does not change
the lack of priority or preference among channels that currently
exists.</p>
</li>
<li><a class="reference external" href="https://discuss.python.org/t/dependency-notation-including-the-index-url/5659">Namespacing</a><p>Namespacing is a means of specifying a package such that the Python
usage of the package does not change, but the package installation
restricts where the package comes from. <a class="pep reference internal" href="../pep-0752/" title="PEP 752 – Implicit namespaces for package repositories">PEP 752</a> recently proposed a way to
multiplex a package’s owners in a flat package namespace (e.g.
PyPI) by reserving prefixes as grouping elements. <a class="reference external" href="https://docs.npmjs.com/cli/v10/using-npm/scope">NPM’s concept
of “scopes”</a> has
been raised as another good example of how this might look. This PEP
differs in that it is targeted to multiple index, not a flat package
namespace. The net effect is roughly the same in terms of predictably
choosing a particular package source, except that the namespacing
approach relies more on naming packages with these namespace prefixes,
whereas this PEP would be less granular, pulling in packages on
whatever higher-priority index the user specifies. The namespacing
approach relies on all configured indexes treating a given namespace
similarly, which leaves the usual concern that not all configured
indexes are trusted equally. The namespace idea is not incompatible
with this PEP, but it also does not improve expression of trust of
indexes in the way that this PEP does.</p>
</li>
</ul>
</section>
<section id="open-issues">
<h2><a class="toc-backref" href="#open-issues" role="doc-backlink">Open Issues</a></h2>
<p>[Any points that are still being decided/discussed.]</p>
</section>
<section id="acknowledgements">
<h2><a class="toc-backref" href="#acknowledgements" role="doc-backlink">Acknowledgements</a></h2>
<p>This work was supported financially by NVIDIA through employment of the author.
NVIDIA teammates dramatically improved this PEP with their
input.  Astral Software pioneered the behaviors of index priority and thus laid the
foundation of this document. The pip authors deserve great praise for their
consistent direction and patient communication of the version priority behavior,
especially in the face of contentious security concerns.</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0766.rst">https://github.com/python/peps/blob/main/peps/pep-0766.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0766.rst">2024-11-21 20:00:24 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#version-priority">“Version priority”</a></li>
<li><a class="reference internal" href="#index-priority">“Index priority”</a><ul>
<li><a class="reference internal" href="#cache-keys">Cache keys</a></li>
<li><a class="reference internal" href="#ways-that-a-request-falls-through-to-a-lower-priority-index">Ways that a request falls through to a lower priority index</a></li>
<li><a class="reference internal" href="#mirroring">Mirroring</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a></li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0766.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>