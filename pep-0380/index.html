
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 380 – Syntax for Delegating to a Subgenerator | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0380/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 380 – Syntax for Delegating to a Subgenerator | peps.python.org'>
    <meta property="og:description" content="A syntax is proposed for a generator to delegate part of its operations to another generator.  This allows a section of code containing ‘yield’ to be factored out and placed in another generator. Additionally, the subgenerator is allowed to return with ...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0380/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="A syntax is proposed for a generator to delegate part of its operations to another generator.  This allows a section of code containing ‘yield’ to be factored out and placed in another generator. Additionally, the subgenerator is allowed to return with ...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 380</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 380 – Syntax for Delegating to a Subgenerator</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Gregory Ewing &lt;greg.ewing&#32;&#97;t&#32;canterbury.ac.nz&gt;</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Accepted and implementation complete, or no longer active">Final</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">13-Feb-2009</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.3</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
<dt class="field-odd">Resolution<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2011-June/112010.html">Python-Dev message</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pep-acceptance">PEP Acceptance</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a><ul>
<li><a class="reference internal" href="#enhancements-to-stopiteration">Enhancements to StopIteration</a></li>
<li><a class="reference internal" href="#formal-semantics">Formal Semantics</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#the-refactoring-principle">The Refactoring Principle</a></li>
<li><a class="reference internal" href="#finalization">Finalization</a></li>
<li><a class="reference internal" href="#generators-as-threads">Generators as Threads</a></li>
<li><a class="reference internal" href="#syntax">Syntax</a></li>
<li><a class="reference internal" href="#optimisations">Optimisations</a></li>
<li><a class="reference internal" href="#use-of-stopiteration-to-return-values">Use of StopIteration to return values</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a></li>
</ul>
</li>
<li><a class="reference internal" href="#criticisms">Criticisms</a></li>
<li><a class="reference internal" href="#alternative-proposals">Alternative Proposals</a></li>
<li><a class="reference internal" href="#additional-material">Additional Material</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>A syntax is proposed for a generator to delegate part of its
operations to another generator.  This allows a section of code
containing ‘yield’ to be factored out and placed in another generator.
Additionally, the subgenerator is allowed to return with a value, and
the value is made available to the delegating generator.</p>
<p>The new syntax also opens up some opportunities for optimisation when
one generator re-yields values produced by another.</p>
</section>
<section id="pep-acceptance">
<h2><a class="toc-backref" href="#pep-acceptance" role="doc-backlink">PEP Acceptance</a></h2>
<p>Guido officially <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2011-June/112010.html">accepted the PEP</a> on 26th June, 2011.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>A Python generator is a form of coroutine, but has the limitation that
it can only yield to its immediate caller.  This means that a piece of
code containing a <code class="docutils literal notranslate"><span class="pre">yield</span></code> cannot be factored out and put into a
separate function in the same way as other code.  Performing such a
factoring causes the called function to itself become a generator, and
it is necessary to explicitly iterate over this second generator and
re-yield any values that it produces.</p>
<p>If yielding of values is the only concern, this can be performed
without much difficulty using a loop such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
    <span class="k">yield</span> <span class="n">v</span>
</pre></div>
</div>
<p>However, if the subgenerator is to interact properly with the caller
in the case of calls to <code class="docutils literal notranslate"><span class="pre">send()</span></code>, <code class="docutils literal notranslate"><span class="pre">throw()</span></code> and <code class="docutils literal notranslate"><span class="pre">close()</span></code>,
things become considerably more difficult.  As will be seen later, the
necessary code is very complicated, and it is tricky to handle all the
corner cases correctly.</p>
<p>A new syntax will be proposed to address this issue.  In the simplest
use cases, it will be equivalent to the above for-loop, but it will
also handle the full range of generator behaviour, and allow generator
code to be refactored in a simple and straightforward way.</p>
</section>
<section id="proposal">
<h2><a class="toc-backref" href="#proposal" role="doc-backlink">Proposal</a></h2>
<p>The following new expression syntax will be allowed in the body of a
generator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">yield from</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where &lt;expr&gt; is an expression evaluating to an iterable, from which an
iterator is extracted. The iterator is run to exhaustion, during which
time it yields and receives values directly to or from the caller of
the generator containing the <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> expression (the
“delegating generator”).</p>
<p>Furthermore, when the iterator is another generator, the subgenerator
is allowed to execute a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement with a value, and that
value becomes the value of the <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> expression.</p>
<p>The full semantics of the <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> expression can be described
in terms of the generator protocol as follows:</p>
<ul class="simple">
<li>Any values that the iterator yields are passed directly to the
caller.</li>
<li>Any values sent to the delegating generator using <code class="docutils literal notranslate"><span class="pre">send()</span></code> are
passed directly to the iterator.  If the sent value is None, the
iterator’s <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> method is called.  If the sent value
is not None, the iterator’s <code class="docutils literal notranslate"><span class="pre">send()</span></code> method is called.  If the
call raises StopIteration, the delegating generator is resumed.
Any other exception is propagated to the delegating generator.</li>
<li>Exceptions other than GeneratorExit thrown into the delegating
generator are passed to the <code class="docutils literal notranslate"><span class="pre">throw()</span></code> method of the iterator.
If the call raises StopIteration, the delegating generator is
resumed.  Any other exception is propagated to the delegating
generator.</li>
<li>If a GeneratorExit exception is thrown into the delegating
generator, or the <code class="docutils literal notranslate"><span class="pre">close()</span></code> method of the delegating generator
is called, then the <code class="docutils literal notranslate"><span class="pre">close()</span></code> method of the iterator is called
if it has one. If this call results in an exception, it is
propagated to the delegating generator.  Otherwise,
GeneratorExit is raised in the delegating generator.</li>
<li>The value of the <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> expression is the first argument
to the <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception raised by the iterator when
it terminates.</li>
<li><code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">expr</span></code> in a generator causes <code class="docutils literal notranslate"><span class="pre">StopIteration(expr)</span></code> to
be raised upon exit from the generator.</li>
</ul>
<section id="enhancements-to-stopiteration">
<h3><a class="toc-backref" href="#enhancements-to-stopiteration" role="doc-backlink">Enhancements to StopIteration</a></h3>
<p>For convenience, the <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception will be given a
<code class="docutils literal notranslate"><span class="pre">value</span></code> attribute that holds its first argument, or None if there
are no arguments.</p>
</section>
<section id="formal-semantics">
<h3><a class="toc-backref" href="#formal-semantics" role="doc-backlink">Formal Semantics</a></h3>
<p>Python 3 syntax is used in this section.</p>
<ol class="arabic">
<li>The statement<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RESULT</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">EXPR</span>
</pre></div>
</div>
<p>is semantically equivalent to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_i</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">EXPR</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_i</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
    <span class="n">_r</span> <span class="o">=</span> <span class="n">_e</span><span class="o">.</span><span class="n">value</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_s</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">_y</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_m</span> <span class="o">=</span> <span class="n">_i</span><span class="o">.</span><span class="n">close</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_m</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">_e</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_m</span> <span class="o">=</span> <span class="n">_i</span><span class="o">.</span><span class="n">throw</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_y</span> <span class="o">=</span> <span class="n">_m</span><span class="p">(</span><span class="o">*</span><span class="n">_x</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
                    <span class="n">_r</span> <span class="o">=</span> <span class="n">_e</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_y</span> <span class="o">=</span> <span class="n">_i</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">_s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
                <span class="n">_r</span> <span class="o">=</span> <span class="n">_e</span><span class="o">.</span><span class="n">value</span>
                <span class="k">break</span>
<span class="n">RESULT</span> <span class="o">=</span> <span class="n">_r</span>
</pre></div>
</div>
</li>
<li>In a generator, the statement<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
<p>is semantically equivalent to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>except that, as currently, the exception cannot be caught by
<code class="docutils literal notranslate"><span class="pre">except</span></code> clauses within the returning generator.</p>
</li>
<li>The StopIteration exception behaves as though defined thusly:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StopIteration</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<section id="the-refactoring-principle">
<h3><a class="toc-backref" href="#the-refactoring-principle" role="doc-backlink">The Refactoring Principle</a></h3>
<p>The rationale behind most of the semantics presented above stems from
the desire to be able to refactor generator code.  It should be
possible to take a section of code containing one or more <code class="docutils literal notranslate"><span class="pre">yield</span></code>
expressions, move it into a separate function (using the usual
techniques to deal with references to variables in the surrounding
scope, etc.), and call the new function using a <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>
expression.</p>
<p>The behaviour of the resulting compound generator should be, as far as
reasonably practicable, the same as the original unfactored generator
in all situations, including calls to <code class="docutils literal notranslate"><span class="pre">__next__()</span></code>, <code class="docutils literal notranslate"><span class="pre">send()</span></code>,
<code class="docutils literal notranslate"><span class="pre">throw()</span></code> and <code class="docutils literal notranslate"><span class="pre">close()</span></code>.</p>
<p>The semantics in cases of subiterators other than generators has been
chosen as a reasonable generalization of the generator case.</p>
<p>The proposed semantics have the following limitations with regard to
refactoring:</p>
<ul class="simple">
<li>A block of code that catches GeneratorExit without subsequently
re-raising it cannot be factored out while retaining exactly the
same behaviour.</li>
<li>Factored code may not behave the same way as unfactored code if a
StopIteration exception is thrown into the delegating generator.</li>
</ul>
<p>With use cases for these being rare to non-existent, it was not
considered worth the extra complexity required to support them.</p>
</section>
<section id="finalization">
<h3><a class="toc-backref" href="#finalization" role="doc-backlink">Finalization</a></h3>
<p>There was some debate as to whether explicitly finalizing the
delegating generator by calling its <code class="docutils literal notranslate"><span class="pre">close()</span></code> method while it is
suspended at a <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> should also finalize the subiterator.
An argument against doing so is that it would result in premature
finalization of the subiterator if references to it exist elsewhere.</p>
<p>Consideration of non-refcounting Python implementations led to the
decision that this explicit finalization should be performed, so that
explicitly closing a factored generator has the same effect as doing
so to an unfactored one in all Python implementations.</p>
<p>The assumption made is that, in the majority of use cases, the
subiterator will not be shared.  The rare case of a shared subiterator
can be accommodated by means of a wrapper that blocks <code class="docutils literal notranslate"><span class="pre">throw()</span></code> and
<code class="docutils literal notranslate"><span class="pre">close()</span></code> calls, or by using a means other than <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> to
call the subiterator.</p>
</section>
<section id="generators-as-threads">
<h3><a class="toc-backref" href="#generators-as-threads" role="doc-backlink">Generators as Threads</a></h3>
<p>A motivation for generators being able to return values concerns the
use of generators to implement lightweight threads.  When using
generators in that way, it is reasonable to want to spread the
computation performed by the lightweight thread over many functions.
One would like to be able to call a subgenerator as though it were an
ordinary function, passing it parameters and receiving a returned
value.</p>
<p>Using the proposed syntax, a statement such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>where f is an ordinary function, can be transformed into a delegation
call</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>where g is a generator.  One can reason about the behaviour of the
resulting code by thinking of g as an ordinary function that can be
suspended using a <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement.</p>
<p>When using generators as threads in this way, typically one is not
interested in the values being passed in or out of the yields.
However, there are use cases for this as well, where the thread is
seen as a producer or consumer of items.  The <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>
expression allows the logic of the thread to be spread over as many
functions as desired, with the production or consumption of items
occurring in any subfunction, and the items are automatically routed to
or from their ultimate source or destination.</p>
<p>Concerning <code class="docutils literal notranslate"><span class="pre">throw()</span></code> and <code class="docutils literal notranslate"><span class="pre">close()</span></code>, it is reasonable to expect
that if an exception is thrown into the thread from outside, it should
first be raised in the innermost generator where the thread is
suspended, and propagate outwards from there; and that if the thread
is terminated from outside by calling <code class="docutils literal notranslate"><span class="pre">close()</span></code>, the chain of active
generators should be finalised from the innermost outwards.</p>
</section>
<section id="syntax">
<h3><a class="toc-backref" href="#syntax" role="doc-backlink">Syntax</a></h3>
<p>The particular syntax proposed has been chosen as suggestive of its
meaning, while not introducing any new keywords and clearly standing
out as being different from a plain <code class="docutils literal notranslate"><span class="pre">yield</span></code>.</p>
</section>
<section id="optimisations">
<h3><a class="toc-backref" href="#optimisations" role="doc-backlink">Optimisations</a></h3>
<p>Using a specialised syntax opens up possibilities for optimisation
when there is a long chain of generators.  Such chains can arise, for
instance, when recursively traversing a tree structure.  The overhead
of passing <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> calls and yielded values down and up the
chain can cause what ought to be an O(n) operation to become, in the
worst case, O(n**2).</p>
<p>A possible strategy is to add a slot to generator objects to hold a
generator being delegated to.  When a <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> or <code class="docutils literal notranslate"><span class="pre">send()</span></code>
call is made on the generator, this slot is checked first, and if it
is nonempty, the generator that it references is resumed instead.  If
it raises StopIteration, the slot is cleared and the main generator is
resumed.</p>
<p>This would reduce the delegation overhead to a chain of C function
calls involving no Python code execution.  A possible enhancement
would be to traverse the whole chain of generators in a loop and
directly resume the one at the end, although the handling of
StopIteration is more complicated then.</p>
</section>
<section id="use-of-stopiteration-to-return-values">
<h3><a class="toc-backref" href="#use-of-stopiteration-to-return-values" role="doc-backlink">Use of StopIteration to return values</a></h3>
<p>There are a variety of ways that the return value from the generator
could be passed back.  Some alternatives include storing it as an
attribute of the generator-iterator object, or returning it as the
value of the <code class="docutils literal notranslate"><span class="pre">close()</span></code> call to the subgenerator.  However, the
proposed mechanism is attractive for a couple of reasons:</p>
<ul class="simple">
<li>Using a generalization of the StopIteration exception makes it easy
for other kinds of iterators to participate in the protocol without
having to grow an extra attribute or a close() method.</li>
<li>It simplifies the implementation, because the point at which the
return value from the subgenerator becomes available is the same
point at which the exception is raised.  Delaying until any later
time would require storing the return value somewhere.</li>
</ul>
</section>
<section id="rejected-ideas">
<h3><a class="toc-backref" href="#rejected-ideas" role="doc-backlink">Rejected Ideas</a></h3>
<p>Some ideas were discussed but rejected.</p>
<p>Suggestion: There should be some way to prevent the initial call to
__next__(), or substitute it with a send() call with a specified
value, the intention being to support the use of generators wrapped so
that the initial __next__() is performed automatically.</p>
<p>Resolution: Outside the scope of the proposal. Such generators should
not be used with <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>.</p>
<p>Suggestion: If closing a subiterator raises StopIteration with a
value, return that value from the <code class="docutils literal notranslate"><span class="pre">close()</span></code> call to the delegating
generator.</p>
<p>The motivation for this feature is so that the end of a stream of
values being sent to a generator can be signalled by closing the
generator.  The generator would catch GeneratorExit, finish its
computation and return a result, which would then become the return
value of the close() call.</p>
<p>Resolution: This usage of close() and GeneratorExit would be
incompatible with their current role as a bail-out and clean-up
mechanism.  It would require that when closing a delegating generator,
after the subgenerator is closed, the delegating generator be resumed
instead of re-raising GeneratorExit.  But this is not acceptable,
because it would fail to ensure that the delegating generator is
finalised properly in the case where close() is being called for
cleanup purposes.</p>
<p>Signalling the end of values to a consumer is better addressed by
other means, such as sending in a sentinel value or throwing in an
exception agreed upon by the producer and consumer.  The consumer can
then detect the sentinel or exception and respond by finishing its
computation and returning normally.  Such a scheme behaves correctly
in the presence of delegation.</p>
<p>Suggestion: If <code class="docutils literal notranslate"><span class="pre">close()</span></code> is not to return a value, then raise an
exception if StopIteration with a non-None value occurs.</p>
<p>Resolution: No clear reason to do so. Ignoring a return value is not
considered an error anywhere else in Python.</p>
</section>
</section>
<section id="criticisms">
<h2><a class="toc-backref" href="#criticisms" role="doc-backlink">Criticisms</a></h2>
<p>Under this proposal, the value of a <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> expression would be
derived in a very different way from that of an ordinary <code class="docutils literal notranslate"><span class="pre">yield</span></code>
expression.  This suggests that some other syntax not containing the
word <code class="docutils literal notranslate"><span class="pre">yield</span></code> might be more appropriate, but no acceptable
alternative has so far been proposed.  Rejected alternatives include
<code class="docutils literal notranslate"><span class="pre">call</span></code>, <code class="docutils literal notranslate"><span class="pre">delegate</span></code> and <code class="docutils literal notranslate"><span class="pre">gcall</span></code>.</p>
<p>It has been suggested that some mechanism other than <code class="docutils literal notranslate"><span class="pre">return</span></code> in the
subgenerator should be used to establish the value returned by the
<code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> expression.  However, this would interfere with the
goal of being able to think of the subgenerator as a suspendable
function, since it would not be able to return values in the same way
as other functions.</p>
<p>The use of an exception to pass the return value has been criticised
as an “abuse of exceptions”, without any concrete justification of
this claim.  In any case, this is only one suggested implementation;
another mechanism could be used without losing any essential features
of the proposal.</p>
<p>It has been suggested that a different exception, such as
GeneratorReturn, should be used instead of StopIteration to return a
value.  However, no convincing practical reason for this has been put
forward, and the addition of a <code class="docutils literal notranslate"><span class="pre">value</span></code> attribute to StopIteration
mitigates any difficulties in extracting a return value from a
StopIteration exception that may or may not have one.  Also, using a
different exception would mean that, unlike ordinary functions,
‘return’ without a value in a generator would not be equivalent to
‘return None’.</p>
</section>
<section id="alternative-proposals">
<h2><a class="toc-backref" href="#alternative-proposals" role="doc-backlink">Alternative Proposals</a></h2>
<p>Proposals along similar lines have been made before, some using the
syntax <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">*</span></code> instead of <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>.  While <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">*</span></code> is
more concise, it could be argued that it looks too similar to an
ordinary <code class="docutils literal notranslate"><span class="pre">yield</span></code> and the difference might be overlooked when reading
code.</p>
<p>To the author’s knowledge, previous proposals have focused only on
yielding values, and thereby suffered from the criticism that the
two-line for-loop they replace is not sufficiently tiresome to write
to justify a new syntax.  By dealing with the full generator protocol,
this proposal provides considerably more benefit.</p>
</section>
<section id="additional-material">
<h2><a class="toc-backref" href="#additional-material" role="doc-backlink">Additional Material</a></h2>
<p>Some examples of the use of the proposed syntax are available, and
also a prototype implementation based on the first optimisation
outlined above.</p>
<p><a class="reference external" href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/yield-from/">Examples and Implementation</a></p>
<p>A version of the implementation updated for Python 3.3 is available from
tracker <a class="reference external" href="http://bugs.python.org/issue11682">issue #11682</a></p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0380.rst">https://github.com/python/peps/blob/main/peps/pep-0380.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0380.rst">2025-02-01 08:59:27 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pep-acceptance">PEP Acceptance</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a><ul>
<li><a class="reference internal" href="#enhancements-to-stopiteration">Enhancements to StopIteration</a></li>
<li><a class="reference internal" href="#formal-semantics">Formal Semantics</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#the-refactoring-principle">The Refactoring Principle</a></li>
<li><a class="reference internal" href="#finalization">Finalization</a></li>
<li><a class="reference internal" href="#generators-as-threads">Generators as Threads</a></li>
<li><a class="reference internal" href="#syntax">Syntax</a></li>
<li><a class="reference internal" href="#optimisations">Optimisations</a></li>
<li><a class="reference internal" href="#use-of-stopiteration-to-return-values">Use of StopIteration to return values</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a></li>
</ul>
</li>
<li><a class="reference internal" href="#criticisms">Criticisms</a></li>
<li><a class="reference internal" href="#alternative-proposals">Alternative Proposals</a></li>
<li><a class="reference internal" href="#additional-material">Additional Material</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0380.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
</body>
</html>