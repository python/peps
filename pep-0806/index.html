
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 806 – Mixed sync/async context managers with precise async marking | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0806/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 806 – Mixed sync/async context managers with precise async marking | peps.python.org'>
    <meta property="og:description" content="Python allows the with and async with statements to handle multiple context managers in a single statement, so long as they are all respectively synchronous or asynchronous.  When mixing synchronous and asynchronous context managers, developers must use...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0806/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Python allows the with and async with statements to handle multiple context managers in a single statement, so long as they are all respectively synchronous or asynchronous.  When mixing synchronous and asynchronous context managers, developers must use...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 806</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 806 – Mixed sync/async context managers with precise async marking" data-pagefind-weight="10" class="visually-hidden">PEP 806 – Mixed sync/async context managers with precise async marking</span>
            <section id="pep-content">
<h1 class="page-title">PEP 806 – Mixed sync/async context managers with precise async marking</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Zac Hatfield-Dodds &lt;zac&#32;&#97;t&#32;zhd.dev&gt;</dd>
<dt class="field-even">Sponsor<span class="colon">:</span></dt>
<dd class="field-even">Jelle Zijlstra &lt;jelle.zijlstra&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-odd">Discussions-To<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/103971">Discourse thread</a></dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">05-Sep-2025</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.15</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/92939/" title="Discourse thread">22-May-2025</a>,
<a class="reference external" href="https://discuss.python.org/t/103971/" title="Discourse thread">25-Sep-2025</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a><ul>
<li><a class="reference internal" href="#real-world-impact">Real-World Impact</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#workaround-an-as-acm-wrapper">Workaround: an <code class="docutils literal notranslate"><span class="pre">as_acm()</span></code> wrapper</a></li>
<li><a class="reference internal" href="#workaround-using-asyncexitstack">Workaround: using <code class="docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a></li>
<li><a class="reference internal" href="#workaround-asyncexitstack-based-helper">Workaround: <code class="docutils literal notranslate"><span class="pre">AsyncExitStack</span></code>-based helper</a></li>
<li><a class="reference internal" href="#syntax-allow-async-with-sync-cm-async-cm">Syntax: allow <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span> <span class="pre">sync_cm,</span> <span class="pre">async_cm:</span></code></a></li>
<li><a class="reference internal" href="#syntax-ban-single-line-with-async">Syntax: ban single-line <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">async</span> <span class="pre">...</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Python allows the <code class="docutils literal notranslate"><span class="pre">with</span></code> and <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> statements to handle multiple
context managers in a single statement, so long as they are all respectively
synchronous or asynchronous.  When mixing synchronous and asynchronous context
managers, developers must use deeply nested statements or use risky workarounds
such as overuse of <a class="reference external" href="https://docs.python.org/3/library/contextlib.html#contextlib.AsyncExitStack" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a>.</p>
<p>We therefore propose to allow <code class="docutils literal notranslate"><span class="pre">with</span></code> statements to accept both synchronous
and asynchronous context managers in a single statement by prefixing individual
async context managers with the <code class="docutils literal notranslate"><span class="pre">async</span></code> keyword.</p>
<p>This change eliminates unnecessary nesting, improves code readability, and
improves ergonomics without making async code any less explicit.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>Modern Python applications frequently need to acquire multiple resources, via
a mixture of synchronous and asynchronous context managers.  While the all-sync
or all-async cases permit a single statement with multiple context managers,
mixing the two results in the “staircase of doom”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">acquire_lock</span><span class="p">()</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">temp_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">connect_to_db</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;config.json&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># We&#39;re now 16 spaces deep before any actual logic</span>
                    <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">])</span>
                    <span class="c1"># ... more processing</span>
</pre></div>
</div>
<p>This excessive indentation discourages use of context managers, despite their
desirable semantics.  See the <a class="reference internal" href="#rejected-ideas">Rejected Ideas</a> section for current workarounds
and commentary on their downsides.</p>
<p>With this PEP, the function could instead be written:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">():</span>
    <span class="k">with</span> <span class="p">(</span>
        <span class="k">async</span> <span class="n">acquire_lock</span><span class="p">()</span> <span class="k">as</span> <span class="n">lock</span><span class="p">,</span>
        <span class="n">temp_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">,</span>
        <span class="k">async</span> <span class="n">connect_to_db</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">,</span>
        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;config.json&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">])</span>
        <span class="c1"># ... more processing</span>
</pre></div>
</div>
<p>This compact alternative avoids forcing a new level of indentation on every
switch between sync and async context managers.  At the same time, it uses
only existing keywords, distinguishing async code with the <code class="docutils literal notranslate"><span class="pre">async</span></code> keyword
more precisely even than our current syntax.</p>
<p>We do not propose that the <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> statement should ever be deprecated,
and indeed advocate its continued use for single-line statements so that
“async” is the first non-whitespace token of each line opening an async
context manager.</p>
<p>Our proposal nonetheless permits <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">async</span> <span class="pre">some_ctx()</span></code>, valuing consistent
syntax design over enforcement of a single code style which we expect will be
handled by style guides, linters, formatters, etc.
See <a class="reference external" href="ban-single-line-with-async">here</a> for further discussion.</p>
<section id="real-world-impact">
<h3><a class="toc-backref" href="#real-world-impact" role="doc-backlink">Real-World Impact</a></h3>
<p>These enhancements address pain points that Python developers encounter daily.
We surveyed an industry codebase, finding more than ten thousand functions
containing at least one async context manager.  19% of these also contained a
sync context manager.  For reference, async functions contain sync context
managers about two-thirds as often as they contain async context managers.</p>
<p>39% of functions with both <code class="docutils literal notranslate"><span class="pre">with</span></code> and <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> statements could switch
immediately to the proposed syntax, but this is a loose lower
bound due to avoidance of sync context managers and use of workarounds listed
under Rejected Ideas.  Based on inspecting a random sample of functions, we
estimate that between 20% and 50% of async functions containing any context
manager would use <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">async</span></code> if this PEP is accepted.</p>
<p>Across the ecosystem more broadly, we expect lower rates, perhaps in the
5% to 20% range: the surveyed codebase uses structured concurrency with Trio,
and also makes extensive use of context managers to mitigate the issues
discussed in <a class="pep reference internal" href="../pep-0533/" title="PEP 533 – Deterministic cleanup for iterators">PEP 533</a> and <a class="pep reference internal" href="../pep-0789/" title="PEP 789 – Preventing task-cancellation bugs by limiting yield in async generators">PEP 789</a>.</p>
</section>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>Mixed sync/async context managers are common in modern Python applications,
such as async database connections or API clients and synchronous file
operations.  The current syntax forces developers to choose between deeply
nested code or error-prone workarounds like <a class="reference external" href="https://docs.python.org/3/library/contextlib.html#contextlib.AsyncExitStack" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a>.</p>
<p>This PEP addresses the problem with a minimal syntax change that builds on
existing patterns. By allowing individual context managers to be marked with
<code class="docutils literal notranslate"><span class="pre">async</span></code>, we maintain Python’s explicit approach to asynchronous code while
eliminating unnecessary nesting.</p>
<p>The implementation as syntactic sugar ensures zero runtime overhead – the new
syntax desugars to the same nested <code class="docutils literal notranslate"><span class="pre">with</span></code> and <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> statements
developers write today. This approach requires no new protocols, no changes
to existing context managers, and no new runtime behaviors to understand.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">(...,</span> <span class="pre">async</span> <span class="pre">...):</span></code> syntax desugars into a sequence of context
managers in the same way as current multi-context <code class="docutils literal notranslate"><span class="pre">with</span></code> statements,
except that those prefixed by the <code class="docutils literal notranslate"><span class="pre">async</span></code> keyword use the <code class="docutils literal notranslate"><span class="pre">__aenter__</span></code> /
<code class="docutils literal notranslate"><span class="pre">__aexit__</span></code> protocol.</p>
<p>Only the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement is modified; <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span> <span class="pre">async</span> <span class="pre">ctx():</span></code> is a
syntax error.</p>
<p>The <a class="reference external" href="https://docs.python.org/3/library/ast.html#ast.withitem" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ast.withitem</span></code></a> node gains a new <code class="docutils literal notranslate"><span class="pre">is_async</span></code> integer attribute,
following the existing <code class="docutils literal notranslate"><span class="pre">is_async</span></code> attribute on <a class="reference external" href="https://docs.python.org/3/library/ast.html#ast.comprehension" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ast.comprehension</span></code></a>.
For <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> statement items, this attribute is always <code class="docutils literal notranslate"><span class="pre">1</span></code>. For items
in a regular <code class="docutils literal notranslate"><span class="pre">with</span></code> statement, the attribute is <code class="docutils literal notranslate"><span class="pre">1</span></code> when the <code class="docutils literal notranslate"><span class="pre">async</span></code>
keyword is present and <code class="docutils literal notranslate"><span class="pre">0</span></code> otherwise. This allows the AST to precisely
represent which context managers should use the async protocol while
maintaining backwards compatibility with existing AST processing tools.</p>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>This change is fully backwards compatible: the only observable difference is
that certain syntax that previously raised <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#SyntaxError" title="(in Python v3.14)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">SyntaxError</span></code></a> now executes
successfully.</p>
<p>Libraries that implement context managers (standard library and third-party)
work with the new syntax without modifications.  Libraries and tools which
work directly with source code will need minor updates, as for any new syntax.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>We recommend introducing “mixed context managers” together with or immediately
after <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code>.  For example, a tutorial might cover:</p>
<ol class="arabic simple">
<li><strong>Basic context managers</strong>: Start with single <code class="docutils literal notranslate"><span class="pre">with</span></code> statements</li>
<li><strong>Multiple context managers</strong>: Show the current comma syntax</li>
<li><strong>Async context managers</strong>: Introduce <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code></li>
<li><strong>Mixed contexts</strong>: “Mark each async context manager with <code class="docutils literal notranslate"><span class="pre">async</span></code>”</li>
</ol>
</section>
<section id="rejected-ideas">
<h2><a class="toc-backref" href="#rejected-ideas" role="doc-backlink">Rejected Ideas</a></h2>
<section id="workaround-an-as-acm-wrapper">
<h3><a class="toc-backref" href="#workaround-an-as-acm-wrapper" role="doc-backlink">Workaround: an <code class="docutils literal notranslate"><span class="pre">as_acm()</span></code> wrapper</a></h3>
<p>It is easy to implement a helper function which wraps a synchronous context
manager in an async context manager.  For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">as_acm</span><span class="p">(</span><span class="n">sync_cm</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">sync_cm</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">result</span>

<span class="k">async</span> <span class="k">with</span> <span class="p">(</span>
    <span class="n">acquire_lock</span><span class="p">(),</span>
    <span class="n">as_acm</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span>
<span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This is our recommended workaround for almost all code.</p>
<p>However, there are some cases where calling back into the async runtime (i.e.
executing <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">sleep(0)</span></code>) to allow cancellation is undesirable.  On the
other hand, <em>omitting</em> <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">sleep(0)</span></code> would break the transitive property
that a syntactic <code class="docutils literal notranslate"><span class="pre">await</span></code> / <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">for</span></code> / <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> always calls back
into the async runtime (or raises an exception).  While few codebases enforce
this property today, we have found it indispensable in preventing deadlocks,
and accordingly prefer a cleaner foundation for the ecosystem.</p>
</section>
<section id="workaround-using-asyncexitstack">
<h3><a class="toc-backref" href="#workaround-using-asyncexitstack" role="doc-backlink">Workaround: using <code class="docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a></h3>
<p><a class="reference external" href="https://docs.python.org/3/library/contextlib.html#contextlib.AsyncExitStack" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a> offers a powerful, low-level interface
which allows for explicit entry of sync and/or async context managers.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span><span class="n">acquire_lock</span><span class="p">())</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>However, <a class="reference external" href="https://docs.python.org/3/library/contextlib.html#contextlib.AsyncExitStack" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a> introduces significant complexity
and potential for errors - it’s easy to violate properties that syntactic use
of context managers would guarantee, such as ‘last-in, first-out’ order.</p>
</section>
<section id="workaround-asyncexitstack-based-helper">
<h3><a class="toc-backref" href="#workaround-asyncexitstack-based-helper" role="doc-backlink">Workaround: <code class="docutils literal notranslate"><span class="pre">AsyncExitStack</span></code>-based helper</a></h3>
<p>We could also implement a <code class="docutils literal notranslate"><span class="pre">multicontext()</span></code> wrapper, which avoids some of the
downsides of direct use of <a class="reference external" href="https://docs.python.org/3/library/contextlib.html#contextlib.AsyncExitStack" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">with</span> <span class="n">multicontext</span><span class="p">(</span>
    <span class="n">acquire_lock</span><span class="p">(),</span>
    <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
<span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>However, this helper breaks the locality of <code class="docutils literal notranslate"><span class="pre">as</span></code> clauses, which makes it
easy to accidentally mis-assign the yielded variables (as in the code sample).
It also requires either distinguishing sync from async context managers using
something like a tagged union - perhaps overloading an operator so that, e.g.,
<code class="docutils literal notranslate"><span class="pre">async_</span> <span class="pre">&#64;</span> <span class="pre">acquire_lock()</span></code> works - or else guessing what to do with objects
that implement both sync and async context-manager protocols.
Finally, it has the error-prone semantics around exception handling which led
<a class="reference external" href="https://docs.python.org/2.7/library/contextlib.html#contextlib.nested">contextlib.nested()</a> to be deprecated in favor of the multi-argument
<code class="docutils literal notranslate"><span class="pre">with</span></code> statement.</p>
</section>
<section id="syntax-allow-async-with-sync-cm-async-cm">
<h3><a class="toc-backref" href="#syntax-allow-async-with-sync-cm-async-cm" role="doc-backlink">Syntax: allow <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span> <span class="pre">sync_cm,</span> <span class="pre">async_cm:</span></code></a></h3>
<p>An early draft of this proposal used <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> for the entire statement
when mixing context managers, <em>if</em> there is at least one async context manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rejected approach</span>
<span class="k">async</span> <span class="k">with</span> <span class="p">(</span>
    <span class="n">acquire_lock</span><span class="p">(),</span>
    <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;config.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span>  <span class="c1"># actually sync, surprise!</span>
<span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Requiring an async context manager maintains the syntax/scheduler link, but at
the cost of setting invisible constraints on future code changes.  Removing
one of several context managers could cause runtime errors, if that happened
to be the last async context manager!</p>
<p>Explicit is better than implicit.</p>
</section>
<section id="syntax-ban-single-line-with-async">
<span id="ban-single-line-with-async"></span><h3><a class="toc-backref" href="#syntax-ban-single-line-with-async" role="doc-backlink">Syntax: ban single-line <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">async</span> <span class="pre">...</span></code></a></h3>
<p>Our proposed syntax could be restricted, e.g. to place <code class="docutils literal notranslate"><span class="pre">async</span></code> only as the
first token of lines in a parenthesised multi-context <code class="docutils literal notranslate"><span class="pre">with</span></code> statement.
This is indeed how we recommend it should be used, and we expect that most
uses will follow this pattern.</p>
<p>While an option to write either <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span> <span class="pre">ctx():</span></code> or <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">async</span> <span class="pre">ctx():</span></code>
may cause some small confusion due to ambiguity, we think that enforcing a
preferred style via the syntax would make Python more confusing to learn,
and thus prefer simple syntactic rules plus community conventions on how to
use them.</p>
<p>To illustrate, we do not think it’s obvious at what point (if any) in the
following code samples the syntax should become disallowed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="p">(</span>
    <span class="n">sync_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">foo</span><span class="p">,</span>
    <span class="k">async</span> <span class="n">a_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">bar</span><span class="p">,</span>
<span class="p">):</span> <span class="o">...</span>

<span class="k">with</span> <span class="p">(</span>
    <span class="n">sync_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">foo</span><span class="p">,</span>
    <span class="k">async</span> <span class="n">a_context</span><span class="p">()</span>
<span class="p">):</span> <span class="o">...</span>

<span class="k">with</span> <span class="p">(</span>
    <span class="c1"># sync_context() as foo,</span>
    <span class="k">async</span> <span class="n">a_context</span><span class="p">()</span>
<span class="p">):</span> <span class="o">...</span>

<span class="k">with</span> <span class="p">(</span><span class="k">async</span> <span class="n">a_context</span><span class="p">()):</span> <span class="o">...</span>

<span class="k">with</span> <span class="k">async</span> <span class="n">a_context</span><span class="p">():</span> <span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="acknowledgements">
<h2><a class="toc-backref" href="#acknowledgements" role="doc-backlink">Acknowledgements</a></h2>
<p>Thanks to Rob Rolls for <a class="reference external" href="https://discuss.python.org/t/92939/10">proposing</a> <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">async</span></code>.  Thanks also to the many
other people with whom we discussed this problem and possible solutions at the
PyCon 2025 sprints, on Discourse, and at work.</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0806.rst">https://github.com/python/peps/blob/main/peps/pep-0806.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0806.rst">2025-09-27 10:52:42 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a><ul>
<li><a class="reference internal" href="#real-world-impact">Real-World Impact</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#workaround-an-as-acm-wrapper">Workaround: an <code class="docutils literal notranslate"><span class="pre">as_acm()</span></code> wrapper</a></li>
<li><a class="reference internal" href="#workaround-using-asyncexitstack">Workaround: using <code class="docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a></li>
<li><a class="reference internal" href="#workaround-asyncexitstack-based-helper">Workaround: <code class="docutils literal notranslate"><span class="pre">AsyncExitStack</span></code>-based helper</a></li>
<li><a class="reference internal" href="#syntax-allow-async-with-sync-cm-async-cm">Syntax: allow <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span> <span class="pre">sync_cm,</span> <span class="pre">async_cm:</span></code></a></li>
<li><a class="reference internal" href="#syntax-ban-single-line-with-async">Syntax: ban single-line <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">async</span> <span class="pre">...</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0806.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>