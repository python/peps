
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 818 – Adding the Core of the Pyodide Foreign Function Interface to Python | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0818/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 818 – Adding the Core of the Pyodide Foreign Function Interface to Python | peps.python.org'>
    <meta property="og:description" content="Pyodide is a distribution of Python for JavaScript runtimes, including browsers. Browsers are a universal computing platform. As with C for Unix family operating systems, in the browser platform all fundamental capabilities are exposed through the JavaS...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0818/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Pyodide is a distribution of Python for JavaScript runtimes, including browsers. Browsers are a universal computing platform. As with C for Unix family operating systems, in the browser platform all fundamental capabilities are exposed through the JavaS...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 818</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 818 – Adding the Core of the Pyodide Foreign Function Interface to Python" data-pagefind-weight="10" class="visually-hidden">PEP 818 – Adding the Core of the Pyodide Foreign Function Interface to Python</span>
            <section id="pep-content">
<h1 class="page-title">PEP 818 – Adding the Core of the Pyodide Foreign Function Interface to Python</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Hood Chatham &lt;roberthoodchatham at gmail.com&gt;</dd>
<dt class="field-even">Sponsor<span class="colon">:</span></dt>
<dd class="field-even">Łukasz Langa &lt;lukasz at python.org&gt;</dd>
<dt class="field-odd">Discussions-To<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/pep-818-upstreaming-the-pyodide-ffi/105530">Discourse thread</a></dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">10-Dec-2025</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.15</dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#translating-objects">Translating Objects</a></li>
<li><a class="reference internal" href="#proxies">Proxies</a></li>
<li><a class="reference internal" href="#garbage-collection-and-destruction-of-proxies">Garbage Collection and Destruction of Proxies</a></li>
<li><a class="reference internal" href="#calling-conventions">Calling Conventions</a><ul>
<li><a class="reference internal" href="#calling-a-python-function-from-javascript">Calling a Python Function from JavaScript</a></li>
<li><a class="reference internal" href="#calling-a-javascript-function-from-python">Calling a JavaScript Function from Python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#defense-of-the-calling-convention-for-a-jsproxy">Defense of the Calling Convention for a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code></a><ul>
<li><a class="reference internal" href="#an-example-of-a-disadvantage-of-the-calling-convention">An Example of a Disadvantage of the Calling Convention</a></li>
<li><a class="reference internal" href="#a-use-case-that-is-made-simpler-by-this-calling-convention">A Use Case That Is Made Simpler By This Calling Convention</a></li>
</ul>
</li>
<li><a class="reference internal" href="#new-top-level-packages">New Top Level Packages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#the-pseudocode-in-this-document">The Pseudocode in this Document</a></li>
<li><a class="reference internal" href="#converting-values-between-python-and-javascript">Converting Values between Python and JavaScript</a><ul>
<li><a class="reference internal" href="#implicit-conversion-from-python-to-javascript">Implicit conversion from Python to JavaScript</a></li>
<li><a class="reference internal" href="#implicit-conversion-from-javascript-to-python">Implicit conversion from JavaScript to Python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#error-handling">Error handling</a><ul>
<li><a class="reference internal" href="#executing-javascript-code-from-c">Executing JavaScript Code from C</a></li>
<li><a class="reference internal" href="#executing-c-code-from-javascript">Executing C Code from JavaScript</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">Calling Conventions</a><ul>
<li><a class="reference internal" href="#id2">Calling a Python Function from JavaScript</a></li>
<li><a class="reference internal" href="#id3">Calling a JavaScript Function from Python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#run-js"><code class="docutils literal notranslate"><span class="pre">run_js</span></code></a></li>
<li><a class="reference internal" href="#makepythonfunction"><code class="docutils literal notranslate"><span class="pre">makePythonFunction</span></code></a></li>
<li><a class="reference internal" href="#jsproxy">JSProxy</a><ul>
<li><a class="reference internal" href="#creating-a-jsproxy">Creating a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code></a></li>
<li><a class="reference internal" href="#the-jsproxy-metaclass">The <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> Metaclass</a></li>
<li><a class="reference internal" href="#the-jsproxy-base-class">The <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> Base Class</a></li>
<li><a class="reference internal" href="#determining-which-flags-to-set">Determining Which Flags to Set</a></li>
<li><a class="reference internal" href="#the-has-get-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-set-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-has-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_HAS</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-includes-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_INCLUDES</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-length-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-dispose-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_DISPOSE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-array-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ARRAY</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-array-like-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ARRAY_LIKE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-callable-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_CALLABLE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-error-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ERROR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-iterable-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-iterator-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ITERATOR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-generator-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_GENERATOR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-mapping-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_MAPPING</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-mutable-mapping-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_MAPPING</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-py-json-sequence-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_SEQUENCE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-py-json-dict-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-double-proxy-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_DOUBLE_PROXY</span></code> Mixin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pyproxy">PyProxy</a><ul>
<li><a class="reference internal" href="#creating-a-pyproxy">Creating a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code></a></li>
<li><a class="reference internal" href="#the-pyproxy-base-class">The <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> Base Class</a></li>
<li><a class="reference internal" href="#id4">Determining Which Flags to Set</a></li>
<li><a class="reference internal" href="#id5">The <code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id6">The <code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-contains-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_CONTAINS</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id7">The <code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id8">The <code class="docutils literal notranslate"><span class="pre">IS_CALLABLE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-dict-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_DICT</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id9">The <code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id10">The <code class="docutils literal notranslate"><span class="pre">IS_ITERATOR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id11">The <code class="docutils literal notranslate"><span class="pre">IS_GENERATOR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-sequence-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_SEQUENCE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-mutable-sequence-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_SEQUENCE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-js-json-dict-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_DICT</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-js-json-sequence-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_SEQUENCE</span></code> Mixin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deep-conversions">Deep Conversions</a><ul>
<li><a class="reference internal" href="#from-javascript-to-python">From JavaScript to Python</a></li>
<li><a class="reference internal" href="#from-python-to-javascript">From Python to JavaScript</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-jstypes-global-this-module">The <code class="docutils literal notranslate"><span class="pre">jstypes.global_this</span></code> Module</a></li>
<li><a class="reference internal" href="#the-jstypes-package">The <code class="docutils literal notranslate"><span class="pre">jstypes</span></code> package</a><ul>
<li><a class="reference internal" href="#the-jstypes-ffi-module">The <code class="docutils literal notranslate"><span class="pre">jstypes.ffi</span></code> Module</a></li>
<li><a class="reference internal" href="#the-jstypes-code-module">The <code class="docutils literal notranslate"><span class="pre">jstypes.code</span></code> Module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changes-to-the-json-module">Changes to the <code class="docutils literal notranslate"><span class="pre">json</span></code> Module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#acknowledgments">Acknowledgments</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Pyodide is a distribution of Python for JavaScript runtimes, including browsers.
Browsers are a universal computing platform. As with C for Unix family operating
systems, in the browser platform all fundamental capabilities are exposed
through the JavaScript language. For years, Pyodide has included a comprehensive
JavaScript foreign function interface. This provides the equivalent of the
<code class="docutils literal notranslate"><span class="pre">os</span></code> module for the JavaScript world.</p>
<p>This PEP proposes adding the core of the Pyodide foreign function interface to
Python.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>The Pyodide project is a Python distribution for JavaScript runtimes. Pyodide is
a very popular project. In 2025, Pyodide received over a billion requests on
JsDelivr. The popularity is rapidly growing: usage has more than doubled in each
of the last two years.</p>
<p>Pyodide includes several components:</p>
<ol class="arabic simple">
<li>A port of CPython to the Emscripten compiler toolchain (a toolchain to
compile linux C/C++ programs to JavaScript and WebAssembly).</li>
<li>A foreign function interface for calling Python from JavaScript and
JavaScript from Python.</li>
<li>A JavaScript programmatic interface for managing the Python runtime and
package installation.</li>
<li>An ABI for native extensions.</li>
<li>A toolchain to cross-compile Python packages compatible with that ABI for use
with Pyodide.</li>
</ol>
<p>In the long run, we would like to upstream the runtime components (1)–(4) of
the Pyodide project into CPython. In 2022, Christian Heimes upstreamed (1) the
Emscripten port of CPython, and Emscripten is currently a tier 3 supported
platform  (see <a class="pep reference internal" href="../pep-0776/" title="PEP 776 – Emscripten Support">PEP 776</a>). <a class="pep reference internal" href="../pep-0783/" title="PEP 783 – Emscripten Packaging">PEP 783</a> proposes to allow Pyodide-compatible
wheels to be uploaded to PyPI. What is needed for these to be
Emscripten-CPython-compatible wheels is to upstream (2) the Python/JavaScript
foreign function interface and (4) the ABI for native extensions. This PEP
concerns partially upstreaming (2) the Python/JavaScript foreign function
interface.</p>
<p>This interface is similar to the <code class="docutils literal notranslate"><span class="pre">os</span></code> module for Python on linux: all IO
requires going through libc and the <code class="docutils literal notranslate"><span class="pre">os</span></code> module provides access to libc calls
to Python code. Similarly, in a JavaScript runtime, to do any actual work
requires making calls into JavaScript: for example, it is required to display
content to the screen, to receive user input, to handle events, to access
databases, etc. For instance, once Python has a JavaScript foreign function
interface, it will be possible to support <code class="docutils literal notranslate"><span class="pre">urllib</span></code> on Emscripten. Downstream,
supporting <code class="docutils literal notranslate"><span class="pre">urllib3</span></code>, <code class="docutils literal notranslate"><span class="pre">aiohttp</span></code>, and <code class="docutils literal notranslate"><span class="pre">httpx</span></code> requires the foreign function
interface.</p>
<p>In order to keep the length of this PEP reasonable, we focus on the “core” of
the foreign function interface. Three areas are left to future PEPs:</p>
<ol class="arabic simple">
<li>asyncio</li>
<li>integration between the buffer protocol and JavaScript equivalents</li>
<li>a JavaScript interface for managing the Python runtime</li>
</ol>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>Our goal here is to upstream Pyodide’s foreign function interface, without
breaking backwards compatibility more than necessary for Pyodide’s large
collection of existing users. On the other hand, the best time to making
breaking changes is now.</p>
<p>With that in mind, we wish here to justify not that our design is perfect but
that the costs of any changes outweigh the benefits.</p>
<section id="translating-objects">
<h3><a class="toc-backref" href="#translating-objects" role="doc-backlink">Translating Objects</a></h3>
<p>The most fundamental decision is how we translate objects from one language to
the other. When translating an object, we can either choose to convert the value
into a similar object in the target language, or to make a proxy that “wraps”
the original object. A few considerations apply here:</p>
<ol class="arabic simple">
<li>Mutability: If we call a function that expects to mutate its argument, then
it is important that we proxy the argument and not convert it. Otherwise, the
function mutates a copy that we then throw away. So implicit conversion is
only a reasonable option for immutable objects.</li>
<li>Round trip behavior: It is strongly desirable that passing an object from
Python to JavaScript back to Python results in the original Python object and
vice-versa. If the object is immutable, it is okay if the result is only
equal to the original object and not the same object. If the object is
mutable, it should be the same object.</li>
<li>Performance characteristics: Converting a complex object entails a lot of up
front work. If the object is only minimally used, then it may be less
performant. On the other hand, each access to an object via a proxy is slower
than to a native object so if the object is used a lot, converting up front
is more efficient than proxying. Proxying by default and allowing the user to
explicitly convert when they want to gives the user maximum control over
performance.</li>
<li>Ergonomics: A native object is in many cases easier to work with.</li>
</ol>
<p>JavaScript has the following immutable types: <code class="docutils literal notranslate"><span class="pre">string</span></code>, <code class="docutils literal notranslate"><span class="pre">undefined</span></code>,
<code class="docutils literal notranslate"><span class="pre">boolean</span></code>, <code class="docutils literal notranslate"><span class="pre">number</span></code> and <code class="docutils literal notranslate"><span class="pre">bigint</span></code>. It also has the special value <code class="docutils literal notranslate"><span class="pre">null</span></code>.</p>
<p>Of these, <code class="docutils literal notranslate"><span class="pre">string</span></code> and <code class="docutils literal notranslate"><span class="pre">boolean</span></code> directly correspond to <code class="docutils literal notranslate"><span class="pre">str</span></code> and
<code class="docutils literal notranslate"><span class="pre">bool</span></code>. We convert a <code class="docutils literal notranslate"><span class="pre">number</span></code> to an <code class="docutils literal notranslate"><span class="pre">int</span></code> if <code class="docutils literal notranslate"><span class="pre">Number.isSafeInteger()</span></code>
returns <code class="docutils literal notranslate"><span class="pre">true</span></code> and otherwise we convert it to a <code class="docutils literal notranslate"><span class="pre">float</span></code>. Conversely we
convert <code class="docutils literal notranslate"><span class="pre">float</span></code> to <code class="docutils literal notranslate"><span class="pre">number</span></code> and we convert <code class="docutils literal notranslate"><span class="pre">int</span></code> to <code class="docutils literal notranslate"><span class="pre">number</span></code> unless it
exceeds <code class="docutils literal notranslate"><span class="pre">2**53</span></code> in which case we convert it to a <code class="docutils literal notranslate"><span class="pre">bigint</span></code>. We make a new
subclass of <code class="docutils literal notranslate"><span class="pre">int</span></code> called <code class="docutils literal notranslate"><span class="pre">JSBigInt</span></code> to act as the conversion for
<code class="docutils literal notranslate"><span class="pre">bigint</span></code>.``undefined`` is the default value for a missing argument so it
corresponds to <code class="docutils literal notranslate"><span class="pre">None</span></code>. We invent a new falsey singleton Python value
<code class="docutils literal notranslate"><span class="pre">jsnull</span></code> of type <code class="docutils literal notranslate"><span class="pre">JSNull</span></code> to act as the conversion of <code class="docutils literal notranslate"><span class="pre">null</span></code>. All other
types are proxied.</p>
<p>In particular, even though <code class="docutils literal notranslate"><span class="pre">tuples</span></code> are immutable, they have no equivalent in
JavaScript so we proxy them. They can be manually converted to an <code class="docutils literal notranslate"><span class="pre">Array</span></code> with
the <code class="docutils literal notranslate"><span class="pre">toJs()</span></code> method if desired.</p>
</section>
<section id="proxies">
<h3><a class="toc-backref" href="#proxies" role="doc-backlink">Proxies</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> is a Python object used for accessing a JavaScript object. While
the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> exists, the underlying JavaScript object is kept in a table
which keeps it from being garbage collected.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> is a JavaScript object used for accessing a Python object. When a
<code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> is created, the reference count of the underlying Python object is
incremented. When the <code class="docutils literal notranslate"><span class="pre">.destroy()</span></code> method is called, the reference count of the
underlying Python object is decremented and the proxy is disabled. Any further
attempt to use it raises an error.</p>
<p>The base <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> implements property access, equality checks, <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>,
<code class="docutils literal notranslate"><span class="pre">__eq__</span></code>, <code class="docutils literal notranslate"><span class="pre">__bool__</span></code>, and a handful of other convenience methods. We also
define a large number of mixins by mapping abstract Python object protocols to
abstract JavaScript object protocols (and vice-versa). The mapping described in
this PEP is as follows:</p>
<p>Base proxies (properties common to all objects):</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">__getattribute__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">Reflect.get</span></code> (proxy handler)</li>
<li><code class="docutils literal notranslate"><span class="pre">__setattr__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">Reflect.set</span></code> (proxy handler)</li>
<li><code class="docutils literal notranslate"><span class="pre">__eq__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">===</span></code> (object identity)</li>
<li><code class="docutils literal notranslate"><span class="pre">__repr__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">toString</span></code></li>
</ul>
<p>For the <code class="docutils literal notranslate"><span class="pre">__str__</span></code> implementation, we inherit the default implementation which
uses <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>.</p>
<p>We implement the following mappings between protocols as mixins. When we create
a proxy, we feature detect which of these abstract and concrete protocols it
supports and create a class for the proxy with the appropriate mixins.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">__iter__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">[Symbol.iterator]</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">__next__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">next</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">__len__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">length</span></code>, <code class="docutils literal notranslate"><span class="pre">size</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">get</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">__setitem__</span></code>, <code class="docutils literal notranslate"><span class="pre">__delitem__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">set</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">__contains__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">includes</span></code>, <code class="docutils literal notranslate"><span class="pre">has</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">__call__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">Reflect.apply</span></code> (proxy handler)</li>
<li><code class="docutils literal notranslate"><span class="pre">Generator</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">Generator</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Exception</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">Error</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">MutableSequence</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">Array</span></code></li>
</ul>
<p>If a JavaScript object has a <code class="docutils literal notranslate"><span class="pre">[Symbol.dispose]()</span></code> method, we make the Python
object into a context manager, but we do not presently use context managers to
implement <code class="docutils literal notranslate"><span class="pre">[Symbol.dispose]()</span></code>.</p>
<p>JavaScript also has <code class="docutils literal notranslate"><span class="pre">Reflect.construct</span></code> (the <code class="docutils literal notranslate"><span class="pre">new</span></code> keyword). Callable
JSProxies have a method called <code class="docutils literal notranslate"><span class="pre">new()</span></code> which corresponds to
<code class="docutils literal notranslate"><span class="pre">Reflect.construct</span></code>.</p>
<p>The following additional mappings are defined in Pyodide. It is our intention to
eventually add them to Python itself, but they are deferred to a future PEP:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">__await__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">then</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">__aiter__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">[Symbol.asyncIterator]</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">__anext__</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">next</span></code> (same as <code class="docutils literal notranslate"><span class="pre">__next__</span></code>; check for presence of
<code class="docutils literal notranslate"><span class="pre">[Symbol.asyncIterator]</span></code> to distinguish)</li>
<li><code class="docutils literal notranslate"><span class="pre">AsyncGenerator</span></code> &lt;==&gt; <code class="docutils literal notranslate"><span class="pre">AsyncGenerator</span></code></li>
<li>buffer protocol &lt;==&gt; typed arrays</li>
<li>Async context managers are implemented on JSProxies that implement
<code class="docutils literal notranslate"><span class="pre">[Symbol.asyncDispose]</span></code>.</li>
</ul>
</section>
<section id="garbage-collection-and-destruction-of-proxies">
<h3><a class="toc-backref" href="#garbage-collection-and-destruction-of-proxies" role="doc-backlink">Garbage Collection and Destruction of Proxies</a></h3>
<p>The most fundamental difficulty that we face is the existence of two garbage
collectors, the Python garbage collector and the JavaScript garbage collector.
Any reference loop from Python to JavaScript back to Python will be leaked.
Furthermore, even if there is no loop, the JavaScript garbage collector has no
idea how much memory a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> owns nor how much memory pressure the Python
garbage collector faces.</p>
<p>For this reason, we need to include a way to manually break references between
languages. In Python, destructors are run eagerly when the reference count of an
object reaches 0. Thus, if a programmer wishes to manually release a JavaScript
object, they can delete all references to it and after that the JavaScript
garbage collector will be able to reclaim it.</p>
<p>On the other hand, JavaScript finalizers are not reliable. The proposal that
introduced them to the language says the following:</p>
<blockquote>
<div>If an application or library depends on GC [calling a finalizer] in a timely,
predictable manner, it’s likely to be disappointed: the cleanup may happen much
later than expected, or not at all.<p>…</p>
<p>It’s best if [finalizers] are used as a way to avoid excess memory usage, or as a
backstop against certain bugs, rather than as a normal way to clean up external
resources.</p>
</div></blockquote>
<p><a class="reference external" href="https://github.com/tc39/proposal-weakrefs?tab=readme-ov-file#a-note-of-caution">https://github.com/tc39/proposal-weakrefs?tab=readme-ov-file#a-note-of-caution</a></p>
<p>A <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> has a <code class="docutils literal notranslate"><span class="pre">destroy()</span></code> method that manually detaches the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>
and releases the Python reference. We consider destroying a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> to be
the correct, normal way to clean it up. As recommended by the proposal, the
finalizer is treated as a backstop. In the Pyodide test suite, we require that
every <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> be manually destroyed in the majority of the tests. This helps
to ensure that our APIs are designed in a way that keeps this ergonomic.</p>
</section>
<section id="calling-conventions">
<h3><a class="toc-backref" href="#calling-conventions" role="doc-backlink">Calling Conventions</a></h3>
<section id="calling-a-python-function-from-javascript">
<h4><a class="toc-backref" href="#calling-a-python-function-from-javascript" role="doc-backlink">Calling a Python Function from JavaScript</a></h4>
<p>To call a callable <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> we do the following steps:</p>
<ol class="arabic simple">
<li>Translate each argument from JavaScript to Python and place the arguments
in a C array.</li>
<li>Use <code class="docutils literal notranslate"><span class="pre">PyObject_VectorCall</span></code> to call the Python object.</li>
<li>If a JavaScript error is raised, this is fatal – Python interpreter
invariants have been violated. Report the fatal error and tear down the Python interpreter.</li>
<li>If the Python error flag is set, set <code class="docutils literal notranslate"><span class="pre">sys.last_value</span></code> to the current
exception. Convert the Python exception to a JavaScript <code class="docutils literal notranslate"><span class="pre">PythonError</span></code>
object. This <code class="docutils literal notranslate"><span class="pre">PythonError</span></code> object records the type, the formatted traceback
of the Python exception, and a weak reference to the original Python
exception. Throw this <code class="docutils literal notranslate"><span class="pre">PythonError</span></code>.</li>
<li>Translate the result from Python to JavaScript and return it.</li>
</ol>
<p>Note here that if a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> is created but the Python function does not
store a reference to it, it will be released immediately. The JavaScript error
doesn’t hold a strong reference the Python exception because JavaScript errors
are often leaked and Python error objects hold a reference to frame objects
which may hold a significant amount of memory.</p>
</section>
<section id="calling-a-javascript-function-from-python">
<h4><a class="toc-backref" href="#calling-a-javascript-function-from-python" role="doc-backlink">Calling a JavaScript Function from Python</a></h4>
<p>To call a callable <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> we do the following steps:</p>
<ol class="arabic">
<li>Make an empty array called <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code></li>
<li>Translate each positional argument from Python to JavaScript and place these
arguments in a JavaScript array called <code class="docutils literal notranslate"><span class="pre">jsargs</span></code>. If any <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> is
generated in this way, don’t register a JavaScript finalizer for it and do
append it to <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code>.</li>
<li>If there are any keyword arguments, create an empty JavaScript object
<code class="docutils literal notranslate"><span class="pre">jskwargs</span></code>, translate each keyword argument to JavaScript and assign
<code class="docutils literal notranslate"><span class="pre">jskwargs[key]</span> <span class="pre">=</span> <span class="pre">jskwarg</span></code>. Append <code class="docutils literal notranslate"><span class="pre">jskwargs</span></code> to <code class="docutils literal notranslate"><span class="pre">jsargs</span></code>. If any
<code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> is generated in this way, don’t register a JavaScript finalizer
for it and do append it to <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code>.</li>
<li>Call the JavaScript function and store the result into <code class="docutils literal notranslate"><span class="pre">jsresult</span></code>.</li>
<li>If an error is thrown:<blockquote>
<div><ol class="loweralpha simple">
<li>If the error is a <code class="docutils literal notranslate"><span class="pre">PythonError</span></code> and the weak reference to the Python
exception is still alive, raise the referenced Python exception.</li>
<li>Otherwise, convert the exception from JavaScript to Python and raise the
result. Note that the <code class="docutils literal notranslate"><span class="pre">JSException</span></code> object holds a reference to the
original JavaScript error.</li>
</ol>
</div></blockquote>
</li>
<li>If <code class="docutils literal notranslate"><span class="pre">jsresult</span></code> is a JavaScript generator, iterate over <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code> and
register a JavaScript finalizer for each. Wrap the generator with a new
generator that destroys <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code> when they are exhausted. Translate the
wrapped generator to Python and return it.</li>
<li>Otherwise, translate <code class="docutils literal notranslate"><span class="pre">jsresult</span></code> to Python and store it in <code class="docutils literal notranslate"><span class="pre">pyresult</span></code>.</li>
<li>Iterate over <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code> and destroy them. If <code class="docutils literal notranslate"><span class="pre">jsresult</span></code> is a
<code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>, destroy it too.</li>
<li>Return <code class="docutils literal notranslate"><span class="pre">pyresult</span></code>.</li>
</ol>
<p>This is modeled on the calling convention for C Python APIs.</p>
</section>
</section>
<section id="defense-of-the-calling-convention-for-a-jsproxy">
<h3><a class="toc-backref" href="#defense-of-the-calling-convention-for-a-jsproxy" role="doc-backlink">Defense of the Calling Convention for a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code></a></h3>
<p>The calling convention from JavaScript into Python is uncontroversial so we will
not defend it. The calling convention from Python into JavaScript is more
controversial so we will explain here why we believe it is a better design than
the alternatives.</p>
<p>The main disadvantage of this design is that it is not as ergonomic in cases
where the callee is going to persist its arguments. However, we argue that the
benefits outweigh this.</p>
<p>The biggest advantage of this approach is that it makes it possible to use
JavaScript functions that are unaware of the existence of Python without memory
leaks. Another advantage is that registering a finalizer for a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> is
somewhat expensive and so avoiding this step can substantially decrease the
overhead for certain Python to JavaScript calls.</p>
<section id="an-example-of-a-disadvantage-of-the-calling-convention">
<h4><a class="toc-backref" href="#an-example-of-a-disadvantage-of-the-calling-convention" role="doc-backlink">An Example of a Disadvantage of the Calling Convention</a></h4>
<p>We will start by illustrating the common complaint about the Python to
JavaScript calling convention. Consider the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.code</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_js</span>
<span class="n">set_x</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;(x) =&gt; { globalThis.x = x; }&quot;</span><span class="p">)</span>
<span class="n">get_x</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;(x) =&gt; globalThis.x&quot;</span><span class="p">)</span>

<span class="n">set_x</span><span class="p">({})</span>
<span class="n">get_x</span><span class="p">()</span>
</pre></div>
</div>
<p>This code is broken. Calling <code class="docutils literal notranslate"><span class="pre">set_x</span></code> creates a PyProxy but it is destroyed
when the call is done. When we call <code class="docutils literal notranslate"><span class="pre">get_x()</span></code> the following error is raised:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">borrowed</span> <span class="n">proxy</span> <span class="n">was</span> <span class="n">automatically</span> <span class="n">destroyed</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">a</span> <span class="n">function</span> <span class="n">call</span><span class="o">.</span>
</pre></div>
</div>
<p>To fix it to manage memory correctly, we can change <code class="docutils literal notranslate"><span class="pre">set_x</span></code> to the following
function:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">globalThis</span><span class="p">.</span><span class="nx">x</span><span class="o">?</span><span class="p">.</span><span class="nx">destroy</span><span class="o">?</span><span class="p">.();</span>
<span class="w">    </span><span class="nb">globalThis</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="o">?</span><span class="p">.</span><span class="nx">copy</span><span class="o">?</span><span class="p">.()</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Or we can manage the memory from Python using <code class="docutils literal notranslate"><span class="pre">create_proxy()</span></code> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.ffi</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSDoubleProxy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.code</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_js</span>

<span class="n">setXJs</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;(x) =&gt; { globalThis.x = x; }&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">set_x</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">orig_x</span> <span class="o">=</span> <span class="n">get_x</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orig_x</span><span class="p">,</span> <span class="n">JSDoubleProxy</span><span class="p">):</span>
        <span class="n">orig_x</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
    <span class="n">xpx</span> <span class="o">=</span> <span class="n">create_proxy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">setXJs</span><span class="p">(</span><span class="n">xpx</span><span class="p">)</span>
</pre></div>
</div>
<p>This extra boilerplate is not too hard to get right – it’s roughly equivalent
to what is needed to assign an attribute in C. However, it does impose a
nontrivial complexity cost on the user and so we need to justify why this is
better than the alternatives.</p>
</section>
<section id="a-use-case-that-is-made-simpler-by-this-calling-convention">
<h4><a class="toc-backref" href="#a-use-case-that-is-made-simpler-by-this-calling-convention" role="doc-backlink">A Use Case That Is Made Simpler By This Calling Convention</a></h4>
<p>Suppose we have a Python function <code class="docutils literal notranslate"><span class="pre">render()</span></code> that returns a buffer, and a
JavaScript function <code class="docutils literal notranslate"><span class="pre">drawImageToCanvas(buffer)</span></code> that displays the buffer on a
canvas. If the buffer is a 1024 by 1024 bitmap with four color channels, then it
is a 4 megabyte buffer. Imagine the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@create_proxy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main_loop</span><span class="p">():</span>
    <span class="n">update</span><span class="p">()</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">render</span><span class="p">()</span>
    <span class="n">drawImageToCanvas</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="n">requestAnimationFrame</span><span class="p">(</span><span class="n">main_loop</span><span class="p">)</span>
</pre></div>
</div>
<p>With the calling convention described here, the buffer is released normally
after each call and memory usage stays consistent, in my tests it stays at 57
megabytes.</p>
<p>If we rely on a JavaScript finalizer to release <code class="docutils literal notranslate"><span class="pre">buffer</span></code>, in my tests the
JavaScript finalizer doesn’t run until malloc runs out of space on the
WebAssembly heap and requests more memory, with the effect that over several
minutes the WebAssembly heap gradually grows to the maximum allowed 4 gigabytes
and then a memory error is raised.</p>
<p>Now a cooperating implementation of <code class="docutils literal notranslate"><span class="pre">drawImageToCanvas()</span></code> could destroy the
<code class="docutils literal notranslate"><span class="pre">buffer</span></code> when it is done, but my philosophy in designing the calling
convention was that it should be possible to take care of the memory management
from Python. This necessitates something like the current approach.</p>
</section>
</section>
<section id="new-top-level-packages">
<h3><a class="toc-backref" href="#new-top-level-packages" role="doc-backlink">New Top Level Packages</a></h3>
<p>We introduce a new top level package called <code class="docutils literal notranslate"><span class="pre">jstypes</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">jstypes</span></code> package three two modules: <code class="docutils literal notranslate"><span class="pre">jstypes.code</span></code> and <code class="docutils literal notranslate"><span class="pre">jstypes.ffi</span></code>.
The <code class="docutils literal notranslate"><span class="pre">jstypes.global_this</span></code> package is the JavaScript global scope
<code class="docutils literal notranslate"><span class="pre">globalThis</span></code>. What set of values are present on the <code class="docutils literal notranslate"><span class="pre">jstypes.global_this</span></code>
module depends on the JavaScript runtime and whether the Python runtime is in
the main thread or a worker thread. For instance <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">jstypes.global_this</span>
<span class="pre">import</span> <span class="pre">Buffer</span></code> will succeed in Node but fail in a browser.</p>
<p><code class="docutils literal notranslate"><span class="pre">jstypes.code</span></code> exposes the <code class="docutils literal notranslate"><span class="pre">run_js</span></code> function.</p>
<p><code class="docutils literal notranslate"><span class="pre">jstypes.ffi</span></code> exposes the following functions:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">create_proxy</span></code></dt><dd>Creates a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> from Python. Used to control the lifetime of the
<code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> from Python.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">jsnull</span></code></dt><dd>Special value that converts to/from the JavaScript <code class="docutils literal notranslate"><span class="pre">null</span></code> value.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSNull</span></code></dt><dd>The type of <code class="docutils literal notranslate"><span class="pre">jsnull</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSBigInt</span></code></dt><dd>Subtype of <code class="docutils literal notranslate"><span class="pre">int</span></code> that converts to/from JavaScript <code class="docutils literal notranslate"><span class="pre">bigint</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">to_js</span></code></dt><dd>Does a deep conversion of a Python value to JavaScript.</dd>
</dl>
<p>We also include <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> and its subtypes:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">JSProxy</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;({})&quot;))</span></code></dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSArray</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;[]&quot;))</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSCallable</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;()</span> <span class="pre">=&gt;</span> <span class="pre">{}&quot;))</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSDoubleProxy</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(create_proxy({}))</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSException</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;new</span> <span class="pre">Error()&quot;))</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSGenerator</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;(function*(){})()&quot;))</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSIterable</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;({[Symbol.iterator](){}})&quot;))</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSIterator</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;({next(){}})&quot;))</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSMap</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;({get(){}})&quot;))</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">JSMutableMap</span></code></dt><dd>This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;new</span> <span class="pre">Map()&quot;))</span></code>.</dd>
</dl>
</section>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<section id="the-pseudocode-in-this-document">
<h3><a class="toc-backref" href="#the-pseudocode-in-this-document" role="doc-backlink">The Pseudocode in this Document</a></h3>
<p>The pseudocode in this PEP is generally written in Python or JavaScript. We
leave out most resource management and exception handling except when we think
it is particularly interesting. If an error is raised, we implicitly clean up
all resources and propagate the error. A large fraction of the real code
consists of resource management and exception handling.</p>
<p>For the most part the code works as written but in a few spots we directly call
a C API from Python or otherwise write code that wouldn’t run but whose intent
we believe is clear.</p>
<p>In Python code when we want to execute a JavaScript function inline, we write it
like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jsfunc</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;(x, y) =&gt; doSomething&quot;</span><span class="p">)</span>
<span class="n">jsfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>Conversely, when we want to execute Python code inline in JavaScript we write it
like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pyfunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    def pyfunc(x, y):</span>
<span class="sb">        # do something</span>
<span class="sb">`</span><span class="p">);</span>
<span class="nx">pyfunc</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
</pre></div>
</div>
<p>For the most part, this code could actually be used if performance was not a
concern. In some places there may be bootstrapping issues.</p>
<p>Our first task is to define the Python callable <code class="docutils literal notranslate"><span class="pre">run_js</span></code> and the JavaScript
callable <code class="docutils literal notranslate"><span class="pre">makePythonFunction</span></code>. <code class="docutils literal notranslate"><span class="pre">run_js</span></code> is a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> and
<code class="docutils literal notranslate"><span class="pre">makePythonFunction</span></code> is a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</p>
<p>To make sense of this, we need to describe</p>
<ol class="arabic simple">
<li>how we convert values from JavaScript to Python and from Python to JavaScript</li>
<li>how to call a Python function from JavaScript and how to call a JavaScript
function from Python</li>
</ol>
<p>We can directly represent a <code class="docutils literal notranslate"><span class="pre">PyObject*</span></code> as a <code class="docutils literal notranslate"><span class="pre">number</span></code> in JavaScript so we
can describe the process of calling a <code class="docutils literal notranslate"><span class="pre">PyObject*</span></code> from JavaScript. On the
other hand, JavaScript objects are not directly representable in Python, we have
to create a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> of it. We describe first the process of calling a
<code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>, the process of creating it is described in the section on
JSProxies.</p>
</section>
<section id="converting-values-between-python-and-javascript">
<h3><a class="toc-backref" href="#converting-values-between-python-and-javascript" role="doc-backlink">Converting Values between Python and JavaScript</a></h3>
<p>A few primitive types are implicitly converted between Python and JavaScript.
Implicit conversions are supposed to round trip, so that when converting from
Python to JavaScript back to Python or from JavaScript to Python back to
JavaScript, the result is the same primitive as we started with. The one
exception to this is that a JavaScript <code class="docutils literal notranslate"><span class="pre">BigInt</span></code> that is smaller than <code class="docutils literal notranslate"><span class="pre">2^53</span></code>
round trips to a <code class="docutils literal notranslate"><span class="pre">Number</span></code>. We convert <code class="docutils literal notranslate"><span class="pre">undefined</span></code> to <code class="docutils literal notranslate"><span class="pre">None</span></code> and introduce
the special falsey singleton <code class="docutils literal notranslate"><span class="pre">jstypes.ffi.jsnull</span></code> to convert <code class="docutils literal notranslate"><span class="pre">null</span></code>. We also
introduce a subtype of <code class="docutils literal notranslate"><span class="pre">int</span></code> called <code class="docutils literal notranslate"><span class="pre">jstypes.ffi.JSBigInt</span></code> which converts to
and from JavaScript <code class="docutils literal notranslate"><span class="pre">bigint</span></code>.</p>
<p>Implicit conversions are done with the C functions <code class="docutils literal notranslate"><span class="pre">_Py_python2js</span></code> and
<code class="docutils literal notranslate"><span class="pre">_Py_js2python()</span></code>. These functions cannot be called directly from Python code
because the <code class="docutils literal notranslate"><span class="pre">JSVal</span></code> type is not representable in Python.</p>
<section id="implicit-conversion-from-python-to-javascript">
<h4><a class="toc-backref" href="#implicit-conversion-from-python-to-javascript" role="doc-backlink">Implicit conversion from Python to JavaScript</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">JSVal</span> <span class="pre">_Py_python2js_track_proxies(PyObject*</span> <span class="pre">pyvalue,</span> <span class="pre">JSVal</span> <span class="pre">pyproxies,</span> <span class="pre">bool</span> <span class="pre">gc_register)</span></code>
is responsible for implicit conversions from Python to JavaScript. It does the
following steps:</p>
<ol class="arabic simple">
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>, return <code class="docutils literal notranslate"><span class="pre">undefined</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is <code class="docutils literal notranslate"><span class="pre">jsnull</span></code>, return <code class="docutils literal notranslate"><span class="pre">null</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, return <code class="docutils literal notranslate"><span class="pre">true</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code>, return <code class="docutils literal notranslate"><span class="pre">false</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is a <code class="docutils literal notranslate"><span class="pre">str</span></code>, convert the string to JavaScript and return the result.</li>
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is an instance of <code class="docutils literal notranslate"><span class="pre">JSBigInt</span></code>, convert it to a <code class="docutils literal notranslate"><span class="pre">BigInt</span></code>.</li>
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is an <code class="docutils literal notranslate"><span class="pre">int</span></code> and it is less than <code class="docutils literal notranslate"><span class="pre">2^53</span></code>, convert it to
a <code class="docutils literal notranslate"><span class="pre">Number</span></code>. Otherwise, convert it to a <code class="docutils literal notranslate"><span class="pre">BigInt</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is a <code class="docutils literal notranslate"><span class="pre">float</span></code>, convert it to  a <code class="docutils literal notranslate"><span class="pre">Number</span></code>.</li>
<li>if <code class="docutils literal notranslate"><span class="pre">pyvalue</span></code> is a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>, convert it to the wrapped JavaScript value.</li>
<li>Let <code class="docutils literal notranslate"><span class="pre">result</span></code> be <code class="docutils literal notranslate"><span class="pre">createPyProxy(pyvalue,</span> <span class="pre">{gcRegister:</span> <span class="pre">gc_register})</span></code>. If
<code class="docutils literal notranslate"><span class="pre">pyproxies</span></code> is an array, append <code class="docutils literal notranslate"><span class="pre">result</span></code> to <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code>.</li>
</ol>
<p>We define <code class="docutils literal notranslate"><span class="pre">JSVal</span> <span class="pre">_Py_python2js(PyObject*</span> <span class="pre">pyvalue)</span></code> to be
<code class="docutils literal notranslate"><span class="pre">_Py_python2js_track_proxies(pyvalue,</span> <span class="pre">Js_undefined,</span> <span class="pre">true)</span></code>.</p>
</section>
<section id="implicit-conversion-from-javascript-to-python">
<h4><a class="toc-backref" href="#implicit-conversion-from-javascript-to-python" role="doc-backlink">Implicit conversion from JavaScript to Python</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">PyObject*</span> <span class="pre">_Py_js2python(JSVal</span> <span class="pre">jsvalue)</span></code> is responsible for implicit
conversions from JavaScript to Python.</p>
<p>We first define the helper function <code class="docutils literal notranslate"><span class="pre">PyObject*</span> <span class="pre">_Py_js2python_immutable(JSVal</span> <span class="pre">jsvalue)</span></code>
does the following steps:</p>
<ol class="arabic simple">
<li>if <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is <code class="docutils literal notranslate"><span class="pre">undefined</span></code>, return <code class="docutils literal notranslate"><span class="pre">None</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is <code class="docutils literal notranslate"><span class="pre">null</span></code> return <code class="docutils literal notranslate"><span class="pre">jsnull</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> return <code class="docutils literal notranslate"><span class="pre">True</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is <code class="docutils literal notranslate"><span class="pre">false</span></code> return <code class="docutils literal notranslate"><span class="pre">False</span></code></li>
<li>if <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is a <code class="docutils literal notranslate"><span class="pre">string</span></code>, convert the string to Python and return the
result.</li>
<li>if <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is a <code class="docutils literal notranslate"><span class="pre">Number</span></code> and <code class="docutils literal notranslate"><span class="pre">Number.isSafeInteger(jsvalue)</span></code> returns
<code class="docutils literal notranslate"><span class="pre">true</span></code>, then convert <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> to an <code class="docutils literal notranslate"><span class="pre">int</span></code>. Otherwise convert it to a
<code class="docutils literal notranslate"><span class="pre">float</span></code>.</li>
<li>if <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is a <code class="docutils literal notranslate"><span class="pre">BigInt</span></code> then convert it to an <code class="docutils literal notranslate"><span class="pre">JSBigInt</span></code>.</li>
<li>If <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> that has not been destroyed, convert it to
the wrapped Python value.</li>
<li>If the <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code> is a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> that has been destroyed, throw an error
indicating this.</li>
<li>Return <code class="docutils literal notranslate"><span class="pre">NoValue</span></code>.</li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">_Py_js2python(JSVal</span> <span class="pre">jsvalue)</span></code> does the following steps:</p>
<ol class="arabic simple">
<li>Let <code class="docutils literal notranslate"><span class="pre">result</span></code> be <code class="docutils literal notranslate"><span class="pre">_Py_js2python_immutable(jsvalue)</span></code>. If <code class="docutils literal notranslate"><span class="pre">result</span></code> is
not <code class="docutils literal notranslate"><span class="pre">NoValue</span></code>, return <code class="docutils literal notranslate"><span class="pre">result</span></code>.</li>
<li>Return <code class="docutils literal notranslate"><span class="pre">create_jsproxy(jsvalue)</span></code>.</li>
</ol>
</section>
</section>
<section id="error-handling">
<h3><a class="toc-backref" href="#error-handling" role="doc-backlink">Error handling</a></h3>
<p>At the boundary between JavaScript and C, we have to translate errors.</p>
<section id="executing-javascript-code-from-c">
<h4><a class="toc-backref" href="#executing-javascript-code-from-c" role="doc-backlink">Executing JavaScript Code from C</a></h4>
<p>When we execute any JavaScript code from C, we wrap it in a try/catch block. If
an error is caught, we use <code class="docutils literal notranslate"><span class="pre">_Py_js2python(jserror)</span></code> to convert it into a
Python exception, set the Python error flag to this python exception, and return
the appropriate error value to signal an error. This makes it ergonomic to
create JavaScript functions that can be called from C and follow CPython’s
normal conventions for C APIs.</p>
</section>
<section id="executing-c-code-from-javascript">
<h4><a class="toc-backref" href="#executing-c-code-from-javascript" role="doc-backlink">Executing C Code from JavaScript</a></h4>
<p>Whenever we call into C from JavaScript, we wrap the call in the following
boilerplate:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">some_c_function</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// If an error was thrown here, the C runtime state is corrupted.</span>
<span class="w">    </span><span class="c1">// Signal a fatal error and tear down the interpreter.</span>
<span class="w">    </span><span class="nx">fatal_error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Depending on the API, we check for -1, 0, _PyErr_Occurred(), etc to</span>
<span class="c1">// decide if an error occurred.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// This function takes the error flag and converts it to a JavaScript</span>
<span class="w">    </span><span class="c1">// exception. It leaves the error flag cleared.</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="nx">__Py_pythonexc2js</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id1">
<h3><a class="toc-backref" href="#id1" role="doc-backlink">Calling Conventions</a></h3>
<section id="id2">
<h4><a class="toc-backref" href="#id2" role="doc-backlink">Calling a Python Function from JavaScript</a></h4>
<p>To call a <code class="docutils literal notranslate"><span class="pre">PyObject*</span></code> from JavaScript we use the following code:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">callPyObjectKwargs</span><span class="p">(</span><span class="nx">pyfuncptr</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">,</span><span class="w"> </span><span class="nx">kwargs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">num_pos_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">kwargs_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">kwargs</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">kwargs_values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">kwargs</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">num_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">kwargs_names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="nx">jsargs</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">kwargs_values</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// apply the usual error handling logic for calling from JavaScript into C.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">_PyProxy_apply</span><span class="p">(</span><span class="nx">pyfuncptr</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">,</span><span class="w"> </span><span class="nx">num_pos_args</span><span class="p">,</span><span class="w"> </span><span class="nx">kwargs_names</span><span class="p">,</span><span class="w"> </span><span class="nx">num_kwargs</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>_PyProxy_apply(PyObject* callable, JSVal jsargs, Py_ssize_t num_pos_args, JSVal kwargs_names, Py_ssize_t num_kwargs)</strong></p>
<ol class="arabic">
<li>Let <code class="docutils literal notranslate"><span class="pre">total_args</span></code> be <code class="docutils literal notranslate"><span class="pre">num_pos_args</span> <span class="pre">+</span> <span class="pre">numkwargs</span></code>.</li>
<li>Create a C array <code class="docutils literal notranslate"><span class="pre">pyargs</span></code> of length <code class="docutils literal notranslate"><span class="pre">total_args</span></code>.</li>
<li>For <code class="docutils literal notranslate"><span class="pre">i</span></code> ranging from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">total_args</span> <span class="pre">-</span> <span class="pre">1</span></code>:<blockquote>
<div><ol class="loweralpha simple">
<li>Execute the JavaScript code <code class="docutils literal notranslate"><span class="pre">jsargs[i]</span></code> and store the result into
<code class="docutils literal notranslate"><span class="pre">jsitem</span></code>.</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">pyargs[i]</span></code> to <code class="docutils literal notranslate"><span class="pre">_Py_js2python(jsitem)</span></code>.</li>
</ol>
</div></blockquote>
</li>
<li>Let <code class="docutils literal notranslate"><span class="pre">pykwnames</span></code> be a new tuple of length <code class="docutils literal notranslate"><span class="pre">numkwargs</span></code></li>
<li>For <code class="docutils literal notranslate"><span class="pre">i</span></code> ranging from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">numkwargs</span> <span class="pre">-</span> <span class="pre">1</span></code>:<blockquote>
<div><ol class="loweralpha simple">
<li>Execute the JavaScript code <code class="docutils literal notranslate"><span class="pre">jskwnames[i]</span></code> and store the result into
<code class="docutils literal notranslate"><span class="pre">jskey</span></code>.</li>
<li>Set the ith entry of <code class="docutils literal notranslate"><span class="pre">pykwnames</span></code> to <code class="docutils literal notranslate"><span class="pre">_Py_js2python(jsitem)</span></code>.</li>
</ol>
</div></blockquote>
</li>
<li>Let <code class="docutils literal notranslate"><span class="pre">pyresult</span></code> be <code class="docutils literal notranslate"><span class="pre">PyObject_Vectorcall(callable,</span> <span class="pre">pyargs,</span> <span class="pre">num_pos_args,</span> <span class="pre">pykwnames)</span></code>.</li>
<li>Return <code class="docutils literal notranslate"><span class="pre">_Py_python2js(pyresult)</span></code>.</li>
</ol>
</section>
<section id="id3">
<h4><a class="toc-backref" href="#id3" role="doc-backlink">Calling a JavaScript Function from Python</a></h4>
<p><strong>``JSMethod_ConvertArgs(posargs, kwargs, pyproxies)``</strong></p>
<p>First we define the function <code class="docutils literal notranslate"><span class="pre">JSMethod_ConvertArgs</span></code> to convert the Python
arguments to a JavaScript array of arguments. Any <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> created at this
stage is not tracked by the finalization registry and is added to the JavaScript
list <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code> so we can either destroy it or track it later. This function
performs the following steps:</p>
<ol class="arabic">
<li>Let <code class="docutils literal notranslate"><span class="pre">jsargs</span></code> be a new empty JavaScript list.</li>
<li>For each positional argument:<blockquote>
<div><ol class="loweralpha simple">
<li>Set <code class="docutils literal notranslate"><span class="pre">JSVal</span> <span class="pre">jsarg</span> <span class="pre">=</span> <span class="pre">_Py_python2js_track_proxies(pyarg,</span> <span class="pre">proxies,</span> <span class="pre">/*gc_register:*/false);</span></code>.</li>
<li>Call <code class="docutils literal notranslate"><span class="pre">_PyJsvArray_Push(jsargs,</span> <span class="pre">arg);</span></code>.</li>
</ol>
</div></blockquote>
</li>
<li>If there are any keyword arguments:<blockquote>
<div><ol class="loweralpha">
<li>Let <code class="docutils literal notranslate"><span class="pre">jskwargs</span></code> be a new empty JavaScript object.</li>
<li>For each keyword argument pykey, pyvalue:<blockquote>
<div><ol class="lowerroman simple">
<li>Set <code class="docutils literal notranslate"><span class="pre">JSVal</span> <span class="pre">jskey</span> <span class="pre">=</span> <span class="pre">_Py_python2js(pykey)</span></code></li>
<li>Set <code class="docutils literal notranslate"><span class="pre">JSVal</span> <span class="pre">jsvalue</span> <span class="pre">=</span> <span class="pre">_Py_python2js_track_proxies(pyvalue,</span> <span class="pre">proxies,</span> <span class="pre">/*gc_register:*/false)</span></code></li>
<li>Set the <code class="docutils literal notranslate"><span class="pre">jskey</span></code> property on <code class="docutils literal notranslate"><span class="pre">jskwargs</span></code> to <code class="docutils literal notranslate"><span class="pre">jsvalue</span></code>.</li>
</ol>
</div></blockquote>
</li>
<li>Call <code class="docutils literal notranslate"><span class="pre">_PyJsvArray_Push(jsargs,</span> <span class="pre">jskwargs);</span></code></li>
</ol>
</div></blockquote>
</li>
<li>Return <code class="docutils literal notranslate"><span class="pre">jsargs</span></code></li>
</ol>
<p><strong>``JSMethod_Vectorcall(jsproxy, posargs, kwargs)``</strong></p>
<p>Each <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> of a function has an underlying JavaScript function and an
underlying <code class="docutils literal notranslate"><span class="pre">this</span></code> value.</p>
<ol class="arabic simple">
<li>Let <code class="docutils literal notranslate"><span class="pre">jsfunc</span></code> be the JavaScript function associated to <code class="docutils literal notranslate"><span class="pre">jsproxy</span></code>.</li>
<li>Let <code class="docutils literal notranslate"><span class="pre">jsthis</span></code> be the <code class="docutils literal notranslate"><span class="pre">this</span></code> value associated to <code class="docutils literal notranslate"><span class="pre">jsproxy</span></code>.</li>
<li>Let <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code> be a new empty JavaScript list.</li>
<li>Execute <code class="docutils literal notranslate"><span class="pre">JSMethod_ConvertArgs(posargs,</span> <span class="pre">kwargs,</span> <span class="pre">pyproxies)</span></code> and store the
result into <code class="docutils literal notranslate"><span class="pre">jsargs</span></code>.</li>
<li>Execute the JavaScript code <code class="docutils literal notranslate"><span class="pre">Function.prototype.apply.apply(jsfunc,</span> <span class="pre">[</span> <span class="pre">jsthis,</span> <span class="pre">jsargs</span> <span class="pre">])</span></code>
and store the result into <code class="docutils literal notranslate"><span class="pre">jsresult</span></code>.
(Apply the usual error handling for calling from C into JavaScript.)</li>
<li>If <code class="docutils literal notranslate"><span class="pre">jsresult</span></code> is a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> run the JavaScript code <code class="docutils literal notranslate"><span class="pre">pyproxies.push(jsresult)</span></code></li>
<li>Set <code class="docutils literal notranslate"><span class="pre">destroy_args</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code></li>
<li>If <code class="docutils literal notranslate"><span class="pre">jsresult</span></code> is a <code class="docutils literal notranslate"><span class="pre">Generator</span></code> set <code class="docutils literal notranslate"><span class="pre">destroy_args</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> and set
<code class="docutils literal notranslate"><span class="pre">jsresult</span></code> to <code class="docutils literal notranslate"><span class="pre">wrap_generator(jsresult,</span> <span class="pre">pyproxies)</span></code>.</li>
<li>Execute <code class="docutils literal notranslate"><span class="pre">_Py_js2python(jsresult)</span></code> and store the result into <code class="docutils literal notranslate"><span class="pre">pyresult</span></code>.</li>
<li>If <code class="docutils literal notranslate"><span class="pre">destroy_args</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code>, then destroy all the proxies in <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code>.</li>
<li>If <code class="docutils literal notranslate"><span class="pre">destroy_args</span></code> is <code class="docutils literal notranslate"><span class="pre">false</span></code>, gc register all the proxies in <code class="docutils literal notranslate"><span class="pre">pyproxies</span></code>.</li>
<li>Return <code class="docutils literal notranslate"><span class="pre">pyresult</span></code>.</li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">wrap_generator(jsresult,</span> <span class="pre">pyproxies)</span></code> is a JavaScript function that wraps a
JavaScript generator in a new generator that destroys all the proxies in
<code class="docutils literal notranslate"><span class="pre">pyproxies</span></code> when the generator is exhausted.</p>
</section>
</section>
<section id="run-js">
<h3><a class="toc-backref" href="#run-js" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">run_js</span></code></a></h3>
<p>The Python object <code class="docutils literal notranslate"><span class="pre">jstypes.code.run_js</span></code> is defined as follows:</p>
<ol class="arabic simple">
<li>Execute the JavaScript code <code class="docutils literal notranslate"><span class="pre">eval</span></code> and store the result into <code class="docutils literal notranslate"><span class="pre">jseval</span></code>.</li>
<li>Run <code class="docutils literal notranslate"><span class="pre">_Py_js2python(jseval)</span></code> and store the result into <code class="docutils literal notranslate"><span class="pre">run_js</span></code>.</li>
</ol>
</section>
<section id="makepythonfunction">
<h3><a class="toc-backref" href="#makepythonfunction" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">makePythonFunction</span></code></a></h3>
<p>Unlike <code class="docutils literal notranslate"><span class="pre">run_js</span></code>, the JavaScript object <code class="docutils literal notranslate"><span class="pre">makePythonFunction</span></code> is strictly for
the sake of our pseudocode and will not be included as part of the API. We
define define <code class="docutils literal notranslate"><span class="pre">makePythonFunction</span></code> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">make_python_function</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">mod</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple">
<li>Let <code class="docutils literal notranslate"><span class="pre">make_python_function</span></code> be the function above.</li>
<li>Run <code class="docutils literal notranslate"><span class="pre">_Py_python2js(make_python_function)</span></code> and store the result into
<code class="docutils literal notranslate"><span class="pre">makePythonFunction</span></code>.</li>
</ol>
</section>
<section id="jsproxy">
<h3><a class="toc-backref" href="#jsproxy" role="doc-backlink">JSProxy</a></h3>
<p>We define 14 different abstract protocols that a JavaScript object can support.
These each correspond to a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> type flag. There are also two additional
flags <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code> and <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_SEQUENCE</span></code> which are set by the
<code class="docutils literal notranslate"><span class="pre">JSProxy.as_py_json()</span></code> method and do not reflect properties of the underlying
JavaScript object.</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code></dt><dd>Signals whether or not the JavaScript object has a <code class="docutils literal notranslate"><span class="pre">get()</span></code>
method. If present, used to implement <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HAS_HAS</span></code></dt><dd>Signals whether or not the JavaScript object has a <code class="docutils literal notranslate"><span class="pre">has()</span></code> method. If
present, used to implement <code class="docutils literal notranslate"><span class="pre">__contains__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HAS_INCLUDES</span></code></dt><dd>Signals whether or not the JavaScript object has an <code class="docutils literal notranslate"><span class="pre">includes()</span></code> method.
If present, used to implement <code class="docutils literal notranslate"><span class="pre">__contains__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>. We prefer
to use <code class="docutils literal notranslate"><span class="pre">has()</span></code> to <code class="docutils literal notranslate"><span class="pre">includes()</span></code> if both are present.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code></dt><dd>Signals whether or not the JavaScript object has a <code class="docutils literal notranslate"><span class="pre">length</span></code> or <code class="docutils literal notranslate"><span class="pre">size</span></code>
property. Used to implement <code class="docutils literal notranslate"><span class="pre">__len__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code></dt><dd>Signals whether or not the JavaScript object has a <code class="docutils literal notranslate"><span class="pre">set()</span></code> method. If
present, used to implement <code class="docutils literal notranslate"><span class="pre">__setitem__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HAS_DISPOSE</span></code></dt><dd>Signals whether or not the JavaScript object has a <code class="docutils literal notranslate"><span class="pre">[Symbol.dispose]()</span></code>
method. If present, used to implement <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_ARRAY</span></code></dt><dd>Signals whether <code class="docutils literal notranslate"><span class="pre">Array.isArray()</span></code> applied to the JavaScript object returns
<code class="docutils literal notranslate"><span class="pre">true</span></code>. If present,  the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> will be an instance of
<code class="docutils literal notranslate"><span class="pre">collections.abc.MutableSequence</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_ARRAY_LIKE</span></code></dt><dd>We set this if <code class="docutils literal notranslate"><span class="pre">Array.isArray()</span></code> returns <code class="docutils literal notranslate"><span class="pre">false</span></code> and the object has a
<code class="docutils literal notranslate"><span class="pre">length</span></code> property and <code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code>. If present, the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> will be
an instance of <code class="docutils literal notranslate"><span class="pre">collections.abc.Sequence</span></code>. This is the case for many
interfaces defined in the webidl such as
<a class="reference external" href="https://github.com/jsdom/jsdom/blob/main/lib/jsdom/living/nodes/NodeList.webidl">NodeList</a></dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_CALLABLE</span></code></dt><dd>Signals whether the <code class="docutils literal notranslate"><span class="pre">typeof</span></code> the JavaScript object is <code class="docutils literal notranslate"><span class="pre">&quot;function&quot;</span></code>. If
present, used to implement <code class="docutils literal notranslate"><span class="pre">__call__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_ERROR</span></code></dt><dd>Signals whether the JavaScript object is an <code class="docutils literal notranslate"><span class="pre">Error</span></code>. If so, the
<code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> it will subclass <code class="docutils literal notranslate"><span class="pre">Exception</span></code> so it can be raised.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_GENERATOR</span></code></dt><dd>Signals whether the JavaScript object is a generator. If so, the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>
will be an instance of <code class="docutils literal notranslate"><span class="pre">collections.abc.Generator</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code></dt><dd>Signals whether the JavaScript object has a <code class="docutils literal notranslate"><span class="pre">[Symbol.iterator]</span></code> method or
the <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code> flag is set. If so, we use it to implement
<code class="docutils literal notranslate"><span class="pre">__iter__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_ITERATOR</span></code></dt><dd>Signals whether the JavaScript object has a <code class="docutils literal notranslate"><span class="pre">next()</span></code> method and no
<code class="docutils literal notranslate"><span class="pre">[Symbol.asyncIterator]</span></code> method. If so, we use it to implement
<code class="docutils literal notranslate"><span class="pre">__next__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>. (If there is a <code class="docutils literal notranslate"><span class="pre">[Symbol.asyncIterator]</span></code>
method, we assume that the <code class="docutils literal notranslate"><span class="pre">next()</span></code> method should be used to implement
<code class="docutils literal notranslate"><span class="pre">__anext__</span></code>.)</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code></dt><dd>This is set on a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> by the <code class="docutils literal notranslate"><span class="pre">as_py_json()</span></code> method if it is not an
<code class="docutils literal notranslate"><span class="pre">Array</span></code>. When this is set, <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> on the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> will turn
into attribute access on the JavaScript object. Also, the return values from
iterating over the proxy or indexing it will also have <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code>
or <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_SEQUENCE</span></code> set as appropriate.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_SEQUENCE</span></code></dt><dd>This is set on a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> by the <code class="docutils literal notranslate"><span class="pre">as_py_json()</span></code> method if it is an
<code class="docutils literal notranslate"><span class="pre">Array</span></code>. When this is set, when indexing or iterating the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>
we’ll call <code class="docutils literal notranslate"><span class="pre">as_py_json()</span></code> on the result.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_MAPPING</span></code></dt><dd>We set this if the flags <code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code>, <code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code>, and <code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code>
are set, or if <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code> is set. In this case, the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>
will be an instance of <code class="docutils literal notranslate"><span class="pre">collections.abc.Mapping</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_MAPPING</span></code></dt><dd>We set this if the flags <code class="docutils literal notranslate"><span class="pre">IS_MAPPING</span></code> and <code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code> are set or if
<code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code> is set. In this case, the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> will be an
instance of <code class="docutils literal notranslate"><span class="pre">collections.abc.MutableMapping</span></code>.</dd>
</dl>
<section id="creating-a-jsproxy">
<h4><a class="toc-backref" href="#creating-a-jsproxy" role="doc-backlink">Creating a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code></a></h4>
<p>To create a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> from a JavaScript object and a value <code class="docutils literal notranslate"><span class="pre">jsthis</span></code> we do the
following steps:</p>
<ol class="arabic simple">
<li>calculate the appropriate type flags for the JavaScript object</li>
<li>get or create and cache an appropriate <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> class with the mixins
appropriate for the set  of type flags that are set</li>
<li>instantiate the class with a reference to the JavaScript object and the
<code class="docutils literal notranslate"><span class="pre">jsthis</span></code> value.</li>
</ol>
<p>The value <code class="docutils literal notranslate"><span class="pre">jsthis</span></code> is used to determine the value of <code class="docutils literal notranslate"><span class="pre">this</span></code> when calling a
function. If <code class="docutils literal notranslate"><span class="pre">jsobj</span></code> is not callable, is has no effect.</p>
<p>Here is pseudocode for the functions <code class="docutils literal notranslate"><span class="pre">create_jsproxy</span></code> and
<code class="docutils literal notranslate"><span class="pre">create_jsproxy_with_flags</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_jsproxy</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">jsthis</span><span class="o">=</span><span class="n">Js_undefined</span><span class="p">):</span>
    <span class="c1"># For the definition of ``compute_type_flags``, see &quot;Determining which flags to set&quot;.</span>
    <span class="k">return</span> <span class="n">create_jsproxy_with_flags</span><span class="p">(</span><span class="n">compute_type_flags</span><span class="p">(</span><span class="n">jsobj</span><span class="p">),</span> <span class="n">jsobj</span><span class="p">,</span> <span class="n">jsthis</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_jsproxy_with_flags</span><span class="p">(</span><span class="n">type_flags</span><span class="p">,</span> <span class="n">jsobj</span><span class="p">,</span> <span class="n">jsthis</span><span class="p">):</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">get_jsproxy_class</span><span class="p">(</span><span class="n">type_flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">jsthis</span><span class="p">)</span>
</pre></div>
</div>
<p>The most important logic is for creating the classes, which works approximately
as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_jsproxy_class</span><span class="p">(</span><span class="n">type_flags</span><span class="p">):</span>
    <span class="n">flag_mixin_pairs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">HAS_GET</span><span class="p">,</span> <span class="n">JSProxyHasGetMixin</span><span class="p">),</span>
        <span class="p">(</span><span class="n">HAS_HAS</span><span class="p">,</span> <span class="n">JSProxyHasHasMixin</span><span class="p">),</span>
        <span class="c1"># ...</span>
        <span class="p">(</span><span class="n">IS_PY_JSON_DICT</span><span class="p">,</span> <span class="n">JSPyJsonDictMixin</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">bases</span> <span class="o">=</span> <span class="p">[</span><span class="n">mixin</span> <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">mixin</span> <span class="ow">in</span> <span class="n">flag_mixin_pairs</span> <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="n">type_flags</span><span class="p">]</span>
    <span class="n">bases</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">type_flags</span> <span class="o">&amp;</span> <span class="n">IS_ERROR</span><span class="p">:</span>
        <span class="c1"># We want JSException to be pickleable so it needs a distinct name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;jstypes.ffi.JSException&quot;</span>
        <span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;jstypes.ffi.JSProxy&quot;</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_js_type_flags&quot;</span><span class="p">:</span> <span class="n">type_flags</span><span class="p">}</span>
    <span class="c1"># Note: The actual way that we build the class does not result in the</span>
    <span class="c1"># mixins appearing as entries on the mro.</span>
    <span class="k">return</span> <span class="n">JSProxyMeta</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">JSProxyMeta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bases</span><span class="p">),</span> <span class="n">ns</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-jsproxy-metaclass">
<h4><a class="toc-backref" href="#the-jsproxy-metaclass" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> Metaclass</a></h4>
<p>This metaclass overrides subclass checks so that if one <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> class has a
superset of the flags of another <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> class, we report it as a subclass.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">_JSProxyMetaClass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__instancecheck__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__subclasscheck__</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__subclasscheck__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">subcls</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__subclasscheck__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">subcls</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subclass</span><span class="p">,</span> <span class="s2">&quot;_js_type_flags&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">subcls_flags</span> <span class="o">=</span> <span class="n">subcls</span><span class="o">.</span><span class="n">_js_type_flags</span>
        <span class="c1"># Check whether the flags on subcls are a subset of the flags on cls</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_js_type_flags</span> <span class="o">&amp;</span> <span class="n">subcls_flags</span> <span class="o">==</span> <span class="n">subcls_flags</span>
</pre></div>
</div>
</section>
<section id="the-jsproxy-base-class">
<h4><a class="toc-backref" href="#the-jsproxy-base-class" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> Base Class</a></h4>
<p>The most complicated part of the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> base class is the implementation of
<code class="docutils literal notranslate"><span class="pre">__getattribute__</span></code>, <code class="docutils literal notranslate"><span class="pre">__setattr__</span></code>, and <code class="docutils literal notranslate"><span class="pre">__delattr__</span></code>. For
<code class="docutils literal notranslate"><span class="pre">__getattribute__</span></code>, we first check if an attribute is defined on the Python
object itself by calling <code class="docutils literal notranslate"><span class="pre">object.__getattribute__()</span></code>. Otherwise, we look up
the attribute on the JavaScript object.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">__setattr__</span></code> and <code class="docutils literal notranslate"><span class="pre">__delattr__</span></code>, we set the keys “__loader__”,
“__name__”, “__package__”, “__path__”, and “__spec__” on the Python object
itself. All other values are set/deleted on the underlying JavaScript object.
This is to allow JavaScript objects to serve as Python modules without modifying
them.</p>
<p>As an odd special case, if the object is an <code class="docutils literal notranslate"><span class="pre">Array</span></code>, we filter out the
<code class="docutils literal notranslate"><span class="pre">keys</span></code> method. We also remove it from the results of <code class="docutils literal notranslate"><span class="pre">dir()</span></code>. This is to
ensure that <code class="docutils literal notranslate"><span class="pre">dict.update()</span></code> behaves correctly when passed a JavaScript
<code class="docutils literal notranslate"><span class="pre">Array</span></code>. We want the following behavior:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;[[&#39;a&#39;, &#39;b&#39;], [1, 2]]&quot;</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">d</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="c1"># The result if we didn&#39;t filter out Array.keys would be as follows:</span>
<span class="k">assert</span> <span class="n">d</span> <span class="o">!=</span> <span class="p">{</span><span class="mi">1</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
</pre></div>
</div>
<p>A possible alternative would be to teach add special case handling for
JavaScript arrays to <code class="docutils literal notranslate"><span class="pre">dict.update()</span></code>.</p>
<p>It is common for JavaScript objects to have important methods that are named the
same thing as a Python keyword (for example, <code class="docutils literal notranslate"><span class="pre">Array.from</span></code>,
<code class="docutils literal notranslate"><span class="pre">Promise.then</span></code>). We access these from Python using the valid identifiers
<code class="docutils literal notranslate"><span class="pre">from_</span></code> and <code class="docutils literal notranslate"><span class="pre">then_</span></code>. If we want to access a JavaScript property called
<code class="docutils literal notranslate"><span class="pre">then_</span></code> we access it from <code class="docutils literal notranslate"><span class="pre">then__</span></code> and so on. So if the attribute is a
Python keyword followed by one or more underscores, we remove one
underscore from the end.   The following helper function is used for this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">normalize_python_keywords</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keyword</span><span class="o">.</span><span class="n">iskeyword</span><span class="p">(</span><span class="n">stripped</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attr</span>
    <span class="k">if</span> <span class="n">stripped</span> <span class="o">!=</span> <span class="n">attr</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">attr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">attr</span>
</pre></div>
</div>
<p>We need the following JavaScript function to implement <code class="docutils literal notranslate"><span class="pre">__bool__</span></code>. In
JavaScript, empty containers are truthy but in Python they should be falsey, so
we detect empty containers and return <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">js_bool</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// if it&#39;s a falsey JS object, return false</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// We also want to return false on container types with size 0.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Return true for HTML elements even if they have a size of zero.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">HTMLElement</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// A function with zero arguments has a length property equal to</span>
<span class="w">    </span><span class="c1">// zero. Make sure we return true for this.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// An empty buffer</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">byteLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The following helper function is used to implement <code class="docutils literal notranslate"><span class="pre">__dir__</span></code>. It walks the
prototype chain and accumulates all keys, filtering out keys that start with
numbers (not valid Python identifiers) and reversing the
<code class="docutils literal notranslate"><span class="pre">normalize_python_keywords</span></code> transform. We also filter out the
<code class="docutils literal notranslate"><span class="pre">Array.keys</span></code> method.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">js_dir</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsobj</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">);</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">keys</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="nx">jsobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">)));</span>
<span class="w">    </span><span class="c1">// Filter out numbers</span>
<span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">48</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">57</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Filter out &quot;keys&quot; key from an array</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;keys&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// If the key is a keyword followed by 0 or more underscores,</span>
<span class="w">    </span><span class="c1">// add an extra underscore to reverse the transformation applied by</span>
<span class="w">    </span><span class="c1">// normalize_python_keywords().</span>
<span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">word</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">        </span><span class="nx">iskeyword</span><span class="p">(</span><span class="nx">word</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_*$/</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">word</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">word</span><span class="p">,</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSProxy</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;keys&quot;</span> <span class="ow">and</span> <span class="n">Array</span><span class="o">.</span><span class="n">isArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="n">attr</span> <span class="o">=</span> <span class="n">normalize_python_keywords</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">js_getattr</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, attr) =&gt; jsobj[attr]</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_hasattr</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, attr) =&gt; attr in jsobj</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">js_getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isjsfunction</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">js_hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;__loader__&quot;</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;__package__&quot;</span><span class="p">,</span> <span class="s2">&quot;__path__&quot;</span><span class="p">,</span> <span class="s2">&quot;__spec__&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">normalize_python_keywords</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">js_setattr</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, attr) =&gt; {</span>
<span class="sd">                jsobj[attr] = value;</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;__loader__&quot;</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;__package__&quot;</span><span class="p">,</span> <span class="s2">&quot;__path__&quot;</span><span class="p">,</span> <span class="s2">&quot;__spec__&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">normalize_python_keywords</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">js_delattr</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, attr) =&gt; {</span>
<span class="sd">                delete jsobj[attr];</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">js_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">js_eq</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;(x, y) =&gt; x === y&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">js_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">js_neq</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;(x, y) =&gt; x !== y&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">js_neq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">js_repr</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;x =&gt; x.toString()&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">js_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">js_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">js_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This returns an integer with the property that jsproxy1 == jsproxy2</span>
<span class="sd">        if and only if jsproxy1.js_id == jsproxy2.js_id. There is no way to</span>
<span class="sd">        express the implementation in pseudocode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_py_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is actually a mixin method. We leave it out if any of the flags</span>
<span class="sd">        IS_CALLABLE, IS_DOUBLE_PROXY, IS_ERROR, or IS_ITERATOR</span>
<span class="sd">        is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_js_type_flags</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IS_ARRAY</span> <span class="o">|</span> <span class="n">IS_ARRAY_LIKE</span><span class="p">)):</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_PY_JSON_SEQUENCE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_PY_JSON_DICT</span>
        <span class="k">return</span> <span class="n">create_jsproxy_with_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsthis</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">depth</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">default_converter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See section on deep conversions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">object_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">js_object_entries</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;x =&gt; Object.entries(x)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">js_object_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">object_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">js_object_keys</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;x =&gt; Object.keys(x)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">js_object_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">object_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">js_object_values</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;x =&gt; Object.values(x)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">js_object_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_weakref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">js_weakref</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;x =&gt; new WeakRef(x)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">js_weakref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>We need the following function which calls the <code class="docutils literal notranslate"><span class="pre">as_py_json()</span></code> method on
<code class="docutils literal notranslate"><span class="pre">value</span></code> if it is present:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">maybe_as_py_json</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">as_py_json</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">as_py_json</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</section>
<section id="determining-which-flags-to-set">
<h4><a class="toc-backref" href="#determining-which-flags-to-set" role="doc-backlink">Determining Which Flags to Set</a></h4>
<p>We need the helper function <code class="docutils literal notranslate"><span class="pre">getTypeTag</span></code>:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">getTypeTag</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Catch and ignore errors</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We use the following function to determine which flags to set:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">compute_type_flags</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">is_py_json</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">type_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">typeTag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getTypeTag</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasLength</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nx">isArray</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">hasProperty</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;length&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">obj</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;function&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nx">SET_FLAG_IF_HAS_METHOD</span><span class="p">(</span><span class="nx">HAS_GET</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;get&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF_HAS_METHOD</span><span class="p">(</span><span class="nx">HAS_SET</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;set&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF_HAS_METHOD</span><span class="p">(</span><span class="nx">HAS_HAS</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;has&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF_HAS_METHOD</span><span class="p">(</span><span class="nx">HAS_INCLUDES</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;includes&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span>
<span class="w">        </span><span class="nx">HAS_LENGTH</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasProperty</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;size&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">hasLength</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF_HAS_METHOD</span><span class="p">(</span><span class="nx">HAS_DISPOSE</span><span class="p">,</span><span class="w"> </span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">dispose</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span><span class="nx">IS_CALLABLE</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">obj</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;function&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span><span class="nx">IS_ARRAY</span><span class="p">,</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span>
<span class="w">        </span><span class="nx">IS_ARRAY_LIKE</span><span class="p">,</span>
<span class="w">        </span><span class="o">!</span><span class="nx">isArray</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">hasLength</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">type_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_ITERABLE</span><span class="p">));</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span><span class="nx">IS_DOUBLE_PROXY</span><span class="p">,</span><span class="w"> </span><span class="nx">isPyProxy</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span><span class="nx">IS_GENERATOR</span><span class="p">,</span><span class="w"> </span><span class="nx">typeTag</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;[object Generator]&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF_HAS_METHOD</span><span class="p">(</span><span class="nx">IS_ITERABLE</span><span class="p">,</span><span class="w"> </span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span>
<span class="w">        </span><span class="nx">IS_ERROR</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasProperty</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">hasProperty</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;message&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">(</span><span class="nx">hasProperty</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;stack&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">constructorName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;DOMException&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="o">!</span><span class="p">(</span><span class="nx">type_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_CALLABLE</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">is_py_json</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">type_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">IS_ARRAY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_ARRAY_LIKE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="nx">IS_PY_JSON_SEQUENCE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">is_py_json</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="o">!</span><span class="p">(</span><span class="nx">type_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">IS_DOUBLE_PROXY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_ITERATOR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_CALLABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_ERROR</span><span class="p">))</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="nx">IS_PY_JSON_DICT</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mapping_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">HAS_GET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">HAS_LENGTH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_ITERABLE</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mutable_mapping_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mapping_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">HAS_SET</span><span class="p">;</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span><span class="nx">IS_MAPPING</span><span class="p">,</span><span class="w"> </span><span class="nx">type_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">mapping_flags</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">mapping_flags</span><span class="p">));</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span>
<span class="w">        </span><span class="nx">IS_MUTABLE_MAPPING</span><span class="p">,</span>
<span class="w">        </span><span class="nx">type_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">mutable_mapping_flags</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">mutable_mapping_flags</span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span><span class="nx">IS_MAPPING</span><span class="p">,</span><span class="w"> </span><span class="nx">type_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_PY_JSON_DICT</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SET_FLAG_IF</span><span class="p">(</span><span class="nx">IS_MUTABLE_MAPPING</span><span class="p">,</span><span class="w"> </span><span class="nx">type_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_PY_JSON_DICT</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">type_flags</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-has-get-mixin">
<h4><a class="toc-backref" href="#the-has-get-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code> Mixin</a></h4>
<p>If a JavaScript <code class="docutils literal notranslate"><span class="pre">get()</span></code> method is present, we define <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> as
follows. If a <code class="docutils literal notranslate"><span class="pre">has()</span></code> method is also present, we’ll use it to decide whether
an <code class="docutils literal notranslate"><span class="pre">undefined</span></code> return value should be treated as a key error or as <code class="docutils literal notranslate"><span class="pre">None</span></code>.
If no <code class="docutils literal notranslate"><span class="pre">has()</span></code> method is present, <code class="docutils literal notranslate"><span class="pre">undefined</span></code> is treated as <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">js_get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsobj</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasMethod</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;has&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">obj</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PythonKeyError</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSProxyHasGetMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">js_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_js_type_flags</span> <span class="o">&amp;</span> <span class="n">IS_PY_JSON_DICT</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">maybe_as_py_json</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="the-has-set-mixin">
<h4><a class="toc-backref" href="#the-has-set-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code> Mixin</a></h4>
<p>If a <code class="docutils literal notranslate"><span class="pre">set()</span></code> method is present, we assume a <code class="docutils literal notranslate"><span class="pre">delete()</span></code> method is also
present and define <code class="docutils literal notranslate"><span class="pre">__setitem__</span></code> and <code class="docutils literal notranslate"><span class="pre">__delitem__</span></code> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSProxyHasSetMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">js_set</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, item, value) =&gt; {</span>
<span class="sd">                jsobj.set(item, value);</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">js_delete</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, item) =&gt; {</span>
<span class="sd">                jsobj.delete(item);</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-has-has-mixin">
<h4><a class="toc-backref" href="#the-has-has-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_HAS</span></code> Mixin</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSProxyHasHasMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">js_has</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, item) =&gt; jsobj.has(item);</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">js_has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-has-includes-mixin">
<h4><a class="toc-backref" href="#the-has-includes-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_INCLUDES</span></code> Mixin</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSProxyHasIncludesMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">js_includes</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, item) =&gt; jsobj.includes(item);</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">js_includes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-has-length-mixin">
<h4><a class="toc-backref" href="#the-has-length-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code> Mixin</a></h4>
<p>We prefer to use the <code class="docutils literal notranslate"><span class="pre">size</span></code> attribute if present and a number and if not fall
back to returning the <code class="docutils literal notranslate"><span class="pre">length</span></code>. If a JavaScript error is raised when looking
up either field, we allow it to propagate into Python as a
<code class="docutils literal notranslate"><span class="pre">JavaScriptException</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSProxyHasLengthMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">js_len</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj) =&gt; {</span>
<span class="sd">                const size = val.size;</span>
<span class="sd">                if (typeof size === &quot;number&quot;) {</span>
<span class="sd">                    return size;</span>
<span class="sd">                }</span>
<span class="sd">                return val.length</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">js_len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;object does not have a valid length&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;length of object is negative&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="the-has-dispose-mixin">
<h4><a class="toc-backref" href="#the-has-dispose-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_DISPOSE</span></code> Mixin</a></h4>
<p>This makes the <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> into a context manager where <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> is a no-op
and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> calls the <code class="docutils literal notranslate"><span class="pre">[Symbol.dispose]()</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSProxyContextManagerMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">js_symbol_dispose</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj) =&gt; jsobj[Symbol.dispose]()</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_symbol_dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-is-array-mixin">
<h4><a class="toc-backref" href="#the-is-array-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_ARRAY</span></code> Mixin</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">js_array_slice</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="p">,</span><span class="w"> </span><span class="nx">step</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">step</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">obj</span><span class="p">[</span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">step</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// we also use this for deletion by setting values to None</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">js_array_slice_assign</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">slicelength</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="p">,</span><span class="w"> </span><span class="nx">step</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">step</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">obj</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">slicelength</span><span class="p">,</span><span class="w"> </span><span class="p">...(</span><span class="nx">values</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="p">[]));</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">values</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">slicelength</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">obj</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">step</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">slicelength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">obj</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">step</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSArrayMixin</span><span class="p">(</span><span class="n">MutableSequence</span><span class="p">,</span> <span class="n">JSProxyHasLengthMixin</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected index to be an int or a slice&quot;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">js_array_get</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, index) =&gt; jsobj[index]</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="n">length</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">js_array_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_js_type_flags</span> <span class="o">&amp;</span> <span class="n">IS_PY_JSON_SEQUENCE</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">maybe_as_py_json</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span>
        <span class="n">slicelength</span> <span class="o">=</span> <span class="n">PySlice_AdjustIndices</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slicelength</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">_PyJsvArray_New</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">js_array_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slicelength</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_js_type_flags</span> <span class="o">&amp;</span> <span class="n">IS_PY_JSON_SEQUENCE</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">as_py_json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected index to be an int or a slice&quot;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">js_array_set</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, index, value) =&gt; { jsobj[index] = value; }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="n">length</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">js_array_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;must assign iterable to extended slice&quot;</span><span class="p">)</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span>
        <span class="n">slicelength</span> <span class="o">=</span> <span class="n">PySlice_AdjustIndices</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">!=</span> <span class="n">slicelength</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;attempted to assign sequence of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span><span class="si">}</span><span class="s2"> to&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;extended slice of length </span><span class="si">{</span><span class="n">slicelength</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">slicelength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">js_array_slice_assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slicelength</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected index to be an int or a slice&quot;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">js_array_delete</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, index) =&gt; { jsobj.splice(index, 1); }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="n">length</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">js_array_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span>
        <span class="n">slicelength</span> <span class="o">=</span> <span class="n">PySlice_AdjustIndices</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">slicelength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">js_array_slice_assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slicelength</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected an integer&quot;</span><span class="p">)</span>
        <span class="n">js_insert</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsarr, pos, value) =&gt; { jsarr.splice(pos, value); }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-is-array-like-mixin">
<h4><a class="toc-backref" href="#the-is-array-like-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_ARRAY_LIKE</span></code> Mixin</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSArrayLikeMixin</span><span class="p">(</span><span class="n">MutableSequence</span><span class="p">,</span> <span class="n">JSProxyHasLengthMixin</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected index to be an int&quot;</span><span class="p">)</span>
        <span class="n">JSArrayMixin</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected index to be an int&quot;</span><span class="p">)</span>
        <span class="n">JSArrayMixin</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected index to be an int&quot;</span><span class="p">)</span>
        <span class="n">JSArrayMixin</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-is-callable-mixin">
<h4><a class="toc-backref" href="#the-is-callable-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_CALLABLE</span></code> Mixin</a></h4>
<p>We already gave more accurate C code for calling a <code class="docutils literal notranslate"><span class="pre">JSCallable</span></code>. See in
particular the definition of <code class="docutils literal notranslate"><span class="pre">JSMethod_ConvertArgs()</span></code> given there.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSCallableMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new jsproxy bound to jsthis with the same JS object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">create_jsproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jsthis</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;See the description of JSMethod_Vectorcall&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">pyproxies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">jsargs</span> <span class="o">=</span> <span class="n">JSMethod_ConvertArgs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">pyproxies</span><span class="p">)</span>

        <span class="n">do_construct</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsfunc, jsargs) =&gt;</span>
<span class="sd">                Reflect.construct(jsfunc, jsargs)</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">do_construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jsargs</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;This borrowed proxy was automatically destroyed &quot;</span>
            <span class="s2">&quot;at the end of a function call.&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">px</span> <span class="ow">in</span> <span class="n">pyproxies</span><span class="p">:</span>
            <span class="n">px</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="the-is-error-mixin">
<h4><a class="toc-backref" href="#the-is-error-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_ERROR</span></code> Mixin</a></h4>
<p>In this case, we inherit from both <code class="docutils literal notranslate"><span class="pre">Exception</span></code> and <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>. We also make
sure that the resulting class is pickleable.</p>
</section>
<section id="the-is-iterable-mixin">
<h4><a class="toc-backref" href="#the-is-iterable-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code> Mixin</a></h4>
<p>If the iterable has the <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code> flag set, we iterate over the object
keys. Otherwise, call <code class="docutils literal notranslate"><span class="pre">obj[Symbol.iterator]()</span></code>. If either
<code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_SEQUENCE</span></code> or <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code>, we call <code class="docutils literal notranslate"><span class="pre">maybe_as_py_json</span></code> on
the iteration results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">wrap_with_maybe_as_py_json</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">val</span> <span class="o">:=</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">maybe_as_py_json</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">maybe_as_py_json</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">JSIterableMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pyjson</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_js_type_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IS_PY_JSON_SEQUENCE</span> <span class="o">|</span> <span class="n">IS_PY_JSON_DICT</span><span class="p">)</span>
        <span class="n">pyjson_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_js_type_flags</span> <span class="o">&amp;</span> <span class="n">IS_PY_JSON_DICT</span>
        <span class="n">js_get_iter</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (obj) =&gt; obj[Symbol.iterator]()</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">pyjson_dict</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">js_get_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pyjson</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">wrap_with_maybe_as_py_json</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="the-is-iterator-mixin">
<h4><a class="toc-backref" href="#the-is-iterator-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_ITERATOR</span></code> Mixin</a></h4>
<p>The JavaScript <code class="docutils literal notranslate"><span class="pre">next</span></code> method returns an <code class="docutils literal notranslate"><span class="pre">IteratorResult</span></code> which has a
<code class="docutils literal notranslate"><span class="pre">done</span></code> field and a <code class="docutils literal notranslate"><span class="pre">value</span></code> field. If <code class="docutils literal notranslate"><span class="pre">done</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code>, we have to raise
a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception to convert to the Python iterator protocol.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSIteratorMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="n">js_next</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (obj, arg) =&gt; obj.next(arg)</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">it_result</span> <span class="o">=</span> <span class="n">js_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">it_result</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">it_result</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-is-generator-mixin">
<h4><a class="toc-backref" href="#the-is-generator-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_GENERATOR</span></code> Mixin</a></h4>
<p>Python generators have a <code class="docutils literal notranslate"><span class="pre">close()</span></code> method which takes no arguments instead of
a <code class="docutils literal notranslate"><span class="pre">return()</span></code> method. We also have to translate <code class="docutils literal notranslate"><span class="pre">gen.throw(GeneratorExit)</span></code>
into <code class="docutils literal notranslate"><span class="pre">jsgen.return_()</span></code>. It is possible to call <code class="docutils literal notranslate"><span class="pre">jsgen.return_(val)</span></code> directly
if there is a need to return a specific value.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSGeneratorMixin</span><span class="p">(</span><span class="n">JSIteratorMixin</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">throw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">GeneratorExit</span><span class="p">):</span>
            <span class="n">js_throw</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                (obj, exc) =&gt; obj.return()</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">js_throw</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                (obj, exc) =&gt; obj.throw(exc)</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="n">it_result</span> <span class="o">=</span> <span class="n">js_throw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="c1"># if the error wasn&#39;t caught it will get raised back out.</span>
        <span class="c1"># now handle the case where the error got caught.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">it_result</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_js_type_flags</span> <span class="o">&amp;</span> <span class="n">IS_PY_JSON_SEQUENCE</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">maybe_as_py_json</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">it_result</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throw</span><span class="p">(</span><span class="ne">GeneratorExit</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-is-mapping-mixin">
<h4><a class="toc-backref" href="#the-is-mapping-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_MAPPING</span></code> Mixin</a></h4>
<p>If the <code class="docutils literal notranslate"><span class="pre">IS_MAPPING</span></code> flag is set, we implement all of the <code class="docutils literal notranslate"><span class="pre">Mapping</span></code> methods.
We only set this flag when there are enough other flags set that the abstract
<code class="docutils literal notranslate"><span class="pre">Mapping</span></code> methods are defined. We use the default implementations for all the
mixin methods.</p>
</section>
<section id="the-is-mutable-mapping-mixin">
<h4><a class="toc-backref" href="#the-is-mutable-mapping-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_MAPPING</span></code> Mixin</a></h4>
<p>If the <code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_MAPPING</span></code> flag is set, we implement all of the
<code class="docutils literal notranslate"><span class="pre">MutableMapping</span></code> methods. We only set this flag when there are enough other
flags set that the abstract <code class="docutils literal notranslate"><span class="pre">MutableMapping</span></code> methods are defined. We use the
default implementations for all the mixin methods.</p>
</section>
<section id="the-is-py-json-sequence-mixin">
<h4><a class="toc-backref" href="#the-is-py-json-sequence-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_SEQUENCE</span></code> Mixin</a></h4>
<p>This flag only ever appears with <code class="docutils literal notranslate"><span class="pre">IS_ARRAY</span></code>. It changes the behavior of
<code class="docutils literal notranslate"><span class="pre">JSArray.__getitem__</span></code> to apply <code class="docutils literal notranslate"><span class="pre">maybe_as_py_json()</span></code> to the result.</p>
</section>
<section id="the-is-py-json-dict-mixin">
<h4><a class="toc-backref" href="#the-is-py-json-dict-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code> Mixin</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JSPyJsonDictMixin</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">js_get</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, key) =&gt; jsobj[key]</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">js_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">maybe_as_py_json</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;only keys of type string are supported&quot;</span><span class="p">)</span>
        <span class="n">js_set</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, key, value) =&gt; {</span>
<span class="sd">                jsobj[key] = value;</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;only keys of type string are supported&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">js_delete</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, key) =&gt; {</span>
<span class="sd">                delete jsobj[key];</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">js_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">js_contains</span> <span class="o">=</span> <span class="n">run_js</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            (jsobj, key) =&gt; key in jsobj</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">js_contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># defined by IS_ITERABLE mixin, see implementation there.</span>
</pre></div>
</div>
</section>
<section id="the-is-double-proxy-mixin">
<h4><a class="toc-backref" href="#the-is-double-proxy-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_DOUBLE_PROXY</span></code> Mixin</a></h4>
<p>In this case the object is a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> of a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>. We add an extra
<code class="docutils literal notranslate"><span class="pre">unwrap()</span></code> method that returns the inner Python object.</p>
</section>
</section>
<section id="pyproxy">
<h3><a class="toc-backref" href="#pyproxy" role="doc-backlink">PyProxy</a></h3>
<p>We define 12 mixins that a Python object may support that affect the type of the
PyProxy we make from it.</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code></dt><dd>We set this flag if the Python object has a <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method. If
present, we use it to implement a <code class="docutils literal notranslate"><span class="pre">get()</span></code> method on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code></dt><dd>We set this flag if the Python object has a <code class="docutils literal notranslate"><span class="pre">__setitem__</span></code> method. If
present, we use it to implement a <code class="docutils literal notranslate"><span class="pre">set()</span></code> method on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HAS_CONTAINS</span></code></dt><dd>We set this flag if the Python object has a <code class="docutils literal notranslate"><span class="pre">__contains__</span></code> method. If
present, we use it to implement a <code class="docutils literal notranslate"><span class="pre">has()</span></code> method on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code></dt><dd>We set this flag if the Python object has a <code class="docutils literal notranslate"><span class="pre">__len__</span></code> method. If present,
we use it to implement a <code class="docutils literal notranslate"><span class="pre">length</span></code> getter on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_CALLABLE</span></code></dt><dd>We set this flag if the Python object has a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method. If present,
we make the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> callable.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_DICT</span></code></dt><dd>We set this flag if the Python object is of exact type <code class="docutils literal notranslate"><span class="pre">dict</span></code>. If present,
we will make property <code class="docutils literal notranslate"><span class="pre">pyproxy.some_property</span></code> fall back to
<code class="docutils literal notranslate"><span class="pre">pyobj.__getitem__(&quot;some_property&quot;)</span></code> if <code class="docutils literal notranslate"><span class="pre">getattr(pyobj,</span> <span class="pre">&quot;some_property&quot;)</span></code>
raises an <code class="docutils literal notranslate"><span class="pre">AttributeError</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_GENERATOR</span></code></dt><dd>We set this flag if the Python object is an instance of
<code class="docutils literal notranslate"><span class="pre">collections.abc.Generator</span></code>. If present, we make the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> implement
the methods of a JavaScript generator.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code></dt><dd>We set this flag if the Python object has a <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> method. If present,
we use it to implement a <code class="docutils literal notranslate"><span class="pre">[Symbol.iterator]</span></code> method on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_ITERATOR</span></code></dt><dd>We set this flag if the Python object has a <code class="docutils literal notranslate"><span class="pre">__next__</span></code> method. If present,
we use it to implement a <code class="docutils literal notranslate"><span class="pre">next()</span></code> method on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_SEQUENCE</span></code></dt><dd>We set this flag if the Python object is an instance of
<code class="docutils literal notranslate"><span class="pre">collections.abc.Sequence</span></code>. If it is present, we use it to implement all
of the <code class="docutils literal notranslate"><span class="pre">Array.prototype</span></code> methods that don’t mutate on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_SEQUENCE</span></code></dt><dd>We set this flag if the Python object is an instance of
<code class="docutils literal notranslate"><span class="pre">collections.abc.MutableSequence</span></code>. If it is present, we use it to implement
all <code class="docutils literal notranslate"><span class="pre">Array.prototype</span></code> methods on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_DICT</span></code></dt><dd>We set this flag when the <code class="docutils literal notranslate"><span class="pre">asJsJson()</span></code> method is used on a dictionary. If
this flag is set, property access on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> will _only_ look at
values from <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and not at attributes on the Python object. We
also will call <code class="docutils literal notranslate"><span class="pre">asJsJson()</span></code> on the result of indexing or iterating
the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_SEQUENCE</span></code></dt><dd>We set this flag when the <code class="docutils literal notranslate"><span class="pre">asJsJson()</span></code> is used on a <code class="docutils literal notranslate"><span class="pre">Sequence</span></code>. If this
flag is set, we will call <code class="docutils literal notranslate"><span class="pre">asJsJson()</span></code> on the result of indexing or
iterating the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</dd>
</dl>
<p>A <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> is made up of a mixture of a JavaScript class and a collection of
ES6 <code class="docutils literal notranslate"><span class="pre">Proxy</span></code> handlers. Depending on which flags are present, we construct our
class out of an appropriate collection of mixins and an appropriate choice of
handlers.</p>
<p>When a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> is created, we increment the reference count of the wrapped
Python object. When a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> is destroyed, we decrement the reference count
and mark it as destroyed. As a result, if we attempt to do anything with the
<code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>, we will call <code class="docutils literal notranslate"><span class="pre">_Py_js2python()</span></code> on it and an error will be thrown.</p>
<section id="creating-a-pyproxy">
<h4><a class="toc-backref" href="#creating-a-pyproxy" role="doc-backlink">Creating a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code></a></h4>
<p>Given a collection of type flags, we use the following function to generate the
<code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> class:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">pyproxyClassMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getPyProxyClass</span><span class="p">(</span><span class="nx">flags</span><span class="o">:</span><span class="w"> </span><span class="nx">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pyproxyClassMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">descriptors</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">FLAG_MIXIN_PAIRS</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">number</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="p">][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">[</span><span class="nx">HAS_CONTAINS</span><span class="p">,</span><span class="w"> </span><span class="nx">PyContainsMixin</span><span class="p">],</span>
<span class="w">        </span><span class="c1">// ... other flag mixin pairs</span>
<span class="w">        </span><span class="p">[</span><span class="nx">IS_MUTABLE_SEQUENCE</span><span class="p">,</span><span class="w"> </span><span class="nx">PyMutableSequenceMixin</span><span class="p">],</span>
<span class="w">    </span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="p">[</span><span class="nx">feature_flag</span><span class="p">,</span><span class="w"> </span><span class="nx">methods</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">FLAG_MIXIN_PAIRS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">feature_flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span>
<span class="w">                </span><span class="nx">descriptors</span><span class="p">,</span>
<span class="w">                </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptors</span><span class="p">(</span><span class="nx">methods</span><span class="p">.</span><span class="nx">prototype</span><span class="p">),</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Use base constructor (just throws an error if construction is attempted).</span>
<span class="w">    </span><span class="nx">descriptors</span><span class="p">.</span><span class="kr">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span>
<span class="w">        </span><span class="nx">PyProxyProto</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;constructor&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// $$flags static field</span>
<span class="w">    </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span>
<span class="w">        </span><span class="nx">descriptors</span><span class="p">,</span>
<span class="w">        </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptors</span><span class="p">({</span><span class="w"> </span><span class="nx">$$flags</span><span class="o">:</span><span class="w"> </span><span class="nx">flags</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// We either inherit PyProxyFunction as the base class if we&#39;re callable or</span>
<span class="w">    </span><span class="c1">// from PyProxy if we&#39;re not.</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">superProto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_CALLABLE</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">PyProxyFunctionProto</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxyProto</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subProto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">superProto</span><span class="p">,</span><span class="w"> </span><span class="nx">descriptors</span><span class="p">);</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">NewPyProxyClass</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="nx">NewPyProxyClass</span><span class="p">.</span><span class="nx">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">subProto</span><span class="p">;</span>
<span class="w">    </span><span class="nx">pyproxyClassMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">flags</span><span class="p">,</span><span class="w"> </span><span class="nx">NewPyProxyClass</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NewPyProxyClass</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To create a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> we also need to be able to get the appropriate handlers:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">getPyProxyHandlers</span><span class="p">(</span><span class="nx">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_JS_JSON_DICT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_DICT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyDictHandlers</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_SEQUENCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxySequenceHandlers</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We use the following function to create the target object for the ES6 proxy:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">createTarget</span><span class="p">(</span><span class="nx">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pyproxyClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPyProxyClass</span><span class="p">(</span><span class="nx">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">IS_CALLABLE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">cls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// In this case we are effectively subclassing Function in order to ensure</span>
<span class="w">    </span><span class="c1">// that the proxy is callable. With a Content Security Protocol that doesn&#39;t</span>
<span class="w">    </span><span class="c1">// allow unsafe-eval, we can&#39;t invoke the Function constructor directly. So</span>
<span class="w">    </span><span class="c1">// instead we create a function in the universally allowed way and then use</span>
<span class="w">    </span><span class="c1">// `setPrototypeOf`. The documentation for `setPrototypeOf` says to use</span>
<span class="w">    </span><span class="c1">// `Object.create` or `Reflect.construct` instead for performance reasons</span>
<span class="w">    </span><span class="c1">// but neither of those work here.</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="nb">Object</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">cls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Remove undesirable properties added by Function constructor. Note: we</span>
<span class="w">    </span><span class="c1">// can&#39;t remove &quot;arguments&quot; or &quot;caller&quot; because they are not configurable</span>
<span class="w">    </span><span class="c1">// and not writable</span>
<span class="w">    </span><span class="ow">delete</span><span class="w"> </span><span class="nx">target</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="ow">delete</span><span class="w"> </span><span class="nx">target</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// prototype isn&#39;t configurable so we can&#39;t delete it but it is writable.</span>
<span class="w">    </span><span class="nx">target</span><span class="p">.</span><span class="nx">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">target</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">createPyProxy</span></code> takes the following options:</p>
<dl class="simple">
<dt>flags</dt><dd>If this is passed, we use the passed flags rather than feature
detecting the object again.</dd>
<dt>props</dt><dd>Information that not shared with other PyProxies of the same lifetime.</dd>
<dt>shared</dt><dd>Data that is shared between all proxies with the same lifetime as this one.</dd>
<dt>gcRegister</dt><dd>Should we register this with the JavaScript garbage collector?</dd>
</dl>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pyproxyAttrsSymbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Symbol</span><span class="p">(</span><span class="s2">&quot;pyproxy.attrs&quot;</span><span class="p">);</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">createPyProxy</span><span class="p">(</span>
<span class="w">    </span><span class="nx">pyObjectPtr</span><span class="o">:</span><span class="w"> </span><span class="nx">number</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nx">flags</span><span class="p">,</span>
<span class="w">        </span><span class="nx">props</span><span class="p">,</span>
<span class="w">        </span><span class="nx">shared</span><span class="p">,</span>
<span class="w">        </span><span class="nx">gcRegister</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gcRegister</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// register by default</span>
<span class="w">        </span><span class="nx">gcRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// See the section &quot;Determining which flags to set&quot; for the definition of</span>
<span class="w">    </span><span class="c1">// get_pyproxy_flags</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonGetFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;get_pyproxy_flags&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">flags</span><span class="w"> </span><span class="o">??=</span><span class="w"> </span><span class="nx">pythonGetFlags</span><span class="p">(</span><span class="nx">pyObjectPtr</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createTarget</span><span class="p">(</span><span class="nx">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">handlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPyProxyHandlers</span><span class="p">(</span><span class="nx">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Proxy</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">handlers</span><span class="p">);</span>

<span class="w">    </span><span class="nx">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">isBound</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">captureThis</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">boundArgs</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">roundtrip</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">props</span><span class="p">,</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// If shared was passed the new PyProxy will have a shared lifetime</span>
<span class="w">    </span><span class="c1">// with some other PyProxy.</span>
<span class="w">    </span><span class="c1">// This happens in asJsJson(), bind(), and captureThis().</span>
<span class="w">    </span><span class="c1">// It specifically does not happen in copy()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">shared</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">shared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">pyObjectPtr</span><span class="p">,</span>
<span class="w">            </span><span class="nx">destroyed_msg</span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">            </span><span class="nx">gcRegistered</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="nx">_Py_IncRef</span><span class="p">(</span><span class="nx">pyObjectPtr</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gcRegister</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">gcRegisterPyProxy</span><span class="p">(</span><span class="nx">shared</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">target</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">shared</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">proxy</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-pyproxy-base-class">
<h4><a class="toc-backref" href="#the-pyproxy-base-class" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> Base Class</a></h4>
<p>The default handlers are as follows:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">filteredHasKey</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">filterProto</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">jsobj</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">jsobj</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nb">Function</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// If we are a PyProxy of a callable we have to subclass function so that if</span>
<span class="w">      </span><span class="c1">// someone feature detects callables with `instanceof Function` it works</span>
<span class="w">      </span><span class="c1">// correctly. But the callable might have attributes `name` and `length` and</span>
<span class="w">      </span><span class="c1">// we don&#39;t want to shadow them with the values from `Function.prototype`.</span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">&amp;&amp;=</span><span class="w"> </span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;length&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;caller&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;arguments&quot;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">jskey</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="c1">// we are required by JS law to return `true` for `&quot;prototype&quot; in pycallable`</span>
<span class="w">        </span><span class="c1">// but we are allowed to return the value of `getattr(pycallable, &quot;prototype&quot;)`.</span>
<span class="w">        </span><span class="c1">// So we filter prototype out of the &quot;get&quot; trap but not out of the &quot;has&quot; trap</span>
<span class="w">        </span><span class="p">(</span><span class="nx">filterProto</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;prototype&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isExtensible</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Must report &quot;prototype&quot; in proxy when we are callable.</span>
<span class="w">        </span><span class="c1">// (We can return the wrong value from &quot;get&quot; handler though.)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filteredHasKey</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// hasattr will crash if given a Symbol.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;symbol&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">jskey</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">jskey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jskey</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonHasAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;hasattr&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonHasAttr</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Preference order:</span>
<span class="w">        </span><span class="c1">// 1. stuff from JavaScript</span>
<span class="w">        </span><span class="c1">// 2. the result of Python getattr</span>
<span class="w">        </span><span class="c1">// pythonGetAttr will crash if given a Symbol.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;symbol&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">filteredHasKey</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Reflect</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">jskey</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">jskey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jskey</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// 2. The result of getattr</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonGetAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;getattr&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonGetAttr</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">set</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">descr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">descr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">descr</span><span class="p">.</span><span class="nx">writable</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">descr</span><span class="p">.</span><span class="nx">set</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// pythonSetAttr will crash if given a Symbol.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;symbol&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">filteredHasKey</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Reflect</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">jskey</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">jskey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jskey</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonSetAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;setattr&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">pythonSetAttr</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">descr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">descr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">descr</span><span class="p">.</span><span class="nx">configurable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Must return &quot;false&quot; if &quot;jskey&quot; is a nonconfigurable own property.</span>
<span class="w">            </span><span class="c1">// Strict mode JS will throw an error here saying that the property cannot</span>
<span class="w">            </span><span class="c1">// be deleted.</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;symbol&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">filteredHasKey</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Reflect</span><span class="p">.</span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">jskey</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">jskey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jskey</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonDelAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;delattr&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">pythonDelAttr</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pythonDir</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">).</span><span class="nx">toJs</span><span class="p">();</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nb">Reflect</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">apply</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nb">Function</span><span class="p">,</span><span class="w"> </span><span class="nx">jsthis</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jsobj</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">jsthis</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
<p>And the base class has the following methods:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nx">PyProxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;PyProxy is not a constructor&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">get</span><span class="w"> </span><span class="p">[</span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">toStringTag</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;PyProxy&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="p">[</span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">hasInstance</span><span class="p">](</span><span class="nx">obj</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">obj</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">PyProxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">PyProxyFunction</span><span class="p">].</span><span class="nx">some</span><span class="p">((</span><span class="nx">cls</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">            </span><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">hasInstance</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">cls</span><span class="p">,</span><span class="w"> </span><span class="nx">obj</span><span class="p">),</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">get</span><span class="w"> </span><span class="nx">type</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">            def python_type(obj):</span>
<span class="sb">                ty = type(obj)</span>
<span class="sb">                if ty.__module__  in [&#39;builtins&#39;, &#39;main&#39;]:</span>
<span class="sb">                    return ty.__name__</span>
<span class="sb">                return ty.__module__ + &quot;.&quot; + ty.__name__</span>
<span class="sb">        `</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonType</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonStr</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">destroy</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">proxy</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">];</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">shared</span><span class="p">.</span><span class="nx">pyObjectPtr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// already destroyed</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">shared</span><span class="p">.</span><span class="nx">pyObjectPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="nx">shared</span><span class="p">.</span><span class="nx">destroyed_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s2">&quot;Object has already been destroyed&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="nx">_Py_DecRef</span><span class="p">(</span><span class="nx">shared</span><span class="p">.</span><span class="nx">pyObjectPtr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">[</span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">dispose</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">copy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">shared</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">proxy</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">];</span>
<span class="w">        </span><span class="c1">// Don&#39;t pass shared as an option since we want this new PyProxy to</span>
<span class="w">        </span><span class="c1">// have a distinct lifetime from the one we are copying.</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">createPyProxy</span><span class="p">(</span><span class="nx">shared</span><span class="p">.</span><span class="nx">pyObjectPtr</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">flags</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$$flags</span><span class="p">,</span>
<span class="w">            </span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="nx">attrs</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">toJs</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// See the definition of to_js in &quot;Deep conversions&quot;.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id4">
<h4><a class="toc-backref" href="#id4" role="doc-backlink">Determining Which Flags to Set</a></h4>
<p>We separate this out into a component <code class="docutils literal notranslate"><span class="pre">get_type_flags</span></code> that computes flags
which only depends on the type and a component that also depends on whether the
<code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> has beenJsJson</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_type_flags</span><span class="p">(</span><span class="n">ty</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">,</span> <span class="n">Sequence</span>

    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">HAS_LENGTH</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="s2">&quot;__getitem__&quot;</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">HAS_GET</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="s2">&quot;__setitem__&quot;</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">HAS_SET</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="s2">&quot;__contains__&quot;</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">HAS_CONTAINS</span>
    <span class="k">if</span> <span class="n">ty</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># Currently we don&#39;t set this on subclasses.</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_DICT</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_CALLABLE</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_ITERABLE</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="s2">&quot;__next__&quot;</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_ITERATOR</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">Generator</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_GENERATOR</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_SEQUENCE</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_MUTABLE_SEQUENCE</span>
    <span class="k">return</span> <span class="n">flags</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_pyproxy_flags</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">is_js_json</span><span class="p">):</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">get_type_flags</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_js_json</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flags</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_SEQUENCE</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_JS_JSON_SEQUENCE</span>
    <span class="k">elif</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HAS_GET</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_JS_JSON_DICT</span>
    <span class="k">return</span> <span class="n">flags</span>
</pre></div>
</div>
</section>
<section id="id5">
<h4><a class="toc-backref" href="#id5" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code> Mixin</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonGetItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    def getitem(obj, key):</span>
<span class="sb">        return obj[key]</span>
<span class="sb">`</span><span class="p">);</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">PyProxyGetItemMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pythonGetItem</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">isJsJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$$flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">IS_JS_JSON_DICT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_JS_JSON_SEQUENCE</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isJsJson</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">asJsJson</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">asJsJson</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">asJsJson</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$$flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_JS_JSON_DICT</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">shared</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">];</span>
<span class="w">        </span><span class="c1">// Note: The PyProxy created here has the same lifetime as the PyProxy it is</span>
<span class="w">        </span><span class="c1">// created from. Destroying either destroys both.</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">createPyProxy</span><span class="p">(</span><span class="nx">shared</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">flags</span><span class="p">,</span><span class="w"> </span><span class="nx">shared</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id6">
<h4><a class="toc-backref" href="#id6" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code> Mixin</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nx">PyProxySetItemMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonSetItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">            def setitem(obj, key, value):</span>
<span class="sb">                obj[key] = value</span>
<span class="sb">        `</span><span class="p">);</span>
<span class="w">        </span><span class="nx">pythonSetItem</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="ow">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonDelItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">            def delitem(obj, key):</span>
<span class="sb">                del obj[key]</span>
<span class="sb">        `</span><span class="p">);</span>
<span class="w">        </span><span class="nx">pythonDelItem</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-has-contains-mixin">
<h4><a class="toc-backref" href="#the-has-contains-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_CONTAINS</span></code> Mixin</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonHasItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    def hasitem(obj, key):</span>
<span class="sb">        return key in obj</span>
<span class="sb">`</span><span class="p">);</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">PyContainsMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonHasItem</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id7">
<h4><a class="toc-backref" href="#id7" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code> Mixin</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;len&quot;</span><span class="p">);</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">PyLengthMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">get</span><span class="w"> </span><span class="nx">length</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonLength</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id8">
<h4><a class="toc-backref" href="#id8" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_CALLABLE</span></code> Mixin</a></h4>
<p>We have to make a custom prototype and class so that this inherits from both
<code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> and <code class="docutils literal notranslate"><span class="pre">Function</span></code>:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">PyProxyFunctionProto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
<span class="w">    </span><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
<span class="w">    </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptors</span><span class="p">(</span><span class="nx">PyProxy</span><span class="p">.</span><span class="nx">prototype</span><span class="p">),</span>
<span class="p">);</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">PyProxyFunction</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="nx">PyProxyFunction</span><span class="p">.</span><span class="nx">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PyProxyFunctionProto</span><span class="p">;</span>
</pre></div>
</div>
<p>We use the following helper function which inserts <code class="docutils literal notranslate"><span class="pre">this</span></code> as the first
argument if <code class="docutils literal notranslate"><span class="pre">captureThis</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> and adds any bound arguments.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">_adjustArgs</span><span class="p">(</span><span class="nx">pyproxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jsthis</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">captureThis</span><span class="p">,</span><span class="w"> </span><span class="nx">boundArgs</span><span class="p">,</span><span class="w"> </span><span class="nx">boundThis</span><span class="p">,</span><span class="w"> </span><span class="nx">isBound</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">props</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">captureThis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isBound</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">boundThis</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">boundArgs</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">jsthis</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isBound</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">boundArgs</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then we implement the following methods. <code class="docutils literal notranslate"><span class="pre">apply()</span></code>, <code class="docutils literal notranslate"><span class="pre">call()</span></code>, and <code class="docutils literal notranslate"><span class="pre">bind()</span></code>
are methods from <code class="docutils literal notranslate"><span class="pre">Function.prototype</span></code>. <code class="docutils literal notranslate"><span class="pre">callKwargs()</span></code> and <code class="docutils literal notranslate"><span class="pre">captureThis()</span></code>
are special to <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PyCallableMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">apply</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Convert jsargs to an array using ordinary .apply in order to match the</span>
<span class="w">        </span><span class="c1">// behavior of .apply very accurately.</span>
<span class="w">        </span><span class="nx">jsargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">args</span><span class="p">;</span>
<span class="w">        </span><span class="p">}.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">        </span><span class="nx">jsargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_adjustArgs</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">thisArg</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pyObjectPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">].</span><span class="nx">shared</span><span class="p">.</span><span class="nx">pyObjectPtr</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">callPyObjectKwargs</span><span class="p">(</span><span class="nx">pyObjectPtr</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">call</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">jsargs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jsargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_adjustArgs</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">thisArg</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pyObjectPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">].</span><span class="nx">shared</span><span class="p">.</span><span class="nx">pyObjectPtr</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">callPyObjectKwargs</span><span class="p">(</span><span class="nx">pyObjectPtr</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Call the function with keyword arguments. The last argument must be an</span>
<span class="cm">     * object with the keyword arguments.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nx">callKwargs</span><span class="p">(...</span><span class="nx">jsargs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jsargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_adjustArgs</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">thisArg</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">jsargs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">TypeError</span><span class="p">(</span>
<span class="w">                </span><span class="s2">&quot;callKwargs requires at least one argument (the kwargs object)&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="nx">kwargs</span><span class="p">.</span><span class="kr">constructor</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="nx">kwargs</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;Object&quot;</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;kwargs argument is not an object&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pyObjectPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">].</span><span class="nx">shared</span><span class="p">.</span><span class="nx">pyObjectPtr</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">callPyObjectKwargs</span><span class="p">(</span><span class="nx">pyObjectPtr</span><span class="p">,</span><span class="w"> </span><span class="nx">jsargs</span><span class="p">,</span><span class="w"> </span><span class="nx">kwargs</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * This is our implementation of Function.prototype.bind().</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nx">bind</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">jsargs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">shared</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">];</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">boundArgs</span><span class="o">:</span><span class="w"> </span><span class="nx">boundArgsOld</span><span class="p">,</span><span class="w"> </span><span class="nx">boundThis</span><span class="o">:</span><span class="w"> </span><span class="nx">boundThisOld</span><span class="p">,</span><span class="w"> </span><span class="nx">isBound</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">props</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">boundThis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">thisArg</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isBound</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">boundThis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">boundThisOld</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">boundArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">boundArgsOld</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">jsargs</span><span class="p">);</span>
<span class="w">        </span><span class="nx">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">props</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">boundArgs</span><span class="p">,</span>
<span class="w">            </span><span class="nx">isBound</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nx">boundThis</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">createPyProxy</span><span class="p">(</span><span class="nx">shared</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">shared</span><span class="p">,</span>
<span class="w">            </span><span class="nx">flags</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$$flags</span><span class="p">,</span>
<span class="w">            </span><span class="nx">props</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">      * This method makes a new PyProxy where ``this`` is passed as the</span>
<span class="cm">      * first argument to the Python function. The new PyProxy has the</span>
<span class="cm">      * same lifetime as the original.</span>
<span class="cm">      */</span>
<span class="w">    </span><span class="nx">captureThis</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">props</span><span class="p">,</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">];</span>
<span class="w">        </span><span class="nx">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">props</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">captureThis</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">createPyProxy</span><span class="p">(</span><span class="nx">shared</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">shared</span><span class="p">,</span>
<span class="w">            </span><span class="nx">flags</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$$flags</span><span class="p">,</span>
<span class="w">            </span><span class="nx">props</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-is-dict-mixin">
<h4><a class="toc-backref" href="#the-is-dict-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_DICT</span></code> Mixin</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">IS_DICT</span></code> mixin does not include any extra methods but it uses a special
set of handlers. These handlers are a hybrid between the normal handlers and the
<code class="docutils literal notranslate"><span class="pre">JS_JSON_DICT</span></code> handlers. We first check whether <code class="docutils literal notranslate"><span class="pre">hasattr(d,</span> <span class="pre">property)</span></code> and
if so return <code class="docutils literal notranslate"><span class="pre">d.property</span></code>. If not, we return <code class="docutils literal notranslate"><span class="pre">d.get(property,</span> <span class="pre">None)</span></code>. The
other methods all work similarly. See the <code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_DICT</span></code> flag for the
definitions of those handlers.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">PyProxyDictHandlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isExtensible</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">set</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">.</span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">prop</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="nb">Reflect</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">prop</span><span class="p">)</span><span class="w"> </span><span class="o">??</span>
<span class="w">            </span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">prop</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)[]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">...</span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">),</span>
<span class="w">            </span><span class="p">...</span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">)</span>
<span class="w">        </span><span class="p">];</span>
<span class="w">        </span><span class="c1">// deduplicate</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">result</span><span class="p">));</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="id9">
<h4><a class="toc-backref" href="#id9" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code> Mixin</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getStopIterationValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    def get_stop_iteration_value():</span>
<span class="sb">        import sys</span>
<span class="sb">        err = sys.last_value</span>
<span class="sb">        return err.value</span>
<span class="sb">`</span><span class="p">);</span>

<span class="kd">function</span><span class="o">*</span><span class="w"> </span><span class="nx">iterHelper</span><span class="p">(</span><span class="nx">iter</span><span class="p">,</span><span class="w"> </span><span class="nx">isJsJson</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pythonNext</span><span class="p">(</span><span class="nx">iter</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isJsJson</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">asJsJson</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">asJsJson</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">yield</span><span class="w"> </span><span class="nx">item</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;StopIteration&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">getStopIterationValue</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">pythonIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="s2">&quot;iter&quot;</span><span class="p">);</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">PyIterableMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">isJsJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$$flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">IS_JS_JSON_DICT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_JS_JSON_SEQUENCE</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">iterHelper</span><span class="p">(</span><span class="nx">pythonIter</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">isJsJson</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id10">
<h4><a class="toc-backref" href="#id10" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_ITERATOR</span></code> Mixin</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonSend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    def python_send(it, val):</span>
<span class="sb">        return gen.send(val)</span>
<span class="sb">`</span><span class="p">);</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">PyIteratorMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pythonSend</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;StopIteration&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getStopIterationValue</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">};</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id11">
<h4><a class="toc-backref" href="#id11" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_GENERATOR</span></code> Mixin</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonThrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    def python_throw(gen, val):</span>
<span class="sb">        return gen.throw(val)</span>
<span class="sb">`</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">pythonClose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    def python_close(gen):</span>
<span class="sb">        return gen.close()</span>
<span class="sb">`</span><span class="p">);</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">PyGeneratorMixin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PyIteratorMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="p">(</span><span class="nx">exc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pythonThrow</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">exc</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;StopIteration&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getStopIterationValue</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">};</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pythonClose</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-is-sequence-mixin">
<h4><a class="toc-backref" href="#the-is-sequence-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_SEQUENCE</span></code> Mixin</a></h4>
<p>We define all of the <code class="docutils literal notranslate"><span class="pre">Array.prototype</span></code> methods that don’t mutate the sequence
on <code class="docutils literal notranslate"><span class="pre">PySequenceMixin</span></code>. For most of them, the <code class="docutils literal notranslate"><span class="pre">Array</span></code> prototype method works
without changes. All of these we define with boilerplate of the form:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nx">methodName</span><span class="p">](...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">methodName</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These include <code class="docutils literal notranslate"><span class="pre">join</span></code>, <code class="docutils literal notranslate"><span class="pre">slice</span></code>, <code class="docutils literal notranslate"><span class="pre">indexOf</span></code>, <code class="docutils literal notranslate"><span class="pre">lastIndexOf</span></code>, <code class="docutils literal notranslate"><span class="pre">forEach</span></code>,
<code class="docutils literal notranslate"><span class="pre">map</span></code>, <code class="docutils literal notranslate"><span class="pre">filter</span></code>, <code class="docutils literal notranslate"><span class="pre">some</span></code>, <code class="docutils literal notranslate"><span class="pre">every</span></code>, <code class="docutils literal notranslate"><span class="pre">reduce</span></code>, <code class="docutils literal notranslate"><span class="pre">reduceRight</span></code>, <code class="docutils literal notranslate"><span class="pre">at</span></code>,
<code class="docutils literal notranslate"><span class="pre">concat</span></code>, <code class="docutils literal notranslate"><span class="pre">includes</span></code>, <code class="docutils literal notranslate"><span class="pre">entries</span></code>, <code class="docutils literal notranslate"><span class="pre">keys</span></code>, <code class="docutils literal notranslate"><span class="pre">values</span></code>, <code class="docutils literal notranslate"><span class="pre">find</span></code>, and
<code class="docutils literal notranslate"><span class="pre">findIndex</span></code>. Other than these boilerplate methods, the remaining attributes on
<code class="docutils literal notranslate"><span class="pre">PySequenceMixin</span></code> are as follows.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nx">PySequenceMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">get</span><span class="w"> </span><span class="p">[</span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">isConcatSpreadable</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">toJSON</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">asJsJson</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$$flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IS_JS_JSON_SEQUENCE</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">shared</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">pyproxyAttrsSymbol</span><span class="p">];</span>
<span class="w">        </span><span class="c1">// Note: Because we pass shared down, the PyProxy created here has</span>
<span class="w">        </span><span class="c1">// the same lifetime as the PyProxy it is created from. Destroying</span>
<span class="w">        </span><span class="c1">// either destroys both.</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">createPyProxy</span><span class="p">(</span><span class="nx">shared</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">flags</span><span class="p">,</span><span class="w"> </span><span class="nx">shared</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// ... boilerplate methods</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Instead of the default proxy handlers, we use the following handlers for
sequences. We don’t</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">PyProxySequenceHandlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isExtensible</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="sr">/^[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Note: if the number was negative it didn&#39;t match the pattern</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">jskey</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">jsobj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;length&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">jsobj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="sr">/^[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyGetItemMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">jskey</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isPythonError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;IndexError&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">set</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="sr">/^[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">PyProxySetItemMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">jskey</span><span class="p">),</span><span class="w"> </span><span class="nx">jsval</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isPythonError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;IndexError&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="sr">/^[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">PyProxySetItemMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="ow">delete</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">jskey</span><span class="p">));</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isPythonError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;IndexError&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)[]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PyProxyHandlers</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">);</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
<span class="w">            </span><span class="p">...</span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="nx">jsobj</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">k</span><span class="p">.</span><span class="nx">toString</span><span class="p">()),</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="the-is-mutable-sequence-mixin">
<h4><a class="toc-backref" href="#the-is-mutable-sequence-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_SEQUENCE</span></code> Mixin</a></h4>
<p>This adds some additional <code class="docutils literal notranslate"><span class="pre">Array</span></code> methods that mutate the sequence.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nx">PyMutableSequenceMixin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">reverse</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Same as the Python reverse method except it returns this instead of undefined</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">$reverse</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">        </span><span class="nx">push</span><span class="p">(...</span><span class="nx">elts</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">elt</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">elts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">elt</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">splice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">deleteCount</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">deleteCount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Max signed size</span>
<span class="w">            </span><span class="nx">deleteCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mf">31</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">deleteCount</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stop</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonSplice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">            def splice(array, start, stop, items):</span>
<span class="sb">                from jstypes.ffi import to_js</span>
<span class="sb">                result = to_js(array[start:stop], depth=1)</span>
<span class="sb">                array[start:stop] = items</span>
<span class="sb">                return result</span>
<span class="sb">        `</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonSplice</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">pop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">            def pop(array):</span>
<span class="sb">                return array.pop()</span>
<span class="sb">        `</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonPop</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">shift</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonShift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">            def pop(array):</span>
<span class="sb">                return array.pop(0)</span>
<span class="sb">        `</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonShift</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">unshift</span><span class="p">(...</span><span class="nx">elts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">elts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">elt</span><span class="p">,</span><span class="w"> </span><span class="nx">idx</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span><span class="w"> </span><span class="nx">elt</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Boilerplate methods</span>
<span class="w">    </span><span class="nx">copyWithin</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyWithin</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">fill</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fill</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-is-js-json-dict-mixin">
<h4><a class="toc-backref" href="#the-is-js-json-dict-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_DICT</span></code> Mixin</a></h4>
<p>There are no methods special to the <code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_DICT</span></code> flag, but we use the
following proxy handlers. We prefer to look up a property as an item in the
dictionary with two exceptions:</p>
<ol class="arabic simple">
<li>Symbols we always look up on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> itself.</li>
<li>We also look up the keys <code class="docutils literal notranslate"><span class="pre">$$flags</span></code>, <code class="docutils literal notranslate"><span class="pre">copy()</span></code>, <code class="docutils literal notranslate"><span class="pre">constructor</span></code>,
<code class="docutils literal notranslate"><span class="pre">destroy</span></code> and <code class="docutils literal notranslate"><span class="pre">toString</span></code> on the <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code>.</li>
</ol>
<p>All Python dictionary methods will be shadowed by a key of the same name.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isExtensible</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">PyContainsMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// If it doesn&#39;t exist as a string key and it looks like a number,</span>
<span class="w">        </span><span class="c1">// try again with the number</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="sr">/^-?[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">PyContainsMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">jskey</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;symbol&quot;</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;$$flags&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;copy&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;constructor&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;destroy&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;toString&quot;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">jskey</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Reflect</span><span class="p">.</span><span class="nx">get</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PyProxyGetItemMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="nx">result</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="nx">PyContainsMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="sr">/^-?[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">jskey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">PyProxyGetItemMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">jskey</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Reflect</span><span class="p">.</span><span class="nx">get</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">set</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;symbol&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="o">!</span><span class="nx">PyContainsMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="sr">/^-?[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">jskey</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">jskey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">PyProxySetItemMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">,</span><span class="w"> </span><span class="nx">jsval</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isPythonError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;KeyError&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;symbol&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="o">!</span><span class="nx">PyContainsMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">jskey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="sr">/^-?[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">jskey</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">jskey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">PyProxySetItemMixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="ow">delete</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">jskey</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isPythonError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;KeyError&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">,</span><span class="w"> </span><span class="nx">prop</span><span class="o">:</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">prop</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PyProxyJsJsonDictHandlers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">,</span><span class="w"> </span><span class="nx">prop</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">configurable</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nx">enumerable</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nx">value</span><span class="p">,</span>
<span class="w">            </span><span class="nx">writable</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="o">:</span><span class="w"> </span><span class="nx">PyProxy</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)[]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pythonDictOwnKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makePythonFunction</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">            def dict_own_keys(d):</span>
<span class="sb">                from jstypes.ffi import to_js</span>
<span class="sb">                result = set()</span>
<span class="sb">                for key in d:</span>
<span class="sb">                    if isinstance(key, str):</span>
<span class="sb">                        result.add(key)</span>
<span class="sb">                    elif isinstance(key, (int, float)):</span>
<span class="sb">                        result.add(str(key))</span>
<span class="sb">                return to_js(result)</span>
<span class="sb">        `</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">pythonDictOwnKeys</span><span class="p">(</span><span class="nx">jsobj</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="the-is-js-json-sequence-mixin">
<h4><a class="toc-backref" href="#the-is-js-json-sequence-mixin" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_SEQUENCE</span></code> Mixin</a></h4>
<p>This has no direct impact on the prototype or handlers of the proxy. However,
when indexing the list or iterating over the list we will apply <code class="docutils literal notranslate"><span class="pre">asJsJson()</span></code>
to the results.</p>
</section>
</section>
<section id="deep-conversions">
<h3><a class="toc-backref" href="#deep-conversions" role="doc-backlink">Deep Conversions</a></h3>
<p>We define <code class="docutils literal notranslate"><span class="pre">JSProxy.to_py()</span></code> to make deep conversions from JavaScript to Python
and <code class="docutils literal notranslate"><span class="pre">jstypes.ffi.to_js()</span></code> to make deep conversions from Python to JavaScript.
Note that it is not intended that these are inverse functions to each other.</p>
<section id="from-javascript-to-python">
<h4><a class="toc-backref" href="#from-javascript-to-python" role="doc-backlink">From JavaScript to Python</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">JSProxy.to_py()</span></code> method makes the following conversions:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Array</span></code> ==&gt; <code class="docutils literal notranslate"><span class="pre">list</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Map</span></code> ==&gt; <code class="docutils literal notranslate"><span class="pre">dict</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Set</span></code> ==&gt; <code class="docutils literal notranslate"><span class="pre">set</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Object</span></code> ==&gt; <code class="docutils literal notranslate"><span class="pre">dict</span></code> but only if the <code class="docutils literal notranslate"><span class="pre">constructor</span></code> is either <code class="docutils literal notranslate"><span class="pre">Object</span></code>
or <code class="docutils literal notranslate"><span class="pre">undefined</span></code>. Other objects we leave alone.</li>
</ul>
<p>It takes the following optional arguments:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">depth</span></code></dt><dd>An integer, specifies the maximum depth down to which to convert. For
instance, setting <code class="docutils literal notranslate"><span class="pre">depth=1</span></code> allows converting exactly one level.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">default_converter</span></code></dt><dd>A function to be called when there is no known conversion for an object.</dd>
</dl>
<p>The default converter takes three arguments:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">jsobj</span></code></dt><dd>The object to convert.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">convert</span></code></dt><dd>Allows recursing.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cache_conversion</span></code></dt><dd>Cache the conversion of an object to allow converting self-referential data.</dd>
</dl>
<p>For example, if we have a JavaScript <code class="docutils literal notranslate"><span class="pre">Pair</span></code> class and want to convert it to a
list, we can use the following <code class="docutils literal notranslate"><span class="pre">default_converter</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">pair_converter</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">convert</span><span class="p">,</span> <span class="n">cache_conversion</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">jsobj</span><span class="o">.</span><span class="n">constructor</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;Pair&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsobj</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cache_conversion</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convert</span><span class="p">(</span><span class="n">jsobj</span><span class="o">.</span><span class="n">first</span><span class="p">))</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convert</span><span class="p">(</span><span class="n">jsobj</span><span class="o">.</span><span class="n">second</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>By first caching the result before making any recursive calls to <code class="docutils literal notranslate"><span class="pre">convert</span></code>, we
ensure that if <code class="docutils literal notranslate"><span class="pre">jsobj.first</span></code> has a transitive reference to <code class="docutils literal notranslate"><span class="pre">jsobj</span></code>, we
convert it correctly.</p>
<p>Complete pseudocode for the <code class="docutils literal notranslate"><span class="pre">to_py</span></code> method is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">to_py</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">depth</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">default_converter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">ToPyConverter</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">default_converter</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">jsobj</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ToPyConverter</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">default_converter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_converter</span> <span class="o">=</span> <span class="n">default_converter</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cache_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jsobj</span><span class="p">,</span> <span class="n">pyobj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">jsobj</span><span class="o">.</span><span class="n">js_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyobj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jsobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jsobj</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jsobj</span><span class="o">.</span><span class="n">js_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.global_this</span><span class="w"> </span><span class="kn">import</span> <span class="n">Array</span><span class="p">,</span> <span class="n">Object</span>
        <span class="n">type_tag</span> <span class="o">=</span> <span class="n">getTypeTag</span><span class="p">(</span><span class="n">jsobj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Array</span><span class="o">.</span><span class="n">isArray</span><span class="p">(</span><span class="n">jsobj</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_list</span><span class="p">(</span><span class="n">jsobj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">type_tag</span> <span class="o">==</span> <span class="s2">&quot;[object Map]&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_map</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">jsobj</span><span class="o">.</span><span class="n">entries</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">type_tag</span> <span class="o">==</span> <span class="s2">&quot;[object Set]&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_set</span><span class="p">(</span><span class="n">jsobj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">type_tag</span> <span class="o">==</span> <span class="s2">&quot;[object Object]&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">jsobj</span><span class="o">.</span><span class="n">constructor</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Object</span><span class="p">]):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_map</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">Object</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">jsobj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_converter</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsobj</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jsobj</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">jsobj</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jsobj</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">]</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jsobj</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span><span class="p">(</span><span class="n">jsobj</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">jsobj</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="from-python-to-javascript">
<h4><a class="toc-backref" href="#from-python-to-javascript" role="doc-backlink">From Python to JavaScript</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">to_js</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">pyproxies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">create_pyproxies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">dict_converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">default_converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">eager_converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">converter</span> <span class="o">=</span> <span class="n">ToJsConverter</span><span class="p">(</span>
        <span class="n">depth</span><span class="p">,</span>
        <span class="n">pyproxies</span><span class="p">,</span>
        <span class="n">create_pyproxies</span><span class="p">,</span>
        <span class="n">dict_converter</span><span class="p">,</span>
        <span class="n">default_converter</span><span class="p">,</span>
        <span class="n">eager_converter</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">converter</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ToJsConverter</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">,</span>
        <span class="n">pyproxies</span><span class="p">,</span>
        <span class="n">create_pyproxies</span><span class="p">,</span>
        <span class="n">dict_converter</span><span class="p">,</span>
        <span class="n">default_converter</span><span class="p">,</span>
        <span class="n">eager_converter</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyproxies</span> <span class="o">=</span> <span class="n">pyproxies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_pyproxies</span> <span class="o">=</span> <span class="n">create_pyproxies</span>
        <span class="k">if</span> <span class="n">dict_converter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dict_converter</span> <span class="o">=</span> <span class="n">Object</span><span class="o">.</span><span class="n">fromEntries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_converter</span> <span class="o">=</span> <span class="n">dict_converter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_converter</span> <span class="o">=</span> <span class="n">default_converter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eager_converter</span> <span class="o">=</span> <span class="n">eager_converter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_process_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs_to_dict_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cache_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyobj</span><span class="p">,</span> <span class="n">jsobj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)]</span> <span class="o">=</span> <span class="n">jsobj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Replace any NoValue&#39;s that appear once we&#39;ve certainly computed</span>
        <span class="c1"># their correct conversions</span>
        <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">pyobj_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_process_list</span><span class="p">:</span>
            <span class="n">real_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">pyobj_id</span><span class="p">]</span>
            <span class="c1"># If it was a dictionary, we need to lookup the actual result object</span>
            <span class="n">real_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs_to_dict_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">js_id</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
            <span class="n">real_parent</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_value</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decrement_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pyobj</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pyobj</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">decrement_depth</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eager_converter</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eager_converter</span><span class="p">(</span>
                    <span class="n">pyobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_no_eager_public</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_no_eager</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_no_eager_public</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyobj</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">decrement_depth</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_no_eager</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_no_eager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pyobj</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_sequence</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pyobj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_dict</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pyobj</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_set</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_converter</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_converter</span><span class="p">(</span>
                <span class="n">pyobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_no_eager_public</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_pyproxies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConversionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No conversion available for </span><span class="si">{</span><span class="n">pyobj</span><span class="si">!r}</span><span class="s2"> and create_pyproxies=False passed&quot;</span>
            <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">create_proxy</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyproxies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pyproxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyobj</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.global_this</span><span class="w"> </span><span class="kn">import</span> <span class="n">Array</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span><span class="p">(</span><span class="n">pyobj</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pyobj</span><span class="p">):</span>
            <span class="n">converted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">converted</span> <span class="ow">is</span> <span class="n">NoValue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_process_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">converted</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyobj</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.global_this</span><span class="w"> </span><span class="kn">import</span> <span class="n">Array</span>

        <span class="c1"># Temporarily store NoValue in the cache since we only get the</span>
        <span class="c1"># actual value from dict_converter. We&#39;ll replace these with the</span>
        <span class="c1"># correct values in the postprocess step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span><span class="p">(</span><span class="n">pyobj</span><span class="p">,</span> <span class="n">NoValue</span><span class="p">)</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pyobj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">converted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">converted</span> <span class="ow">is</span> <span class="n">NoValue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_process_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="n">pairs</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">converted</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_converter</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs_to_dict_map</span><span class="p">[</span><span class="n">pairs</span><span class="o">.</span><span class="n">js_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="c1"># Update the cache to point to the actual result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span><span class="p">(</span><span class="n">pyobj</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyobj</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.global_this</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_conversion</span><span class="p">(</span><span class="n">pyobj</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pyobj</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConversionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot use </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s2"> as a key for a JavaScript Set&quot;</span>
                <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
</section>
<section id="the-jstypes-global-this-module">
<h3><a class="toc-backref" href="#the-jstypes-global-this-module" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">jstypes.global_this</span></code> Module</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">jstypes.global_this</span></code> module allows us to import objects from JavaScript. The definition is
as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.code</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_js</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jstypes.ffi</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSProxy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Loader</span><span class="p">,</span> <span class="n">MetaPathFinder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">spec_from_loader</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JSLoader</span><span class="p">(</span><span class="n">Loader</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jsproxy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jsproxy</span> <span class="o">=</span> <span class="n">jsproxy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsproxy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exec_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JSFinder</span><span class="p">(</span><span class="n">MetaPathFinder</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="p">[</span><span class="n">parent</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullname</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="s2">&quot;jstypes&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">run_js</span><span class="p">(</span><span class="s2">&quot;globalThis&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">parent_module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_module</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">):</span>
            <span class="c1"># Not one of us.</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">jsproxy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent_module</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jsproxy</span><span class="p">,</span> <span class="n">JSProxy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No module named </span><span class="si">{</span><span class="n">fullname</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">fullname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsproxy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_spec</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fullname</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">jsproxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">JSLoader</span><span class="p">(</span><span class="n">jsproxy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spec_from_loader</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;javascript&quot;</span><span class="p">)</span>


<span class="n">finder</span> <span class="o">=</span> <span class="n">JSFinder</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">finder</span><span class="p">)</span>
<span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;jstypes.global_this&quot;</span><span class="p">]</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jstypes.global_this</span>
<span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">finder</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">finder</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-jstypes-package">
<h3><a class="toc-backref" href="#the-jstypes-package" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">jstypes</span></code> package</a></h3>
<p>This has an empty <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> and two submodules.</p>
<section id="the-jstypes-ffi-module">
<h4><a class="toc-backref" href="#the-jstypes-ffi-module" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">jstypes.ffi</span></code> Module</a></h4>
<p>This has the following properties:</p>
<p><code class="docutils literal notranslate"><span class="pre">create_proxy(x)</span></code>: This returns <code class="docutils literal notranslate"><span class="pre">create_jsproxy(createPyProxy(x))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">jsnull</span></code>: Special value that converts to/from the JavaScript <code class="docutils literal notranslate"><span class="pre">null</span></code> value.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSNull</span></code>: The type of <code class="docutils literal notranslate"><span class="pre">jsnull</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">destroy_proxies</span><span class="p">(</span><span class="n">proxies</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
        <span class="n">proxy</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">to_js</span></code>: See definition in the section on deep conversions.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSArray</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;[]&quot;))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSCallable</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;()</span> <span class="pre">=&gt;</span> <span class="pre">{}&quot;))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSDoubleProxy</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(create_proxy({}))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSException</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;new</span> <span class="pre">Error()&quot;))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSGenerator</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;(function*(){})()&quot;))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSIterable</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;({[Symbol.iterator](){}})&quot;))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSIterator</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;({next(){}})&quot;))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSMap</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;({get(){}})&quot;))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSMutableMap</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;new</span> <span class="pre">Map()&quot;))</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>: This is <code class="docutils literal notranslate"><span class="pre">type(run_js(&quot;({})&quot;))</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">JSBigInt</span></code>: This is defined as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_int_to_bigint</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JSBigInt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JSBigInt</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
    <span class="c1"># unary ops</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JSBigInt</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JSBigInt</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JSBigInt</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__pos__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JSBigInt</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__pos__</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="c1"># binary ops</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__floordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__floordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__lshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__lshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">modulus</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">modulus</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__rshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__rshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_int_to_bigint</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="the-jstypes-code-module">
<h4><a class="toc-backref" href="#the-jstypes-code-module" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">jstypes.code</span></code> Module</a></h4>
<p>This exposes the <code class="docutils literal notranslate"><span class="pre">run_js</span></code> function.</p>
</section>
</section>
<section id="changes-to-the-json-module">
<h3><a class="toc-backref" href="#changes-to-the-json-module" role="doc-backlink">Changes to the <code class="docutils literal notranslate"><span class="pre">json</span></code> Module</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">json</span></code> module will be updated to serialize <code class="docutils literal notranslate"><span class="pre">jsnull</span></code> to <code class="docutils literal notranslate"><span class="pre">null</span></code>.</p>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>This is strictly adding new APIs. There are backwards compatibility concerns for
Pyodide. We have changed the names of several modules and types compared to
Pyodide:</p>
<ol class="arabic simple">
<li>The <code class="docutils literal notranslate"><span class="pre">pyodide</span></code> package is changed to <code class="docutils literal notranslate"><span class="pre">jstypes</span></code></li>
<li>The <code class="docutils literal notranslate"><span class="pre">js</span></code> module is changed to <code class="docutils literal notranslate"><span class="pre">jstypes.global_this</span></code></li>
<li>All <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> variants are capitalized like <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code>.</li>
</ol>
<p>In the next release, Pyodide will add support for both the changed names and the
original names. We will also upload a package to PyPI that includes backwards
compatibility shims for the old names.</p>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications" role="doc-backlink">Security Implications</a></h2>
<p>It improves support for one of the few fully sandboxed platforms that Python can
run on.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>Pyodide, <a class="reference external" href="https://github.com/hoodmane/cpython/tree/js-ffi">https://github.com/hoodmane/cpython/tree/js-ffi</a></p>
</section>
<section id="acknowledgments">
<h2><a class="toc-backref" href="#acknowledgments" role="doc-backlink">Acknowledgments</a></h2>
<p>Mike Droettboom, Roman Yurchak, Gyeongjae Choi, Andrea Giammarchi</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0818.rst">https://github.com/python/peps/blob/main/peps/pep-0818.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0818.rst">2026-02-09 19:35:47 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#translating-objects">Translating Objects</a></li>
<li><a class="reference internal" href="#proxies">Proxies</a></li>
<li><a class="reference internal" href="#garbage-collection-and-destruction-of-proxies">Garbage Collection and Destruction of Proxies</a></li>
<li><a class="reference internal" href="#calling-conventions">Calling Conventions</a><ul>
<li><a class="reference internal" href="#calling-a-python-function-from-javascript">Calling a Python Function from JavaScript</a></li>
<li><a class="reference internal" href="#calling-a-javascript-function-from-python">Calling a JavaScript Function from Python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#defense-of-the-calling-convention-for-a-jsproxy">Defense of the Calling Convention for a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code></a><ul>
<li><a class="reference internal" href="#an-example-of-a-disadvantage-of-the-calling-convention">An Example of a Disadvantage of the Calling Convention</a></li>
<li><a class="reference internal" href="#a-use-case-that-is-made-simpler-by-this-calling-convention">A Use Case That Is Made Simpler By This Calling Convention</a></li>
</ul>
</li>
<li><a class="reference internal" href="#new-top-level-packages">New Top Level Packages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#the-pseudocode-in-this-document">The Pseudocode in this Document</a></li>
<li><a class="reference internal" href="#converting-values-between-python-and-javascript">Converting Values between Python and JavaScript</a><ul>
<li><a class="reference internal" href="#implicit-conversion-from-python-to-javascript">Implicit conversion from Python to JavaScript</a></li>
<li><a class="reference internal" href="#implicit-conversion-from-javascript-to-python">Implicit conversion from JavaScript to Python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#error-handling">Error handling</a><ul>
<li><a class="reference internal" href="#executing-javascript-code-from-c">Executing JavaScript Code from C</a></li>
<li><a class="reference internal" href="#executing-c-code-from-javascript">Executing C Code from JavaScript</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">Calling Conventions</a><ul>
<li><a class="reference internal" href="#id2">Calling a Python Function from JavaScript</a></li>
<li><a class="reference internal" href="#id3">Calling a JavaScript Function from Python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#run-js"><code class="docutils literal notranslate"><span class="pre">run_js</span></code></a></li>
<li><a class="reference internal" href="#makepythonfunction"><code class="docutils literal notranslate"><span class="pre">makePythonFunction</span></code></a></li>
<li><a class="reference internal" href="#jsproxy">JSProxy</a><ul>
<li><a class="reference internal" href="#creating-a-jsproxy">Creating a <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code></a></li>
<li><a class="reference internal" href="#the-jsproxy-metaclass">The <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> Metaclass</a></li>
<li><a class="reference internal" href="#the-jsproxy-base-class">The <code class="docutils literal notranslate"><span class="pre">JSProxy</span></code> Base Class</a></li>
<li><a class="reference internal" href="#determining-which-flags-to-set">Determining Which Flags to Set</a></li>
<li><a class="reference internal" href="#the-has-get-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-set-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-has-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_HAS</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-includes-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_INCLUDES</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-length-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-dispose-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_DISPOSE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-array-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ARRAY</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-array-like-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ARRAY_LIKE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-callable-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_CALLABLE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-error-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ERROR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-iterable-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-iterator-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_ITERATOR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-generator-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_GENERATOR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-mapping-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_MAPPING</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-mutable-mapping-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_MAPPING</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-py-json-sequence-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_SEQUENCE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-py-json-dict-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_PY_JSON_DICT</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-double-proxy-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_DOUBLE_PROXY</span></code> Mixin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pyproxy">PyProxy</a><ul>
<li><a class="reference internal" href="#creating-a-pyproxy">Creating a <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code></a></li>
<li><a class="reference internal" href="#the-pyproxy-base-class">The <code class="docutils literal notranslate"><span class="pre">PyProxy</span></code> Base Class</a></li>
<li><a class="reference internal" href="#id4">Determining Which Flags to Set</a></li>
<li><a class="reference internal" href="#id5">The <code class="docutils literal notranslate"><span class="pre">HAS_GET</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id6">The <code class="docutils literal notranslate"><span class="pre">HAS_SET</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-has-contains-mixin">The <code class="docutils literal notranslate"><span class="pre">HAS_CONTAINS</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id7">The <code class="docutils literal notranslate"><span class="pre">HAS_LENGTH</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id8">The <code class="docutils literal notranslate"><span class="pre">IS_CALLABLE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-dict-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_DICT</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id9">The <code class="docutils literal notranslate"><span class="pre">IS_ITERABLE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id10">The <code class="docutils literal notranslate"><span class="pre">IS_ITERATOR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#id11">The <code class="docutils literal notranslate"><span class="pre">IS_GENERATOR</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-sequence-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_SEQUENCE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-mutable-sequence-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_MUTABLE_SEQUENCE</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-js-json-dict-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_DICT</span></code> Mixin</a></li>
<li><a class="reference internal" href="#the-is-js-json-sequence-mixin">The <code class="docutils literal notranslate"><span class="pre">IS_JS_JSON_SEQUENCE</span></code> Mixin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deep-conversions">Deep Conversions</a><ul>
<li><a class="reference internal" href="#from-javascript-to-python">From JavaScript to Python</a></li>
<li><a class="reference internal" href="#from-python-to-javascript">From Python to JavaScript</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-jstypes-global-this-module">The <code class="docutils literal notranslate"><span class="pre">jstypes.global_this</span></code> Module</a></li>
<li><a class="reference internal" href="#the-jstypes-package">The <code class="docutils literal notranslate"><span class="pre">jstypes</span></code> package</a><ul>
<li><a class="reference internal" href="#the-jstypes-ffi-module">The <code class="docutils literal notranslate"><span class="pre">jstypes.ffi</span></code> Module</a></li>
<li><a class="reference internal" href="#the-jstypes-code-module">The <code class="docutils literal notranslate"><span class="pre">jstypes.code</span></code> Module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changes-to-the-json-module">Changes to the <code class="docutils literal notranslate"><span class="pre">json</span></code> Module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#acknowledgments">Acknowledgments</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0818.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>