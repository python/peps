
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 820 – PySlot: Unified slot system for the C API | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0820/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 820 – PySlot: Unified slot system for the C API | peps.python.org'>
    <meta property="og:description" content="Replace type and module slots with a new structure: a tagged anonymous union with flags. This improves type safety and allows adding new slots in a more forward-compatible way.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0820/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Replace type and module slots with a new structure: a tagged anonymous union with flags. This improves type safety and allows adding new slots in a more forward-compatible way.">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 820</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 820 – PySlot: Unified slot system for the C API" data-pagefind-weight="10" class="visually-hidden">PEP 820 – PySlot: Unified slot system for the C API</span>
            <section id="pep-content">
<h1 class="page-title">PEP 820 – PySlot: Unified slot system for the C API</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Petr Viktorin &lt;encukou&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Discussions-To<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/105552">Discourse thread</a></dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-odd">Created<span class="colon">:</span></dt>
<dd class="field-odd">19-Dec-2025</dd>
<dt class="field-even">Python-Version<span class="colon">:</span></dt>
<dd class="field-even">3.15</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/105552" title="Discourse thread">06-Jan-2026</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#using-slots">Using slots</a></li>
<li><a class="reference internal" href="#using-slots-only">Using slots <em>only</em></a></li>
<li><a class="reference internal" href="#nested-slot-tables">Nested slot tables</a></li>
<li><a class="reference internal" href="#nested-legacy-slot-tables">Nested “legacy” slot tables</a></li>
<li><a class="reference internal" href="#fixed-width-integers">Fixed-width integers</a></li>
<li><a class="reference internal" href="#memory-layout">Memory layout</a></li>
<li><a class="reference internal" href="#single-id-space">Single ID space</a></li>
<li><a class="reference internal" href="#deprecation-warnings">Deprecation warnings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#new-api">New API</a></li>
<li><a class="reference internal" href="#changed-api">Changed API</a></li>
<li><a class="reference internal" href="#general-slot-semantics">General slot semantics</a></li>
<li><a class="reference internal" href="#flags">Flags</a></li>
<li><a class="reference internal" href="#convenience-macros">Convenience macros</a></li>
<li><a class="reference internal" href="#pep820-nested-tables">Nested slot tables</a></li>
<li><a class="reference internal" href="#new-slot-ids">New slot IDs</a></li>
<li><a class="reference internal" href="#slot-renumbering">Slot renumbering</a></li>
<li><a class="reference internal" href="#soft-deprecation">Soft deprecation</a></li>
<li><a class="reference internal" href="#pep820-hard-deprecations">Deprecation warnings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#third-party-slot-id-allocation">Third-party slot ID allocation</a></li>
<li><a class="reference internal" href="#avoiding-anonymous-unions">Avoiding anonymous unions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Replace type and module slots with a new structure: a tagged anonymous
union with flags.
This improves type safety and allows adding new slots
in a more forward-compatible way.</p>
<p>API added in 3.15 (<a class="reference external" href="https://docs.python.org/3.15/c-api/module.html#c.PyModule_FromSlotsAndSpec" title="(in Python v3.15)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyModule_FromSlotsAndSpec()</span></code></a> and the
new <a class="reference external" href="https://docs.python.org/3.15/c-api/extension-modules.html#extension-export-hook" title="(in Python v3.15)"><span class="xref std std-ref">extension export hook</span></a>)
will be changed to use the new slots.</p>
<p>The existing slot structures and related API is soft-deprecated.
(That is: they will continue to work without warnings, and it’ll be fully
documented and supported, but we plan to not add any new features to it.)</p>
</section>
<section id="background">
<h2><a class="toc-backref" href="#background" role="doc-backlink">Background</a></h2>
<p>The C API in Python 3.14 contains two extendable structs used to provide
information when creating a new object: <a class="reference external" href="https://docs.python.org/3/c-api/type.html#c.PyType_Spec" title="(in Python v3.14)"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyType_Spec</span></code></a> and
<a class="reference external" href="https://docs.python.org/3/c-api/module.html#c.PyModuleDef" title="(in Python v3.14)"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyModuleDef</span></code></a>.</p>
<p>Each has a family of C API functions that create a Python object from it.
(Each family works as a single function, with optional arguments that
got added over time.) These are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">PyType_From*</span></code> functions, like <a class="reference external" href="https://docs.python.org/3/c-api/type.html#c.PyType_FromMetaclass" title="(in Python v3.14)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyType_FromMetaclass()</span></code></a>,
for <code class="docutils literal notranslate"><span class="pre">PyType_Spec</span></code>;</li>
<li><code class="docutils literal notranslate"><span class="pre">PyModule_FromDef*</span></code> functions, like <a class="reference external" href="https://docs.python.org/3/c-api/module.html#c.PyModule_FromDefAndSpec" title="(in Python v3.14)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyModule_FromDefAndSpec()</span></code></a>,
for <code class="docutils literal notranslate"><span class="pre">PyModuleDef</span></code>.</li>
</ul>
<p>Separating “input” structures from runtime objects allows the internal
structure of the object to stay opaque (in both the API and the ABI),
allowing future CPython versions (or even alternative implementations) to
change the details.</p>
<p>Both structures contain a <em>slots</em> field, essentially an array of
<a class="reference external" href="https://en.wikipedia.org/wiki/Tagged_union">tagged unions</a>
(<code class="docutils literal notranslate"><span class="pre">void</span></code> pointers taged with an <code class="docutils literal notranslate"><span class="pre">int</span></code> ID).
This allows for future expansion.</p>
<p>In <a class="pep reference internal" href="../pep-0793/" title="PEP 793 – PyModExport: A new entry point for C extension modules">PEP 793</a>, new module creation API was added.
Instead of the <code class="docutils literal notranslate"><span class="pre">PyModuleDef</span></code> structure, it uses only an array of <em>slots</em>.
To replace the existing members of <code class="docutils literal notranslate"><span class="pre">PyModuleDef</span></code>, it adds
corresponding slot IDs – for example, the module name is specified in a
<code class="docutils literal notranslate"><span class="pre">Py_mod_name</span></code> slot, rather than in <code class="docutils literal notranslate"><span class="pre">PyModuleDef.m_name</span></code>.
That PEP notes:</p>
<blockquote>
<div>The PyModuleDef_Slot struct does have some downsides compared to fixed
fields.
We believe these are fixable, but leave that out of scope of this PEP.</div></blockquote>
<p>This proposal addresses the downsides.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>The main shortcomings of the existing <code class="docutils literal notranslate"><span class="pre">PyModuleDef_Slot</span></code> and <code class="docutils literal notranslate"><span class="pre">PyType_Slot</span></code>
are:</p>
<dl>
<dt>Type safety</dt><dd><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code> is used for data pointers, function pointers and small integers,
requiring casting that works in practice on all relevant architectures,
but is technically undefined or implementation-defined behaviour in C.<p>For example: <a class="reference external" href="https://docs.python.org/3/c-api/typeobj.html#c.Py_tp_doc" title="(in Python v3.14)"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_tp_doc</span></code></a> marks a string; <a class="reference external" href="https://docs.python.org/3/c-api/module.html#c.Py_mod_gil" title="(in Python v3.14)"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_mod_gil</span></code></a>
a small integer, and <a class="reference external" href="https://docs.python.org/3/c-api/typeobj.html#c.Py_tp_repr" title="(in Python v3.14)"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_tp_repr</span></code></a> a function; all must
be cast to <code class="docutils literal notranslate"><span class="pre">void*</span></code>.</p>
</dd>
<dt>Limited forward compatibility</dt><dd>If an extension provides a slot ID that’s unknown to the current
interpreter, type/module creation will fail.
This makes it cumbersome to use “optional” features – ones that should
only take effect if the interpreter supports them.
The recently added slots <a class="reference external" href="https://docs.python.org/3/c-api/module.html#c.Py_mod_gil" title="(in Python v3.14)"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_mod_gil</span></code></a> and
<a class="reference external" href="https://docs.python.org/3/c-api/module.html#c.Py_mod_multiple_interpreters" title="(in Python v3.14)"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_mod_multiple_interpreters</span></code></a> are good examples.<p>One workaround is to check the Python version, and omit slots
that predate the current interpreter.
This is cumbersome for users.
It also constraints possible non-CPython implementations of the C API,
preventing them from “cherry-picking” features introduced in newer CPython
versions.</p>
</dd>
</dl>
</section>
<section id="example">
<h2><a class="toc-backref" href="#example" role="doc-backlink">Example</a></h2>
<p>This proposal adds API to create classes and modules from arrays of slots,
which can be specified as C literals using macros, like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">PySlot</span><span class="w"> </span><span class="n">myClass_slots</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">PySlot_STATIC</span><span class="p">(</span><span class="n">tp_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mymod.MyClass&quot;</span><span class="p">),</span>
<span class="w">   </span><span class="n">PySlot_SIZE</span><span class="p">(</span><span class="n">tp_extra_basicsize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">myClass</span><span class="p">)),</span>
<span class="w">   </span><span class="n">PySlot_FUNC</span><span class="p">(</span><span class="n">tp_repr</span><span class="p">,</span><span class="w"> </span><span class="n">myClass_repr</span><span class="p">),</span>
<span class="w">   </span><span class="n">PySlot_INT64</span><span class="p">(</span><span class="n">tp_flags</span><span class="p">,</span><span class="w"> </span><span class="n">Py_TPFLAGS_DEFAULT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Py_TPFLAGS_MANAGED_DICT</span><span class="p">),</span>
<span class="w">   </span><span class="n">PySlot_END</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">MyClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyType_FromSlots</span><span class="p">(</span><span class="n">myClass_slots</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
</pre></div>
</div>
<p>The macros simplify hand-written literals.
For more complex use cases, like compatibility between several Python versions,
or templated/auto-generated slot arrays, as well as for non-C users of the
C API, the slot struct definitions can be written out.
For example, if the transition from <code class="docutils literal notranslate"><span class="pre">tp_getattr</span></code> to <code class="docutils literal notranslate"><span class="pre">tp_getattro</span></code>
was happening in the near future (say, CPython 3.17), rather than 1.4, and
the user wanted to support CPython with and without <code class="docutils literal notranslate"><span class="pre">tp_getattro</span></code>, they could
add a “<code class="docutils literal notranslate"><span class="pre">HAS_FALLBACK</span></code>” flag:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">PySlot</span><span class="w"> </span><span class="n">myClass_slots</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="p">...</span>
<span class="w">   </span><span class="p">{</span><span class="w">   </span><span class="c1">// skipped if not supported</span>
<span class="w">       </span><span class="p">.</span><span class="n">sl_id</span><span class="o">=</span><span class="n">Py_tp_getattro</span><span class="p">,</span>
<span class="w">       </span><span class="p">.</span><span class="n">sl_flags</span><span class="o">=</span><span class="n">PySlot_HAS_FALLBACK</span><span class="p">,</span>
<span class="w">       </span><span class="p">.</span><span class="n">sl_func</span><span class="o">=</span><span class="n">myClass_getattro</span><span class="p">,</span>
<span class="w">   </span><span class="p">},</span>
<span class="w">   </span><span class="p">{</span><span class="w">    </span><span class="c1">// used if if the slot above was skipped</span>
<span class="w">       </span><span class="p">.</span><span class="n">sl_id</span><span class="o">=</span><span class="n">Py_tp_getattr</span><span class="p">,</span>
<span class="w">       </span><span class="p">.</span><span class="n">sl_func</span><span class="o">=</span><span class="n">myClass_old_getattr</span><span class="p">,</span>
<span class="w">   </span><span class="p">},</span>
<span class="w">   </span><span class="n">PySlot_END</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Similarly, if the <code class="docutils literal notranslate"><span class="pre">nb_matrix_multiply</span></code> slot (<a class="pep reference internal" href="../pep-0465/" title="PEP 465 – A dedicated infix operator for matrix multiplication">PEP 465</a>) was added in the
near future, users could add it with an “<code class="docutils literal notranslate"><span class="pre">OPTIONAL</span></code>” flag, making their class
support the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> operator only on CPython versions with that operator.</p>
</section>
<section id="rationale">
<span id="pep820-rationale"></span><h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>Here we explain the design decisions in this proposal.</p>
<p>Some of the rationale is repeated from <a class="pep reference internal" href="../pep-0793/" title="PEP 793 – PyModExport: A new entry point for C extension modules">PEP 793</a>, which replaced
the <a class="reference external" href="https://docs.python.org/3/c-api/module.html#c.PyModuleDef" title="(in Python v3.14)"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyModuleDef</span></code></a> struct with an array of slots.</p>
<section id="using-slots">
<h3><a class="toc-backref" href="#using-slots" role="doc-backlink">Using slots</a></h3>
<p>The main alternative to slots is using a versioned <code class="docutils literal notranslate"><span class="pre">struct</span></code> for input.</p>
<p>There are two variants of such a design:</p>
<ul>
<li>A large struct with fields for all info. As we can see with
<code class="docutils literal notranslate"><span class="pre">PyTypeObject</span></code>, most of such a struct tends to be NULLs in practice.
As more fields become obsolete, either the wastage grows, or we introduce new
struct layouts (while keeping compatibility with the old ones for a while).</li>
<li>A small struct with only the info necessary for initial creation, with other
info added afterwards (with dedicated function calls, or Python-level
<code class="docutils literal notranslate"><span class="pre">setattr</span></code>). This design:<ul class="simple">
<li>makes it cumbersome to add/obsolete/adjust the required info (for example,
in <a class="pep reference internal" href="../pep-0697/" title="PEP 697 – Limited C API for Extending Opaque Types">PEP 697</a> I gave meaning to negative values of an existing field;
adding a new field would be cleaner in similar situations);</li>
<li>increases the number of API calls between an extension and the interpreter.</li>
</ul>
<p>We believe that “batch” API for type/module creation makes sense,
even if it partially duplicates an API to modify “live” objects.</p>
</li>
</ul>
</section>
<section id="using-slots-only">
<h3><a class="toc-backref" href="#using-slots-only" role="doc-backlink">Using slots <em>only</em></a></h3>
<p>The classes <code class="docutils literal notranslate"><span class="pre">PyType_Spec</span></code> and <code class="docutils literal notranslate"><span class="pre">PyModuleDef</span></code> have explicit fields
in addition to a slots array. These include:</p>
<ul class="simple">
<li>Required information, such as the class name (<code class="docutils literal notranslate"><span class="pre">PyType_Spec.name</span></code>).
This proposal adds a <em>slot</em> ID for the name, and makes it required.</li>
<li>Non-pointers (<code class="docutils literal notranslate"><span class="pre">basicsize</span></code>, <code class="docutils literal notranslate"><span class="pre">flags</span></code>).
Originally, slots were intended to
only contain <em>function pointers</em>; they now contain <em>data pointers</em> as well as
integers or flags. This proposal uses a union to handle types cleanly.</li>
<li>Items added before the slots mechanism. The <code class="docutils literal notranslate"><span class="pre">PyModuleDef.m_slots</span></code>
itself was repurposed from <code class="docutils literal notranslate"><span class="pre">m_reload</span></code> which was always NULL;
the optional <code class="docutils literal notranslate"><span class="pre">m_traverse</span></code> or <code class="docutils literal notranslate"><span class="pre">m_methods</span></code> members predate it.</li>
</ul>
<p>We can do without these fields, and have <em>only</em> an array of slots.
A wrapper class around the array would complicate the design.
If fields in such a class ever become obsolete, they are hard to remove or
repurpose.</p>
</section>
<section id="nested-slot-tables">
<h3><a class="toc-backref" href="#nested-slot-tables" role="doc-backlink">Nested slot tables</a></h3>
<p>In this proposal, the array of slots can reference another array of slots,
which is treated as if it was merged into its “parent”, recursively.
This complicates slot handling inside the interpreter, but allows:</p>
<ul class="simple">
<li>Mixing dynamically allocated (or stack-allocated) slots with <code class="docutils literal notranslate"><span class="pre">static</span></code> ones.
This solves the issue that lead to the <code class="docutils literal notranslate"><span class="pre">PyType_From*</span></code> family of
functions expanding with values that typically can’t  be <code class="docutils literal notranslate"><span class="pre">static</span></code>.
For example, the <em>module</em> argument to <a class="reference external" href="https://docs.python.org/3/c-api/type.html#c.PyType_FromModuleAndSpec" title="(in Python v3.14)"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyType_FromModuleAndSpec()</span></code></a>
should be a heap-allocated module object.</li>
<li>Sharing a subset of the slots to implement functionality
common to several classes/modules.</li>
<li>Easily including some slots conditionally, e.g. based on the Python version.</li>
</ul>
</section>
<section id="nested-legacy-slot-tables">
<h3><a class="toc-backref" href="#nested-legacy-slot-tables" role="doc-backlink">Nested “legacy” slot tables</a></h3>
<p>Similarly to nested arrays of <code class="docutils literal notranslate"><span class="pre">PyType_Slot</span></code>, we also propose supporting
arrays of “legacy” slots (<code class="docutils literal notranslate"><span class="pre">PyType_Slot</span></code> and <code class="docutils literal notranslate"><span class="pre">PyModuleDef_Slot</span></code>) in
the “new” slots, and vice versa.</p>
<p>This way, users can reuse code they already have written without
rewriting/reformatting,
and only use the “new” slots if they need any new features.</p>
</section>
<section id="fixed-width-integers">
<h3><a class="toc-backref" href="#fixed-width-integers" role="doc-backlink">Fixed-width integers</a></h3>
<p>This proposal uses fixed-width integers (<code class="docutils literal notranslate"><span class="pre">uint16_t</span></code>) for slot IDs and
flags.
With the C <code class="docutils literal notranslate"><span class="pre">int</span></code> type, using more than 16 bits would not be portable,
but it would silently work on common platforms.
Using <code class="docutils literal notranslate"><span class="pre">int</span></code> but avoiding values over <code class="docutils literal notranslate"><span class="pre">UINT16_MAX</span></code> wastes 16 bits
on common platforms.</p>
</section>
<section id="memory-layout">
<h3><a class="toc-backref" href="#memory-layout" role="doc-backlink">Memory layout</a></h3>
<p>On common 64-bit platforms, we can keep the size of the new struct the same
as the existing <code class="docutils literal notranslate"><span class="pre">PyType_Slot</span></code> and <code class="docutils literal notranslate"><span class="pre">PyModuleDef_Slot</span></code>. (The existing
struct waste 6 out of 16 bytes due to <code class="docutils literal notranslate"><span class="pre">int</span></code> portability and padding;
this proposal puts some of those bits to use for new features.)
On 32-bit platforms, this proposal calls for the same layout as on 64-bit,
doubling the size compared to the existing structs (from 8 bytes to 16).
For “configuration” data that’s usually <code class="docutils literal notranslate"><span class="pre">static</span></code>, it should be OK.</p>
<p>The proposal does not use bit-fields and enums, whose memory representation is
compiler-dependent, causing issues when using the API from languages other
than C.</p>
<p>The structure is laid out assuming that a type’s alignment matches its size.</p>
</section>
<section id="single-id-space">
<h3><a class="toc-backref" href="#single-id-space" role="doc-backlink">Single ID space</a></h3>
<p>Currently, the numeric values of <em>module</em> and <em>type</em> slots overlap:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_bf_getbuffer</span></code> == <code class="docutils literal notranslate"><span class="pre">Py_mod_create</span></code> == 1</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_bf_releasebuffer</span></code> == <code class="docutils literal notranslate"><span class="pre">Py_mod_exec</span></code> == 2</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mp_ass_subscript</span></code> == <code class="docutils literal notranslate"><span class="pre">Py_mod_multiple_interpreters</span></code> == 3</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mp_length</span></code> == <code class="docutils literal notranslate"><span class="pre">Py_mod_gil</span></code> == 4</li>
<li>and similar for module slots added in CPython 3.15</li>
</ul>
<p>This proposal use a single sequence for both, so future slots avoid this
overlap. This is to:</p>
<ul class="simple">
<li>Avoid <em>accidentally</em> using type slots for modules, and vice versa</li>
<li>Allow external libraries or checkers to determine a slot’s meaning
(and type) based on the ID.</li>
</ul>
<p>The 4 existing overlaps means we don’t reach these goals right now,
but we can gradually migrate to new numeric IDs in a way that’s transparent
to the user.</p>
<p>The main disadvantage is that any internal lookup tables will be either bigger
(if we use separate ones for types &amp; modules, so they’ll contain blanks),
or harder to manage (if they’re merged).</p>
</section>
<section id="deprecation-warnings">
<h3><a class="toc-backref" href="#deprecation-warnings" role="doc-backlink">Deprecation warnings</a></h3>
<p>Multiple slots are documented to not allow NULL values, but CPython allows
NULL for backwards compatibility.
Similarly, multiple slot IDs should not appear more than once in a single
array, but CPython allows such duplicates.</p>
<p>This is a maintenance issue, as CPython should preserve its undocumented
(and often untested) behaviour in these cases as the implementation is changed.</p>
<p>It also prevents API extensions.
For example, instead of adding the <a class="reference external" href="https://docs.python.org/3/c-api/typeobj.html#c.Py_TPFLAGS_DISALLOW_INSTANTIATION" title="(in Python v3.14)"><code class="xref c c-macro docutils literal notranslate"><span class="pre">Py_TPFLAGS_DISALLOW_INSTANTIATION</span></code></a>
flag in 3.10, we could have allowed settning the <code class="docutils literal notranslate"><span class="pre">Py_tp_new</span></code> slot to NULL for
the same effect.</p>
<p>To allow changing the edge case behaviour in the (far) future,
and to allow freedom for possible alternative implementations of the C API,
we’ll start issuing runtime deprecation warnings in these cases.</p>
</section>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>A new <code class="docutils literal notranslate"><span class="pre">PySlot</span></code> structure will be defined as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PySlot</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">sl_id</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">sl_flags</span><span class="p">;</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">_sl_reserved</span><span class="p">;</span><span class="w">  </span><span class="c1">// must be 0</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sl_ptr</span><span class="p">;</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sl_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="w">        </span><span class="n">Py_ssize_t</span><span class="w"> </span><span class="n">sl_size</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">sl_int64</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sl_uint64</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span><span class="w"> </span><span class="n">PySlot</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">sl_id</span></code>: A slot number, identifying what the slot does.</li>
<li><code class="docutils literal notranslate"><span class="pre">sl_flags</span></code>: Flags, defined below.</li>
<li>32 bits reserved for future extensions (expected to be enabled by
future flags).</li>
<li>An union with the data, whose type depends on the slot.</li>
</ul>
<section id="new-api">
<h3><a class="toc-backref" href="#new-api" role="doc-backlink">New API</a></h3>
<p>The following function will be added.
It will create the corresponding Python type object from the given
array of slots:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="nf">PyType_FromSlots</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">PySlot</span><span class="w"> </span><span class="o">*</span><span class="n">slots</span><span class="p">);</span>
</pre></div>
</div>
<p>With this function, the <code class="docutils literal notranslate"><span class="pre">Py_tp_token</span></code> slot may not be set to
<code class="docutils literal notranslate"><span class="pre">Py_TP_USE_SPEC</span></code> (i.e. <code class="docutils literal notranslate"><span class="pre">NULL</span></code>).</p>
</section>
<section id="changed-api">
<h3><a class="toc-backref" href="#changed-api" role="doc-backlink">Changed API</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">PyModule_FromSlotsAndSpec</span></code> function (added in CPython 3.15 in
<a class="pep reference internal" href="../pep-0793/" title="PEP 793 – PyModExport: A new entry point for C extension modules">PEP 793</a>) will be <em>changed</em> to take the new slot structure:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">PyModule_FromSlotsAndSpec</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">PySlot</span><span class="w"> </span><span class="o">*</span><span class="n">slots</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">spec</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference external" href="https://docs.python.org/3.15/c-api/extension-modules.html#extension-export-hook" title="(in Python v3.15)"><span class="xref std std-ref">extension module export hook</span></a>
added in <a class="pep reference internal" href="../pep-0793/" title="PEP 793 – PyModExport: A new entry point for C extension modules">PEP 793</a> (<code class="samp docutils literal notranslate"><span class="pre">PyModExport_</span><em><span class="pre">&lt;name&gt;</span></em></code>) will be <em>changed</em> to
return the new slot structure.
The <a class="reference external" href="https://docs.python.org/3.15/c-api/extension-modules.html#c.PyMODEXPORT_FUNC" title="(in Python v3.15)"><code class="xref c c-macro docutils literal notranslate"><span class="pre">PyMODEXPORT_FUNC</span></code></a> macro will
be updated accordingly.</p>
</section>
<section id="general-slot-semantics">
<h3><a class="toc-backref" href="#general-slot-semantics" role="doc-backlink">General slot semantics</a></h3>
<p>When slots are passed to a function that applies them, the function will not
modify the slot array, nor any data it points to (recursively).</p>
<p>After the function is done, the user is allowed to modify or deallocate the
array, and any data it points to (recursively), unless it’s explicitly marked
as “static” (see <code class="docutils literal notranslate"><span class="pre">PySlot_STATIC</span></code> below).
This means the interpreter typically needs to make a copy of all data
in the struct, including <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*</span></code> text.</p>
</section>
<section id="flags">
<h3><a class="toc-backref" href="#flags" role="doc-backlink">Flags</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">sl_flags</span></code> may set the following bits. Unassigned bits must be set to zero.</p>
<ul>
<li><code class="docutils literal notranslate"><span class="pre">PySlot_OPTIONAL</span></code>: If the slot ID is unknown, the interpreter should
ignore the slot entirely. (For example, if <code class="docutils literal notranslate"><span class="pre">nb_matrix_multiply</span></code> was being
added to CPython now, your type could use this.)</li>
<li><code class="docutils literal notranslate"><span class="pre">PySlot_STATIC</span></code>: All data the slot points to is statically allocated
and constant.
Thus, the interpreter does not need to copy the information.
This flag is implied for function pointers.<p>The flag applies even to data the slot points to “indirectly”, except for
nested slots – see <a class="reference internal" href="#pep820-nested-tables"><span class="std std-ref">Nested slot tables</span></a> below – which can have their
own <code class="docutils literal notranslate"><span class="pre">PySlot_STATIC</span></code> flag.
For example, if applied to a <code class="docutils literal notranslate"><span class="pre">Py_tp_members</span></code> slot that points to an
<em>array</em> of <code class="docutils literal notranslate"><span class="pre">PyMemberDef</span></code> structures, then the entire array, as well as the
<code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">doc</span></code> strings in its elements, must be static and constant.</p>
</li>
<li><code class="docutils literal notranslate"><span class="pre">PySlot_HAS_FALLBACK</span></code>: If the slot ID is unknown, the interpreter will
ignore the slot.
If it’s known, the interpreter should ignore subsequent slots up to
(and including) the first one without HAS_FALLBACK.<p>Effectively, consecutive slots with the HAS_FALLBACK flag, plus the first
non-HAS_FALLBACK slot after them, form a “block” where the the interpreter
will only consider the <em>first</em> slot in the block that it understands.
If the entire block is to be optional, it should end with a
slot with the OPTIONAL flag.</p>
</li>
<li><code class="docutils literal notranslate"><span class="pre">PySlot_INTPTR</span></code>: The data is stored in <code class="docutils literal notranslate"><span class="pre">sl_ptr</span></code>, and must be cast to
the appropriate type.<p>This flag simplifies porting from the existing <code class="docutils literal notranslate"><span class="pre">PyType_Slot</span></code> and
<code class="docutils literal notranslate"><span class="pre">PyModuleDef_Slot</span></code>, where all slots work this way.</p>
</li>
</ul>
</section>
<section id="convenience-macros">
<h3><a class="toc-backref" href="#convenience-macros" role="doc-backlink">Convenience macros</a></h3>
<p>The following macros will be added to the API to simplify slot definition:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PySlot_DATA(NAME, VALUE) \</span>
<span class="cp">   {.sl_id=NAME, .sl_ptr=(void*)(VALUE)}</span>

<span class="cp">#define PySlot_FUNC(NAME, VALUE) \</span>
<span class="cp">   {.sl_id=NAME, .sl_func=(VALUE)}</span>

<span class="cp">#define PySlot_SIZE(NAME, VALUE) \</span>
<span class="cp">   {.sl_id=NAME, .sl_size=(VALUE)}</span>

<span class="cp">#define PySlot_INT64(NAME, VALUE) \</span>
<span class="cp">   {.sl_id=NAME, .sl_int64=(VALUE)}</span>

<span class="cp">#define PySlot_UINT64(NAME, VALUE) \</span>
<span class="cp">   {.sl_id=NAME, .sl_uint64=(VALUE)}</span>

<span class="cp">#define PySlot_STATIC_DATA(NAME, VALUE) \</span>
<span class="cp">   {.sl_id=NAME, .sl_flags=PySlot_STATIC, .sl_ptr=(VALUE)}</span>

<span class="cp">#define PySlot_END {0}</span>
</pre></div>
</div>
<p>We’ll also add two more macros that avoid named initializers,
for use in C++11-compatibile code.
Note that these cast the value to <code class="docutils literal notranslate"><span class="pre">void*</span></code>, so they do not improve type safety
over existing slots:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PySlot_PTR(NAME, VALUE) \</span>
<span class="cp">   {NAME, PySlot_INTPTR, {0}, {(void*)(VALUE)}}</span>

<span class="cp">#define PySlot_PTR_STATIC(NAME, VALUE) \</span>
<span class="cp">   {NAME, PySlot_INTPTR|Py_SLOT_STATIC, {0}, {(void*)(VALUE)}}</span>
</pre></div>
</div>
</section>
<section id="pep820-nested-tables">
<span id="id1"></span><h3><a class="toc-backref" href="#pep820-nested-tables" role="doc-backlink">Nested slot tables</a></h3>
<p>A new slot, <code class="docutils literal notranslate"><span class="pre">Py_slot_subslots</span></code>, will be added to allow nesting slot tables.
Its value (<code class="docutils literal notranslate"><span class="pre">sl_ptr</span></code>) should point to an array of <code class="docutils literal notranslate"><span class="pre">PySlot</span></code> structures,
which will be treated as if they were part of the current slot array.
<code class="docutils literal notranslate"><span class="pre">sl_ptr</span></code> can be <code class="docutils literal notranslate"><span class="pre">NULL</span></code> to indicate that there are no slots.</p>
<p>Two more slots will allow similar nesting for existing slot structures:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_tp_slots</span></code> for an array of <code class="docutils literal notranslate"><span class="pre">PyType_Slot</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_slots</span></code> for an array of <code class="docutils literal notranslate"><span class="pre">PyModuleDef_Slot</span></code></li>
</ul>
<p>Each <code class="docutils literal notranslate"><span class="pre">PyType_Slot</span></code> in the array will be converted to
<code class="docutils literal notranslate"><span class="pre">(PySlot){.sl_id=slot,</span> <span class="pre">.sl_flags=PySlot_INTPTR,</span> <span class="pre">.sl_ptr=func}</span></code>,
and similar with <code class="docutils literal notranslate"><span class="pre">PyModuleDef_Slot</span></code>.</p>
<p>The initial implementation will have restrictions that may be lifted
in the future:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_slot_subslots</span></code>, <code class="docutils literal notranslate"><span class="pre">Py_tp_slots</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_mod_slots</span></code> cannot use
<code class="docutils literal notranslate"><span class="pre">PySlot_HAS_FALLBACK</span></code> (the flag cannot be set on them nor a slot that
precedes them).</li>
<li>Nesting depth will be limited to 5 levels.</li>
</ul>
</section>
<section id="new-slot-ids">
<h3><a class="toc-backref" href="#new-slot-ids" role="doc-backlink">New slot IDs</a></h3>
<p>The following new slot IDs, usable for both type and module
definitions, will be added:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_slot_end</span></code> (defined as <code class="docutils literal notranslate"><span class="pre">0</span></code>): Marks the end of a slots array.<ul>
<li>The <code class="docutils literal notranslate"><span class="pre">PySlot_INTPTR</span></code> and <code class="docutils literal notranslate"><span class="pre">PySlot_STATIC</span></code> flags are ignored.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">PySlot_OPTIONAL</span></code> and <code class="docutils literal notranslate"><span class="pre">PySlot_HAS_FALLBACK</span></code> flags are not
allowed with <code class="docutils literal notranslate"><span class="pre">Py_slot_end</span></code>.</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_slot_subslots</span></code>, <code class="docutils literal notranslate"><span class="pre">Py_tp_slots</span></code>, <code class="docutils literal notranslate"><span class="pre">Py_mod_slots</span></code>: see
<a class="reference internal" href="#pep820-nested-tables"><span class="std std-ref">Nested slot tables</span></a> above</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_slot_invalid</span></code> (defined as <code class="docutils literal notranslate"><span class="pre">UINT16_MAX</span></code>, i.e. <code class="docutils literal notranslate"><span class="pre">-1</span></code>): treated as an
unknown slot ID.</li>
</ul>
<p>The following new slot IDs will be added to cover existing
members of <code class="docutils literal notranslate"><span class="pre">PyModuleDef</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_tp_name</span></code> (mandatory for type creation)</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_tp_basicsize</span></code> (of type <code class="docutils literal notranslate"><span class="pre">Py_ssize_t</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_tp_extra_basicsize</span></code> (equivalent to setting <code class="docutils literal notranslate"><span class="pre">PyType_Spec.basicsize</span></code>
to <code class="docutils literal notranslate"><span class="pre">-extra_basicsize</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_tp_itemsize</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_tp_flags</span></code></li>
</ul>
<p>The following new slot IDs will be added to cover
arguments of <code class="docutils literal notranslate"><span class="pre">PyType_FromMetaclass</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_tp_metaclass</span></code> (used to set <code class="docutils literal notranslate"><span class="pre">ob_type</span></code> after metaclass calculation)</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_tp_module</span></code></li>
</ul>
<p>Note that <code class="docutils literal notranslate"><span class="pre">Py_tp_base</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_tp_bases</span></code> already exist.
The interpreter will treat them identically: either can specify a class
object or a tuple of them.
<code class="docutils literal notranslate"><span class="pre">Py_tp_base</span></code> will be soft-deprecated in favour of <code class="docutils literal notranslate"><span class="pre">Py_tp_bases</span></code>.
Specifying both in a single definition will be deprecated (currently,
<code class="docutils literal notranslate"><span class="pre">Py_tp_bases</span></code> overrides <code class="docutils literal notranslate"><span class="pre">Py_tp_base</span></code>).</p>
<p>None of the new slots will be usable with <code class="docutils literal notranslate"><span class="pre">PyType_GetSlot</span></code>.
(This limitation may be lifted in the future, with C API WG approval.)</p>
<p>Of the new slots, only <code class="docutils literal notranslate"><span class="pre">Py_slot_end</span></code>, <code class="docutils literal notranslate"><span class="pre">Py_slot_subslots</span></code>, <code class="docutils literal notranslate"><span class="pre">Py_tp_slots</span></code>,
<code class="docutils literal notranslate"><span class="pre">Py_mod_slots</span></code> will be allowed in <code class="docutils literal notranslate"><span class="pre">PyType_Spec</span></code> and/or <code class="docutils literal notranslate"><span class="pre">PyModuleDef</span></code>.</p>
</section>
<section id="slot-renumbering">
<h3><a class="toc-backref" href="#slot-renumbering" role="doc-backlink">Slot renumbering</a></h3>
<p>New slots IDs will have unique numeric values (that is, <code class="docutils literal notranslate"><span class="pre">Py_slot_*</span></code>,
<code class="docutils literal notranslate"><span class="pre">Py_tp_*</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_mod_*</span></code> won’t share IDs).</p>
<p>Slots numbered 1 through 4 (<code class="docutils literal notranslate"><span class="pre">Py_bf_getbuffer</span></code>…<code class="docutils literal notranslate"><span class="pre">Py_mp_length</span></code> and
<code class="docutils literal notranslate"><span class="pre">Py_mod_create</span></code>…<code class="docutils literal notranslate"><span class="pre">Py_mod_gil</span></code>) will be redefined as new
(larger) numbers.
The old numbers will remain as aliases, and will be used when compiling for
Stable ABI versions below 3.15.</p>
<p>Slots for members of <code class="docutils literal notranslate"><span class="pre">PyModuleDef</span></code>, which were added in
<a class="reference internal" href="../pep-0793/#pep793-api-summary"><span class="std std-ref">PEP 793</span></a>, will be renumbered so that they have
unique IDs:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_name</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_doc</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_state_size</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_methods</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_state_traverse</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_state_clear</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_state_free</span></code></li>
</ul>
</section>
<section id="soft-deprecation">
<h3><a class="toc-backref" href="#soft-deprecation" role="doc-backlink">Soft deprecation</a></h3>
<p>These existing functions will be <a class="pep reference internal" href="../pep-0387/#soft-deprecation" title="PEP 387 – Backwards Compatibility Policy § Soft Deprecation">soft-deprecated</a>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">PyType_FromSpec</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PyType_FromSpecWithBases</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PyType_FromModuleAndSpec</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PyType_FromMetaclass</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PyModule_FromDefAndSpec</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PyModule_FromDefAndSpec2</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PyModule_ExecDef</span></code></li>
</ul>
<p>(As a reminder: soft-deprecated API is not scheduled for removal, does not
raise warnings, and remains documented and tested. However, no new
functionality will be added to it.)</p>
<p>Arrays of <code class="docutils literal notranslate"><span class="pre">PyType_Slot</span></code> or <code class="docutils literal notranslate"><span class="pre">PyModuleDef_Slot</span></code>, which are accepted by
these functions, can contain any slots, including “new” ones defined
in this PEP.
This includes nested “new-style” slots (<code class="docutils literal notranslate"><span class="pre">Py_slot_subslots</span></code>).</p>
</section>
<section id="pep820-hard-deprecations">
<span id="id2"></span><h3><a class="toc-backref" href="#pep820-hard-deprecations" role="doc-backlink">Deprecation warnings</a></h3>
<p>CPython will emit runtime deprecation warnings for the following cases,
for slots where the case is currently disallowed in documentation but allowed
by the runtime:</p>
<ul class="simple">
<li>setting a slot value to NULL:<ul>
<li>all type slots except <code class="docutils literal notranslate"><span class="pre">Py_tp_doc</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_create</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_exec</span></code></li>
</ul>
</li>
<li>repeating a slot ID in a single slots array (including sub-slot arrays
added in this PEP):<ul>
<li>all type slots, except slots where this is already a runtime error
(<code class="docutils literal notranslate"><span class="pre">Py_tp_doc</span></code>, <code class="docutils literal notranslate"><span class="pre">Py_tp_members</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_create</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_mod_abi</span></code></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>This PEP proposes to change API that was already released in alpha versions of
Python 3.15.
This will inconvenience early adopters of that API, but – as long as the
PEP is accepted and implemented before the first bety – this change is within
the letter and spirit of our backwards compatibility policy.</p>
<p>Renumbering of slots is done in a backwards-compatible way.
Old values continue to be accepted, and are used when compiling for
earlier Stable ABI.</p>
<p>Some cases that are documented as illegal will begin emitting deprecation
warnings (see <a class="reference internal" href="#pep820-hard-deprecations"><span class="std std-ref">Deprecation warnings</span></a>).</p>
<p>Otherwise, this PEP only adds and soft-deprecates APIs, which is backwards
compatible.</p>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications" role="doc-backlink">Security Implications</a></h2>
<p>None known</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>Adjust the “Extending and Embedding” tutorial to use this.</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>Draft implementation is available as <a class="reference external" href="https://github.com/encukou/cpython/pull/37">pull request #37 in the author’s fork</a>.</p>
</section>
<section id="rejected-ideas">
<h2><a class="toc-backref" href="#rejected-ideas" role="doc-backlink">Rejected Ideas</a></h2>
<p>See the <a class="reference internal" href="#pep820-rationale"><span class="std std-ref">Rationale</span></a> section for several alternative ideas.</p>
<section id="third-party-slot-id-allocation">
<h3><a class="toc-backref" href="#third-party-slot-id-allocation" role="doc-backlink">Third-party slot ID allocation</a></h3>
<p>It was suggested to allow third parties to reserve slot IDs for their own use.
This would be mainly useful for alternate implementations. For example,
something like GraalPy might want custom type slots (e.g. an “inherits
from this Java class” slot).
Similarly, at one point PyPy had an extra <code class="docutils literal notranslate"><span class="pre">tp_pypy_flags</span></code> in their
typeobject struct.</p>
<p>This PEP does not specify a namespace mechanism.
One can be added in the future.
We’re also free to reserve individual slot IDs for alternate implementations.</p>
<p>Note that slots are not a good way for <em>extension modules</em> to add extra data
to types or modules, as there is no API to retrieve the slots used to create
a specific object.</p>
</section>
<section id="avoiding-anonymous-unions">
<h3><a class="toc-backref" href="#avoiding-anonymous-unions" role="doc-backlink">Avoiding anonymous unions</a></h3>
<p>This PEP proposes a struct with <em>anonymous unions</em>, which are not yet used in
CPython’s documented public API.</p>
<p>There is no known issue with adding these, but the following notes may
be relevant:</p>
<ul>
<li>Anonymous unions are only supported in C since C11.
But, CPython already requires the feature, and uses it for internal members
of the <code class="docutils literal notranslate"><span class="pre">PyObject</span></code> struct.</li>
<li>Until C++20, which adds C-style designated initializers, C++ initializers
only allow setting the first member of a union.
However, this is an issue for <em>named</em> unions as well.
Avoiding unions entirely would mean losing most of the type-safety
improvements of this PEP.<p>Note that the proposed flag <code class="docutils literal notranslate"><span class="pre">PySlot_INTPTR</span></code>, and the workaround macros
<code class="docutils literal notranslate"><span class="pre">PySlot_PTR</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">PySlot_PTR_STATIC</span></code>, allow using this API in
code that needs to be compatible with C++11 or has similar union-related
limitations.</p>
</li>
<li>C++ doesn’t have anonymous <em>structs</em>.
This might surprise C programmers for whom anonymous structs/unions are
a single language feature.</li>
<li>Non-C/C++ language wrappers may need to give the union a name.
This is fine.
(Dear reader: if you need this, please open a CPython issue about
exposing a preferred name in headers and documentation.)</li>
</ul>
<p>For a bigger picture: anonymous unions can be a helpful tool for implemeting
tagged unions and for evolving public API in backwards-compatible ways.
This PEP intentionally opens the door to using them more often.</p>
</section>
</section>
<section id="open-issues">
<h2><a class="toc-backref" href="#open-issues" role="doc-backlink">Open Issues</a></h2>
<p>None yet.</p>
</section>
<section id="acknowledgements">
<h2><a class="toc-backref" href="#acknowledgements" role="doc-backlink">Acknowledgements</a></h2>
<p>Thanks to Da Woods, Antoine Pitrou and Mark Shannon
for substantial input on this iteration of the proposal.</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0820.rst">https://github.com/python/peps/blob/main/peps/pep-0820.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0820.rst">2026-01-28 20:35:29 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#using-slots">Using slots</a></li>
<li><a class="reference internal" href="#using-slots-only">Using slots <em>only</em></a></li>
<li><a class="reference internal" href="#nested-slot-tables">Nested slot tables</a></li>
<li><a class="reference internal" href="#nested-legacy-slot-tables">Nested “legacy” slot tables</a></li>
<li><a class="reference internal" href="#fixed-width-integers">Fixed-width integers</a></li>
<li><a class="reference internal" href="#memory-layout">Memory layout</a></li>
<li><a class="reference internal" href="#single-id-space">Single ID space</a></li>
<li><a class="reference internal" href="#deprecation-warnings">Deprecation warnings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#new-api">New API</a></li>
<li><a class="reference internal" href="#changed-api">Changed API</a></li>
<li><a class="reference internal" href="#general-slot-semantics">General slot semantics</a></li>
<li><a class="reference internal" href="#flags">Flags</a></li>
<li><a class="reference internal" href="#convenience-macros">Convenience macros</a></li>
<li><a class="reference internal" href="#pep820-nested-tables">Nested slot tables</a></li>
<li><a class="reference internal" href="#new-slot-ids">New slot IDs</a></li>
<li><a class="reference internal" href="#slot-renumbering">Slot renumbering</a></li>
<li><a class="reference internal" href="#soft-deprecation">Soft deprecation</a></li>
<li><a class="reference internal" href="#pep820-hard-deprecations">Deprecation warnings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#third-party-slot-id-allocation">Third-party slot ID allocation</a></li>
<li><a class="reference internal" href="#avoiding-anonymous-unions">Avoiding anonymous unions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0820.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>