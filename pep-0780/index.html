
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 780 – ABI features as environment markers | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0780/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 780 – ABI features as environment markers | peps.python.org'>
    <meta property="og:description" content="This PEP defines using ABI features as environment markers for project dependencies, through a new sys_abi_features environment marker. PEP 508 (later moved to packaging:dependency-specifiers) introduced environment markers to specify dependencies based...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0780/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="This PEP defines using ABI features as environment markers for project dependencies, through a new sys_abi_features environment marker. PEP 508 (later moved to packaging:dependency-specifiers) introduced environment markers to specify dependencies based...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 780</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 780 – ABI features as environment markers" data-pagefind-weight="10" class="visually-hidden">PEP 780 – ABI features as environment markers</span>
            <section id="pep-content">
<h1 class="page-title">PEP 780 – ABI features as environment markers</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Klaus Zimmermann &lt;klaus_zimmermann&#32;&#97;t&#32;gmx.de&gt;,
Ralf Gommers &lt;ralf.gommers&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Sponsor<span class="colon">:</span></dt>
<dd class="field-even">Lysandros Nikolaou &lt;lisandrosnik&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-odd">Discussions-To<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/86013">Discourse thread</a></dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Topic<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="../topic/packaging/">Packaging</a></dd>
<dt class="field-odd">Created<span class="colon">:</span></dt>
<dd class="field-odd">21-Mar-2025</dd>
<dt class="field-even">Python-Version<span class="colon">:</span></dt>
<dd class="field-even">3.14</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/60007" title="Discourse thread">05-Aug-2024</a>,
<a class="reference external" href="https://discuss.python.org/t/86013" title="Discourse thread">26-Mar-2025</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#a-forward-looking-view-on-free-threaded-python">A Forward Looking View on Free-Threaded Python</a></li>
<li><a class="reference internal" href="#relation-to-other-peps">Relation to Other PEPs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#abi-features">ABI Features</a></li>
<li><a class="reference internal" href="#the-sys-abi-features-environment-marker">The <code class="docutils literal notranslate"><span class="pre">sys_abi_features</span></code> Environment Marker</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#require-cython-pre-release-for-free-threaded-python">Require Cython Pre-release for Free-Threaded Python</a></li>
<li><a class="reference internal" href="#require-scipy-unless-on-32-bit-win32">Require SciPy Unless on 32-bit <code class="docutils literal notranslate"><span class="pre">win32</span></code></a></li>
<li><a class="reference internal" href="#require-numpy-for-a-free-threaded-interpreter-with-debugging-capabilities">Require NumPy for a Free-Threaded Interpreter With Debugging Capabilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a><ul>
<li><a class="reference internal" href="#audit-and-update-tools">Audit and Update Tools</a></li>
</ul>
</li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#extension-mechanism">Extension Mechanism</a></li>
</ul>
</li>
<li><a class="reference internal" href="#open-issues">Open Issues</a><ul>
<li><a class="reference internal" href="#other-environment-markers">Other Environment Markers</a></li>
<li><a class="reference internal" href="#other-tooling">Other Tooling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#footnotes">Footnotes</a></li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>This PEP defines using ABI features as environment markers for project
dependencies, through a new <code class="docutils literal notranslate"><span class="pre">sys_abi_features</span></code> environment marker. <a class="pep reference internal" href="../pep-0508/" title="PEP 508 – Dependency specification for Python Software Packages">PEP 508</a>
(later moved to <a class="reference external" href="https://packaging.python.org/en/latest/specifications/dependency-specifiers/#dependency-specifiers" title="(in Python Packaging User Guide)"><span>Dependency specifiers</span></a>) introduced environment
markers to specify dependencies based on rules that describe when the
dependency should be used. This PEP extends the environment markers to allow
specifying dependencies based on specific ABI features of the Python
interpreter. For this, it defines a set of <a class="reference internal" href="#abi-features">ABI Features</a> and specifies how
they are made available for <a class="reference internal" href="#pep-780-sys-abi-features">environment markers</a>
as a new marker variable, <code class="docutils literal notranslate"><span class="pre">sys_abi_features</span></code>.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>In 2015, <a class="pep reference internal" href="../pep-0508/" title="PEP 508 – Dependency specification for Python Software Packages">PEP 508</a> established environment markers to specify dependencies
based on environment conditions. The development of free-threaded CPython
<a class="footnote-reference brackets" href="#python-free-threading" id="id1">[1]</a> has underlined the need for an environment marker to
discriminate between different ABI features that the interpreter was built
with. For example, currently there is no way to distinguish between a
GIL-enabled and a free-threaded CPython interpreter with an environment marker.
This leads to real world issues for the adoption of free-threading and its
incremental rollout. When a Python package is being made compatible with
free-threaded CPython, it also needs all its build and runtime dependencies to
be compatible. Capturing the first version of a dependency that is compatible
precisely in metadata is currently not possible, and increasing the minimum
version of a dependency also for the GIL-enabled build is usually undesirable
since it unnecessarily limits compatibility between packages.</p>
<p>Some concrete examples of such issues have been discussed in the <a class="reference external" href="https://discuss.python.org/t/environment-marker-for-free-threading/60007">Environment
marker for free-threading</a> Discourse thread:</p>
<ul class="simple">
<li>Cython has (experimental) support for free-threading only in its master
branch, and is used by a lot of projects that already publish <code class="docutils literal notranslate"><span class="pre">cp313t</span></code>
wheels. Picking up the wrong Cython version is causing a lot of obscure build
failures and runtime crashes. It would be beneficial if the metadata could
express that (c.f. <a class="reference internal" href="#require-cython-pre-release-for-free-threaded-python">Require Cython Pre-release for Free-Threaded Python</a>).</li>
<li>CFFI has no support for free-threading yet, and <a class="reference external" href="https://github.com/python-cffi/cffi/pull/143#issuecomment-2580781899">Armin Rigo, one of the
maintainers, has stated</a>
that it may be a good idea to fork <code class="docutils literal notranslate"><span class="pre">cffi</span></code>, implement support for
free-threading, and only come back to the CFFI project with a single large PR
that adds support after the functionality “is reasonably well-tested (either
as tests or, better in this case, tested by being in use in various other
projects)”. There are a lot of projects that depend on <code class="docutils literal notranslate"><span class="pre">cffi</span></code>. They are
likely fine to start depending on a fork for free-threading only, however
depending on a fork for &gt;=3.13 or for all Python versions seems like a much
larger ask, and more disruptive for distribution packagers.</li>
</ul>
<p>While these concrete examples may be addressed later this year by Cython and
CFFI making compatible releases, the same issue is going to repeat further up
the stack. The free-threading rollout is expected to take several years, and an
environment marker for free-threading will make that rollout significantly
easier.</p>
<p>Another important ABI feature that is not yet covered by environment markers is
the bitness of the interpreter. In most cases, the <code class="docutils literal notranslate"><span class="pre">sys_platform</span></code> or
<code class="docutils literal notranslate"><span class="pre">platform_system</span></code> markers are enough, because there is only a single bitness
in use per platform. This is not the case on Windows however: both 32-bit and
64-bit Python interpreters are widely used on x86-64 Windows. Not being able to
distinguish between the two may be relevant for packages that provide compiled
extensions. For example, SciPy does not provide <code class="docutils literal notranslate"><span class="pre">win32</span></code> wheels (it isn’t able
to due to the lack of a suitable 32-bit compiler toolchain with Fortran
support). Those wheels lacking can be awkward especially for projects where
SciPy is an optional dependency only. In that case, it would be useful to be
able to specify that SciPy is required <em>unless</em> the interpreter is a 32-bit one
on Windows (c.f. <a class="reference internal" href="#require-scipy-unless-on-32-bit-win32">Require SciPy Unless on 32-bit win32</a>), to avoid failed
from-source installations due to the missing wheels.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>The intention of this PEP is to introduce its core features with minimal impact
on the existing ecosystem. The existing grammar proposed in <a class="pep reference internal" href="../pep-0508/" title="PEP 508 – Dependency specification for Python Software Packages">PEP 508</a> lends
itself to a straightforward extension to include the new environment marker.</p>
<section id="a-forward-looking-view-on-free-threaded-python">
<h3><a class="toc-backref" href="#a-forward-looking-view-on-free-threaded-python" role="doc-backlink">A Forward Looking View on Free-Threaded Python</a></h3>
<p><a class="pep reference internal" href="../pep-0703/" title="PEP 703 – Making the Global Interpreter Lock Optional in CPython">PEP 703</a>, the accepted proposal for free threading, states that the rollout
of free-threaded Python should be gradual, which has been clarified by the
Python Steering Council in <a class="reference external" href="https://discuss.python.org/t/pep-703-making-the-global-interpreter-lock-optional-in-cpython-acceptance/37075">the PEP 703 acceptance post</a> to mean a three stage
process over multiple releases. It is therefore important to make sure that the
mechanisms in this PEP are useable for Python interpreters where either
free-threading or non-free-threading could be the default or the only option.</p>
<p>At the time of writing, free-threaded Python is in Phase I: experimental phase.
In this phase, there is an acute need for the proposed environment markers to
help with the transition to free-threaded Python as package authors gradually
add support.</p>
<p>As the number of packages with support increases, and particularly during
Phase II: Supported-but-not-default phase, we still anticipate a strong need
for the environment markers to help with the transition.</p>
<p>As free-threaded Python enters into Phase III: Default phase, the need for the
environment markers will decrease, though at this point it is not clear that
the GIL-enabled Python will be completely phased out (it may remain available
as a non standard build option). If it persists, the inverse need for the ABI
feature detection may arise.</p>
<p>Indeed, in all three phases it may be necessary for package authors to choose
specific versions of their dependencies based on the ABI features, with a shift
from GIL-enabled as default to free-threading as default over time.</p>
<p>The ABI features are designed with this in mind to guarantee usefulness and
simplicity for the foreseeable future in a changing Python ecosystem.</p>
</section>
<section id="relation-to-other-peps">
<h3><a class="toc-backref" href="#relation-to-other-peps" role="doc-backlink">Relation to Other PEPs</a></h3>
<p>This PEP extends environment markers with set semantics for ABI features.
<a class="pep reference internal" href="../pep-0751/#additions-to-marker-expression-syntax" title="PEP 751 – A file format to record Python dependencies for installation reproducibility § Additions to marker expression syntax">PEP 751</a> includes a similar extension
for lock file specific environment markers; although the two have been
developed indepedently, they are compatible where they overlap in terms of the
new set semantics.</p>
</section>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>The keywords “<strong>MUST</strong>”, “<strong>MUST NOT</strong>”, “<strong>REQUIRED</strong>”, “<strong>SHALL</strong>”,
“<strong>SHALL NOT</strong>”, “<strong>SHOULD</strong>”, “<strong>SHOULD NOT</strong>”, “<strong>RECOMMENDED</strong>”, “<strong>MAY</strong>”,
and “<strong>OPTIONAL</strong>”” in this document are to be interpreted as described in
<span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc2119.html"><strong>RFC 2119</strong></a>.</p>
<section id="abi-features">
<h3><a class="toc-backref" href="#abi-features" role="doc-backlink">ABI Features</a></h3>
<p>ABI features are intrinsic properties of the Python interpreter, expressed as
simple, understandable strings. However, not all features are equally
applicable to all Python interpreters or Python versions. For example, the
distinction between free-threaded and GIL-enabled interpreters is only relevant
for CPython 3.13 onwards, but the bitness of the interpreter is relevant for
all interpreters.</p>
<p>All interpreters MUST handle the following ABI features as stated. ABI features
that are restricted to particular interpreters MUST NOT be provided by other
interpreters. The features are subdivided into groups and for each group there
MUST be exactly one feature present, except when the group is marked as
optional, in which case there MUST be at most one feature present.</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">free-threading</span></code> or <code class="docutils literal notranslate"><span class="pre">gil-enabled</span></code> (only CPython)</dt><dd>If the Python interpreter is free-threaded, the <code class="docutils literal notranslate"><span class="pre">free-threading</span></code> feature
MUST be present and the <code class="docutils literal notranslate"><span class="pre">gil-enabled</span></code> feature MUST NOT be present.
Otherwise, the <code class="docutils literal notranslate"><span class="pre">gil-enabled</span></code> feature MUST be present and the
<code class="docutils literal notranslate"><span class="pre">free-threading</span></code> feature MUST NOT be present.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">debug</span></code> (only CPython, optional)</dt><dd>This ABI feature is reserved for the <code class="docutils literal notranslate"><span class="pre">--with-pydebug</span></code> build of CPython.
If the interpreter is a CPython interpreter with <code class="docutils literal notranslate"><span class="pre">Py_DEBUG</span></code> capabilities,
the <code class="docutils literal notranslate"><span class="pre">debug</span></code> feature MUST be present. On POSIX systems, this corresponds
to the Python expression <code class="docutils literal notranslate"><span class="pre">&quot;d&quot;</span> <span class="pre">in</span> <span class="pre">sys.abiflags</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">32-bit</span></code> or <code class="docutils literal notranslate"><span class="pre">64-bit</span></code> (optional)</dt><dd>The bitness of the interpreter, that is, whether it is a 32-bit or 64-bit
build <a class="footnote-reference brackets" href="#bitness" id="id2">[2]</a>. If the bitness is unknown or neither 32-bit nor 64-bit,
this feature MUST NOT be present.</dd>
</dl>
</section>
<section id="the-sys-abi-features-environment-marker">
<span id="pep-780-sys-abi-features"></span><h3><a class="toc-backref" href="#the-sys-abi-features-environment-marker" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">sys_abi_features</span></code> Environment Marker</a></h3>
<p>To make ABI features available in dependency specifications, a new environment
marker variable, <code class="docutils literal notranslate"><span class="pre">sys_abi_features</span></code>, is added to the format of dependency
specifiers.</p>
<p>To do this, we need to extend the grammar laid out in <a class="pep reference internal" href="../pep-0508/" title="PEP 508 – Dependency specification for Python Software Packages">PEP 508</a> and maintained
in the <a class="reference external" href="https://packaging.python.org/en/latest/specifications/dependency-specifiers/#dependency-specifiers" title="(in Python Packaging User Guide)"><span>Dependency specifiers</span></a> and document the possible values.</p>
<p>The grammar is extended to include the <code class="docutils literal notranslate"><span class="pre">sys_abi_features</span></code> marker variable by
augmenting the definition of <code class="docutils literal notranslate"><span class="pre">env_var</span></code> as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env_var</span>       <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;python_version&#39;</span> <span class="o">|</span> <span class="s1">&#39;python_full_version&#39;</span> <span class="o">|</span>
                 <span class="s1">&#39;os_name&#39;</span> <span class="o">|</span> <span class="s1">&#39;sys_platform&#39;</span> <span class="o">|</span> <span class="s1">&#39;platform_release&#39;</span> <span class="o">|</span>
                 <span class="s1">&#39;platform_system&#39;</span> <span class="o">|</span> <span class="s1">&#39;platform_version&#39;</span> <span class="o">|</span>
                 <span class="s1">&#39;platform_machine&#39;</span> <span class="o">|</span> <span class="s1">&#39;platform_python_implementation&#39;</span> <span class="o">|</span>
                 <span class="s1">&#39;implementation_name&#39;</span> <span class="o">|</span> <span class="s1">&#39;implementation_version&#39;</span> <span class="o">|</span>
                 <span class="s1">&#39;sys_abi_features&#39;</span> <span class="o">|</span>
                 <span class="s1">&#39;extra&#39;</span> <span class="c1"># ONLY when defined by a containing layer</span>
                 <span class="p">)</span>
</pre></div>
</div>
<p>Like the grammar, also the overview table of environment markers in
<a class="reference external" href="https://packaging.python.org/en/latest/specifications/dependency-specifiers/#dependency-specifiers" title="(in Python Packaging User Guide)"><span>Dependency specifiers</span></a> is augmented to add the following row:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Marker</th>
<th class="head">Python equivalent</th>
<th class="head">Sample values</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">sys_abi_features</span></code></td>
<td>no direct equivalent available</td>
<td><code class="docutils literal notranslate"><span class="pre">{'free-threading',</span> <span class="pre">'64-bit'}</span></code>,
<code class="docutils literal notranslate"><span class="pre">{'gil-enabled',</span> <span class="pre">'debug',</span> <span class="pre">'32-bit'}</span></code></td>
</tr>
</tbody>
</table>
<p>With these additions, ABI features can be used in dependency specifications via
the <code class="docutils literal notranslate"><span class="pre">in</span></code> operator to test for the presence of a feature, or the <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">in</span></code>
operator to test for the absence of a feature.</p>
</section>
</section>
<section id="examples">
<h2><a class="toc-backref" href="#examples" role="doc-backlink">Examples</a></h2>
<section id="require-cython-pre-release-for-free-threaded-python">
<h3><a class="toc-backref" href="#require-cython-pre-release-for-free-threaded-python" role="doc-backlink">Require Cython Pre-release for Free-Threaded Python</a></h3>
<p>To require a pre-release of Cython only for a free-threaded Python interpreter,
the following dependency specification can be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cython</span> <span class="o">&gt;</span><span class="mf">3.1.0</span><span class="n">a1</span><span class="p">;</span> <span class="s2">&quot;free-threading&quot;</span> <span class="ow">in</span> <span class="n">sys_abi_features</span>
<span class="n">cython</span> <span class="o">==</span><span class="mf">3.0</span><span class="o">.*</span><span class="p">;</span> <span class="s2">&quot;free-threading&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_abi_features</span>
</pre></div>
</div>
</section>
<section id="require-scipy-unless-on-32-bit-win32">
<h3><a class="toc-backref" href="#require-scipy-unless-on-32-bit-win32" role="doc-backlink">Require SciPy Unless on 32-bit <code class="docutils literal notranslate"><span class="pre">win32</span></code></a></h3>
<p>To require SciPy unless on a 32-bit interpreter on Windows, the following
dependency specification can be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scipy</span><span class="p">;</span> <span class="n">platform_system</span> <span class="o">!=</span> <span class="s2">&quot;Windows&quot;</span> <span class="ow">or</span> <span class="s2">&quot;32-bit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_abi_features</span>
</pre></div>
</div>
</section>
<section id="require-numpy-for-a-free-threaded-interpreter-with-debugging-capabilities">
<h3><a class="toc-backref" href="#require-numpy-for-a-free-threaded-interpreter-with-debugging-capabilities" role="doc-backlink">Require NumPy for a Free-Threaded Interpreter With Debugging Capabilities</a></h3>
<p>To require NumPy only for a free-threaded interpreter with debugging
capabilities, the following dependency can be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">numpy</span><span class="p">;</span> <span class="s2">&quot;free-threading&quot;</span> <span class="ow">in</span> <span class="n">sys_abi_features</span> <span class="ow">and</span> <span class="s2">&quot;debug&quot;</span> <span class="ow">in</span> <span class="n">sys_abi_features</span>
</pre></div>
</div>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>This is a pure extension to the existing environment markers and does not
affect existing environment markers or dependency specifications, hence there
are no direct backwards compatibility concerns.</p>
<p>However, the introduction of the feature has implications for a number of
ecosystem tools, especially those which attempt to support examination of data
in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> and <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>.</p>
<section id="audit-and-update-tools">
<h3><a class="toc-backref" href="#audit-and-update-tools" role="doc-backlink">Audit and Update Tools</a></h3>
<p>A wide range of tools understand Python dependency data as expressed in
<code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files. (e.g., Dependabot, Tidelift, etc)</p>
<p>Such tools inspect dependency data and, in some cases, offer tool-assisted or
fully automated updates. It is our expectation that no such tools would support
the new environment markers at first, and broad ecosystem support could take
many months or even some number of years to arrive.</p>
<p>As a result, users of the new environment markers would experience a
degradation in their workflows and tool support at the time that they start
using them. This is true of any new standard for where and how dependency data
are encoded.</p>
</section>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications" role="doc-backlink">Security Implications</a></h2>
<p>This PEP introduces new syntax for specifying dependency information in
projects. However, it does not introduce newly specified mechanisms for
handling or resolving dependencies.</p>
<p>It therefore does not carry security concerns other than those inherent in any
tools which may already be used to install dependencies—i.e. malicious
dependencies may be specified here, just as they may be specified in
<code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>The use of environment markers is well established and communicated chiefly in
<a class="reference external" href="https://packaging.python.org/en/latest/specifications/dependency-specifiers/#dependency-specifiers" title="(in Python Packaging User Guide)"><span>Dependency specifiers</span></a>. The new environment marker can be
introduced in the same document. Additionally, both for package authors and
users, free-threading specific guidance can be provided at the
<a class="reference external" href="https://py-free-threading.github.io/">Python free-threading guide</a>.</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>The reference implementation for the environment markers is available in a fork
of the <code class="docutils literal notranslate"><span class="pre">packaging</span></code> library at <a class="reference external" href="https://github.com/zklaus/packaging/pull/1">Environment markers for ABI features</a>.</p>
<p><a class="reference external" href="https://github.com/zklaus/env-marker-example">A demonstration package</a> is
also available.</p>
<p>Since <code class="docutils literal notranslate"><span class="pre">pip</span></code> uses a vendored copy of <code class="docutils literal notranslate"><span class="pre">packaging</span></code> internally, we also provide
<a class="reference external" href="https://github.com/zklaus/pip/tree/env-marker-free-threading">a patched version of pip</a>, which replaces the vendored <code class="docutils literal notranslate"><span class="pre">packaging</span></code> with
the reference implementation linked above.</p>
</section>
<section id="rejected-ideas">
<h2><a class="toc-backref" href="#rejected-ideas" role="doc-backlink">Rejected Ideas</a></h2>
<section id="extension-mechanism">
<h3><a class="toc-backref" href="#extension-mechanism" role="doc-backlink">Extension Mechanism</a></h3>
<p>In an early discussion of the topic (<a class="reference external" href="https://discuss.python.org/t/environment-marker-for-free-threading/60007">Environment marker for free-threading</a>),
the idea of a general extension mechanism for environment markers was brought
up. While it is appealing to forego a whole PEP process should the need for
new environment markers arise in the future, there are two main challenges.</p>
<p>First, a completely dynamic mechanism would present difficulties for tools that
rely on static analysis of dependency specifications.</p>
<p>This means that even if a dynamic mechanism were to be adopted, new environment
markers would likely still need to be spelled out in a PEP.</p>
<p>Second, the introduction of a dynamic mechanism would require a more complex
implementation in the packaging library, which would be a significant departure
from the current approach.</p>
</section>
</section>
<section id="open-issues">
<h2><a class="toc-backref" href="#open-issues" role="doc-backlink">Open Issues</a></h2>
<section id="other-environment-markers">
<h3><a class="toc-backref" href="#other-environment-markers" role="doc-backlink">Other Environment Markers</a></h3>
<p>If other environment markers are needed right now, this PEP could be extended
to include them.</p>
</section>
<section id="other-tooling">
<h3><a class="toc-backref" href="#other-tooling" role="doc-backlink">Other Tooling</a></h3>
<p>The reference implementation is based on the <code class="docutils literal notranslate"><span class="pre">packaging</span></code> library and <code class="docutils literal notranslate"><span class="pre">pip</span></code>.
We have confirmed that this allows for building and installing packages with
several build backends. It is possible that other tools should be added to the
reference implementation.</p>
</section>
</section>
<section id="footnotes">
<h2><a class="toc-backref" href="#footnotes" role="doc-backlink">Footnotes</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="python-free-threading" role="doc-footnote">
<dt class="label" id="python-free-threading">[<a href="#id1">1</a>]</dt>
<dd>Python experimental support for free threading is
available in Python 3.13 and later. For more information, see <a class="reference external" href="https://docs.python.org/3/howto/free-threading-python.html">Python
experimental support for free threading</a>.</aside>
<aside class="footnote brackets" id="bitness" role="doc-footnote">
<dt class="label" id="bitness">[<a href="#id2">2</a>]</dt>
<dd>While there are some related environment markers available, such
as <code class="docutils literal notranslate"><span class="pre">platform_machine</span></code> and <code class="docutils literal notranslate"><span class="pre">platform_python_implementation</span></code>, these are
not sufficient to reliably determine the bitness of the interpreter,
particularly on platforms that allow the execution of either kind of binary.</aside>
</aside>
</section>
<section id="acknowledgements">
<h2><a class="toc-backref" href="#acknowledgements" role="doc-backlink">Acknowledgements</a></h2>
<p>Thanks to Filipe Laíns for the suggestion of the <code class="docutils literal notranslate"><span class="pre">abi_features</span></code> attribute and
to Stephen Rosen for the Backwards Compatibility section of <a class="pep reference internal" href="../pep-0735/" title="PEP 735 – Dependency Groups in pyproject.toml">PEP 735</a>, which
served as a template for the corresponding section in this PEP.</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0780.rst">https://github.com/python/peps/blob/main/peps/pep-0780.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0780.rst">2025-04-17 09:38:03 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#a-forward-looking-view-on-free-threaded-python">A Forward Looking View on Free-Threaded Python</a></li>
<li><a class="reference internal" href="#relation-to-other-peps">Relation to Other PEPs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#abi-features">ABI Features</a></li>
<li><a class="reference internal" href="#the-sys-abi-features-environment-marker">The <code class="docutils literal notranslate"><span class="pre">sys_abi_features</span></code> Environment Marker</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#require-cython-pre-release-for-free-threaded-python">Require Cython Pre-release for Free-Threaded Python</a></li>
<li><a class="reference internal" href="#require-scipy-unless-on-32-bit-win32">Require SciPy Unless on 32-bit <code class="docutils literal notranslate"><span class="pre">win32</span></code></a></li>
<li><a class="reference internal" href="#require-numpy-for-a-free-threaded-interpreter-with-debugging-capabilities">Require NumPy for a Free-Threaded Interpreter With Debugging Capabilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a><ul>
<li><a class="reference internal" href="#audit-and-update-tools">Audit and Update Tools</a></li>
</ul>
</li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#extension-mechanism">Extension Mechanism</a></li>
</ul>
</li>
<li><a class="reference internal" href="#open-issues">Open Issues</a><ul>
<li><a class="reference internal" href="#other-environment-markers">Other Environment Markers</a></li>
<li><a class="reference internal" href="#other-tooling">Other Tooling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#footnotes">Footnotes</a></li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0780.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>