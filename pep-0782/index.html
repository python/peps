
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 782 – Add PyBytesWriter C API | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0782/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 782 – Add PyBytesWriter C API | peps.python.org'>
    <meta property="og:description" content="Add a new PyBytesWriter C API to create bytes objects.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0782/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Add a new PyBytesWriter C API to create bytes objects.">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 782</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 782 – Add PyBytesWriter C API</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Victor Stinner &lt;vstinner&#32;&#97;t&#32;python.org&gt;</dd>
<dt class="field-even">Discussions-To<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/86617">Discourse thread</a></dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Accepted and implementation complete, or no longer active">Final</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-odd">Created<span class="colon">:</span></dt>
<dd class="field-odd">27-Mar-2025</dd>
<dt class="field-even">Python-Version<span class="colon">:</span></dt>
<dd class="field-even">3.15</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/81182" title="Discourse thread">18-Feb-2025</a></dd>
<dt class="field-even">Resolution<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/86617/15">11-Sep-2025</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#disallow-creation-of-incomplete-inconsistent-objects">Disallow creation of incomplete/inconsistent objects</a></li>
<li><a class="reference internal" href="#inefficient-allocation-strategy">Inefficient allocation strategy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#api">API</a><ul>
<li><a class="reference internal" href="#create-finish-discard">Create, Finish, Discard</a></li>
<li><a class="reference internal" href="#high-level-api">High-level API</a></li>
<li><a class="reference internal" href="#getters">Getters</a></li>
<li><a class="reference internal" href="#low-level-api">Low-level API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overallocation">Overallocation</a></li>
<li><a class="reference internal" href="#thread-safety">Thread safety</a></li>
<li><a class="reference internal" href="#soft-deprecations">Soft deprecations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#id1">High-level API</a></li>
<li><a class="reference internal" href="#create-the-bytes-string-abc">Create the bytes string “abc”</a></li>
<li><a class="reference internal" href="#growandupdatepointer-example"><code class="docutils literal notranslate"><span class="pre">GrowAndUpdatePointer()</span></code> example</a></li>
<li><a class="reference internal" href="#update-pybytes-fromstringandsize-code">Update <code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize()</span></code> code</a></li>
<li><a class="reference internal" href="#update-pybytes-resize-code">Update <code class="docutils literal notranslate"><span class="pre">_PyBytes_Resize()</span></code> code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#prior-discussions">Prior Discussions</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<div class="pep-banner canonical-doc sticky-banner admonition important">
<p class="admonition-title">Important</p>
<p>This PEP is a historical document. The up-to-date, canonical documentation can now be found at the <a class="reference external" href="https://docs.python.org/3.15/c-api/bytes.html#pybyteswriter" title="(in Python v3.15)"><span class="xref std std-ref">PyBytesWriter API</span></a>.</p>
<p class="close-button">×</p>
<p>See <a class="pep reference internal" href="../pep-0001/" title="PEP 1 – PEP Purpose and Guidelines">PEP 1</a> for how to propose changes.</p>
</div>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Add a new <code class="docutils literal notranslate"><span class="pre">PyBytesWriter</span></code> C API to create <code class="docutils literal notranslate"><span class="pre">bytes</span></code> objects.</p>
<p>Soft deprecate <code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize(NULL,</span> <span class="pre">size)</span></code> and
<code class="docutils literal notranslate"><span class="pre">_PyBytes_Resize()</span></code> APIs. These APIs treat an immutable <code class="docutils literal notranslate"><span class="pre">bytes</span></code>
object as a mutable object. They remain available and maintained, don’t
emit deprecation warning, but are no longer recommended when writing new
code.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<section id="disallow-creation-of-incomplete-inconsistent-objects">
<h3><a class="toc-backref" href="#disallow-creation-of-incomplete-inconsistent-objects" role="doc-backlink">Disallow creation of incomplete/inconsistent objects</a></h3>
<p>Creating a Python <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object using
<code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize(NULL,</span> <span class="pre">size)</span></code> and <code class="docutils literal notranslate"><span class="pre">_PyBytes_Resize()</span></code>
treats an immutable <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object as mutable. It goes against
the principle that <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> objects are immutable. It also creates
an incomplete or “invalid” object since bytes are not initialized. In
Python, a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object should always have its bytes fully
initialized.</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/capi-workgroup/api-evolution/issues/36">Avoid creating incomplete/invalid objects api-evolution#36</a></li>
<li><a class="reference external" href="https://github.com/capi-workgroup/api-evolution/issues/20">Disallow mutating immutable objects api-evolution#20</a></li>
<li><a class="reference external" href="https://github.com/capi-workgroup/problems/issues/56">Disallow creation of incomplete/inconsistent objects problems#56</a></li>
</ul>
</section>
<section id="inefficient-allocation-strategy">
<h3><a class="toc-backref" href="#inefficient-allocation-strategy" role="doc-backlink">Inefficient allocation strategy</a></h3>
<p>When creating a bytes string and the output size is unknown, one
strategy is to allocate a short buffer and extend it (to the exact size)
each time a larger write is needed.</p>
<p>This strategy is inefficient because it requires enlarging the buffer
multiple times. It’s more efficient to overallocate the buffer the
first time that a larger write is needed. It reduces the number of
expensive <code class="docutils literal notranslate"><span class="pre">realloc()</span></code> operations which can imply a memory copy.</p>
</section>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<section id="api">
<h3><a class="toc-backref" href="#api" role="doc-backlink">API</a></h3>
<dl class="c type">
<dt class="sig sig-object c" id="c.PyBytesWriter">
<span class="k"><span class="pre">type</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter</span></span></span><br /></dt>
<dd>A Python <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> writer instance created by
<a class="reference internal" href="#c.PyBytesWriter_Create" title="PyBytesWriter_Create"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Create()</span></code></a>.<p>The instance must be destroyed by <a class="reference internal" href="#c.PyBytesWriter_Finish" title="PyBytesWriter_Finish"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Finish()</span></code></a> or
<a class="reference internal" href="#c.PyBytesWriter_Discard" title="PyBytesWriter_Discard"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Discard()</span></code></a>.</p>
</dd></dl>

<section id="create-finish-discard">
<h4><a class="toc-backref" href="#create-finish-discard" role="doc-backlink">Create, Finish, Discard</a></h4>
<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_Create">
<a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_Create</span></span></span><span class="sig-paren">(</span><a class="reference external" href="https://docs.python.org/3/c-api/intro.html#c.Py_ssize_t" title="(in Python v3.14)"><span class="n"><span class="pre">Py_ssize_t</span></span></a><span class="w"> </span><span class="n"><span class="pre">size</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Create a <a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyBytesWriter</span></code></a> to write <em>size</em> bytes.<p>If <em>size</em> is greater than zero, allocate <em>size</em> bytes, and set the
writer size to <em>size</em>. The caller is responsible to write <em>size</em>
bytes using <a class="reference internal" href="#c.PyBytesWriter_GetData" title="PyBytesWriter_GetData"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_GetData()</span></code></a>.</p>
<p>On error, set an exception and return NULL.</p>
<p><em>size</em> must be positive or zero.</p>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_Finish">
<a class="reference external" href="https://docs.python.org/3/c-api/structures.html#c.PyObject" title="(in Python v3.14)"><span class="n"><span class="pre">PyObject</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_Finish</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Finish a <a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyBytesWriter</span></code></a> created by
<a class="reference internal" href="#c.PyBytesWriter_Create" title="PyBytesWriter_Create"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Create()</span></code></a>.<p>On success, return a Python <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object.
On error, set an exception and return <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.</p>
<p>The writer instance is invalid after the call in any case.</p>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_FinishWithSize">
<a class="reference external" href="https://docs.python.org/3/c-api/structures.html#c.PyObject" title="(in Python v3.14)"><span class="n"><span class="pre">PyObject</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_FinishWithSize</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span>, <a class="reference external" href="https://docs.python.org/3/c-api/intro.html#c.Py_ssize_t" title="(in Python v3.14)"><span class="n"><span class="pre">Py_ssize_t</span></span></a><span class="w"> </span><span class="n"><span class="pre">size</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Similar to <a class="reference internal" href="#c.PyBytesWriter_Finish" title="PyBytesWriter_Finish"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Finish()</span></code></a>, but resize the writer
to <em>size</em> bytes before creating the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object.</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_FinishWithPointer">
<a class="reference external" href="https://docs.python.org/3/c-api/structures.html#c.PyObject" title="(in Python v3.14)"><span class="n"><span class="pre">PyObject</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_FinishWithPointer</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span>, <span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">buf</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Similar to <a class="reference internal" href="#c.PyBytesWriter_Finish" title="PyBytesWriter_Finish"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Finish()</span></code></a>, but resize the writer
using <em>buf</em> pointer before creating the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object.<p>Set an exception and return <code class="docutils literal notranslate"><span class="pre">NULL</span></code> if <em>buf</em> pointer is outside the
internal buffer bounds.</p>
<p>Function pseudo-code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Py_ssize_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">PyBytesWriter_GetData</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="k">return</span><span class="w"> </span><span class="n">PyBytesWriter_FinishWithSize</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_Discard">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_Discard</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Discard a <a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyBytesWriter</span></code></a> created by <a class="reference internal" href="#c.PyBytesWriter_Create" title="PyBytesWriter_Create"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Create()</span></code></a>.<p>Do nothing if <em>writer</em> is <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.</p>
<p>The writer instance is invalid after the call.</p>
</dd></dl>

</section>
<section id="high-level-api">
<h4><a class="toc-backref" href="#high-level-api" role="doc-backlink">High-level API</a></h4>
<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_WriteBytes">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_WriteBytes</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">bytes</span></span>, <a class="reference external" href="https://docs.python.org/3/c-api/intro.html#c.Py_ssize_t" title="(in Python v3.14)"><span class="n"><span class="pre">Py_ssize_t</span></span></a><span class="w"> </span><span class="n"><span class="pre">size</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Grow the <em>writer</em> internal buffer by <em>size</em> bytes,
write <em>size</em> bytes of <em>bytes</em> at the <em>writer</em> end,
and add <em>size</em> to the <em>writer</em> size.<p>If <em>size</em> is equal to <code class="docutils literal notranslate"><span class="pre">-1</span></code>, call <code class="docutils literal notranslate"><span class="pre">strlen(bytes)</span></code> to get the
string length.</p>
<p>On success, return <code class="docutils literal notranslate"><span class="pre">0</span></code>.
On error, set an exception and return <code class="docutils literal notranslate"><span class="pre">-1</span></code>.</p>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_Format">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_Format</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">format</span></span>, <span class="p"><span class="pre">...</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Similar to <code class="docutils literal notranslate"><span class="pre">PyBytes_FromFormat()</span></code>, but write the output directly at
the writer end. Grow the writer internal buffer on demand.
Then add the written size to the writer size.<p>On success, return <code class="docutils literal notranslate"><span class="pre">0</span></code>.
On error, set an exception and return <code class="docutils literal notranslate"><span class="pre">-1</span></code>.</p>
</dd></dl>

</section>
<section id="getters">
<h4><a class="toc-backref" href="#getters" role="doc-backlink">Getters</a></h4>
<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_GetSize">
<a class="reference external" href="https://docs.python.org/3/c-api/intro.html#c.Py_ssize_t" title="(in Python v3.14)"><span class="n"><span class="pre">Py_ssize_t</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_GetSize</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Get the writer size.</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_GetData">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_GetData</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Get the writer data: start of the internal buffer.<p>The pointer is valid until <a class="reference internal" href="#c.PyBytesWriter_Finish" title="PyBytesWriter_Finish"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Finish()</span></code></a> or
<a class="reference internal" href="#c.PyBytesWriter_Discard" title="PyBytesWriter_Discard"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Discard()</span></code></a> is called on <em>writer</em>.</p>
</dd></dl>

</section>
<section id="low-level-api">
<h4><a class="toc-backref" href="#low-level-api" role="doc-backlink">Low-level API</a></h4>
<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_Resize">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_Resize</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span>, <a class="reference external" href="https://docs.python.org/3/c-api/intro.html#c.Py_ssize_t" title="(in Python v3.14)"><span class="n"><span class="pre">Py_ssize_t</span></span></a><span class="w"> </span><span class="n"><span class="pre">size</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Resize the writer to <em>size</em> bytes. It can be used to enlarge or to
shrink the writer.<p>Newly allocated bytes are left uninitialized.</p>
<p>On success, return <code class="docutils literal notranslate"><span class="pre">0</span></code>.
On error, set an exception and return <code class="docutils literal notranslate"><span class="pre">-1</span></code>.</p>
<p><em>size</em> must be positive or zero.</p>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_Grow">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_Grow</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span>, <a class="reference external" href="https://docs.python.org/3/c-api/intro.html#c.Py_ssize_t" title="(in Python v3.14)"><span class="n"><span class="pre">Py_ssize_t</span></span></a><span class="w"> </span><span class="n"><span class="pre">grow</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Resize the writer by adding <em>grow</em> bytes to the current writer size.<p>Newly allocated bytes are left uninitialized.</p>
<p>On success, return <code class="docutils literal notranslate"><span class="pre">0</span></code>.
On error, set an exception and return <code class="docutils literal notranslate"><span class="pre">-1</span></code>.</p>
<p><em>size</em> can be negative to shrink the writer.</p>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.PyBytesWriter_GrowAndUpdatePointer">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">PyBytesWriter_GrowAndUpdatePointer</span></span></span><span class="sig-paren">(</span><a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><span class="n"><span class="pre">PyBytesWriter</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">writer</span></span>, <a class="reference external" href="https://docs.python.org/3/c-api/intro.html#c.Py_ssize_t" title="(in Python v3.14)"><span class="n"><span class="pre">Py_ssize_t</span></span></a><span class="w"> </span><span class="n"><span class="pre">size</span></span>, <span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">buf</span></span><span class="sig-paren">)</span><br /></dt>
<dd>Similar to <a class="reference internal" href="#c.PyBytesWriter_Grow" title="PyBytesWriter_Grow"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Grow()</span></code></a>, but update also the <em>buf</em>
pointer.<p>The <em>buf</em> pointer is moved if the internal buffer is moved in memory.
The <em>buf</em> relative position within the internal buffer is left
unchanged.</p>
<p>On error, set an exception and return <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.</p>
<p><em>buf</em> must not be <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.</p>
<p>Function pseudo-code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Py_ssize_t</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">PyBytesWriter_GetData</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PyBytesWriter_Grow</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">PyBytesWriter_GetData</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
</pre></div>
</div>
</dd></dl>

</section>
</section>
<section id="overallocation">
<h3><a class="toc-backref" href="#overallocation" role="doc-backlink">Overallocation</a></h3>
<p><a class="reference internal" href="#c.PyBytesWriter_Resize" title="PyBytesWriter_Resize"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Resize()</span></code></a> and <a class="reference internal" href="#c.PyBytesWriter_Grow" title="PyBytesWriter_Grow"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Grow()</span></code></a>
overallocate the internal buffer to reduce the number of <code class="docutils literal notranslate"><span class="pre">realloc()</span></code>
calls and so reduce memory copies.</p>
<p><a class="reference internal" href="#c.PyBytesWriter_Finish" title="PyBytesWriter_Finish"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Finish()</span></code></a> trims overallocations: it shrinks the
internal buffer to the exact size when creating the final <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a>
object.</p>
</section>
<section id="thread-safety">
<h3><a class="toc-backref" href="#thread-safety" role="doc-backlink">Thread safety</a></h3>
<p>The API is not thread safe: a writer should only be used by a single
thread at the same time.</p>
</section>
<section id="soft-deprecations">
<h3><a class="toc-backref" href="#soft-deprecations" role="doc-backlink">Soft deprecations</a></h3>
<p>Soft deprecate <code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize(NULL,</span> <span class="pre">size)</span></code> and
<code class="docutils literal notranslate"><span class="pre">_PyBytes_Resize()</span></code> APIs. These APIs treat an immutable <code class="docutils literal notranslate"><span class="pre">bytes</span></code>
object as a mutable object. They remain available and maintained, don’t
emit deprecation warning, but are no longer recommended when writing new
code.</p>
<p><code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize(str,</span> <span class="pre">size)</span></code> is not soft deprecated. Only
calls with <code class="docutils literal notranslate"><span class="pre">NULL</span></code> <em>str</em> are soft deprecated.</p>
</section>
</section>
<section id="examples">
<h2><a class="toc-backref" href="#examples" role="doc-backlink">Examples</a></h2>
<section id="id1">
<h3><a class="toc-backref" href="#id1" role="doc-backlink">High-level API</a></h3>
<p>Create the bytes string <code class="docutils literal notranslate"><span class="pre">b&quot;Hello</span> <span class="pre">World!&quot;</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">hello_world</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PyBytesWriter</span><span class="w"> </span><span class="o">*</span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_Create</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">writer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PyBytesWriter_WriteBytes</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PyBytesWriter_Format</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; %s!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;World&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PyBytesWriter_Finish</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>

<span class="nl">error</span><span class="p">:</span>
<span class="w">    </span><span class="n">PyBytesWriter_Discard</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="create-the-bytes-string-abc">
<h3><a class="toc-backref" href="#create-the-bytes-string-abc" role="doc-backlink">Create the bytes string “abc”</a></h3>
<p>Example creating the bytes string <code class="docutils literal notranslate"><span class="pre">b&quot;abc&quot;</span></code>, with a fixed size of 3 bytes:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">create_abc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PyBytesWriter</span><span class="w"> </span><span class="o">*</span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_Create</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">writer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_GetData</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;abc&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PyBytesWriter_Finish</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="growandupdatepointer-example">
<h3><a class="toc-backref" href="#growandupdatepointer-example" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">GrowAndUpdatePointer()</span></code> example</a></h3>
<p>Example using a pointer to write bytes and to track the written size.</p>
<p>Create the bytes string <code class="docutils literal notranslate"><span class="pre">b&quot;Hello</span> <span class="pre">World&quot;</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">grow_example</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Allocate 10 bytes</span>
<span class="w">    </span><span class="n">PyBytesWriter</span><span class="w"> </span><span class="o">*</span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_Create</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">writer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Write some bytes</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_GetData</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="s">&quot;Hello &quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">buf</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="s">&quot;Hello &quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Allocate 10 more bytes</span>
<span class="w">    </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_GrowAndUpdatePointer</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buf</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyBytesWriter_Discard</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Write more bytes</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;World&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="s">&quot;World&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">buf</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="s">&quot;World&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Truncate the string at &#39;buf&#39; position</span>
<span class="w">    </span><span class="c1">// and create a bytes object</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PyBytesWriter_FinishWithPointer</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="update-pybytes-fromstringandsize-code">
<h3><a class="toc-backref" href="#update-pybytes-fromstringandsize-code" role="doc-backlink">Update <code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize()</span></code> code</a></h3>
<p>Example of code using the soft deprecated
<code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize(NULL,</span> <span class="pre">size)</span></code> API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytes_FromStringAndSize</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">num_bytes</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_bytes</span><span class="p">(</span><span class="n">PyBytes_AS_STRING</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">num_bytes</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</pre></div>
</div>
<p>It can now be updated to:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyBytesWriter</span><span class="w"> </span><span class="o">*</span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_Create</span><span class="p">(</span><span class="n">num_bytes</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">writer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_bytes</span><span class="p">(</span><span class="n">PyBytesWriter_GetData</span><span class="p">(</span><span class="n">writer</span><span class="p">),</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">num_bytes</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PyBytesWriter_Discard</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">return</span><span class="w"> </span><span class="n">PyBytesWriter_Finish</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="update-pybytes-resize-code">
<h3><a class="toc-backref" href="#update-pybytes-resize-code" role="doc-backlink">Update <code class="docutils literal notranslate"><span class="pre">_PyBytes_Resize()</span></code> code</a></h3>
<p>Example of code using the soft deprecated <code class="docutils literal notranslate"><span class="pre">_PyBytes_Resize()</span></code> API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytes_FromStringAndSize</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytes_AS_STRING</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

<span class="c1">// ... fill bytes into &#39;p&#39; ...</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_PyBytes_Resize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PyBytes_AS_STRING</span><span class="p">(</span><span class="n">v</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
</pre></div>
</div>
<p>It can now be updated to:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyBytesWriter</span><span class="w"> </span><span class="o">*</span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_Create</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">writer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyBytesWriter_GetData</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>

<span class="c1">// ... fill bytes into &#39;p&#39; ...</span>

<span class="k">return</span><span class="w"> </span><span class="n">PyBytesWriter_FinishWithPointer</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p><a class="reference external" href="https://github.com/python/cpython/pull/131681">Pull request gh-131681</a>.</p>
<p>Notes on the CPython reference implementation which are not part of the
Specification:</p>
<ul class="simple">
<li>The implementation allocates internally a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object, so
<a class="reference internal" href="#c.PyBytesWriter_Finish" title="PyBytesWriter_Finish"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Finish()</span></code></a> just returns the object without having
to copy memory.</li>
<li>For strings up to 256 bytes, a small internal raw buffer of bytes is
used. It avoids having to resize a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object which is
inefficient. At the end, <a class="reference internal" href="#c.PyBytesWriter_Finish" title="PyBytesWriter_Finish"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyBytesWriter_Finish()</span></code></a> creates the
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object from this small buffer.</li>
<li>A free list is used to reduce the cost of allocating a
<a class="reference internal" href="#c.PyBytesWriter" title="PyBytesWriter"><code class="xref c c-type docutils literal notranslate"><span class="pre">PyBytesWriter</span></code></a> on the heap memory.</li>
</ul>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>There is no impact on the backward compatibility, only new APIs are
added.</p>
<p><code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize(NULL,</span> <span class="pre">size)</span></code> and <code class="docutils literal notranslate"><span class="pre">_PyBytes_Resize()</span></code> APIs
are soft deprecated. No new warnings is emitted when these functions are
used and they are not planned for removal.</p>
</section>
<section id="prior-discussions">
<h2><a class="toc-backref" href="#prior-discussions" role="doc-backlink">Prior Discussions</a></h2>
<ul class="simple">
<li>March 2025: Third public API attempt, using size rather than pointers:<ul>
<li><a class="reference external" href="https://discuss.python.org/t/81182/56">Discussion</a></li>
<li><a class="reference external" href="https://github.com/python/cpython/pull/131681">Pull request gh-131681</a></li>
</ul>
</li>
<li>February 2025: Second public API attempt:<ul>
<li><a class="reference external" href="https://github.com/python/cpython/issues/129813">Issue gh-129813</a>
and
<a class="reference external" href="https://github.com/python/cpython/pull/129814">pull request gh-129814</a></li>
</ul>
</li>
<li>July 2024: First public API attempt:<ul>
<li>C API Working Group decision:
<a class="reference external" href="https://github.com/capi-workgroup/decisions/issues/39">Add PyBytes_Writer() API</a>
(August 2024)</li>
<li><a class="reference external" href="https://github.com/python/cpython/pull/121726">Pull request gh-121726</a>:
first public API attempt (July 2024)</li>
</ul>
</li>
<li>March 2016:
<a class="reference external" href="https://vstinner.github.io/pybyteswriter.html">Fast _PyAccu, _PyUnicodeWriter and _PyBytesWriter APIs to produce
strings in CPython</a>:
Article on the original private <code class="docutils literal notranslate"><span class="pre">_PyBytesWriter</span></code> C API.</li>
</ul>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0782.rst">https://github.com/python/peps/blob/main/peps/pep-0782.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0782.rst">2025-09-18 13:28:58 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#disallow-creation-of-incomplete-inconsistent-objects">Disallow creation of incomplete/inconsistent objects</a></li>
<li><a class="reference internal" href="#inefficient-allocation-strategy">Inefficient allocation strategy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#api">API</a><ul>
<li><a class="reference internal" href="#create-finish-discard">Create, Finish, Discard</a></li>
<li><a class="reference internal" href="#high-level-api">High-level API</a></li>
<li><a class="reference internal" href="#getters">Getters</a></li>
<li><a class="reference internal" href="#low-level-api">Low-level API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overallocation">Overallocation</a></li>
<li><a class="reference internal" href="#thread-safety">Thread safety</a></li>
<li><a class="reference internal" href="#soft-deprecations">Soft deprecations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#id1">High-level API</a></li>
<li><a class="reference internal" href="#create-the-bytes-string-abc">Create the bytes string “abc”</a></li>
<li><a class="reference internal" href="#growandupdatepointer-example"><code class="docutils literal notranslate"><span class="pre">GrowAndUpdatePointer()</span></code> example</a></li>
<li><a class="reference internal" href="#update-pybytes-fromstringandsize-code">Update <code class="docutils literal notranslate"><span class="pre">PyBytes_FromStringAndSize()</span></code> code</a></li>
<li><a class="reference internal" href="#update-pybytes-resize-code">Update <code class="docutils literal notranslate"><span class="pre">_PyBytes_Resize()</span></code> code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#prior-discussions">Prior Discussions</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0782.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
</body>
</html>