
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 743 – Add Py_OMIT_LEGACY_API to the Python C API | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0743/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 743 – Add Py_OMIT_LEGACY_API to the Python C API | peps.python.org'>
    <meta property="og:description" content="Add Py_OMIT_LEGACY_API C macro that hides deprecated and soft-deprecated symbols, allowing users to opt out of using API with known issues that other API solves.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0743/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Add Py_OMIT_LEGACY_API C macro that hides deprecated and soft-deprecated symbols, allowing users to opt out of using API with known issues that other API solves.">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 743</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 743 – Add Py_OMIT_LEGACY_API to the Python C API</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Victor Stinner &lt;vstinner&#32;&#97;t&#32;python.org&gt;,
Petr Viktorin &lt;encukou&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">PEP-Delegate<span class="colon">:</span></dt>
<dd class="field-even">C API Working Group</dd>
<dt class="field-odd">Discussions-To<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/59323">Discourse thread</a></dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">11-Mar-2024</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.15</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/48243" title="Discourse thread">11-Mar-2024</a>,
<a class="reference external" href="https://discuss.python.org/t/59323" title="Discourse thread">27-Jul-2024</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a><ul>
<li><a class="reference internal" href="#adding-the-py-prefix">Adding the <code class="docutils literal notranslate"><span class="pre">Py</span></code> prefix</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#requirements-for-omitted-api">Requirements for omitted API</a></li>
<li><a class="reference internal" href="#location">Location</a></li>
<li><a class="reference internal" href="#documentation">Documentation</a></li>
<li><a class="reference internal" href="#initial-set">Initial set</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#discussions">Discussions</a></li>
<li><a class="reference internal" href="#prior-art">Prior Art</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Add <code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code> C macro that hides deprecated and
soft-deprecated symbols, allowing users to opt out of using API with known
issues that other API solves.</p>
<p>Also, add namespaced alternatives for API without the <code class="docutils literal notranslate"><span class="pre">Py_</span></code> prefix,
and soft-deprecate the original names.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>Some of Python’s C API has flaws that are only obvious in hindsight.</p>
<p>If an API prevents adding features or optimizations, or presents a serious
security risk or maintenance burden, we can deprecate and remove it as
described in <a class="pep reference internal" href="../pep-0387/" title="PEP 387 – Backwards Compatibility Policy">PEP 387</a>.</p>
<p>However, this leaves us with some API that has “sharp edges” – it works fine
for its current users, but should be avoided in new code.
For example:</p>
<ul class="simple">
<li>API that cannot signal an exception, so failures are either ignored or
exit the process with a fatal error. For example <code class="docutils literal notranslate"><span class="pre">PyObject_HasAttr</span></code>.</li>
<li>API that is not thread-safe, for example by borrowing references from
mutable objects, or exposing unfinished mutable objects. For example
<code class="docutils literal notranslate"><span class="pre">PyDict_GetItemWithError</span></code>.</li>
<li>API with names that don’t use the <code class="docutils literal notranslate"><span class="pre">Py</span></code>/<code class="docutils literal notranslate"><span class="pre">_Py</span></code> prefix, and so can clash
with other code. For example: <code class="docutils literal notranslate"><span class="pre">setter</span></code>.</li>
</ul>
<p>It is important to note that despite such flaws, it’s usually possible
to use the API correctly. For example, in a single-threaded environment,
thread safety is not an issue.
We do not want to break working code, even if it uses API that would be wrong
in some – or even <em>most</em> – other contexts.</p>
<p>On the other hand, we want to steer users away from such “undesirable” API
in <em>new</em> code, especially if a safer alternative exists.</p>
<section id="adding-the-py-prefix">
<h3><a class="toc-backref" href="#adding-the-py-prefix" role="doc-backlink">Adding the <code class="docutils literal notranslate"><span class="pre">Py</span></code> prefix</a></h3>
<p>Some names defined in CPython headers is not namespaced: it that lacks the
<code class="docutils literal notranslate"><span class="pre">Py</span></code> prefix (or a variant: <code class="docutils literal notranslate"><span class="pre">_Py</span></code>, and alternative capitalizations).
For example, we declare a function type named simply <code class="docutils literal notranslate"><span class="pre">setter</span></code>.</p>
<p>While such names are not exported in the ABI (as checked by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">smelly</span></code>),
they can clash with user code and, more importantly, with libraries linked
to third-party extensions.</p>
<p>While it would be possible to provide namespaced aliases and (soft-)deprecate
these names, the only way to make them not clash with third-party code is to
not define them in Python headers at all.</p>
</section>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>We want to allow an easy way for users to avoid “undesirable” API if they
choose to do so.</p>
<p>It might be be sufficient to leave this to third-party linters.
For that we’d need a good way to expose a list of (soft-)deprecated
API to such linters.
While adding that, we can – rather easily – do the linter’s job directly
in CPython headers, avoiding the need for an extra tool.
Unlike Python, C makes it rather easy to limit available API – for a whole
project or for each individual source file – by having users define
an “opt-in” macro.</p>
<p>We already do something similar with <code class="docutils literal notranslate"><span class="pre">Py_LIMITED_API</span></code>, which limits the
available API to a subset that compiles to stable ABI. (In hindsight, we should
have used a different macro name for that particular kind of limiting, but it’s
too late to change that now.)</p>
<p>To be clear, this mechanism is <em>not</em> a replacement for deprecation.
Deprecation is for API that prevents new features or optimizations, or
presents a security risk or maintenance burden.
This mechanism, on the other hand, is meant for cases where “we found
a slightly better way of doing things” – perhaps one that’s harder to misuse,
or just has a less misleading name.
(On a lighter note: many people configure a code quality checker to shout at
them about the number of blank lines between functions. Let’s help them
identify more substantial “code smells”!)</p>
<p>The proposed macro does not <em>change</em> any API definitions; it only <em>hides</em> them.
So, if code compiles with the macro, it’ll also compile without it, with
identical behaviour.
This has implications for core devs: to deal with undesirable behaviour,
we’ll need to introduce new, better API, and <em>then</em> discourage the old one.
In turn, this implies that we should look at an individual API and fix all its
known issues at once, rather than do codebase-wide sweeps for a single kind of
issue, so that we avoid multiple renames of the same function.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>We introduce a <code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code> macro.
If this macro is defined before <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;Python.h&gt;</span></code>, some API definitions
– as described below – will be omitted from the Python header files.</p>
<p>The macro only omits complete top-level definitions exposed from <code class="docutils literal notranslate"><span class="pre">&lt;Python.h&gt;</span></code>.
Other things (the ABI, structure definitions, macro expansions, static inline
function bodies, etc.) are not affected.</p>
<p>The C API working group (<a class="pep reference internal" href="../pep-0731/" title="PEP 731 – C API Working Group Charter">PEP 731</a>) has authority over the set of omitted
definitions.</p>
<p>The set of omitted definitions will be tied to a particular feature release
of CPython, and is finalized in each 3.x.0 Beta 1 release.
In rare cases, entries can be removed (i.e. made available for use) at any
time.</p>
<section id="requirements-for-omitted-api">
<h3><a class="toc-backref" href="#requirements-for-omitted-api" role="doc-backlink">Requirements for omitted API</a></h3>
<p>An API that is omitted with <code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code> must:</p>
<ul class="simple">
<li>be soft-deprecated (see <a class="pep reference internal" href="../pep-0387/" title="PEP 387 – Backwards Compatibility Policy">PEP 387</a>);</li>
<li>for all known use cases of the API, have a documented alternative
or workaround;</li>
<li>have tests to ensure it keeps working (except for 1:1 renames using
<code class="docutils literal notranslate"><span class="pre">#define</span></code> or <code class="docutils literal notranslate"><span class="pre">typedef</span></code>);</li>
<li>be documented (except if it was never mentioned in previous versions of the
documentation); and</li>
<li>be approved by the C API working group. (The WG may give blanket approvals
for groups of related API; see <em>Initial set</em> below for examples.)</li>
</ul>
<p>Note that <code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code> is meant for API that can be trivially
replaced by a better alternative.
API without a replacement should generally be deprecated instead.</p>
</section>
<section id="location">
<h3><a class="toc-backref" href="#location" role="doc-backlink">Location</a></h3>
<p>All API definitions omitted by <code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code> will be moved to
a new header, <code class="docutils literal notranslate"><span class="pre">Include/legacy.h</span></code>.</p>
<p>This is meant to help linter authors compile lists, so they can flag the API
with warnings rather than errors.</p>
<p>Note that for simple renaming of source-only constructs (macros, types), we
expect names to be omitted in the same version – or the same PR – that adds
a replacement.
This means that the original definition will be renamed, and a <code class="docutils literal notranslate"><span class="pre">typedef</span></code>
or <code class="docutils literal notranslate"><span class="pre">#define</span></code> for the old name added to <code class="docutils literal notranslate"><span class="pre">Include/legacy.h</span></code>.</p>
</section>
<section id="documentation">
<h3><a class="toc-backref" href="#documentation" role="doc-backlink">Documentation</a></h3>
<p>Documentation for omitted API should generally:</p>
<ul class="simple">
<li>appear after the recommended replacement,</li>
<li>reference the replacement (e.g. “Similar to X, but…”), and</li>
<li>focus on differences from the replacement and migration advice.</li>
</ul>
<p>Exceptions are possible if there is a good reason for them.</p>
</section>
<section id="initial-set">
<h3><a class="toc-backref" href="#initial-set" role="doc-backlink">Initial set</a></h3>
<p>The following API will be omitted with <code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code> set:</p>
<ul>
<li>Omit API returning borrowed references:<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Omitted API</th>
<th class="head">Replacement</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyDict_GetItem()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyDict_GetItemRef()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyDict_GetItemString()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyDict_GetItemStringRef()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyImport_AddModule()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyImport_AddModuleRef()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyList_GetItem()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyList_GetItemRef()</span></code></td>
</tr>
</tbody>
</table>
</li>
<li>Omit deprecated APIs:<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Omitted Deprecated API</th>
<th class="head">Replacement</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PY_FORMAT_SIZE_T</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">&quot;z&quot;</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PY_UNICODE_TYPE</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">wchar_t</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyCode_GetFirstFree()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnstable_Code_GetFirstFree()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyCode_New()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnstable_Code_New()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyCode_NewWithPosOnlyArgs()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnstable_Code_NewWithPosOnlyArgs()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyImport_ImportModuleNoBlock()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyImport_ImportModule()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyMem_DEL()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMem_Free()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyMem_Del()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMem_Free()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyMem_FREE()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMem_Free()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyMem_MALLOC()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMem_Malloc()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyMem_NEW()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMem_New()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyMem_REALLOC()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMem_Realloc()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyMem_RESIZE()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMem_Resize()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyModule_GetFilename()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyModule_GetFilenameObject()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyOS_AfterFork()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyOS_AfterFork_Child()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyObject_DEL()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyObject_Free()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyObject_Del()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyObject_Free()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyObject_FREE()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyObject_Free()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyObject_MALLOC()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyObject_Malloc()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyObject_REALLOC()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyObject_Realloc()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PySlice_GetIndicesEx()</span></code></td>
<td>(two calls; see current docs)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyThread_ReInitTLS()</span></code></td>
<td>(no longer needed)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyThread_create_key()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyThread_tss_alloc()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyThread_delete_key()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyThread_tss_free()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyThread_delete_key_value()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyThread_tss_delete()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyThread_get_key_value()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyThread_tss_get()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyThread_set_key_value()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyThread_tss_set()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUnicode_AsDecodedObject()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnicode_Decode()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUnicode_AsDecodedUnicode()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnicode_Decode()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUnicode_AsEncodedObject()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnicode_AsEncodedString()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUnicode_AsEncodedUnicode()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnicode_AsEncodedString()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUnicode_IS_READY()</span></code></td>
<td>(no longer needed)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUnicode_READY()</span></code></td>
<td>(no longer needed)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyWeakref_GET_OBJECT()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyWeakref_GetRef()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyWeakref_GetObject()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyWeakref_GetRef()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">Py_UNICODE</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">wchar_t</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_PyCode_GetExtra()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnstable_Code_GetExtra()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">_PyCode_SetExtra()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnstable_Code_SetExtra()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_PyDict_GetItemStringWithError()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyDict_GetItemStringRef()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">_PyEval_RequestCodeExtraIndex()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnstable_Eval_RequestCodeExtraIndex()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_PyHASH_BITS</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyHASH_BITS</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">_PyHASH_IMAG</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyHASH_IMAG</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_PyHASH_INF</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyHASH_INF</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">_PyHASH_MODULUS</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyHASH_MODULUS</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_PyHASH_MULTIPLIER</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyHASH_MULTIPLIER</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">_PyObject_EXTRA_INIT</span></code></td>
<td>(no longer needed)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_PyThreadState_UncheckedGet()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyThreadState_GetUnchecked()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">_PyUnicode_AsString()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyUnicode_AsUTF8()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_Py_HashPointer()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_HashPointer()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">_Py_T_OBJECT</span></code></td>
<td>(<code class="docutils literal notranslate"><span class="pre">tp_getset</span></code>; docs to be written)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_Py_WRITE_RESTRICTED</span></code></td>
<td>(no longer needed)</td>
</tr>
</tbody>
</table>
</li>
<li>Soft-deprecate and omit APIs:<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Omitted Deprecated API</th>
<th class="head">Replacement</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyDict_GetItemWithError()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyDict_GetItemRef()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyDict_SetDefault()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyDict_SetDefaultRef()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyMapping_HasKey()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMapping_HasKeyWithError()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyMapping_HasKeyString()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyMapping_HasKeyStringWithError()</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyObject_HasAttr()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyObject_HasAttrWithError()</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyObject_HasAttrString()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">PyObject_HasAttrStringWithError()</span></code></td>
</tr>
</tbody>
</table>
</li>
<li>Omit <code class="docutils literal notranslate"><span class="pre">&lt;structmember.h&gt;</span></code> legacy API:<p>The header file <code class="docutils literal notranslate"><span class="pre">structmember.h</span></code>, which is not included from <code class="docutils literal notranslate"><span class="pre">&lt;Python.h&gt;</span></code>
and must be included separately, will <code class="docutils literal notranslate"><span class="pre">#error</span></code> if
<code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code> is defined.
This affects the following API:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Omitted Deprecated API</th>
<th class="head">Replacement</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_SHORT</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_SHORT</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_INT</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_INT</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_LONG</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_LONG</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_FLOAT</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_FLOAT</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_DOUBLE</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_DOUBLE</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_STRING</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_STRING</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_OBJECT</span></code></td>
<td>(<code class="docutils literal notranslate"><span class="pre">tp_getset</span></code>; docs to be written)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_CHAR</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_CHAR</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_BYTE</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_BYTE</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_UBYTE</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_UBYTE</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_USHORT</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_USHORT</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_UINT</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_UINT</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_ULONG</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_ULONG</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_STRING_INPLACE</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_STRING_INPLACE</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_BOOL</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_BOOL</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_OBJECT_EX</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_OBJECT_EX</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_LONGLONG</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_LONGLONG</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_ULONGLONG</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_ULONGLONG</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">T_PYSSIZET</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_T_PYSSIZET</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">T_NONE</span></code></td>
<td>(<code class="docutils literal notranslate"><span class="pre">tp_getset</span></code>; docs to be written)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">READONLY</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_READONLY</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PY_AUDIT_READ</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_AUDIT_READ</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">READ_RESTRICTED</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_AUDIT_READ</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PY_WRITE_RESTRICTED</span></code></td>
<td>(no longer needed)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">RESTRICTED</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">Py_AUDIT_READ</span></code></td>
</tr>
</tbody>
</table>
</li>
<li>Omit soft deprecated macros:<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Omitted Macros</th>
<th class="head">Replacement</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">Py_IS_NAN()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">isnan()</span></code> (C99+ <code class="docutils literal notranslate"><span class="pre">&lt;math.h&gt;</span></code>)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">Py_IS_INFINITY()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">isinf(X)</span></code> (C99+ <code class="docutils literal notranslate"><span class="pre">&lt;math.h&gt;</span></code>)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">Py_IS_FINITE()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">isfinite(X)</span></code> (C99+ <code class="docutils literal notranslate"><span class="pre">&lt;math.h&gt;</span></code>)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">Py_MEMCPY()</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">memcpy()</span></code> (C <code class="docutils literal notranslate"><span class="pre">&lt;string.h&gt;</span></code>)</td>
</tr>
</tbody>
</table>
</li>
<li>Soft-deprecate and omit typedefs without the <code class="docutils literal notranslate"><span class="pre">Py</span></code>/<code class="docutils literal notranslate"><span class="pre">_Py</span></code> prefix
(<code class="docutils literal notranslate"><span class="pre">getter</span></code>, <code class="docutils literal notranslate"><span class="pre">setter</span></code>, <code class="docutils literal notranslate"><span class="pre">allocfunc</span></code>, …), in favour of <em>new</em> ones
that add the prefix (<code class="docutils literal notranslate"><span class="pre">Py_getter</span></code> , etc.)</li>
<li>Soft-deprecate and omit macros without the <code class="docutils literal notranslate"><span class="pre">Py</span></code>/<code class="docutils literal notranslate"><span class="pre">_Py</span></code> prefix
(<code class="docutils literal notranslate"><span class="pre">METH_O</span></code>, <code class="docutils literal notranslate"><span class="pre">CO_COROUTINE</span></code>, <code class="docutils literal notranslate"><span class="pre">FUTURE_ANNOTATIONS</span></code>, <code class="docutils literal notranslate"><span class="pre">WAIT_LOCK</span></code>, …),
favour of <em>new</em> ones that add the prefix  (<code class="docutils literal notranslate"><span class="pre">Py_METH_O</span></code> , etc.).</li>
<li>Any others approved by the C API workgroup</li>
</ul>
<p>If any of these proposed replacements, or associated documentation,
are not added in time for 3.14.0b1, they’ll be omitted with later versions
of <code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code>.
(We expect this for macros generated by <code class="docutils literal notranslate"><span class="pre">configure</span></code>: <code class="docutils literal notranslate"><span class="pre">HAVE_*</span></code>, <code class="docutils literal notranslate"><span class="pre">WITH_*</span></code>,
<code class="docutils literal notranslate"><span class="pre">ALIGNOF_*</span></code>, <code class="docutils literal notranslate"><span class="pre">SIZEOF_*</span></code>, and several without a common prefix.)</p>
</section>
</section>
<section id="implementation">
<h2><a class="toc-backref" href="#implementation" role="doc-backlink">Implementation</a></h2>
<p>TBD</p>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>The macro is backwards compatible.
Developers can introduce and update the macro on their own pace, potentially
for one source file at a time.</p>
<p>Future versions of CPython may add more API to the set that
<code class="docutils literal notranslate"><span class="pre">Py_OMIT_LEGACY_API</span></code> hides, breaking user code.
The fix is to undefine the macro (which is safe to do) or rework the
code.</p>
</section>
<section id="discussions">
<h2><a class="toc-backref" href="#discussions" role="doc-backlink">Discussions</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://discuss.python.org/t/pep-743-add-py-compat-api-version-to-the-python-c-api-take-2/59323">PEP 743 – Add Py_COMPAT_API_VERSION to the Python C API (take 2)</a>
(July 2024)</li>
<li><a class="reference external" href="https://discuss.python.org/t/finishing-the-great-renaming/54082">Finishing the Great Renaming</a>
(May 2024)</li>
<li><a class="reference external" href="https://discuss.python.org/t/pep-743-add-py-compat-api-version-to-the-python-c-api/48243">PEP 743: Add Py_COMPAT_API_VERSION to the Python C API</a>
(March 2024)</li>
<li>C API Evolutions: <a class="reference external" href="https://github.com/capi-workgroup/api-evolution/issues/24">Macro to hide deprecated functions</a>
(October 2023)</li>
<li>C API Problems: <a class="reference external" href="https://github.com/capi-workgroup/problems/issues/54">Opt-in macro for a new clean API? Subset of functions
with no known issues</a>
(June 2023)</li>
</ul>
</section>
<section id="prior-art">
<h2><a class="toc-backref" href="#prior-art" role="doc-backlink">Prior Art</a></h2>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_LIMITED_API</span></code> macro of <a class="pep reference internal" href="../pep-0384/" title="PEP 384 – Defining a Stable ABI">PEP 384</a> “Defining a Stable ABI”.</li>
<li>Rejected <a class="pep reference internal" href="../pep-0606/" title="PEP 606 – Python Compatibility Version">PEP 606</a> “Python Compatibility Version” which has a global
scope.</li>
</ul>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0743.rst">https://github.com/python/peps/blob/main/peps/pep-0743.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0743.rst">2025-10-22 11:56:43 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a><ul>
<li><a class="reference internal" href="#adding-the-py-prefix">Adding the <code class="docutils literal notranslate"><span class="pre">Py</span></code> prefix</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#requirements-for-omitted-api">Requirements for omitted API</a></li>
<li><a class="reference internal" href="#location">Location</a></li>
<li><a class="reference internal" href="#documentation">Documentation</a></li>
<li><a class="reference internal" href="#initial-set">Initial set</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#discussions">Discussions</a></li>
<li><a class="reference internal" href="#prior-art">Prior Art</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0743.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
</body>
</html>