
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 293 – Codec Error Handling Callbacks | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0293/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 293 – Codec Error Handling Callbacks | peps.python.org'>
    <meta property="og:description" content="This PEP aims at extending Python’s fixed codec error handling schemes with a more flexible callback based approach.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0293/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="This PEP aims at extending Python’s fixed codec error handling schemes with a more flexible callback based approach.">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 293</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 293 – Codec Error Handling Callbacks</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Walter Dörwald &lt;walter&#32;&#97;t&#32;livinglogic.de&gt;</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Accepted and implementation complete, or no longer active">Final</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">18-Jun-2002</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">2.3</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even">19-Jun-2002</dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#implementation-notes">Implementation Notes</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>This PEP aims at extending Python’s fixed codec error handling
schemes with a more flexible callback based approach.</p>
<p>Python currently uses a fixed error handling for codec error
handlers.  This PEP describes a mechanism which allows Python to
use function callbacks as error handlers.  With these more
flexible error handlers it is possible to add new functionality to
existing codecs by e.g. providing fallback solutions or different
encodings for cases where the standard codec mapping does not
apply.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>Currently the set of codec error handling algorithms is fixed to
either “strict”, “replace” or “ignore” and the semantics of these
algorithms is implemented separately for each codec.</p>
<p>The proposed patch will make the set of error handling algorithms
extensible through a codec error handler registry which maps
handler names to handler functions.  This registry consists of the
following two C functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">PyCodec_RegisterError</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>

<span class="n">PyObject</span> <span class="o">*</span><span class="n">PyCodec_LookupError</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>and their Python counterparts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">codecs</span><span class="o">.</span><span class="n">register_error</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>

<span class="n">codecs</span><span class="o">.</span><span class="n">lookup_error</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">PyCodec_LookupError</span></code> raises a <code class="docutils literal notranslate"><span class="pre">LookupError</span></code> if no callback function
has been registered under this name.</p>
<p>Similar to the encoding name registry there is no way of
unregistering callback functions or iterating through the
available functions.</p>
<p>The callback functions will be used in the following way by the
codecs: when the codec encounters an encoding/decoding error, the
callback function is looked up by name, the information about the
error is stored in an exception object and the callback is called
with this object.  The callback returns information about how to
proceed (or raises an exception).</p>
<p>For encoding, the exception object will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UnicodeEncodeError</span><span class="p">(</span><span class="ne">UnicodeError</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="ne">UnicodeError</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;encoding &#39;</span><span class="si">%s</span><span class="s2">&#39; can&#39;t encode characters &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;in positions </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">encoding</span><span class="p">,</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object</span> <span class="o">=</span> <span class="nb">object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
</pre></div>
</div>
<p>This type will be implemented in C with the appropriate setter and
getter methods for the attributes, which have the following
meaning:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">encoding</span></code>: The name of the encoding;</li>
<li><code class="docutils literal notranslate"><span class="pre">object</span></code>: The original unicode object for which <code class="docutils literal notranslate"><span class="pre">encode()</span></code> has
been called;</li>
<li><code class="docutils literal notranslate"><span class="pre">start</span></code>: The position of the first unencodable character;</li>
<li><code class="docutils literal notranslate"><span class="pre">end</span></code>: (The position of the last unencodable character)+1 (or
the length of object, if all characters from start to the end
of object are unencodable);</li>
<li><code class="docutils literal notranslate"><span class="pre">reason</span></code>: The reason why <code class="docutils literal notranslate"><span class="pre">object[start:end]</span></code> couldn’t be encoded.</li>
</ul>
<p>If object has consecutive unencodable characters, the encoder
should collect those characters for one call to the callback if
those characters can’t be encoded for the same reason.  The
encoder is not required to implement this behaviour but may call
the callback for every single character, but it is strongly
suggested that the collecting method is implemented.</p>
<p>The callback must not modify the exception object.  If the
callback does not raise an exception (either the one passed in, or
a different one), it must return a tuple:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">newpos</span><span class="p">)</span>
</pre></div>
</div>
<p>replacement is a unicode object that the encoder will encode and
emit instead of the unencodable <code class="docutils literal notranslate"><span class="pre">object[start:end]</span></code> part, newpos
specifies a new position within object, where (after encoding the
replacement) the encoder will continue encoding.</p>
<p>Negative values for newpos are treated as being relative to
end of object. If newpos is out of bounds the encoder will raise
an <code class="docutils literal notranslate"><span class="pre">IndexError</span></code>.</p>
<p>If the replacement string itself contains an unencodable character
the encoder raises the exception object (but may set a different
reason string before raising).</p>
<p>Should further encoding errors occur, the encoder is allowed to
reuse the exception object for the next call to the callback.
Furthermore, the encoder is allowed to cache the result of
<code class="docutils literal notranslate"><span class="pre">codecs.lookup_error</span></code>.</p>
<p>If the callback does not know how to handle the exception, it must
raise a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code>.</p>
<p>Decoding works similar to encoding with the following differences:</p>
<ul class="simple">
<li>The exception class is named <code class="docutils literal notranslate"><span class="pre">UnicodeDecodeError</span></code> and the attribute
object is the original 8bit string that the decoder is currently
decoding.</li>
<li>The decoder will call the callback with those bytes that
constitute one undecodable sequence, even if there is more than
one undecodable sequence that is undecodable for the same reason
directly after the first one.  E.g. for the “unicode-escape”
encoding, when decoding the illegal string <code class="docutils literal notranslate"><span class="pre">\\u00\\u01x</span></code>, the
callback will be called twice (once for <code class="docutils literal notranslate"><span class="pre">\\u00</span></code> and once for
<code class="docutils literal notranslate"><span class="pre">\\u01</span></code>).  This is done to be able to generate the correct number
of replacement characters.</li>
<li>The replacement returned from the callback is a unicode object
that will be emitted by the decoder as-is without further
processing instead of the undecodable <code class="docutils literal notranslate"><span class="pre">object[start:end]</span></code> part.</li>
</ul>
<p>There is a third API that uses the old strict/ignore/replace error
handling scheme:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PyUnicode_TranslateCharmap</span><span class="o">/</span><span class="n">unicode</span><span class="o">.</span><span class="n">translate</span>
</pre></div>
</div>
<p>The proposed patch will enhance <code class="docutils literal notranslate"><span class="pre">PyUnicode_TranslateCharmap</span></code>, so
that it also supports the callback registry.  This has the
additional side effect that <code class="docutils literal notranslate"><span class="pre">PyUnicode_TranslateCharmap</span></code> will
support multi-character replacement strings (see SF feature
request #403100 <a class="footnote-reference brackets" href="#id3" id="id1">[1]</a>).</p>
<p>For <code class="docutils literal notranslate"><span class="pre">PyUnicode_TranslateCharmap</span></code> the exception class will be named
<code class="docutils literal notranslate"><span class="pre">UnicodeTranslateError</span></code>.  <code class="docutils literal notranslate"><span class="pre">PyUnicode_TranslateCharmap</span></code> will collect
all consecutive untranslatable characters (i.e. those that map to
<code class="docutils literal notranslate"><span class="pre">None</span></code>) and call the callback with them.  The replacement returned
from the callback is a unicode object that will be put in the
translated result as-is, without further processing.</p>
<p>All encoders and decoders are allowed to implement the callback
functionality themselves, if they recognize the callback name
(i.e. if it is a system callback like “strict”, “replace” and
“ignore”).  The proposed patch will add two additional system
callback names: “backslashreplace” and “xmlcharrefreplace”, which
can be used for encoding and translating and which will also be
implemented in-place for all encoders and
<code class="docutils literal notranslate"><span class="pre">PyUnicode_TranslateCharmap</span></code>.</p>
<p>The Python equivalent of these five callbacks will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">strict</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">exc</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ignore</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">UnicodeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;can&#39;t handle </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
         <span class="k">return</span> <span class="p">((</span><span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="o">-</span><span class="n">exc</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">*</span><span class="sa">u</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
     <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">UnicodeDecodeError</span><span class="p">):</span>
         <span class="k">return</span> <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">ufffd&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
     <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">UnicodeTranslateError</span><span class="p">):</span>
         <span class="k">return</span> <span class="p">((</span><span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="o">-</span><span class="n">exc</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">*</span><span class="sa">u</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">ufffd&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;can&#39;t handle </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">backslashreplace</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span>
         <span class="p">(</span><span class="ne">UnicodeEncodeError</span><span class="p">,</span> <span class="ne">UnicodeTranslateError</span><span class="p">)):</span>
         <span class="n">s</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span>
         <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">object</span><span class="p">[</span><span class="n">exc</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;=</span><span class="mh">0xff</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x</span><span class="si">%02x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;=</span><span class="mh">0xffff</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">u</span><span class="si">%04x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">U</span><span class="si">%08x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
         <span class="k">return</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;can&#39;t handle </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">xmlcharrefreplace</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span>
         <span class="p">(</span><span class="ne">UnicodeEncodeError</span><span class="p">,</span> <span class="ne">UnicodeTranslateError</span><span class="p">)):</span>
         <span class="n">s</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span>
         <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">object</span><span class="p">[</span><span class="n">exc</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="p">]:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">u</span><span class="s2">&quot;&amp;#</span><span class="si">%d</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
         <span class="k">return</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;can&#39;t handle </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
<p>These five callback handlers will also be accessible to Python as
<code class="docutils literal notranslate"><span class="pre">codecs.strict_error</span></code>, <code class="docutils literal notranslate"><span class="pre">codecs.ignore_error</span></code>, <code class="docutils literal notranslate"><span class="pre">codecs.replace_error</span></code>,
<code class="docutils literal notranslate"><span class="pre">codecs.backslashreplace_error</span></code> and <code class="docutils literal notranslate"><span class="pre">codecs.xmlcharrefreplace_error</span></code>.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>Most legacy encoding do not support the full range of Unicode
characters.  For these cases many high level protocols support a
way of escaping a Unicode character (e.g. Python itself supports
the <code class="docutils literal notranslate"><span class="pre">\x</span></code>, <code class="docutils literal notranslate"><span class="pre">\u</span></code> and <code class="docutils literal notranslate"><span class="pre">\U</span></code> convention, XML supports character references
via &amp;#xxx; etc.).</p>
<p>When implementing such an encoding algorithm, a problem with the
current implementation of the encode method of Unicode objects
becomes apparent: For determining which characters are unencodable
by a certain encoding, every single character has to be tried,
because encode does not provide any information about the location
of the error(s), so</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (1)</span>
<span class="n">us</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;xxx&quot;</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">us</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
</pre></div>
</div>
<p>has to be replaced by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (2)</span>
<span class="n">us</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;xxx&quot;</span>
<span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">us</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&amp;#</span><span class="si">%d</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>This slows down encoding dramatically as now the loop through the
string is done in Python code and no longer in C code.</p>
<p>Furthermore, this solution poses problems with stateful encodings.
For example, UTF-16 uses a Byte Order Mark at the start of the
encoded byte string to specify the byte order.  Using (2) with
UTF-16, results in an 8 bit string with a BOM between every
character.</p>
<p>To work around this problem, a stream writer - which keeps state
between calls to the encoding function - has to be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (3)</span>
<span class="n">us</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;xxx&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">codecs</span><span class="o">,</span><span class="w"> </span><span class="nn">cStringIO</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">StringIO</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<span class="n">uv</span> <span class="o">=</span> <span class="n">writer</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">us</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
        <span class="n">uv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;&amp;#</span><span class="si">%d</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>To compare the speed of (1) and (3) the following test script has
been used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (4)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="n">us</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;äa&quot;</span><span class="o">*</span><span class="mi">1000000</span>
<span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;ascii&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">codecs</span><span class="o">,</span><span class="w"> </span><span class="nn">cStringIO</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">StringIO</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">s1</span> <span class="o">=</span> <span class="n">us</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>

<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<span class="n">uv</span> <span class="o">=</span> <span class="n">writer</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">us</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
        <span class="n">uv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

<span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">assert</span><span class="p">(</span><span class="n">s1</span><span class="o">==</span><span class="n">s2</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;1:&quot;</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span>
<span class="nb">print</span> <span class="s2">&quot;2:&quot;</span><span class="p">,</span> <span class="n">t3</span><span class="o">-</span><span class="n">t2</span>
<span class="nb">print</span> <span class="s2">&quot;factor:&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
</pre></div>
</div>
<p>On Linux this gives the following output (with Python 2.3a0):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">:</span> <span class="mf">0.274321913719</span>
<span class="mi">2</span><span class="p">:</span> <span class="mf">51.1284689903</span>
<span class="n">factor</span><span class="p">:</span> <span class="mf">186.381278466</span>
</pre></div>
</div>
<p>i.e. (3) is 180 times slower than (1).</p>
<p>Callbacks must be stateless, because as soon as a callback is
registered it is available globally and can be called by multiple
<code class="docutils literal notranslate"><span class="pre">encode()</span></code> calls.  To be able to use stateful callbacks, the errors
parameter for encode/decode/translate would have to be changed
from <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*</span></code> to <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>, so that the callback could be used
directly, without the need to register the callback globally.  As
this requires changes to lots of C prototypes, this approach was
rejected.</p>
<p>Currently all encoding/decoding functions have arguments</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">Py_UNICODE</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="nb">int</span> <span class="n">size</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="nb">int</span> <span class="n">size</span>
</pre></div>
</div>
<p>to specify the unicode characters/8bit characters to be
encoded/decoded.  So in case of an error the codec has to create a
new unicode or str object from these parameters and store it in
the exception object.  The callers of these encoding/decoding
functions extract these parameters from str/unicode objects
themselves most of the time, so it could speed up error handling
if these object were passed directly.  As this again requires
changes to many C functions, this approach has been rejected.</p>
<p>For stream readers/writers the errors attribute must be changeable
to be able to switch between different error handling methods
during the lifetime of the stream reader/writer. This is currently
the case for <code class="docutils literal notranslate"><span class="pre">codecs.StreamReader</span></code> and <code class="docutils literal notranslate"><span class="pre">codecs.StreamWriter</span></code> and
all their subclasses. All core codecs and probably most of the
third party codecs (e.g. <code class="docutils literal notranslate"><span class="pre">JapaneseCodecs</span></code>) derive their stream
readers/writers from these classes so this already works,
but the attribute errors should be documented as a requirement.</p>
</section>
<section id="implementation-notes">
<h2><a class="toc-backref" href="#implementation-notes" role="doc-backlink">Implementation Notes</a></h2>
<p>A sample implementation is available as SourceForge patch #432401
<a class="footnote-reference brackets" href="#id4" id="id2">[2]</a> including a script for testing the speed of various
string/encoding/error combinations and a test script.</p>
<p>Currently the new exception classes are old style Python
classes. This means that accessing attributes results
in a dict lookup. The C API is implemented in a way
that makes it possible to switch to new style classes
behind the scene, if <code class="docutils literal notranslate"><span class="pre">Exception</span></code> (and <code class="docutils literal notranslate"><span class="pre">UnicodeError</span></code>) will
be changed to new style classes implemented in C for
improved performance.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">codecs.StreamReaderWriter</span></code> uses the errors parameter for
both reading and writing.  To be more flexible this should
probably be changed to two separate parameters for reading and
writing.</p>
<p>The errors parameter of <code class="docutils literal notranslate"><span class="pre">PyUnicode_TranslateCharmap</span></code> is not
availably to Python, which makes testing of the new functionality
of <code class="docutils literal notranslate"><span class="pre">PyUnicode_TranslateCharmap</span></code> impossible with Python scripts.  The
patch should add an optional argument errors to unicode.translate
to expose the functionality and make testing possible.</p>
<p>Codecs that do something different than encoding/decoding from/to
unicode and want to use the new machinery can define their own
exception classes and the strict handlers will automatically work
with it. The other predefined error handlers are unicode specific
and expect to get a <code class="docutils literal notranslate"><span class="pre">Unicode(Encode|Decode|Translate)Error</span></code>
exception object so they won’t work.</p>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>The semantics of unicode.encode with errors=”replace” has changed:
The old version always stored a ? character in the output string
even if no character was mapped to ? in the mapping.  With the
proposed patch, the replacement string from the callback will
again be looked up in the mapping dictionary.  But as all
supported encodings are ASCII based, and thus map ? to ?, this
should not be a problem in practice.</p>
<p>Illegal values for the errors argument raised <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> before,
now they will raise <code class="docutils literal notranslate"><span class="pre">LookupError</span></code>.</p>
</section>
<section id="references">
<h2><a class="toc-backref" href="#references" role="doc-backlink">References</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id3" role="doc-footnote">
<dt class="label" id="id3">[<a href="#id1">1</a>]</dt>
<dd>SF feature request #403100
“Multicharacter replacements in PyUnicode_TranslateCharmap”
<a class="reference external" href="https://bugs.python.org/issue403100">https://bugs.python.org/issue403100</a></aside>
<aside class="footnote brackets" id="id4" role="doc-footnote">
<dt class="label" id="id4">[<a href="#id2">2</a>]</dt>
<dd>SF patch #432401 “unicode encoding error callbacks”
<a class="reference external" href="https://bugs.python.org/issue432401">https://bugs.python.org/issue432401</a></aside>
</aside>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0293.rst">https://github.com/python/peps/blob/main/peps/pep-0293.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0293.rst">2025-02-01 08:59:27 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#implementation-notes">Implementation Notes</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0293.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
</body>
</html>