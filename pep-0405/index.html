
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 405 – Python Virtual Environments | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0405/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 405 – Python Virtual Environments | peps.python.org'>
    <meta property="og:description" content="This PEP proposes to add to Python a mechanism for lightweight “virtual environments” with their own site directories, optionally isolated from system site directories.  Each virtual environment has its own Python binary (allowing creation of environmen...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0405/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="This PEP proposes to add to Python a mechanism for lightweight “virtual environments” with their own site directories, optionally isolated from system site directories.  Each virtual environment has its own Python binary (allowing creation of environmen...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 405</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 405 – Python Virtual Environments" data-pagefind-weight="10" class="visually-hidden">PEP 405 – Python Virtual Environments</span>
            <section id="pep-content">
<h1 class="page-title">PEP 405 – Python Virtual Environments</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Carl Meyer &lt;carl&#32;&#97;t&#32;oddbird.net&gt;</dd>
<dt class="field-even">BDFL-Delegate<span class="colon">:</span></dt>
<dd class="field-even">Alyssa Coghlan</dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Accepted and implementation complete, or no longer active">Final</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-odd">Topic<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="../topic/packaging/">Packaging</a></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">13-Jun-2011</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.3</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even">24-Oct-2011, 28-Oct-2011, 06-Mar-2012, 24-May-2012</dd>
<dt class="field-odd">Resolution<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2012-May/119668.html">Python-Dev message</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#isolation-from-system-site-packages">Isolation from system site-packages</a></li>
<li><a class="reference internal" href="#creating-virtual-environments">Creating virtual environments</a></li>
<li><a class="reference internal" href="#sysconfig-install-schemes-and-user-site">Sysconfig install schemes and user-site</a></li>
<li><a class="reference internal" href="#copies-versus-symlinks">Copies versus symlinks</a></li>
<li><a class="reference internal" href="#include-files">Include files</a></li>
<li><a class="reference internal" href="#api">API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a><ul>
<li><a class="reference internal" href="#splitting-the-meanings-of-sys-prefix">Splitting the meanings of <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code></a></li>
<li><a class="reference internal" href="#impact-on-other-python-implementations">Impact on other Python implementations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>This PEP proposes to add to Python a mechanism for lightweight
“virtual environments” with their own site directories, optionally
isolated from system site directories.  Each virtual environment has
its own Python binary (allowing creation of environments with various
Python versions) and can have its own independent set of installed
Python packages in its site directories, but shares the standard
library with the base installed Python.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>The utility of Python virtual environments has already been well
established by the popularity of existing third-party
virtual-environment tools, primarily Ian Bicking’s <a class="reference external" href="http://www.virtualenv.org">virtualenv</a>.
Virtual environments are already widely used for dependency management
and isolation, ease of installing and using Python packages without
system-administrator access, and automated testing of Python software
across multiple Python versions, among other uses.</p>
<p>Existing virtual environment tools suffer from lack of support from
the behavior of Python itself.  Tools such as <a class="reference external" href="https://github.com/kvbik/rvirtualenv">rvirtualenv</a>, which do
not copy the Python binary into the virtual environment, cannot
provide reliable isolation from system site directories.  Virtualenv,
which does copy the Python binary, is forced to duplicate much of
Python’s <code class="docutils literal notranslate"><span class="pre">site</span></code> module and manually symlink/copy an ever-changing
set of standard-library modules into the virtual environment in order
to perform a delicate boot-strapping dance at every startup.
(Virtualenv must copy the binary in order to provide isolation, as
Python dereferences a symlinked executable before searching for
<code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>.)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">PYTHONHOME</span></code> environment variable, Python’s only existing
built-in solution for virtual environments, requires
copying/symlinking the entire standard library into every environment.
Copying the whole standard library is not a lightweight solution, and
cross-platform support for symlinks remains inconsistent (even on
Windows platforms that do support them, creating them often requires
administrator privileges).</p>
<p>A virtual environment mechanism integrated with Python and drawing on
years of experience with existing third-party tools can lower
maintenance, raise reliability, and be more easily available to all
Python users.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>When the Python binary is executed, it attempts to determine its
prefix (which it stores in <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>), which is then used to find
the standard library and other key files, and by the <code class="docutils literal notranslate"><span class="pre">site</span></code> module
to determine the location of the site-package directories.  Currently
the prefix is found (assuming <code class="docutils literal notranslate"><span class="pre">PYTHONHOME</span></code> is not set) by first
walking up the filesystem tree looking for a marker file (<code class="docutils literal notranslate"><span class="pre">os.py</span></code>)
that signifies the presence of the standard library, and if none is
found, falling back to the build-time prefix hardcoded in the binary.</p>
<p>This PEP proposes to add a new first step to this search.  If a
<code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> file is found either adjacent to the Python executable or
one directory above it (if the executable is a symlink, it is not
dereferenced), this file is scanned for lines of the form <code class="docutils literal notranslate"><span class="pre">key</span> <span class="pre">=</span>
<span class="pre">value</span></code>.  If a <code class="docutils literal notranslate"><span class="pre">home</span></code> key is found, this signifies that the Python
binary belongs to a virtual environment, and the value of the <code class="docutils literal notranslate"><span class="pre">home</span></code>
key is the directory containing the Python executable used to create
this virtual environment.</p>
<p>In this case, prefix-finding continues as normal using the value of
the <code class="docutils literal notranslate"><span class="pre">home</span></code> key as the effective Python binary location, which finds
the prefix of the base installation.  <code class="docutils literal notranslate"><span class="pre">sys.base_prefix</span></code> is set to
this value, while <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> is set to the directory containing
<code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code>.</p>
<p>(If <code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> is not found or does not contain the <code class="docutils literal notranslate"><span class="pre">home</span></code> key,
prefix-finding continues normally, and <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> will be equal to
<code class="docutils literal notranslate"><span class="pre">sys.base_prefix</span></code>.)</p>
<p>Also, <code class="docutils literal notranslate"><span class="pre">sys.base_exec_prefix</span></code> is added, and handled similarly with
regard to <code class="docutils literal notranslate"><span class="pre">sys.exec_prefix</span></code>. (<code class="docutils literal notranslate"><span class="pre">sys.exec_prefix</span></code> is the equivalent of
<code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>, but for platform-specific files; by default it has the
same value as <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>.)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">site</span></code> and <code class="docutils literal notranslate"><span class="pre">sysconfig</span></code> standard-library modules are modified
such that the standard library and header files are found relative
to <code class="docutils literal notranslate"><span class="pre">sys.base_prefix</span></code> / <code class="docutils literal notranslate"><span class="pre">sys.base_exec_prefix</span></code>, while site-package
directories (“purelib” and “platlib”, in <code class="docutils literal notranslate"><span class="pre">sysconfig</span></code> terms) are still
found relative to <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> / <code class="docutils literal notranslate"><span class="pre">sys.exec_prefix</span></code>.</p>
<p>Thus, a Python virtual environment in its simplest form would consist
of nothing more than a copy or symlink of the Python binary
accompanied by a <code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> file and a site-packages directory.</p>
<section id="isolation-from-system-site-packages">
<h3><a class="toc-backref" href="#isolation-from-system-site-packages" role="doc-backlink">Isolation from system site-packages</a></h3>
<p>By default, a virtual environment is entirely isolated from the
system-level site-packages directories.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> file also contains a key
<code class="docutils literal notranslate"><span class="pre">include-system-site-packages</span></code> with a value of <code class="docutils literal notranslate"><span class="pre">true</span></code> (not case
sensitive), the <code class="docutils literal notranslate"><span class="pre">site</span></code> module will also add the system site
directories to <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> after the virtual environment site
directories.  Thus system-installed packages will still be importable,
but a package of the same name installed in the virtual environment
will take precedence.</p>
<p><a class="pep reference internal" href="../pep-0370/" title="PEP 370 – Per user site-packages directory">PEP 370</a> user-level site-packages are considered part of the system
site-packages for venv purposes: they are not available from an
isolated venv, but are available from an
<code class="docutils literal notranslate"><span class="pre">include-system-site-packages</span> <span class="pre">=</span> <span class="pre">true</span></code> venv.</p>
</section>
<section id="creating-virtual-environments">
<h3><a class="toc-backref" href="#creating-virtual-environments" role="doc-backlink">Creating virtual environments</a></h3>
<p>This PEP also proposes adding a new <code class="docutils literal notranslate"><span class="pre">venv</span></code> module to the standard
library which implements the creation of virtual environments.  This
module can be executed using the <code class="docutils literal notranslate"><span class="pre">-m</span></code> flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">virtual</span><span class="o">/</span><span class="n">environment</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">pyvenv</span></code> installed script is also provided to make this more
convenient:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pyvenv</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">virtual</span><span class="o">/</span><span class="n">environment</span>
</pre></div>
</div>
<p>Running this command creates the target directory (creating any parent
directories that don’t exist already) and places a <code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> file
in it with a <code class="docutils literal notranslate"><span class="pre">home</span></code> key pointing to the Python installation the
command was run from.  It also creates a <code class="docutils literal notranslate"><span class="pre">bin/</span></code> (or <code class="docutils literal notranslate"><span class="pre">Scripts</span></code> on
Windows) subdirectory containing a copy (or symlink) of the <code class="docutils literal notranslate"><span class="pre">python3</span></code>
executable, and the <code class="docutils literal notranslate"><span class="pre">pysetup3</span></code> script from the <code class="docutils literal notranslate"><span class="pre">packaging</span></code> standard
library module (to facilitate easy installation of packages from PyPI
into the new venv).  And it creates an (initially empty)
<code class="docutils literal notranslate"><span class="pre">lib/pythonX.Y/site-packages</span></code> (or <code class="docutils literal notranslate"><span class="pre">Lib\site-packages</span></code> on Windows)
subdirectory.</p>
<p>If the target directory already exists an error will be raised, unless
the <code class="docutils literal notranslate"><span class="pre">--clear</span></code> option was provided, in which case the target
directory will be deleted and virtual environment creation will
proceed as usual.</p>
<p>The created <code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> file also includes the
<code class="docutils literal notranslate"><span class="pre">include-system-site-packages</span></code> key, set to <code class="docutils literal notranslate"><span class="pre">true</span></code> if <code class="docutils literal notranslate"><span class="pre">pyvenv</span></code> is
run with the <code class="docutils literal notranslate"><span class="pre">--system-site-packages</span></code> option, <code class="docutils literal notranslate"><span class="pre">false</span></code> by default.</p>
<p>Multiple paths can be given to <code class="docutils literal notranslate"><span class="pre">pyvenv</span></code>, in which case an identical
venv will be created, according to the given options, at each
provided path.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">venv</span></code> module also places “shell activation scripts” for POSIX and
Windows systems in the <code class="docutils literal notranslate"><span class="pre">bin</span></code> or <code class="docutils literal notranslate"><span class="pre">Scripts</span></code> directory of the
venv. These scripts simply add the virtual environment’s <code class="docutils literal notranslate"><span class="pre">bin</span></code> (or
<code class="docutils literal notranslate"><span class="pre">Scripts</span></code>) directory to the front of the user’s shell PATH.  This is
not strictly necessary for use of a virtual environment (as an explicit
path to the venv’s python binary or scripts can just as well be used),
but it is convenient.</p>
<p>In order to allow <code class="docutils literal notranslate"><span class="pre">pysetup</span></code> and other Python package managers to
install packages into the virtual environment the same way they would
install into a normal Python installation, and avoid special-casing
virtual environments in <code class="docutils literal notranslate"><span class="pre">sysconfig</span></code> beyond using <code class="docutils literal notranslate"><span class="pre">sys.base_prefix</span></code>
in place of <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> where appropriate, the internal virtual
environment layout mimics the layout of the Python installation itself
on each platform.  So a typical virtual environment layout on a POSIX
system would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pyvenv</span><span class="o">.</span><span class="n">cfg</span>
<span class="nb">bin</span><span class="o">/</span><span class="n">python3</span>
<span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="nb">bin</span><span class="o">/</span><span class="n">pysetup3</span>
<span class="n">include</span><span class="o">/</span>
<span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.3</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span>
</pre></div>
</div>
<p>While on a Windows system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pyvenv</span><span class="o">.</span><span class="n">cfg</span>
<span class="n">Scripts</span><span class="o">/</span><span class="n">python</span><span class="o">.</span><span class="n">exe</span>
<span class="n">Scripts</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="n">dll</span>
<span class="n">Scripts</span><span class="o">/</span><span class="n">pysetup3</span><span class="o">.</span><span class="n">exe</span>
<span class="n">Scripts</span><span class="o">/</span><span class="n">pysetup3</span><span class="o">-</span><span class="n">script</span><span class="o">.</span><span class="n">py</span>
        <span class="o">...</span> <span class="n">other</span> <span class="n">DLLs</span> <span class="ow">and</span> <span class="n">pyds</span><span class="o">...</span>
<span class="n">Include</span><span class="o">/</span>
<span class="n">Lib</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span>
</pre></div>
</div>
<p>Third-party packages installed into the virtual environment will have
their Python modules placed in the <code class="docutils literal notranslate"><span class="pre">site-packages</span></code> directory, and
their executables placed in <code class="docutils literal notranslate"><span class="pre">bin/</span></code> or <code class="docutils literal notranslate"><span class="pre">Scripts</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On a normal Windows system-level installation, the Python binary
itself wouldn’t go inside the “Scripts/” subdirectory, as it does
in the default venv layout.  This is useful in a virtual
environment so that a user only has to add a single directory to
their shell PATH in order to effectively “activate” the virtual
environment.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On Windows, it is necessary to also copy or symlink DLLs and pyd
files from compiled stdlib modules into the env, because if the
venv is created from a non-system-wide Python installation,
Windows won’t be able to find the Python installation’s copies of
those files when Python is run from the venv.</p>
</div>
</section>
<section id="sysconfig-install-schemes-and-user-site">
<h3><a class="toc-backref" href="#sysconfig-install-schemes-and-user-site" role="doc-backlink">Sysconfig install schemes and user-site</a></h3>
<p>This approach explicitly chooses not to introduce a new sysconfig
install scheme for venvs. Rather, by modifying <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> we
ensure that existing install schemes which base locations on
<code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> will simply work in a venv. Installation to other
install schemes (for instance, the user-site schemes) whose paths are
not relative to <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>, will not be affected by a venv at all.</p>
<p>It may be feasible to create an alternative implementation of Python
virtual environments based on a virtual-specific sysconfig scheme, but
it would be less robust, as it would require more code to be aware of
whether it is operating within a virtual environment or not.</p>
</section>
<section id="copies-versus-symlinks">
<h3><a class="toc-backref" href="#copies-versus-symlinks" role="doc-backlink">Copies versus symlinks</a></h3>
<p>The technique in this PEP works equally well in general with a copied
or symlinked Python binary (and other needed DLLs on Windows).
Symlinking is preferable where possible, because in the case of an
upgrade to the underlying Python installation, a Python executable
copied in a venv might become out-of-sync with the installed standard
library and require manual upgrade.</p>
<p>There are some cross-platform difficulties with symlinks:</p>
<ul class="simple">
<li>Not all Windows versions support symlinks, and even on those that
do, creating them often requires administrator privileges.</li>
<li>On OS X framework builds of Python, sys.executable is just a stub
that executes the real Python binary.  Symlinking this stub does not
work; it must be copied.  (Fortunately the stub is also small, and
not changed by bugfix upgrades to Python, so copying it is not an
issue).</li>
</ul>
<p>Thus, this PEP proposes to symlink the binary on all platforms except
for Windows, and OS X framework builds. A <code class="docutils literal notranslate"><span class="pre">--symlink</span></code> option is
available to force the use of symlinks on Windows versions that
support them, if the appropriate permissions are available. (This
option has no effect on OS X framework builds, since symlinking can
never work there, and has no advantages).</p>
<p>On Windows, if <code class="docutils literal notranslate"><span class="pre">--symlink</span></code> is not used, this means that if the
underlying Python installation is upgraded, the Python binary and DLLs
in the venv should be updated, or there could be issues of mismatch
with the upgraded standard library. The pyvenv script accepts a
<code class="docutils literal notranslate"><span class="pre">--upgrade</span></code> option for easily performing this upgrade on an existing
venv.</p>
</section>
<section id="include-files">
<h3><a class="toc-backref" href="#include-files" role="doc-backlink">Include files</a></h3>
<p>Current virtualenv handles include files in this way:</p>
<p>On POSIX systems where the installed Python’s include files are found in
<code class="docutils literal notranslate"><span class="pre">${base_prefix}/include/pythonX.X</span></code>, virtualenv creates
<code class="docutils literal notranslate"><span class="pre">${venv}/include/</span></code> and symlinks <code class="docutils literal notranslate"><span class="pre">${base_prefix}/include/pythonX.X</span></code>
to <code class="docutils literal notranslate"><span class="pre">${venv}/include/pythonX.X</span></code>. On Windows, where Python’s include
files are found in <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">sys.prefix</span> <span class="pre">}}/Include</span></code> and symlinks are not
reliably available, virtualenv copies <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">sys.prefix</span> <span class="pre">}}/Include</span></code> to
<code class="docutils literal notranslate"><span class="pre">${venv}/Include</span></code>. This ensures that extension modules built and
installed within the virtualenv will always find the Python header files
they need in the expected location relative to <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>.</p>
<p>This solution is not ideal when an extension module installs its own
header files, as the default installation location for those header
files may be a symlink to a system directory that may not be
writable. One installer, pip, explicitly works around this by
installing header files to a nonstandard location
<code class="docutils literal notranslate"><span class="pre">${venv}/include/site/pythonX.X/</span></code>, as in Python there’s currently no
standard abstraction for a site-specific include directory.</p>
<p>This PEP proposes a slightly different approach, though one with
essentially the same effect and the same set of advantages and
disadvantages. Rather than symlinking or copying include files into the
venv, we simply modify the sysconfig schemes so that header files are
always sought relative to <code class="docutils literal notranslate"><span class="pre">base_prefix</span></code> rather than <code class="docutils literal notranslate"><span class="pre">prefix</span></code>. (We
also create an <code class="docutils literal notranslate"><span class="pre">include/</span></code> directory within the venv, so installers
have somewhere to put include files installed within the env).</p>
<p>Better handling of include files in distutils/packaging and, by
extension, pyvenv, is an area that may deserve its own future PEP. For
now, we propose that the behavior of virtualenv has thus far proved
itself to be at least “good enough” in practice.</p>
</section>
<section id="api">
<h3><a class="toc-backref" href="#api" role="doc-backlink">API</a></h3>
<p>The high-level method described above makes use of a simple API which
provides mechanisms for third-party virtual environment creators to
customize environment creation according to their needs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">venv</span></code> module contains an <code class="docutils literal notranslate"><span class="pre">EnvBuilder</span></code> class which accepts the
following keyword arguments on instantiation:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">system_site_packages</span></code> - A Boolean value indicating that the
system Python site-packages should be available to the environment.
Defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">clear</span></code> - A Boolean value which, if true, will delete any existing
target directory instead of raising an exception.  Defaults to
<code class="docutils literal notranslate"><span class="pre">False</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">symlinks</span></code> - A Boolean value indicating whether to attempt to
symlink the Python binary (and any necessary DLLs or other binaries,
e.g. <code class="docutils literal notranslate"><span class="pre">pythonw.exe</span></code>), rather than copying.  Defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</li>
</ul>
<p>The instantiated env-builder has a <code class="docutils literal notranslate"><span class="pre">create</span></code> method, which takes as
required argument the path (absolute or relative to the current
directory) of the target directory which is to contain the virtual
environment.  The <code class="docutils literal notranslate"><span class="pre">create</span></code> method either creates the environment in
the specified directory, or raises an appropriate exception.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">venv</span></code> module also provides a module-level <code class="docutils literal notranslate"><span class="pre">create</span></code> function
as a convenience:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">env_dir</span><span class="p">,</span>
           <span class="n">system_site_packages</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">EnvBuilder</span><span class="p">(</span>
        <span class="n">system_site_packages</span><span class="o">=</span><span class="n">system_site_packages</span><span class="p">,</span>
        <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">,</span>
        <span class="n">use_symlinks</span><span class="o">=</span><span class="n">use_symlinks</span><span class="p">)</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">env_dir</span><span class="p">)</span>
</pre></div>
</div>
<p>Creators of third-party virtual environment tools are free to use the
provided <code class="docutils literal notranslate"><span class="pre">EnvBuilder</span></code> class as a base class.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">create</span></code> method of the <code class="docutils literal notranslate"><span class="pre">EnvBuilder</span></code> class illustrates the
hooks available for customization:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a virtualized Python environment in a directory.</span>

<span class="sd">    :param env_dir: The target directory to create an environment in.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">env_dir</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_directories</span><span class="p">(</span><span class="n">env_dir</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_configuration</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setup_python</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_setup</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>Each of the methods <code class="docutils literal notranslate"><span class="pre">create_directories</span></code>, <code class="docutils literal notranslate"><span class="pre">create_configuration</span></code>,
<code class="docutils literal notranslate"><span class="pre">setup_python</span></code>, and <code class="docutils literal notranslate"><span class="pre">post_setup</span></code> can be overridden.  The functions
of these methods are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">create_directories</span></code> - creates the environment directory and all
necessary directories, and returns a context object.  This is just a
holder for attributes (such as paths), for use by the other methods.</li>
<li><code class="docutils literal notranslate"><span class="pre">create_configuration</span></code> - creates the <code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> configuration
file in the environment.</li>
<li><code class="docutils literal notranslate"><span class="pre">setup_python</span></code> - creates a copy of the Python executable (and,
under Windows, DLLs) in the environment.</li>
<li><code class="docutils literal notranslate"><span class="pre">post_setup</span></code> - A (no-op by default) hook method which can be
overridden in third party subclasses to pre-install packages or
install scripts in the virtual environment.</li>
</ul>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">EnvBuilder</span></code> provides a utility method that can be
called from <code class="docutils literal notranslate"><span class="pre">post_setup</span></code> in subclasses to assist in installing
custom scripts into the virtual environment.  The method
<code class="docutils literal notranslate"><span class="pre">install_scripts</span></code> accepts as arguments the <code class="docutils literal notranslate"><span class="pre">context</span></code> object (see
above) and a path to a directory.  The directory should contain
subdirectories “common”, “posix”, “nt”, each containing scripts
destined for the bin directory in the environment.  The contents of
“common” and the directory corresponding to <code class="docutils literal notranslate"><span class="pre">os.name</span></code> are copied
after doing some text replacement of placeholders:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">__VENV_DIR__</span></code> is replaced with absolute path of the environment
directory.</li>
<li><code class="docutils literal notranslate"><span class="pre">__VENV_NAME__</span></code> is replaced with the environment name (final path
segment of environment directory).</li>
<li><code class="docutils literal notranslate"><span class="pre">__VENV_BIN_NAME__</span></code> is replaced with the name of the bin directory
(either <code class="docutils literal notranslate"><span class="pre">bin</span></code> or <code class="docutils literal notranslate"><span class="pre">Scripts</span></code>).</li>
<li><code class="docutils literal notranslate"><span class="pre">__VENV_PYTHON__</span></code> is replaced with the absolute path of the
environment’s executable.</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">DistributeEnvBuilder</span></code> subclass in the reference implementation
illustrates how the customization hook can be used in practice to
pre-install Distribute into the virtual environment.  It’s not
envisaged that <code class="docutils literal notranslate"><span class="pre">DistributeEnvBuilder</span></code> will be actually added to
Python core, but it makes the reference implementation more
immediately useful for testing and exploratory purposes.</p>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<section id="splitting-the-meanings-of-sys-prefix">
<h3><a class="toc-backref" href="#splitting-the-meanings-of-sys-prefix" role="doc-backlink">Splitting the meanings of <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code></a></h3>
<p>Any virtual environment tool along these lines (which attempts to
isolate site-packages, while still making use of the base Python’s
standard library with no need for it to be symlinked into the virtual
environment) is proposing a split between two different meanings
(among others) that are currently both wrapped up in <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>:
the answers to the questions “Where is the standard library?” and
“Where is the site-packages location where third-party modules should
be installed?”</p>
<p>This split could be handled by introducing a new <code class="docutils literal notranslate"><span class="pre">sys</span></code> attribute for
either the former prefix or the latter prefix.  Either option
potentially introduces some backwards-incompatibility with software
written to assume the other meaning for <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>.  (Such
software should preferably be using the APIs in the <code class="docutils literal notranslate"><span class="pre">site</span></code> and
<code class="docutils literal notranslate"><span class="pre">sysconfig</span></code> modules to answer these questions rather than using
<code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> directly, in which case there is no
backwards-compatibility issue, but in practice <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> is
sometimes used.)</p>
<p>The <a class="reference external" href="http://docs.python.org/dev/library/sys.html#sys.prefix">documentation</a> for <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> describes it as “A string
giving the site-specific directory prefix where the platform
independent Python files are installed,” and specifically mentions the
standard library and header files as found under <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>.  It
does not mention <code class="docutils literal notranslate"><span class="pre">site-packages</span></code>.</p>
<p>Maintaining this documented definition would mean leaving
<code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> pointing to the base system installation (which is
where the standard library and header files are found), and
introducing a new value in <code class="docutils literal notranslate"><span class="pre">sys</span></code> (something like
<code class="docutils literal notranslate"><span class="pre">sys.site_prefix</span></code>) to point to the prefix for <code class="docutils literal notranslate"><span class="pre">site-packages</span></code>.
This would maintain the documented semantics of <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>, but
risk breaking isolation if third-party code uses <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> rather
than <code class="docutils literal notranslate"><span class="pre">sys.site_prefix</span></code> or the appropriate <code class="docutils literal notranslate"><span class="pre">site</span></code> API to find
site-packages directories.</p>
<p>The most notable case is probably <a class="reference external" href="http://peak.telecommunity.com/DevCenter/setuptools">setuptools</a> and its fork
<a class="reference external" href="http://packages.python.org/distribute/">distribute</a>, which mostly use <code class="docutils literal notranslate"><span class="pre">distutils</span></code> and <code class="docutils literal notranslate"><span class="pre">sysconfig</span></code> APIs,
but do use <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> directly to build up a list of site
directories for pre-flight checking where <code class="docutils literal notranslate"><span class="pre">pth</span></code> files can usefully be
placed.</p>
<p>Otherwise, a Google Code Search turns up what appears to be a
roughly even mix of usage between packages using <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> to
build up a site-packages path and packages using it to e.g. eliminate
the standard-library from code-execution tracing.</p>
<p>Although it requires modifying the documented definition of
<code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>, this PEP prefers to have <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> point to the
virtual environment (where <code class="docutils literal notranslate"><span class="pre">site-packages</span></code> is found), and introduce
<code class="docutils literal notranslate"><span class="pre">sys.base_prefix</span></code> to point to the standard library and Python header
files. Rationale for this choice:</p>
<ul class="simple">
<li>It is preferable to err on the side of greater isolation of the
virtual environment.</li>
<li>Virtualenv already modifies <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> to point at the virtual
environment, and in practice this has not been a problem.</li>
<li>No modification is required to setuptools/distribute.</li>
</ul>
</section>
<section id="impact-on-other-python-implementations">
<h3><a class="toc-backref" href="#impact-on-other-python-implementations" role="doc-backlink">Impact on other Python implementations</a></h3>
<p>The majority of this PEP’s changes occur in the standard library, which is
shared by other Python implementations and should not present any
problem.</p>
<p>Other Python implementations will need to replicate the new
<code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>-finding behavior of the interpreter bootstrap, including
locating and parsing the <code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> file, if it is present.</p>
</section>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>The reference implementation is found in <a class="reference external" href="http://hg.python.org/sandbox/vsajip#venv">a clone of the CPython
Mercurial repository</a>.  To test it, build and run <code class="docutils literal notranslate"><span class="pre">bin/pyvenv</span>
<span class="pre">/path/to/new/venv</span></code> to create a virtual environment.</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0405.rst">https://github.com/python/peps/blob/main/peps/pep-0405.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0405.rst">2025-02-01 08:59:27 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#isolation-from-system-site-packages">Isolation from system site-packages</a></li>
<li><a class="reference internal" href="#creating-virtual-environments">Creating virtual environments</a></li>
<li><a class="reference internal" href="#sysconfig-install-schemes-and-user-site">Sysconfig install schemes and user-site</a></li>
<li><a class="reference internal" href="#copies-versus-symlinks">Copies versus symlinks</a></li>
<li><a class="reference internal" href="#include-files">Include files</a></li>
<li><a class="reference internal" href="#api">API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a><ul>
<li><a class="reference internal" href="#splitting-the-meanings-of-sys-prefix">Splitting the meanings of <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code></a></li>
<li><a class="reference internal" href="#impact-on-other-python-implementations">Impact on other Python implementations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0405.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>