PEP: 803
Title: "abi3t": Stable ABI for Free-Threaded Builds
Author: Petr Viktorin <encukou@gmail.com>
Discussions-To: https://discuss.python.org/t/103628
Status: Draft
Type: Standards Track
Requires: 703, 793, 697
Created: 19-Aug-2025
Python-Version: 3.15
Post-History: `08-Sep-2025 <https://discuss.python.org/t/103628>`__


Abstract
========

Add a new variant of the Stable ABI, called “Stable ABI for Free-Threaded
Python” (or ``abi3t`` for short), and a corresponding API limitations.
``abi3t`` will be compatible with both free-threaded and GIL-enabled builds of
CPython.

To build for ``abi3t``, users define both :c:macro:`Py_GIL_DISABLED`
and :c:macro:`Py_LIMITED_API` before including ``Python.h``,
and avoid using API that relies on the layout of the :c:type:`PyObject`
structure.
This will require users to migrate to new API for common tasks like defining
modules and most classes.

Binary distributions (wheels) built with this variant of the Limited API
should use the ABI tag ``abi3.abi3t``.


Terminology
===========

This PEP uses “GIL-enabled build” as an antonym to “free-threaded build”,
that is, an interpreter or extension built without ``Py_GIL_DISABLED``.


Motivation
==========

The Stable ABI is currently not available for free-threaded builds.
Extensions will fail to build for a both Limited API and
free-threaded Python (that is, when both :c:macro:`Py_LIMITED_API` and
:c:macro:`Py_GIL_DISABLED` preprocessor macros are defined).
Extensions built for GIL-enabled builds of CPython will fail to load
(or crash) on free-threaded builds.

In its `acceptance post <https://discuss.python.org/t/84319/123>`__
for :pep:`779`, the Steering Council stated that it “expects that Stable ABI
for free-threading should be prepared and defined for Python 3.15”.

This PEP proposes the Stable ABI for free-threading.


Background
----------

Python's Stable ABI (``abi3`` for short), as defined in :pep:`384` and
:pep:`652`, provides a way to compile extension modules that can be loaded
on multiple minor versions of the CPython interpreter.
Several projects use this to limit the number of
:ref:`wheels <packaging:binary-distribution-format>` (binary artefacts)
that need to be built and distributed for each release, and/or to make it
easier to test with pre-release versions of Python.

With free-threading builds (:pep:`703`) being on track to eventually become
the default (:pep:`779`), we need a way to make a Stable ABI available
to those builds.

To build against a Stable ABI, the extension must use a *Limited API*,
that is, only a subset of the functions, structures, etc. that CPython
exposes.
Both the Limited API and the current Stable ABI are versioned, and building
against Stable ABI 3.X requires using only Limited API 3.X, and yields an
extension that is ABI-compatible with CPython 3.X and *any* later version
(though bugs in CPython sometimes cause incompatibilities in practice).

The Limited API is not “stable”: newer versions may remove API that
were a part of older versions.

This PEP proposes additional API limitations, as required to be compatible
with both GIL-enabled and free-threaded builds of CPython.


Rationale
=========

The design in this PEP uses several constraints:

Unified ABI
   A single compiled extension module should support both
   free-threaded and GIL-enabled builds.

No backwards compatibility now
   The new stable ABI variant will not support CPython 3.14 and below.
   Projects that need this support can build separate extensions specifically
   for the 3.14 free-threaded interpreter, and for older stable ABI versions.

   However, we won't block the possibility of extending compatibility to
   CPython 3.14 and below.
   See a :ref:`rejected idea <pep803-no-shim>` for how this could work.

API changes are OK
   The new Limited API variant may require extension authors to make
   significant changes to their code.
   Projects that cannot do this (yet) can continue using Limited API,
   which will yield separate extensions compatible with GIL-enabled builds
   and with specific versions of free-threaded builds.

No new configuration
   We do not introduce new “knobs” that influence what API is available
   and what the ABI is compatible with.
   Instead, we reuse the existing ``Py_GIL_DISABLED`` macro.


Tag name
--------

The tag ``abi3t`` is chosen to reflect the fact that this ABI is similar to
``abi3``, with minimal changes necessary to support free-threading (which
uses the letter ``t`` in existing, version-specific ABI tags like ``cp314t``).


Specification
=============


Building for ``abi3``
---------------------

When the :c:macro:`Py_LIMITED_API` macro is set to ``0x030f0000`` (3.15)
or above, Python will newly allow the :c:macro:`Py_GIL_DISABLED` to be defined.
(Currently -- in 3.14 -- it is an error when both are defined.)

The :c:macro:`Py_GIL_DISABLED` macro can be set in several ways, for example:

- on non-Windows platforms, by compiling with headers configured for
  free-threaded CPython;
- by passing ``Py_GIL_DISABLED`` to the compiler (possibly via a build tool);
  or
- using ``#define`` directly before including ``Python.h``.


Opaque PyObject
---------------

When both :c:macro:`Py_GIL_DISABLED` and :c:macro:`Py_LIMITED_API` is defined,
the CPython headers will:

- make the following structures *opaque* (or in C terminology, *incomplete
  types*):

  - :c:type:`PyObject`
  - :c:type:`PyVarObject`
  - :c:type:`!PyModuleDef_Base`
  - :c:type:`PyModuleDef`

- no longer include the following macros:

  - :c:macro:`PyObject_HEAD`
  - :c:macro:`!_PyObject_EXTRA_INIT`
  - :c:macro:`PyObject_HEAD_INIT`
  - :c:macro:`PyObject_VAR_HEAD`
  - :c:func:`Py_SET_TYPE`

In both the regular stable ABI (``abit3`` 3.15+) and the new
``abi3t``, the following will be exported functions (exposed in the ABI)
rather than macros:

- :c:func:`Py_SIZE`
- :c:func:`Py_SET_SIZE`


Implications
^^^^^^^^^^^^

Making the ``PyObject``, ``PyVarObject`` and ``PyModuleDef`` structures
opaque means:

- Their fields may not be directly accessed.

  For example, instead of ``o->ob_type``, extensions must use
  ``Py_TYPE(o)``.
  This usage has been the preferred practice for some time.

- Their size and alignment will not be available.
  Expressions such as ``sizeof(PyObject)`` will no longer work.

- They cannot be embedded in other structures.
  This mainly affects instance structs of extension-defined types,
  which will need to be defined using API added in :pep:`697` -- that is,
  using a ``struct`` *without* ``PyObject`` (or other base class struct) at
  the beginning, with :c:func:`PyObject_GetTypeData` calls needed to access
  the memory.

- Variables of these types cannot be created.
  This mainly affects static ``PyModuleDef`` variables needed to define
  extension modules.
  Extensions will need to switch to API added in :pep:`793`.

The following functions will become practically unusable in ``abi3t``,
since an extension cannot create valid, statically allocated, input
for them.
They will, however, not be removed.

- :c:func:`PyModuleDef_Init`
- :c:func:`PyModule_Create`, :c:func:`PyModule_Create2`
- :c:func:`PyModule_FromDefAndSpec`, :c:func:`PyModule_FromDefAndSpec2`


New Export Hook (PEP 793)
-------------------------

Implementation of this PEP requires :pep:`793` (``PyModExport``):
A new entry  point for C extension modules), which was accepted for Python
3.15.

Since existing ways of defining modules use API that is removed in ``abi3t``
(namely, :c:type:`PyModuleDef`), extensions will need to migrate to PEP 793's
new “export hook” when switching to Limited API 3.15.


Runtime ABI checks
------------------

Users -- or rather the tools they use for building and installing extensions --
will continue to be responsible for not putting incompatible extensions on
Python's import paths.
This decision makes sense since tools typically have much richer metadata than
what CPython can check.
Typically, build tools and installers use `PyPA packaging metadata`_ and
`platform compatibility tags`_ to communicate compatibility details, but other
models are possible.

.. _PyPA packaging metadata: https://packaging.python.org/en/latest/specifications/core-metadata/
.. _platform compatibility tags: https://packaging.python.org/en/latest/specifications/platform-compatibility-tags/

However, CPython will add a line of defense against outdated or misconfigured
tools, or human mistakes, in the form of a new *module slot* containing
basic ABI information.
This information will be checked when a module is loaded, and incompatible
extensions will be rejected.
The specifics are left to the C API working group
(see `issue 72 <https://github.com/capi-workgroup/decisions/issues/72>`__).

This slot will become *mandatory* with the new export hook added in
:pep:`793`.
(That PEP currently says “there are no required slots”; it will be updated.)


Check for non-free-threaded ABI in free-threading builds
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Additionally, in free-threaded builds, :c:func:`PyModuleDef_Init` will detect
extensions using the non-free-threading Stable ABI, emit an informative
message when one is loaded, *and* raise an exception.
(Implementation note: A message will be printed before raising the exception,
because extensions that attempt to handle an exception using incompatible ABI
will likely crash and lose the exception's message.)

This check for non-free-threading ``abi3`` relies on internal bit patterns
and may be removed in future CPython versions,
if the internal object layout needs to change.


The ``abi3t`` wheel tag
-----------------------

Wheels that use a stable ABI compatible with free-threading CPython builds
should use a new `ABI tag`_: ``abi3t``.

.. _ABI tag: https://packaging.python.org/en/latest/specifications/platform-compatibility-tags/#abi-tag

Package installers should treat this tag as completely separate from ``abi3``.
They should allow ``abi3t``-tagged wheels for free-threaded builds wherever
they currently allow ``abi3``-tagged ones for (orherwise equal) non-free-threaded
builds.

Build tools should generate ``abi3.abi3t`` instead of ``abi3`` for extensions
targetting the Stable ABI for free-threaded Python -- or equivalently: when
both defining ``Py_GIL_DISABLED`` and setting ``Py_LIMITED_API`` to ``3.15``
(``0x030f0000``) or above.
``abi3.abi3t`` is a `compressed tag set`_ that signals compatibility with both
``abi3`` and ``abi3t``.

.. _compressed tag set: https://packaging.python.org/en/latest/specifications/platform-compatibility-tags/#compressed-tag-sets

.. note::

   The version of the Stable ABI is indicated by the `Python wheel tag`_; this
   PEP does not change that.
   For example, a wheel tagged ``cp315-abi3.abi3t`` will be compatible with
   3.15, 3.16, and later versions;
   ``cp317-abi3.abi3t`` will be compatible with 3.17+.

.. _Python wheel tag: https://packaging.python.org/en/latest/specifications/platform-compatibility-tags/#python-tag

The ``abi3t`` tag can be used in extensions compatible with earlier versions of
free-threaded Python.
For example, an extension compatible with GIL-enabled *and* free-threaded
builds of *3.14*, 3.15, and higher versions would be tagged
``cpy314-abi3.abi3t``.
This PEP does not propose an official way to build such extensions, but since
a mechanism for that can be added later (see
:ref:`a Rejected idea <pep803-no-shim>`), installers should be ready to accept
the tag.


New API
-------

Implementing this PEP will make it possible to build extensions that
can be successfully loaded on free-threaded Python, but not necessarily ones
that are thread-safe without a GIL.

Limited API to allow thread-safety without a GIL -- presumably ``PyMutex``,
``PyCriticalSection``, and similar -- will be added via the C API working group,
or in a follow-up PEP.


Backwards and Forwards Compatibility
====================================

Extensions targetting ``abi3t`` will not be backwards-compatible with older
CPython releases, due to the need to use new ``PyModExport`` API added
in :pep:`793`.

Extension authors who cannot switch may continue to use the existing ``abi3``,
that is, build on GIL-enabled Python without defining ``Py_GIL_DISABLED``.
For compatibility with free-threaded builds, they can compile using
version-specific ABI -- that is, compile ``abi3``-compatible source
on free-threaded CPython 3.15 without defining ``Py_LIMITED_API``.

Limited API 3.15 for free-threading is a subset of the general Limited API,
and as such, it will be forward-compatible with future versions of CPython 3.x.
Older versions of the Limited API (that is, 3.14 and below) will continue
to be forward-compatible with GIL-enabled builds of CPython 3.x, starting with
the version that introduced the given Limited API.


Compatibility Overview
----------------------

The following table summarizes compatibility of wheel tags with CPython
interpreters. “GIL” stands for GIL-enabled interpreter; “FT” stands for a
free-threaded one.

.. list-table::
   :widths: auto
   :header-rows: 1

   * * Wheel tag
     * 3.14 (GIL)
     * 3.14 (FT)
     * 3.15 (GIL)
     * 3.15 (FT)
     * 3.16+ (GIL)
     * 3.16+ (FT)
   * * ``cp314-cp314``
     * ✅
     * ❌
     * ❌
     * ❌
     * ❌
     * ❌
   * * ``cp314-cp314t``
     * ❌
     * ✅
     * ❌
     * ❌
     * ❌
     * ❌
   * * ``cp314-abi3``
     * ✅
     * ❌
     * ✅
     * ❌
     * ✅
     * ❌
   * * ``cp314-abi3t`` (*)
     * ❌
     * ✅
     * ❌
     * ✅
     * ❌
     * ✅
   * * ``cp314-abi3.abi3t`` (*)
     * ✅
     * ✅
     * ✅
     * ✅
     * ✅
     * ✅
   * * ``cp315-cp315``
     * ❌
     * ❌
     * ✅
     * ❌
     * ❌
     * ❌
   * * ``cp315-cp315t``
     * ❌
     * ❌
     * ❌
     * ✅
     * ❌
     * ❌
   * * ``cp315-abi3``
     * ❌
     * ❌
     * ✅
     * ❌
     * ✅
     * ❌
   * * ``cp315-abi3t`` (*)
     * ❌
     * ❌
     * ❌
     * ✅
     * ❌
     * ✅
   * * ``cp315-abi3.abi3t``
     * ❌
     * ❌
     * ✅
     * ✅
     * ✅
     * ✅

(*): Wheels with these tags cannot be built; see table below

The following table summarizes which wheel tag should be used for an extension
built with a given interpreter and ``Py_LIMITED_API`` macro:

.. list-table::
   :widths: auto
   :header-rows: 1

   * * To get the wheel tag…
     * Compile on…
     * with ``Py_LIMITED_API`` set to…
     * Note
   * * ``cp314-cp314``
     * 3.14 (GIL)
     * (unset)
     * existing
   * * ``cp314-cp314t``
     * 3.14 (FT)
     * (unset)
     * existing
   * * ``cp314-abi3``
     * 3.14+ (GIL)
     * ``PY_PACK_VERSION(3, 14)``
     * existing
   * * ``cp314-abi3t``
     * N/A
     * N/A
     * out of spec
   * * ``cp314-abi3.abi3t``
     * N/A
     * N/A
     * reserved
   * * ``cp315-cp315``
     * 3.15 (GIL)
     * (unset)
     * continued
   * * ``cp315-cp315t``
     * 3.15 (FT)
     * (unset)
     * continued
   * * ``cp315-abi3``
     * 3.15+ (GIL)
     * ``PY_PACK_VERSION(3, 15)``
     * continued
   * * ``cp315-abi3t``
     * N/A
     * N/A`
     * out of spec
   * * ``cp315-abi3.abi3t``
     * 3.15+ (FT)
     * ``PY_PACK_VERSION(3, 15)``
     * new

In the “Compile on” column, *FT* means that the :c:macro:`Py_GIL_DISABLED`
macro must be defined -- either explicitly or, on non-Windows platforms,
by including CPython headers configured with :option:`--disable-gil`.

Values in the *Note* column:

* *existing*: The wheel tag is currently in use
* *continued*: The wheel tag continues the existing scheme
* *new*: Proposed in this PEP.
* *reserved*: A mechanism to build a matching extension is not proposed in
  this PEP, but may be added in the future.
  Installers should be prepared to handle the tag.
* *out of spec*: Should not be used as-is: extensions should be tagged
  ``abi3.abi3t`` rather than only ``abi3``.
  The entry is included for installers that decompose compressed tag sets.


Security Implications
=====================

None known.


How to Teach This
=================

A porting guide will need to explain how to move to APIs added in
:pep:`697` (Limited C API for Extending Opaque Types)
and :pep:`793` (``PyModExport``).


Reference Implementation
========================

This PEP combines several pieces, implemented individually:

- Opaque ``PyObject`` is available in CPython main branch after defining the
  ``_Py_OPAQUE_PYOBJECT`` macro.
  Implemented in GitHub pull request `python/cpython#136505
  <https://github.com/python/cpython/pull/136505>`__.
- For ``PyModExport``, see :pep:`793` and
  `GitHub issue #140550 <https://github.com/python/cpython/issues/140550>`_.
- A version-checking slot was implemented in GitHub pull request
  `python/cpython#137212 <https://github.com/python/cpython/pull/137212>`__.
- A check for older ``abi3`` was implemented in GitHub pull request
  `python/cpython#137957 <https://github.com/python/cpython/pull/137957>`__.
- For wheel tags, there is no implementation yet.
- A porting guide is not yet written.


Rejected Ideas
==============


Add an separate stable ABI for free-threading
------------------------------------------------

It would be possible to define a new stable ABI compatible *only* with
free-threading builds, not with the existing ``abi3``.
Extensions would need no code changes to target ``abi3t`` and builds would be
compatible with free-threaded CPython (3.14 and above).

In this scheme, an additional macro (“``Py_OPAQUE_PYOBJECT``”), could make
``PyObject`` opaque as in this PEP. To use it, extensions would need code
changes as in this PEP, and as in this PEP, compiled extensions
(“``abi3.abi3t``”) would be compatible with all builds of CPython 3.15+.

This would make the free-threading memory layout of ``PyObject`` part
of a stable ABI, preventing future adjustments.


Make ``PyObject`` opaque in Limited API 3.15
--------------------------------------------

It would be possible to make ``PyObject`` struct opaque in Limited API 3.15
(that is, the new version of the existing Limited API),
rather than introduce a new variant of the Stable ABI and Limited API.

This would mean that extension authors would need to adapt their code to the
new limitations, or abandon Limited API altogether, in order to use any C API
introduced in Python 3.15.

It would also not remove the need for a new wheel tag (``abi3t``),
which would be required to express that an extension
is compatible with both GIL-enabled and free-threaded builds
of CPython 3.14 or lower.


.. _pep803-no-shim:

Shims for compatibility with CPython 3.14
-----------------------------------------

It’s possible to build a ``cp314-abi3.abi3t`` extension – one compatible
with 3.14 (both free-threaded build and default).
There are several challenges around this:

* making it convenient and safe for general extensions
* testing it (as CPython’s test suite doesn’t involve other CPython versions
  than the one being tested)

So, providing a mechanism to build such extensions is best suited to an
external project (for example, one like `pythoncapi-compat`_).
It's out of scope for CPython’s C API, and this PEP.

.. _pythoncapi-compat: https://github.com/python/pythoncapi-compat

To sketch how such a mechanism could work:

The main issue that prevents compatibility with Python 3.14 is that with
opaque ``PyObject`` and ``PyModuleDef``, it is not feasible to initialize
an extension module.
The solution, :pep:`793`, is only being added in Python 3.15.

It is possible to work around this using the fact that the 3.14 ABIs (both
free-threading and GIL-enabled) are “frozen”, so it is possible for an
extension to query the running interpreter, and for 3.14, use
a ``struct`` definition corresponding to the detected build's ``PyModuleDef``.


Naming this ``abi4``
--------------------

Instead of ``abi3t``, we could “bump the version” and use ``abi4`` instead.
The difference is largely cosmetic.

However, one thing this PEP does not propose is changing the *filename*
tag: extensions will be named with the extensions like ``.abi3.so``.
Changing this while keeping compatibility with GIL-enabled builds would be
an unnecessary technical change.

Using ``abi3.abi4`` in wheel tags but only ``.abi3`` in filenames would
look more inconsistent than ``abi3.abi3t`` and ``.abi3``.

If we added an ``abi4`` tag, the ``Py_LIMITED_API`` value would either need to:

* change to start with ``4`` to match ``abi4``, but no longer correspond
  to ``PY_VERSION_HEX`` (making it harder to generate and check), or
* not change, making it inconsistent with ``abi4``.

Adding ``abi3t`` is a smaller change than adding ``abi4``, making it work
better as a transitional state before larger changes like :pep:`809`'s
``abi2026``.


Copyright
=========

This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.
