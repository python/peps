
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 479 – Change StopIteration handling inside generators | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0479/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 479 – Change StopIteration handling inside generators | peps.python.org'>
    <meta property="og:description" content="This PEP proposes a change to generators: when StopIteration is raised inside a generator, it is replaced with RuntimeError. (More precisely, this happens when the exception is about to bubble out of the generator’s stack frame.)  Because the change is ...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0479/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="This PEP proposes a change to generators: when StopIteration is raised inside a generator, it is replaced with RuntimeError. (More precisely, this happens when the exception is about to bubble out of the generator’s stack frame.)  Because the change is ...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 479</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 479 – Change StopIteration handling inside generators" data-pagefind-weight="10" class="visually-hidden">PEP 479 – Change StopIteration handling inside generators</span>
            <section id="pep-content">
<h1 class="page-title">PEP 479 – Change StopIteration handling inside generators</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Chris Angelico &lt;rosuav&#32;&#97;t&#32;gmail.com&gt;, Guido van Rossum &lt;guido&#32;&#97;t&#32;python.org&gt;</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Accepted and implementation complete, or no longer active">Final</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">15-Nov-2014</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.5</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even">15-Nov-2014, 19-Nov-2014, 05-Dec-2014</dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#acceptance">Acceptance</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#background-information">Background information</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a></li>
<li><a class="reference internal" href="#consequences-for-existing-code">Consequences for existing code</a><ul>
<li><a class="reference internal" href="#writing-backwards-and-forwards-compatible-code">Writing backwards and forwards compatible code</a></li>
<li><a class="reference internal" href="#examples-of-breakage">Examples of breakage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#explanation-of-generators-iterators-and-stopiteration">Explanation of generators, iterators, and StopIteration</a></li>
<li><a class="reference internal" href="#transition-plan">Transition plan</a></li>
<li><a class="reference internal" href="#alternate-proposals">Alternate proposals</a><ul>
<li><a class="reference internal" href="#raising-something-other-than-runtimeerror">Raising something other than RuntimeError</a></li>
<li><a class="reference internal" href="#supplying-a-specific-exception-to-raise-on-return">Supplying a specific exception to raise on return</a></li>
<li><a class="reference internal" href="#making-return-triggered-stopiterations-obvious">Making return-triggered StopIterations obvious</a></li>
<li><a class="reference internal" href="#converting-the-exception-inside-next">Converting the exception inside next()</a></li>
<li><a class="reference internal" href="#sub-proposal-decorator-to-explicitly-request-current-behaviour">Sub-proposal: decorator to explicitly request current behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#criticism">Criticism</a><ul>
<li><a class="reference internal" href="#why-not-fix-all-next-methods">Why not fix all __next__() methods?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>This PEP proposes a change to generators: when <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> is
raised inside a generator, it is replaced with <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>.
(More precisely, this happens when the exception is about to bubble
out of the generator’s stack frame.)  Because the change is backwards
incompatible, the feature is initially introduced using a
<code class="docutils literal notranslate"><span class="pre">__future__</span></code> statement.</p>
</section>
<section id="acceptance">
<h2><a class="toc-backref" href="#acceptance" role="doc-backlink">Acceptance</a></h2>
<p>This PEP was accepted by the BDFL on November 22.  Because of the
exceptionally short period from first draft to acceptance, the main
objections brought up after acceptance were carefully considered and
have been reflected in the “Alternate proposals” section below.
However, none of the discussion changed the BDFL’s mind and the PEP’s
acceptance is now final.  (Suggestions for clarifying edits are still
welcome – unlike IETF RFCs, the text of a PEP is not cast in stone
after its acceptance, although the core design/plan/specification
should not change after acceptance.)</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>The interaction of generators and <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> is currently
somewhat surprising, and can conceal obscure bugs.  An unexpected
exception should not result in subtly altered behaviour, but should
cause a noisy and easily-debugged traceback.  Currently,
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> raised accidentally inside a generator function will
be interpreted as the end of the iteration by the loop construct
driving the generator.</p>
<p>The main goal of the proposal is to ease debugging in the situation
where an unguarded <code class="docutils literal notranslate"><span class="pre">next()</span></code> call (perhaps several stack frames deep)
raises <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> and causes the iteration controlled by the
generator to terminate silently.  (Whereas, when some other exception
is raised, a traceback is printed pinpointing the cause of the
problem.)</p>
<p>This is particularly pernicious in combination with the <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>
construct of <a class="pep reference internal" href="../pep-0380/" title="PEP 380 – Syntax for Delegating to a Subgenerator">PEP 380</a>, as it breaks the abstraction that a
subgenerator may be factored out of a generator.  That PEP notes this
limitation, but notes that “use cases for these [are] rare to
non-existent”.  Unfortunately while intentional use is rare, it is
easy to stumble on these cases by accident:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transaction</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;begin&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">do_it</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rollback&#39;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;commit&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">do_it</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Refactored initial setup&#39;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="c1"># Body of with-statement is executed here</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Refactored finalization of successful transaction&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gene</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">transaction</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">i</span>
            <span class="c1"># return</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>  <span class="c1"># This is wrong</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Should not be reached&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gene</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;main: i =&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>Here factoring out <code class="docutils literal notranslate"><span class="pre">do_it</span></code> into a subgenerator has introduced a
subtle bug: if the wrapped block raises <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>, under the
current behavior this exception will be swallowed by the context
manager; and, worse, the finalization is silently skipped!  Similarly
problematic behavior occurs when an <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> coroutine raises
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>, causing it to terminate silently, or when <code class="docutils literal notranslate"><span class="pre">next</span></code>
is used to take the first result from an iterator that unexpectedly
turns out to be empty, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># using the same context manager as above</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>

<span class="k">with</span> <span class="n">transaction</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;commit file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="c1"># I can never remember what the README extension is</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/some/dir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;README*&#39;</span><span class="p">))))</span>
</pre></div>
</div>
<p>In both cases, the refactoring abstraction of <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> breaks
in the presence of bugs in client code.</p>
<p>Additionally, the proposal reduces the difference between list
comprehensions and generator expressions, preventing surprises such as
the one that started this discussion <a class="footnote-reference brackets" href="#id17" id="id1">[2]</a>.  Henceforth, the following
statements will produce the same result if either produces a result at
all:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span> <span class="k">if</span> <span class="n">P</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span> <span class="k">if</span> <span class="n">P</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
</pre></div>
</div>
<p>With the current state of affairs, it is possible to write a function
<code class="docutils literal notranslate"><span class="pre">F(x)</span></code> or a predicate <code class="docutils literal notranslate"><span class="pre">P(x)</span></code> that causes the first form to produce
a (truncated) result, while the second form raises an exception
(namely, <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>).  With the proposed change, both forms
will raise an exception at this point (albeit <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> in the
first case and <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> in the second).</p>
<p>Finally, the proposal also clears up the confusion about how to
terminate a generator: the proper way is <code class="docutils literal notranslate"><span class="pre">return</span></code>, not
<code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">StopIteration</span></code>.</p>
<p>As an added bonus, the above changes bring generator functions much
more in line with regular functions.  If you wish to take a piece of
code presented as a generator and turn it into something else, you
can usually do this fairly simply, by replacing every <code class="docutils literal notranslate"><span class="pre">yield</span></code> with
a call to <code class="docutils literal notranslate"><span class="pre">print()</span></code> or <code class="docutils literal notranslate"><span class="pre">list.append()</span></code>; however, if there are any
bare <code class="docutils literal notranslate"><span class="pre">next()</span></code> calls in the code, you have to be aware of them.  If
the code was originally written without relying on <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>
terminating the function, the transformation would be that much
easier.</p>
</section>
<section id="background-information">
<h2><a class="toc-backref" href="#background-information" role="doc-backlink">Background information</a></h2>
<p>When a generator frame is (re)started as a result of a <code class="docutils literal notranslate"><span class="pre">__next__()</span></code>
(or <code class="docutils literal notranslate"><span class="pre">send()</span></code> or <code class="docutils literal notranslate"><span class="pre">throw()</span></code>) call, one of three outcomes can occur:</p>
<ul class="simple">
<li>A yield point is reached, and the yielded value is returned.</li>
<li>The frame is returned from; <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> is raised.</li>
<li>An exception is raised, which bubbles out.</li>
</ul>
<p>In the latter two cases the frame is abandoned (and the generator
object’s <code class="docutils literal notranslate"><span class="pre">gi_frame</span></code> attribute is set to None).</p>
</section>
<section id="proposal">
<h2><a class="toc-backref" href="#proposal" role="doc-backlink">Proposal</a></h2>
<p>If a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> is about to bubble out of a generator frame, it
is replaced with <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>, which causes the <code class="docutils literal notranslate"><span class="pre">next()</span></code> call
(which invoked the generator) to fail, passing that exception out.
From then on it’s just like any old exception. <a class="footnote-reference brackets" href="#id18" id="id2">[3]</a></p>
<p>This affects the third outcome listed above, without altering any
other effects.  Furthermore, it only affects this outcome when the
exception raised is <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> (or a subclass thereof).</p>
<p>Note that the proposed replacement happens at the point where the
exception is about to bubble out of the frame, i.e. after any
<code class="docutils literal notranslate"><span class="pre">except</span></code> or <code class="docutils literal notranslate"><span class="pre">finally</span></code> blocks that could affect it have been
exited.  The <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> raised by returning from the frame is
not affected (the point being that <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> means that the
generator terminated “normally”, i.e. it did not raise an exception).</p>
<p>A subtle issue is what will happen if the caller, having caught the
<code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>, calls the generator object’s <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> method
again.  The answer is that from this point on it will raise
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> – the behavior is the same as when any other
exception was raised by the generator.</p>
<p>Another logical consequence of the proposal: if someone uses
<code class="docutils literal notranslate"><span class="pre">g.throw(StopIteration)</span></code> to throw a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception into
a generator, if the generator doesn’t catch it (which it could do
using a <code class="docutils literal notranslate"><span class="pre">try/except</span></code> around the <code class="docutils literal notranslate"><span class="pre">yield</span></code>), it will be transformed
into <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>.</p>
<p>During the transition phase, the new feature must be enabled
per-module using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">generator_stop</span>
</pre></div>
</div>
<p>Any generator function constructed under the influence of this
directive will have the <code class="docutils literal notranslate"><span class="pre">REPLACE_STOPITERATION</span></code> flag set on its code
object, and generators with the flag set will behave according to this
proposal.  Once the feature becomes standard, the flag may be dropped;
code should not inspect generators for it.</p>
<p>A proof-of-concept patch has been created to facilitate testing. <a class="footnote-reference brackets" href="#id19" id="id3">[4]</a></p>
</section>
<section id="consequences-for-existing-code">
<h2><a class="toc-backref" href="#consequences-for-existing-code" role="doc-backlink">Consequences for existing code</a></h2>
<p>This change will affect existing code that depends on
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> bubbling up.  The pure Python reference
implementation of <code class="docutils literal notranslate"><span class="pre">groupby</span></code> <a class="footnote-reference brackets" href="#id20" id="id4">[5]</a> currently has comments “Exit on
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>” where it is expected that the exception will
propagate and then be handled.  This will be unusual, but not unknown,
and such constructs will fail.  Other examples abound, e.g. <a class="footnote-reference brackets" href="#id21" id="id5">[6]</a>, <a class="footnote-reference brackets" href="#id22" id="id6">[7]</a>.</p>
<p>(Alyssa Coghlan comments: “””If you wanted to factor out a helper
function that terminated the generator you’d have to do “return
yield from helper()” rather than just “helper()”.”””)</p>
<p>There are also examples of generator expressions floating around that
rely on a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> raised by the expression, the target or the
predicate (rather than by the <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> call implied in the <code class="docutils literal notranslate"><span class="pre">for</span></code>
loop proper).</p>
<section id="writing-backwards-and-forwards-compatible-code">
<h3><a class="toc-backref" href="#writing-backwards-and-forwards-compatible-code" role="doc-backlink">Writing backwards and forwards compatible code</a></h3>
<p>With the exception of hacks that raise <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> to exit a
generator expression, it is easy to write code that works equally well
under older Python versions as under the new semantics.</p>
<p>This is done by enclosing those places in the generator body where a
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> is expected (e.g. bare <code class="docutils literal notranslate"><span class="pre">next()</span></code> calls or in some
cases helper functions that are expected to raise <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>)
in a <code class="docutils literal notranslate"><span class="pre">try/except</span></code> construct that returns when <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> is
raised.  The <code class="docutils literal notranslate"><span class="pre">try/except</span></code> construct should appear directly in the
generator function; doing this in a helper function that is not itself
a generator does not work.  If <code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">StopIteration</span></code> occurs directly
in a generator, simply replace it with <code class="docutils literal notranslate"><span class="pre">return</span></code>.</p>
</section>
<section id="examples-of-breakage">
<h3><a class="toc-backref" href="#examples-of-breakage" role="doc-backlink">Examples of breakage</a></h3>
<p>Generators which explicitly raise <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> can generally be
changed to simply return instead.  This will be compatible with all
existing Python versions, and will not be affected by <code class="docutils literal notranslate"><span class="pre">__future__</span></code>.
Here are some illustrations from the standard library.</p>
<p>Lib/ipaddress.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">StopIteration</span>
</pre></div>
</div>
<p>Becomes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
    <span class="k">return</span>
</pre></div>
</div>
<p>In some cases, this can be combined with <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code> to simplify
the code, such as Lib/difflib.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="nb">next</span><span class="p">(</span><span class="n">line_pair_iterator</span><span class="p">)</span>
</pre></div>
</div>
<p>Becomes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">yield from</span> <span class="n">line_pair_iterator</span>
    <span class="k">return</span>
</pre></div>
</div>
<p>(The <code class="docutils literal notranslate"><span class="pre">return</span></code> is necessary for a strictly-equivalent translation,
though in this particular file, there is no further code, and the
<code class="docutils literal notranslate"><span class="pre">return</span></code> can be omitted.) For compatibility with pre-3.3 versions
of Python, this could be written with an explicit <code class="docutils literal notranslate"><span class="pre">for</span></code> loop:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">line_pair_iterator</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">line</span>
    <span class="k">return</span>
</pre></div>
</div>
<p>More complicated iteration patterns will need explicit <code class="docutils literal notranslate"><span class="pre">try/except</span></code>
constructs.  For example, a hypothetical parser like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">parser</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;- end -&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">line</span>
        <span class="k">yield</span> <span class="n">data</span>
</pre></div>
</div>
<p>would need to be rewritten as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">parser</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;- end -&quot;</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="n">line</span>
            <span class="k">yield</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span>
</pre></div>
</div>
<p>or possibly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">parser</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;- end -&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">line</span>
        <span class="k">yield</span> <span class="n">data</span>
</pre></div>
</div>
<p>The latter form obscures the iteration by purporting to iterate over
the file with a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, but then also fetches more data from
the same iterator during the loop body.  It does, however, clearly
differentiate between a “normal” termination (<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>
instead of the initial line) and an “abnormal” termination (failing
to find the end marker in the inner loop, which will now raise
<code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>).</p>
<p>This effect of <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> has been used to cut a generator
expression short, creating a form of <code class="docutils literal notranslate"><span class="pre">takewhile</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">StopIteration</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">stop</span><span class="p">()))</span>
<span class="c1"># prints [0, 1, 2, 3, 4]</span>
</pre></div>
</div>
<p>Under the current proposal, this form of non-local flow control is
not supported, and would have to be rewritten in statement form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">gen</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">yield</span> <span class="n">x</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">gen</span><span class="p">()))</span>
<span class="c1"># prints [0, 1, 2, 3, 4]</span>
</pre></div>
</div>
<p>While this is a small loss of functionality, it is functionality that
often comes at the cost of readability, and just as <code class="docutils literal notranslate"><span class="pre">lambda</span></code> has
restrictions compared to <code class="docutils literal notranslate"><span class="pre">def</span></code>, so does a generator expression have
restrictions compared to a generator function. In many cases, the
transformation to full generator function will be trivially easy, and
may improve structural clarity.</p>
</section>
</section>
<section id="explanation-of-generators-iterators-and-stopiteration">
<h2><a class="toc-backref" href="#explanation-of-generators-iterators-and-stopiteration" role="doc-backlink">Explanation of generators, iterators, and StopIteration</a></h2>
<p>The proposal does not change the relationship between generators and
iterators: a generator object is still an iterator, and not all
iterators are generators.  Generators have additional methods that
iterators don’t have, like <code class="docutils literal notranslate"><span class="pre">send</span></code> and <code class="docutils literal notranslate"><span class="pre">throw</span></code>.  All this is
unchanged.  Nothing changes for generator users – only authors of
generator functions may have to learn something new.  (This includes
authors of generator expressions that depend on early termination of
the iteration by a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> raised in a condition.)</p>
<p>An iterator is an object with a <code class="docutils literal notranslate"><span class="pre">__next__</span></code> method.  Like many other
special methods, it may either return a value, or raise a specific
exception - in this case, <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> - to signal that it has
no value to return.  In this, it is similar to <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> (can
raise <code class="docutils literal notranslate"><span class="pre">AttributeError</span></code>), <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> (can raise <code class="docutils literal notranslate"><span class="pre">KeyError</span></code>),
and so on.  A helper function for an iterator can be written to
follow the same protocol; for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">helper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">StopIteration</span>

<span class="k">def</span><span class="w"> </span><span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="k">return</span> <span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>Both forms of signalling are carried through: a returned value is
returned, an exception bubbles up.  The helper is written to match
the protocol of the calling function.</p>
<p>A generator function is one which contains a <code class="docutils literal notranslate"><span class="pre">yield</span></code> expression.
Each time it is (re)started, it may either yield a value, or return
(including “falling off the end”).  A helper function for a generator
can also be written, but it must also follow generator protocol:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">helper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">:</span> <span class="k">yield</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
<p>In both cases, any unexpected exception will bubble up. Due to the
nature of generators and iterators, an unexpected <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>
inside a generator will be converted into <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>, but
beyond that, all exceptions will propagate normally.</p>
</section>
<section id="transition-plan">
<h2><a class="toc-backref" href="#transition-plan" role="doc-backlink">Transition plan</a></h2>
<ul class="simple">
<li>Python 3.5: Enable new semantics under <code class="docutils literal notranslate"><span class="pre">__future__</span></code> import; silent
deprecation warning if <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> bubbles out of a generator
not under <code class="docutils literal notranslate"><span class="pre">__future__</span></code> import.</li>
<li>Python 3.6: Non-silent deprecation warning.</li>
<li>Python 3.7: Enable new semantics everywhere.</li>
</ul>
</section>
<section id="alternate-proposals">
<h2><a class="toc-backref" href="#alternate-proposals" role="doc-backlink">Alternate proposals</a></h2>
<section id="raising-something-other-than-runtimeerror">
<h3><a class="toc-backref" href="#raising-something-other-than-runtimeerror" role="doc-backlink">Raising something other than RuntimeError</a></h3>
<p>Rather than the generic <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>, it might make sense to raise
a new exception type <code class="docutils literal notranslate"><span class="pre">UnexpectedStopIteration</span></code>.  This has the
downside of implicitly encouraging that it be caught; the correct
action is to catch the original <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>, not the chained
exception.</p>
</section>
<section id="supplying-a-specific-exception-to-raise-on-return">
<h3><a class="toc-backref" href="#supplying-a-specific-exception-to-raise-on-return" role="doc-backlink">Supplying a specific exception to raise on return</a></h3>
<p>Alyssa (Nick) Coghlan suggested a means of providing a specific
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> instance to the generator; if any other instance of
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> is raised, it is an error, but if that particular
one is raised, the generator has properly completed.  This subproposal
has been withdrawn in favour of better options, but is retained for
reference.</p>
</section>
<section id="making-return-triggered-stopiterations-obvious">
<h3><a class="toc-backref" href="#making-return-triggered-stopiterations-obvious" role="doc-backlink">Making return-triggered StopIterations obvious</a></h3>
<p>For certain situations, a simpler and fully backward-compatible
solution may be sufficient: when a generator returns, instead of
raising <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>, it raises a specific subclass of
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> (<code class="docutils literal notranslate"><span class="pre">GeneratorReturn</span></code>) which can then be detected.
If it is not that subclass, it is an escaping exception rather than a
return statement.</p>
<p>The inspiration for this alternative proposal was Alyssa’s observation
<a class="footnote-reference brackets" href="#id23" id="id7">[8]</a> that if an <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> coroutine <a class="footnote-reference brackets" href="#id24" id="id8">[9]</a> accidentally raises
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>, it currently terminates silently, which may present
a hard-to-debug mystery to the developer.  The main proposal turns
such accidents into clearly distinguishable <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> exceptions,
but if that is rejected, this alternate proposal would enable
<code class="docutils literal notranslate"><span class="pre">asyncio</span></code> to distinguish between a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement and an
accidentally-raised <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception.</p>
<p>Of the three outcomes listed above, two change:</p>
<ul class="simple">
<li>If a yield point is reached, the value, obviously, would still be
returned.</li>
<li>If the frame is returned from, <code class="docutils literal notranslate"><span class="pre">GeneratorReturn</span></code> (rather than
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>) is raised.</li>
<li>If an instance of <code class="docutils literal notranslate"><span class="pre">GeneratorReturn</span></code> would be raised, instead an
instance of <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> would be raised. Any other exception
bubbles up normally.</li>
</ul>
<p>In the third case, the <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> would have the <code class="docutils literal notranslate"><span class="pre">value</span></code> of
the original <code class="docutils literal notranslate"><span class="pre">GeneratorReturn</span></code>, and would reference the original
exception in its <code class="docutils literal notranslate"><span class="pre">__cause__</span></code>.  If uncaught, this would clearly show
the chaining of exceptions.</p>
<p>This alternative does <em>not</em> affect the discrepancy between generator
expressions and list comprehensions, but allows generator-aware code
(such as the <code class="docutils literal notranslate"><span class="pre">contextlib</span></code> and <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> modules) to reliably
differentiate between the second and third outcomes listed above.</p>
<p>However, once code exists that depends on this distinction between
<code class="docutils literal notranslate"><span class="pre">GeneratorReturn</span></code> and <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>, a generator that invokes
another generator and relies on the latter’s <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> to
bubble out would still be potentially wrong, depending on the use made
of the distinction between the two exception types.</p>
</section>
<section id="converting-the-exception-inside-next">
<h3><a class="toc-backref" href="#converting-the-exception-inside-next" role="doc-backlink">Converting the exception inside next()</a></h3>
<p>Mark Shannon suggested <a class="footnote-reference brackets" href="#id25" id="id9">[10]</a> that the problem could be solved in
<code class="docutils literal notranslate"><span class="pre">next()</span></code> rather than at the boundary of generator functions.  By
having <code class="docutils literal notranslate"><span class="pre">next()</span></code> catch <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> and raise instead
<code class="docutils literal notranslate"><span class="pre">ValueError</span></code>, all unexpected <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> bubbling would be
prevented; however, the backward-incompatibility concerns are far
more serious than for the current proposal, as every <code class="docutils literal notranslate"><span class="pre">next()</span></code> call
now needs to be rewritten to guard against <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> - not to mention that there is no way to write one
block of code which reliably works on multiple versions of Python.
(Using a dedicated exception type, perhaps subclassing <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>,
would help this; however, all code would still need to be rewritten.)</p>
<p>Note that calling <code class="docutils literal notranslate"><span class="pre">next(it,</span> <span class="pre">default)</span></code> catches <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> and
substitutes the given default value; this feature is often useful to
avoid a <code class="docutils literal notranslate"><span class="pre">try/except</span></code> block.</p>
</section>
<section id="sub-proposal-decorator-to-explicitly-request-current-behaviour">
<h3><a class="toc-backref" href="#sub-proposal-decorator-to-explicitly-request-current-behaviour" role="doc-backlink">Sub-proposal: decorator to explicitly request current behaviour</a></h3>
<p>Alyssa Coghlan suggested <a class="footnote-reference brackets" href="#id26" id="id10">[11]</a> that the situations where the current
behaviour is desired could be supported by means of a decorator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">allow_implicit_stop</span>

<span class="nd">@allow_implicit_stop</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_generator</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="k">yield</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Which would be semantically equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_generator</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="k">yield</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="o">...</span>
    <span class="k">except</span> <span class="ne">StopIteration</span>
        <span class="k">return</span>
</pre></div>
</div>
<p>but be faster, as it could be implemented by simply permitting the
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> to bubble up directly.</p>
<p>Single-source Python 2/3 code would also benefit in a 3.7+ world,
since libraries like six and python-future could just define their own
version of “allow_implicit_stop” that referred to the new builtin in
3.5+, and was implemented as an identity function in other versions.</p>
<p>However, due to the implementation complexities required, the ongoing
compatibility issues created, the subtlety of the decorator’s effect,
and the fact that it would encourage the “quick-fix” solution of just
slapping the decorator onto all generators instead of properly fixing
the code in question, this sub-proposal has been rejected. <a class="footnote-reference brackets" href="#id27" id="id11">[12]</a></p>
</section>
</section>
<section id="criticism">
<h2><a class="toc-backref" href="#criticism" role="doc-backlink">Criticism</a></h2>
<p>Unofficial and apocryphal statistics suggest that this is seldom, if
ever, a problem. <a class="footnote-reference brackets" href="#id28" id="id12">[13]</a>  Code does exist which relies on the current
behaviour (e.g. <a class="footnote-reference brackets" href="#id18" id="id13">[3]</a>, <a class="footnote-reference brackets" href="#id21" id="id14">[6]</a>, <a class="footnote-reference brackets" href="#id22" id="id15">[7]</a>), and there is the concern that this
would be unnecessary code churn to achieve little or no gain.</p>
<p>Steven D’Aprano started an informal survey on comp.lang.python <a class="footnote-reference brackets" href="#id29" id="id16">[14]</a>;
at the time of writing only two responses have been received: one was
in favor of changing list comprehensions to match generator
expressions (!), the other was in favor of this PEP’s main proposal.</p>
<p>The existing model has been compared to the perfectly-acceptable
issues inherent to every other case where an exception has special
meaning.  For instance, an unexpected <code class="docutils literal notranslate"><span class="pre">KeyError</span></code> inside a
<code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method will be interpreted as failure, rather than
permitted to bubble up.  However, there is a difference.  Special
methods use <code class="docutils literal notranslate"><span class="pre">return</span></code> to indicate normality, and <code class="docutils literal notranslate"><span class="pre">raise</span></code> to signal
abnormality; generators <code class="docutils literal notranslate"><span class="pre">yield</span></code> to indicate data, and <code class="docutils literal notranslate"><span class="pre">return</span></code> to
signal the abnormal state.  This makes explicitly raising
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> entirely redundant, and potentially surprising.  If
other special methods had dedicated keywords to distinguish between
their return paths, they too could turn unexpected exceptions into
<code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>; the fact that they cannot should not preclude
generators from doing so.</p>
<section id="why-not-fix-all-next-methods">
<h3><a class="toc-backref" href="#why-not-fix-all-next-methods" role="doc-backlink">Why not fix all __next__() methods?</a></h3>
<p>When implementing a regular <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> method, the only way to
indicate the end of the iteration is to raise <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>.  So
catching <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> here and converting it to <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>
would defeat the purpose.  This is a reminder of the special status of
generator functions: in a generator function, raising
<code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> is redundant since the iteration can be terminated
by a simple <code class="docutils literal notranslate"><span class="pre">return</span></code>.</p>
</section>
</section>
<section id="references">
<h2><a class="toc-backref" href="#references" role="doc-backlink">References</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id17" role="doc-footnote">
<dt class="label" id="id17">[<a href="#id1">2</a>]</dt>
<dd>Initial mailing list comment
(<a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2014-November/029906.html">https://mail.python.org/pipermail/python-ideas/2014-November/029906.html</a>)</aside>
<aside class="footnote brackets" id="id18" role="doc-footnote">
<dt class="label" id="id18">[3]<em> (<a href='#id2'>1</a>, <a href='#id13'>2</a>) </em></dt>
<dd>Proposal by GvR
(<a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2014-November/029953.html">https://mail.python.org/pipermail/python-ideas/2014-November/029953.html</a>)</aside>
<aside class="footnote brackets" id="id19" role="doc-footnote">
<dt class="label" id="id19">[<a href="#id3">4</a>]</dt>
<dd>Tracker issue with Proof-of-Concept patch
(<a class="reference external" href="http://bugs.python.org/issue22906">http://bugs.python.org/issue22906</a>)</aside>
<aside class="footnote brackets" id="id20" role="doc-footnote">
<dt class="label" id="id20">[<a href="#id4">5</a>]</dt>
<dd>Pure Python implementation of groupby
(<a class="reference external" href="https://docs.python.org/3/library/itertools.html#itertools.groupby">https://docs.python.org/3/library/itertools.html#itertools.groupby</a>)</aside>
<aside class="footnote brackets" id="id21" role="doc-footnote">
<dt class="label" id="id21">[6]<em> (<a href='#id5'>1</a>, <a href='#id14'>2</a>) </em></dt>
<dd>Split a sequence or generator using a predicate
(<a class="reference external" href="http://code.activestate.com/recipes/578416-split-a-sequence-or-generator-using-a-predicate/">http://code.activestate.com/recipes/578416-split-a-sequence-or-generator-using-a-predicate/</a>)</aside>
<aside class="footnote brackets" id="id22" role="doc-footnote">
<dt class="label" id="id22">[7]<em> (<a href='#id6'>1</a>, <a href='#id15'>2</a>) </em></dt>
<dd>wrap unbounded generator to restrict its output
(<a class="reference external" href="http://code.activestate.com/recipes/66427-wrap-unbounded-generator-to-restrict-its-output/">http://code.activestate.com/recipes/66427-wrap-unbounded-generator-to-restrict-its-output/</a>)</aside>
<aside class="footnote brackets" id="id23" role="doc-footnote">
<dt class="label" id="id23">[<a href="#id7">8</a>]</dt>
<dd>Post from Alyssa (Nick) Coghlan mentioning asyncio
(<a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2014-November/029961.html">https://mail.python.org/pipermail/python-ideas/2014-November/029961.html</a>)</aside>
<aside class="footnote brackets" id="id24" role="doc-footnote">
<dt class="label" id="id24">[<a href="#id8">9</a>]</dt>
<dd>Coroutines in asyncio
(<a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#coroutines">https://docs.python.org/3/library/asyncio-task.html#coroutines</a>)</aside>
<aside class="footnote brackets" id="id25" role="doc-footnote">
<dt class="label" id="id25">[<a href="#id9">10</a>]</dt>
<dd>Post from Mark Shannon with alternate proposal
(<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2014-November/137129.html">https://mail.python.org/pipermail/python-dev/2014-November/137129.html</a>)</aside>
<aside class="footnote brackets" id="id26" role="doc-footnote">
<dt class="label" id="id26">[<a href="#id10">11</a>]</dt>
<dd>Idea from Alyssa Coghlan
(<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2014-November/137201.html">https://mail.python.org/pipermail/python-dev/2014-November/137201.html</a>)</aside>
<aside class="footnote brackets" id="id27" role="doc-footnote">
<dt class="label" id="id27">[<a href="#id11">12</a>]</dt>
<dd>Rejection of above idea by GvR
(<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2014-November/137243.html">https://mail.python.org/pipermail/python-dev/2014-November/137243.html</a>)</aside>
<aside class="footnote brackets" id="id28" role="doc-footnote">
<dt class="label" id="id28">[<a href="#id12">13</a>]</dt>
<dd>Response by Steven D’Aprano
(<a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2014-November/029994.html">https://mail.python.org/pipermail/python-ideas/2014-November/029994.html</a>)</aside>
<aside class="footnote brackets" id="id29" role="doc-footnote">
<dt class="label" id="id29">[<a href="#id16">14</a>]</dt>
<dd>Thread on comp.lang.python started by Steven D’Aprano
(<a class="reference external" href="https://mail.python.org/pipermail/python-list/2014-November/680757.html">https://mail.python.org/pipermail/python-list/2014-November/680757.html</a>)</aside>
</aside>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0479.rst">https://github.com/python/peps/blob/main/peps/pep-0479.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0479.rst">2025-02-01 08:59:27 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#acceptance">Acceptance</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#background-information">Background information</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a></li>
<li><a class="reference internal" href="#consequences-for-existing-code">Consequences for existing code</a><ul>
<li><a class="reference internal" href="#writing-backwards-and-forwards-compatible-code">Writing backwards and forwards compatible code</a></li>
<li><a class="reference internal" href="#examples-of-breakage">Examples of breakage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#explanation-of-generators-iterators-and-stopiteration">Explanation of generators, iterators, and StopIteration</a></li>
<li><a class="reference internal" href="#transition-plan">Transition plan</a></li>
<li><a class="reference internal" href="#alternate-proposals">Alternate proposals</a><ul>
<li><a class="reference internal" href="#raising-something-other-than-runtimeerror">Raising something other than RuntimeError</a></li>
<li><a class="reference internal" href="#supplying-a-specific-exception-to-raise-on-return">Supplying a specific exception to raise on return</a></li>
<li><a class="reference internal" href="#making-return-triggered-stopiterations-obvious">Making return-triggered StopIterations obvious</a></li>
<li><a class="reference internal" href="#converting-the-exception-inside-next">Converting the exception inside next()</a></li>
<li><a class="reference internal" href="#sub-proposal-decorator-to-explicitly-request-current-behaviour">Sub-proposal: decorator to explicitly request current behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#criticism">Criticism</a><ul>
<li><a class="reference internal" href="#why-not-fix-all-next-methods">Why not fix all __next__() methods?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0479.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>