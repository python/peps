
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 432 – Restructuring the CPython startup sequence | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0432/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 432 – Restructuring the CPython startup sequence | peps.python.org'>
    <meta property="og:description" content="This PEP proposes a mechanism for restructuring the startup sequence for CPython, making it easier to modify the initialization behaviour of the reference interpreter executable, as well as making it easier to control CPython’s startup behaviour when cr...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0432/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="This PEP proposes a mechanism for restructuring the startup sequence for CPython, making it easier to modify the initialization behaviour of the reference interpreter executable, as well as making it easier to control CPython’s startup behaviour when cr...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 432</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 432 – Restructuring the CPython startup sequence" data-pagefind-weight="10" class="visually-hidden">PEP 432 – Restructuring the CPython startup sequence</span>
            <section id="pep-content">
<h1 class="page-title">PEP 432 – Restructuring the CPython startup sequence</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Alyssa Coghlan &lt;ncoghlan&#32;&#97;t&#32;gmail.com&gt;,
Victor Stinner &lt;vstinner&#32;&#97;t&#32;python.org&gt;,
Eric Snow &lt;ericsnowcurrently&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Discussions-To<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://mail.python.org/archives/list/capi-sig&#64;python.org/">Capi-SIG list</a></dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Removed from consideration by sponsor or authors">Withdrawn</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-odd">Requires<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="../pep-0587/">587</a></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">28-Dec-2012</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd">28-Dec-2012, 02-Jan-2013, 30-Mar-2019, 28-Jun-2020</dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#pep-withdrawal">PEP Withdrawal</a></li>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a></li>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#key-concerns">Key Concerns</a><ul>
<li><a class="reference internal" href="#maintainability">Maintainability</a></li>
<li><a class="reference internal" href="#testability">Testability</a></li>
<li><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#required-configuration-settings">Required Configuration Settings</a></li>
<li><a class="reference internal" href="#implementation-strategy">Implementation Strategy</a></li>
<li><a class="reference internal" href="#design-details">Design Details</a><ul>
<li><a class="reference internal" href="#interpreter-initialization-phases">Interpreter Initialization Phases</a></li>
<li><a class="reference internal" href="#invocation-of-phases">Invocation of Phases</a></li>
<li><a class="reference internal" href="#uninitialized-state">Uninitialized State</a></li>
<li><a class="reference internal" href="#runtime-pre-initialization-phase">Runtime Pre-Initialization Phase</a></li>
<li><a class="reference internal" href="#determining-the-remaining-configuration-settings">Determining the remaining configuration settings</a></li>
<li><a class="reference internal" href="#supported-configuration-settings">Supported configuration settings</a></li>
<li><a class="reference internal" href="#completing-the-main-interpreter-initialization">Completing the main interpreter initialization</a></li>
<li><a class="reference internal" href="#preparing-the-main-module">Preparing the main module</a></li>
<li><a class="reference internal" href="#executing-the-main-module">Executing the main module</a></li>
<li><a class="reference internal" href="#internal-storage-of-configuration-data">Internal Storage of Configuration Data</a></li>
<li><a class="reference internal" href="#creating-and-configuring-subinterpreters">Creating and Configuring Subinterpreters</a></li>
<li><a class="reference internal" href="#stable-abi">Stable ABI</a></li>
<li><a class="reference internal" href="#build-time-configuration">Build time configuration</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-system-python-executable">A System Python Executable</a></li>
<li><a class="reference internal" href="#open-questions">Open Questions</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#the-status-quo-as-of-python-3-6">The Status Quo (as of Python 3.6)</a><ul>
<li><a class="reference internal" href="#ignoring-environment-variables">Ignoring Environment Variables</a></li>
<li><a class="reference internal" href="#randomised-hashing">Randomised Hashing</a></li>
<li><a class="reference internal" href="#locating-python-and-the-standard-library">Locating Python and the standard library</a></li>
<li><a class="reference internal" href="#configuring-sys-path">Configuring <code class="docutils literal notranslate"><span class="pre">sys.path</span></code></a></li>
<li><a class="reference internal" href="#configuring-sys-argv">Configuring <code class="docutils literal notranslate"><span class="pre">sys.argv</span></code></a></li>
<li><a class="reference internal" href="#other-configuration-settings">Other configuration settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="pep-withdrawal">
<h2><a class="toc-backref" href="#pep-withdrawal" role="doc-backlink">PEP Withdrawal</a></h2>
<p>From late 2012 to mid 2020, this PEP provided general background and specific
concrete proposals for making the CPython startup sequence easier to maintain
and the CPython runtime easier to embed as part of a larger application.</p>
<p>For most of that time, the changes were maintained either in a separate feature
branch, or else as underscore-prefixed private APIs in the main CPython repo.</p>
<p>In 2019, <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> migrated a subset of those API changes to the public CPython
API for Python 3.8+ (specifically, the PEP updated the interpreter runtime to
offer an explicitly multi-stage struct-based configuration interface).</p>
<p>In June 2020, in response to a query from the Steering Council, the PEP authors
decided that it made sense to withdraw the original PEP, as enough has changed
since <a class="pep reference internal" href="../pep-0432/" title="PEP 432 – Restructuring the CPython startup sequence">PEP 432</a> was first written that we think any further changes to the
startup sequence and embedding API would be best formulated as a new PEP (or
PEPs) that take into account not only the not-yet-implemented ideas from <a class="pep reference internal" href="../pep-0432/" title="PEP 432 – Restructuring the CPython startup sequence">PEP 432</a>
that weren’t considered sufficiently well validated to make their way into
<a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>, but also any feedback on the public <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> API, and any other lessons
that have been learned while adjusting the CPython implementation to be more
embedding and subinterpreter friendly.</p>
<p>In particular, PEPs proposing the following changes, and any further
infrastructure changes needed to enable them, would likely still be worth
exploring:</p>
<ul class="simple">
<li>shipping an alternate Python executable that ignores all user level
settings and runs in isolated mode by default, and would hence be more
suitable for execution of system level Python applications than the default
interpreter</li>
<li>enhancing the zipapp module to support the creation of single-file executables
from pure Python scripts (and potentially even Python extension modules, given
the introduction of multi-phase extension module initialisation)</li>
<li>migrating the complex sys.path initialisation logic from C to Python in order
to improve test suite coverage and the general maintainability of that code</li>
</ul>
</section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>This PEP proposes a mechanism for restructuring the startup sequence for
CPython, making it easier to modify the initialization behaviour of the
reference interpreter executable, as well as making it easier to control
CPython’s startup behaviour when creating an alternate executable or
embedding it as a Python execution engine inside a larger application.</p>
<p>When implementation of this proposal is completed, interpreter startup will
consist of three clearly distinct and independently configurable phases:</p>
<ul class="simple">
<li>Python core runtime preinitialization<ul>
<li>setting up memory management</li>
<li>determining the encodings used for system interfaces (including settings
passed in for later configuration phase)</li>
</ul>
</li>
<li>Python core runtime initialization<ul>
<li>ensuring C API is ready for use</li>
<li>ensuring builtin and frozen modules are accessible</li>
</ul>
</li>
<li>Main interpreter configuration<ul>
<li>ensuring external modules are accessible</li>
<li>(Note: the name of this phase is quite likely to change)</li>
</ul>
</li>
</ul>
<p>Changes are also proposed that impact main module execution and subinterpreter
initialization.</p>
<p>Note: TBC = To Be Confirmed, TBD = To Be Determined. The appropriate
resolution for most of these should become clearer as the reference
implementation is developed.</p>
</section>
<section id="proposal">
<h2><a class="toc-backref" href="#proposal" role="doc-backlink">Proposal</a></h2>
<p>This PEP proposes that initialization of the CPython runtime be split into
three clearly distinct phases:</p>
<ul class="simple">
<li>core runtime preinitialization</li>
<li>core runtime initialization</li>
<li>main interpreter configuration</li>
</ul>
<p>(Earlier versions proposed only two phases, but experience with attempting to
implement the PEP as an internal CPython refactoring showed that at least 3
phases are needed to get clear separation of concerns)</p>
<p>The proposed design also has significant implications for:</p>
<ul class="simple">
<li>main module execution</li>
<li>subinterpreter initialization</li>
</ul>
<p>In the new design, the interpreter will move through the following
well-defined phases during the initialization sequence:</p>
<ul class="simple">
<li>Uninitialized - haven’t even started the pre-initialization phase yet</li>
<li>Pre-Initialization - no interpreter available</li>
<li>Runtime Initialized - main interpreter partially available,
subinterpreter creation not yet available</li>
<li>Initialized - main interpreter fully available, subinterpreter creation
available</li>
</ul>
<p><a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> is a more detailed proposal that covers separating out the
Pre-Initialization phase from the last two phases, but doesn’t allow embedding
applications to run arbitrary code while in the “Runtime Initialized” state
(instead, initializing the core runtime will also always fully initialize the
main interpreter, as that’s the way the native CPython CLI still works in
Python 3.8).</p>
<p>As a concrete use case to help guide any design changes, and to solve a known
problem where the appropriate defaults for system utilities differ from those
for running user scripts, this PEP proposes the creation and
distribution of a separate system Python (<code class="docutils literal notranslate"><span class="pre">system-python</span></code>) executable
which, by default, operates in “isolated mode” (as selected by the CPython
<code class="docutils literal notranslate"><span class="pre">-I</span></code> switch), as well as the creation of an example stub binary that just
runs an appended zip archive (permitting single-file pure Python executables)
rather than going through the normal CPython startup sequence.</p>
<p>To keep the implementation complexity under control, this PEP does <em>not</em>
propose wholesale changes to the way the interpreter state is accessed at
runtime. Changing the order in which the existing initialization steps
occur in order to make the startup sequence easier to maintain is already a
substantial change, and attempting to make those other changes at the same time
will make the change significantly more invasive and much harder to review.
However, such proposals may be suitable topics for follow-on PEPs or patches
- one key benefit of this PEP and its related subproposals is decreasing the
coupling between the internal storage model and the configuration interface,
so such changes should be easier once this PEP has been implemented.</p>
</section>
<section id="background">
<h2><a class="toc-backref" href="#background" role="doc-backlink">Background</a></h2>
<p>Over time, CPython’s initialization sequence has become progressively more
complicated, offering more options, as well as performing more complex tasks
(such as configuring the Unicode settings for OS interfaces in Python 3 <a class="footnote-reference brackets" href="#id22" id="id1">[10]</a>,
bootstrapping a pure Python implementation of the import system, and
implementing an isolated mode more suitable for system applications that run
with elevated privileges <a class="footnote-reference brackets" href="#id18" id="id2">[6]</a>).</p>
<p>Much of this complexity is formally accessible only through the <code class="docutils literal notranslate"><span class="pre">Py_Main</span></code>
and <code class="docutils literal notranslate"><span class="pre">Py_Initialize</span></code> APIs, offering embedding applications little
opportunity for customisation. This creeping complexity also makes life
difficult for maintainers, as much of the configuration needs to take
place prior to the <code class="docutils literal notranslate"><span class="pre">Py_Initialize</span></code> call, meaning much of the Python C
API cannot be used safely.</p>
<p>A number of proposals are on the table for even <em>more</em> sophisticated
startup behaviour, such as better control over <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>
initialization (e.g. easily adding additional directories on the command line
in a cross-platform fashion <a class="footnote-reference brackets" href="#id19" id="id3">[7]</a>, controlling the configuration of
<code class="docutils literal notranslate"><span class="pre">sys.path[0]</span></code> <a class="footnote-reference brackets" href="#id20" id="id4">[8]</a>), easier configuration of utilities like coverage
tracing when launching Python subprocesses <a class="footnote-reference brackets" href="#id21" id="id5">[9]</a>).</p>
<p>Rather than continuing to bolt such behaviour onto an already complicated
system indefinitely, this PEP proposes to start simplifying the status quo by
introducing a more structured startup sequence, with the aim of making these
further feature requests easier to implement.</p>
<p>Originally the entire proposal was maintained in this one PEP, but that proved
impractical, so as parts of the proposed design stabilised, they are now split
out into their own PEPs, allowing progress to be made, even while the details
of the overall design are still evolving.</p>
</section>
<section id="key-concerns">
<h2><a class="toc-backref" href="#key-concerns" role="doc-backlink">Key Concerns</a></h2>
<p>There are a few key concerns that any change to the startup sequence
needs to take into account.</p>
<section id="maintainability">
<h3><a class="toc-backref" href="#maintainability" role="doc-backlink">Maintainability</a></h3>
<p>The CPython startup sequence as of Python 3.6 was difficult to understand, and
even more difficult to modify. It was not clear what state the interpreter was
in while much of the initialization code executed, leading to behaviour such
as lists, dictionaries and Unicode values being created prior to the call
to <code class="docutils literal notranslate"><span class="pre">Py_Initialize</span></code> when the <code class="docutils literal notranslate"><span class="pre">-X</span></code> or <code class="docutils literal notranslate"><span class="pre">-W</span></code> options are used <a class="footnote-reference brackets" href="#id13" id="id6">[1]</a>.</p>
<p>By moving to an explicitly multi-phase startup sequence, developers should
only need to understand:</p>
<ul class="simple">
<li>which APIs and features are available prior to pre-configuration (essentially
none, except for the pre-configuration API itself)</li>
<li>which APIs and features are available prior to core runtime configuration, and
will implicitly run the pre-configuration with default settings that match the
behaviour of Python 3.6 if the pre-configuration hasn’t been run explicitly</li>
<li>which APIs and features are only available after the main interpreter has been
fully configured (which will hopefully be a relatively small subset of the
full C API)</li>
</ul>
<p>The first two aspects of that are covered by <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>, while the details of the
latter distinction are still being considered.</p>
<p>By basing the new design on a combination of C structures and Python
data types, it should also be easier to modify the system in the
future to add new configuration options.</p>
</section>
<section id="testability">
<h3><a class="toc-backref" href="#testability" role="doc-backlink">Testability</a></h3>
<p>One of the problems with the complexity of the CPython startup sequence is the
combinatorial explosion of possible interactions between different configuration
settings.</p>
<p>This concern impacts both the design of the new initialisation system, and
the proposed approach for getting there.</p>
</section>
<section id="performance">
<h3><a class="toc-backref" href="#performance" role="doc-backlink">Performance</a></h3>
<p>CPython is used heavily to run short scripts where the runtime is dominated
by the interpreter initialization time. Any changes to the startup sequence
should minimise their impact on the startup overhead.</p>
<p>Experience with the importlib migration suggests that the startup time is
dominated by IO operations. However, to monitor the impact of any changes,
a simple benchmark can be used to check how long it takes to start and then
tear down the interpreter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;from subprocess import call&quot;</span><span class="w"> </span><span class="s2">&quot;call([&#39;./python&#39;, &#39;-Sc&#39;, &#39;pass&#39;])&quot;</span>
</pre></div>
</div>
<p>Current numbers on my system for Python 3.7 (as built by the Fedora project):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python3<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;from subprocess import call&quot;</span><span class="w"> </span><span class="s2">&quot;call([&#39;python3&#39;, &#39;-Sc&#39;, &#39;pass&#39;])&quot;</span>
<span class="go">50 loops, best of 5: 6.48 msec per loop</span>
</pre></div>
</div>
<p>(TODO: run this microbenchmark with perf rather than the stdlib timeit)</p>
<p>This PEP is not expected to have any significant effect on the startup time,
as it is aimed primarily at <em>reordering</em> the existing initialization
sequence, without making substantial changes to the individual steps.</p>
<p>However, if this simple check suggests that the proposed changes to the
initialization sequence may pose a performance problem, then a more
sophisticated microbenchmark will be developed to assist in investigation.</p>
</section>
</section>
<section id="required-configuration-settings">
<h2><a class="toc-backref" href="#required-configuration-settings" role="doc-backlink">Required Configuration Settings</a></h2>
<p>See <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> for a detailed listing of CPython interpreter configuration settings
and the various means available for setting them.</p>
</section>
<section id="implementation-strategy">
<h2><a class="toc-backref" href="#implementation-strategy" role="doc-backlink">Implementation Strategy</a></h2>
<p>An initial attempt was made at implementing an earlier version of this PEP for
Python 3.4 <a class="footnote-reference brackets" href="#id14" id="id7">[2]</a>, with one of the significant problems encountered being merge
conflicts after the initial structural changes were put in place to start the
refactoring process. Unlike some other previous major changes, such as the
switch to an AST-based compiler in Python 2.5, or the switch to the importlib
implementation of the import system in Python 3.3, there is no clear way to
structure a draft implementation that won’t be prone to the kinds of merge
conflicts that afflicted the original attempt.</p>
<p>Accordingly, the implementation strategy was revised to instead first implement
this refactoring as a private API for CPython 3.7, and then review the viability
of exposing the new functions and structures as public API elements in CPython
3.8.</p>
<p>After the initial merge, Victor Stinner then proceeded to actually migrate
settings to the new structure in order to successfully implement the <a class="pep reference internal" href="../pep-0540/" title="PEP 540 – Add a new UTF-8 Mode">PEP 540</a>
UTF-8 mode changes (which required the ability to track all settings that had
previously been decoded with the locale encoding, and decode them again using
UTF-8 instead). Eric Snow also migrated a number of internal subsystems over as
part of making the subinterpreter feature more robust.</p>
<p>That work showed that the detailed design originally proposed in this PEP had a
range of practical issues, so Victor designed and implemented an improved
private API (inspired by an earlier iteration of this PEP), which <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>
proposes to promote to a public API in Python 3.8.</p>
</section>
<section id="design-details">
<h2><a class="toc-backref" href="#design-details" role="doc-backlink">Design Details</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The API details here are still very much in flux. The header files that show
the current state of the private API are mainly:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/python/cpython/blob/master/Include/cpython/coreconfig.h">https://github.com/python/cpython/blob/master/Include/cpython/coreconfig.h</a></li>
<li><a class="reference external" href="https://github.com/python/cpython/blob/master/Include/cpython/pystate.h">https://github.com/python/cpython/blob/master/Include/cpython/pystate.h</a></li>
<li><a class="reference external" href="https://github.com/python/cpython/blob/master/Include/cpython/pylifecycle.h">https://github.com/python/cpython/blob/master/Include/cpython/pylifecycle.h</a></li>
</ul>
<p><a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> covers the aspects of the API that are considered potentially stable
enough to make public. Where a proposed API is covered by that PEP,
“(see PEP 587)” is added to the text below.</p>
</div>
<p>The main theme of this proposal is to initialize the core language runtime
and create a partially initialized interpreter state for the main interpreter
<em>much</em> earlier in the startup process. This will allow most of the CPython API
to be used during the remainder of the initialization process, potentially
simplifying a number of operations that currently need to rely on basic C
functionality rather than being able to use the richer data structures provided
by the CPython C API.</p>
<p><a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> covers a subset of that task, which is splitting out the components that
even the existing “May be called before <code class="docutils literal notranslate"><span class="pre">Py_Initialize</span></code>” interfaces need (like
memory allocators and operating system interface encoding details) into a
separate pre-configuration step.</p>
<p>In the following, the term “embedding application” also covers the standard
CPython command line application.</p>
<section id="interpreter-initialization-phases">
<h3><a class="toc-backref" href="#interpreter-initialization-phases" role="doc-backlink">Interpreter Initialization Phases</a></h3>
<p>The following distinct interpreter initialisation phases are proposed:</p>
<ul class="simple">
<li>Uninitialized:<ul>
<li>Not really a phase, but the absence of a phase</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsInitializing()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsRuntimeInitialized()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsInitialized()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code></li>
<li>The embedding application determines which memory allocator to use, and
which encoding to use to access operating system interfaces (or chooses
to delegate those decisions to the Python runtime)</li>
<li>Application starts the initialization process by calling one of the
<code class="docutils literal notranslate"><span class="pre">Py_PreInitialize</span></code> APIs (see <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>)</li>
</ul>
</li>
<li>Runtime Pre-Initialization:<ul>
<li>no interpreter is available</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsInitializing()</span></code> returns <code class="docutils literal notranslate"><span class="pre">1</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsRuntimeInitialized()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsInitialized()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code></li>
<li>The embedding application determines the settings required to initialize
the core CPython runtime and create the main interpreter and moves to the
next phase by calling <code class="docutils literal notranslate"><span class="pre">Py_InitializeRuntime</span></code></li>
<li>Note: as of <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>, the embedding application instead calls <code class="docutils literal notranslate"><span class="pre">Py_Main()</span></code>,
<code class="docutils literal notranslate"><span class="pre">Py_UnixMain</span></code>, or one of the <code class="docutils literal notranslate"><span class="pre">Py_Initialize</span></code> APIs, and hence jumps
directly to the Initialized state.</li>
</ul>
</li>
<li>Main Interpreter Initialization:<ul>
<li>the builtin data types and other core runtime services are available</li>
<li>the main interpreter is available, but only partially configured</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsInitializing()</span></code> returns <code class="docutils literal notranslate"><span class="pre">1</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsRuntimeInitialized()</span></code> returns <code class="docutils literal notranslate"><span class="pre">1</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsInitialized()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code></li>
<li>The embedding application determines and applies the settings
required to complete the initialization process by calling
<code class="docutils literal notranslate"><span class="pre">Py_InitializeMainInterpreter</span></code></li>
<li>Note: as of <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>, this state is not reachable via any public API, it
only exists as an implicit internal state while one of the <code class="docutils literal notranslate"><span class="pre">Py_Initialize</span></code>
functions is running</li>
</ul>
</li>
<li>Initialized:<ul>
<li>the main interpreter is available and fully operational, but
<code class="docutils literal notranslate"><span class="pre">__main__</span></code> related metadata is incomplete</li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsInitializing()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsRuntimeInitialized()</span></code> returns <code class="docutils literal notranslate"><span class="pre">1</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_IsInitialized()</span></code> returns <code class="docutils literal notranslate"><span class="pre">1</span></code></li>
</ul>
</li>
</ul>
</section>
<section id="invocation-of-phases">
<h3><a class="toc-backref" href="#invocation-of-phases" role="doc-backlink">Invocation of Phases</a></h3>
<p>All listed phases will be used by the standard CPython interpreter and the
proposed System Python interpreter.</p>
<p>An embedding application may still continue to leave initialization almost
entirely under CPython’s control by using the existing <code class="docutils literal notranslate"><span class="pre">Py_Initialize</span></code>
or <code class="docutils literal notranslate"><span class="pre">Py_Main()</span></code> APIs - backwards compatibility will be preserved.</p>
<p>Alternatively, if an embedding application wants greater control
over CPython’s initial state, it will be able to use the new, finer
grained API, which allows the embedding application greater control
over the initialization process.</p>
<p><a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> covers an initial iteration of that API, separating out the
pre-initialization phase without attempting to separate core runtime
initialization from main interpreter initialization.</p>
</section>
<section id="uninitialized-state">
<h3><a class="toc-backref" href="#uninitialized-state" role="doc-backlink">Uninitialized State</a></h3>
<p>The uninitialized state is where an embedding application determines the settings
which are required in order to be able to correctly pass configurations settings
to the embedded Python runtime.</p>
<p>This covers telling Python which memory allocator to use, as well as which text
encoding to use when processing provided settings.</p>
<p><a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> defines the settings needed to exit this state in its <code class="docutils literal notranslate"><span class="pre">PyPreConfig</span></code>
struct.</p>
<p>A new query API will allow code to determine if the interpreter hasn’t even
started the initialization process:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">Py_IsInitializing</span><span class="p">();</span>
</pre></div>
</div>
<p>The query for a completely uninitialized environment would then be
<code class="docutils literal notranslate"><span class="pre">!(Py_Initialized()</span> <span class="pre">||</span> <span class="pre">Py_Initializing())</span></code>.</p>
</section>
<section id="runtime-pre-initialization-phase">
<h3><a class="toc-backref" href="#runtime-pre-initialization-phase" role="doc-backlink">Runtime Pre-Initialization Phase</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>, the settings for this phase are not yet separated out,
and are instead only available through the combined <code class="docutils literal notranslate"><span class="pre">PyConfig</span></code> struct</p>
</div>
<p>The pre-initialization phase is where an embedding application determines
the settings which are absolutely required before the CPython runtime can be
initialized at all. Currently, the primary configuration settings in this
category are those related to the randomised hash algorithm - the hash
algorithms must be consistent for the lifetime of the process, and so they
must be in place before the core interpreter is created.</p>
<p>The essential settings needed are a flag indicating whether or not to use a
specific seed value for the randomised hashes, and if so, the specific value
for the seed (a seed value of zero disables randomised hashing). In addition,
due to the possible use of <code class="docutils literal notranslate"><span class="pre">PYTHONHASHSEED</span></code> in configuring the hash
randomisation, the question of whether or not to consider environment
variables must also be addressed early. Finally, to support the CPython
build process, an option is offered to completely disable the import
system.</p>
<p>The proposed APIs for this step in the startup sequence are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyInitError</span><span class="w"> </span><span class="nf">Py_InitializeRuntime</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">PyRuntimeConfig</span><span class="w"> </span><span class="o">*</span><span class="n">config</span>
<span class="p">);</span>

<span class="n">PyInitError</span><span class="w"> </span><span class="nf">Py_InitializeRuntimeFromArgs</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">PyRuntimeConfig</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span>
<span class="p">);</span>

<span class="n">PyInitError</span><span class="w"> </span><span class="nf">Py_InitializeRuntimeFromWideArgs</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">PyRuntimeConfig</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span>
<span class="p">);</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">Py_IsInitializing()</span></code> is false, the <code class="docutils literal notranslate"><span class="pre">Py_InitializeRuntime</span></code> functions will
implicitly call the corresponding <code class="docutils literal notranslate"><span class="pre">Py_PreInitialize</span></code> function. The
<code class="docutils literal notranslate"><span class="pre">use_environment</span></code> setting will be passed down, while other settings will be
processed according to their defaults, as described in <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">PyInitError</span></code> return type is defined in <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>, and allows an embedding
application to gracefully handle Python runtime initialization failures,
rather than having the entire process abruptly terminated by <code class="docutils literal notranslate"><span class="pre">Py_FatalError</span></code>.</p>
<p>The new <code class="docutils literal notranslate"><span class="pre">PyRuntimeConfig</span></code> struct holds the settings required for preliminary
configuration of the core runtime and creation of the main interpreter:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Note: if changing anything in PyRuntimeConfig, also update</span>
<span class="cm"> * PyRuntimeConfig_INIT */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_environment</span><span class="p">;</span><span class="w">     </span><span class="cm">/* as in PyPreConfig, PyConfig from PEP 587 */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">use_hash_seed</span><span class="p">;</span><span class="w">        </span><span class="cm">/* PYTHONHASHSEED, as in PyConfig from PEP 587 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">hash_seed</span><span class="p">;</span><span class="w">  </span><span class="cm">/* PYTHONHASHSEED, as in PyConfig from PEP 587 */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">_install_importlib</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Needed by freeze_importlib */</span>
<span class="p">}</span><span class="w"> </span><span class="n">PyRuntimeConfig</span><span class="p">;</span>

<span class="cm">/* Rely on the &quot;designated initializer&quot; feature of C99 */</span>
<span class="cp">#define PyRuntimeConfig_INIT {.use_hash_seed=-1}</span>
</pre></div>
</div>
<p>The core configuration settings pointer may be <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, in which case the
default values are as specified in <code class="docutils literal notranslate"><span class="pre">PyRuntimeConfig_INIT</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">PyRuntimeConfig_INIT</span></code> macro is designed to allow easy initialization
of a struct instance with sensible defaults:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyRuntimeConfig</span><span class="w"> </span><span class="n">runtime_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyRuntimeConfig_INIT</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">use_environment</span></code> controls the processing of all Python related
environment variables. If the flag is true, then <code class="docutils literal notranslate"><span class="pre">PYTHONHASHSEED</span></code> is
processed normally. Otherwise, all Python-specific environment variables
are considered undefined (exceptions may be made for some OS specific
environment variables, such as those used on Mac OS X to communicate
between the App bundle and the main Python binary).</p>
<p><code class="docutils literal notranslate"><span class="pre">use_hash_seed</span></code> controls the configuration of the randomised hash
algorithm. If it is zero, then randomised hashes with a random seed will
be used. It is positive, then the value in <code class="docutils literal notranslate"><span class="pre">hash_seed</span></code> will be used
to seed the random number generator. If the <code class="docutils literal notranslate"><span class="pre">hash_seed</span></code> is zero in this
case, then the randomised hashing is disabled completely.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">use_hash_seed</span></code> is negative (and <code class="docutils literal notranslate"><span class="pre">use_environment</span></code> is true),
then CPython will inspect the <code class="docutils literal notranslate"><span class="pre">PYTHONHASHSEED</span></code> environment variable. If the
environment variable is not set, is set to the empty string, or to the value
<code class="docutils literal notranslate"><span class="pre">&quot;random&quot;</span></code>, then randomised hashes with a random seed will be used. If the
environment variable is set to the string <code class="docutils literal notranslate"><span class="pre">&quot;0&quot;</span></code> the randomised hashing will
be disabled. Otherwise, the hash seed is expected to be a string
representation of an integer in the range <code class="docutils literal notranslate"><span class="pre">[0;</span> <span class="pre">4294967295]</span></code>.</p>
<p>To make it easier for embedding applications to use the <code class="docutils literal notranslate"><span class="pre">PYTHONHASHSEED</span></code>
processing with a different data source, the following helper function
will be added to the C API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">Py_ReadHashSeed</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">seed_text</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">use_hash_seed</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">hash_seed</span><span class="p">);</span>
</pre></div>
</div>
<p>This function accepts a seed string in <code class="docutils literal notranslate"><span class="pre">seed_text</span></code> and converts it to
the appropriate flag and seed values. If <code class="docutils literal notranslate"><span class="pre">seed_text</span></code> is <code class="docutils literal notranslate"><span class="pre">NULL</span></code>,
the empty string or the value <code class="docutils literal notranslate"><span class="pre">&quot;random&quot;</span></code>, both <code class="docutils literal notranslate"><span class="pre">use_hash_seed</span></code> and
<code class="docutils literal notranslate"><span class="pre">hash_seed</span></code> will be set to zero. Otherwise, <code class="docutils literal notranslate"><span class="pre">use_hash_seed</span></code> will be set to
<code class="docutils literal notranslate"><span class="pre">1</span></code> and the seed text will be interpreted as an integer and reported as
<code class="docutils literal notranslate"><span class="pre">hash_seed</span></code>. On success the function will return zero. A non-zero return
value indicates an error (most likely in the conversion to an integer).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">_install_importlib</span></code> setting is used as part of the CPython build
process to create an interpreter with no import capability at all. It is
considered private to the CPython development team (hence the leading
underscore), as the only currently supported use case is to permit compiler
changes that invalidate the previously frozen bytecode for
<code class="docutils literal notranslate"><span class="pre">importlib._bootstrap</span></code> without breaking the build process.</p>
<p>The aim is to keep this initial level of configuration as small as possible
in order to keep the bootstrapping environment consistent across
different embedding applications. If we can create a valid interpreter state
without the setting, then the setting should appear solely in the comprehensive
<code class="docutils literal notranslate"><span class="pre">PyConfig</span></code> struct rather than in the core runtime configuration.</p>
<p>A new query API will allow code to determine if the interpreter is in the
bootstrapping state between the core runtime initialization and the creation of
the main interpreter state and the completion of the bulk of the main
interpreter initialization process:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">Py_IsRuntimeInitialized</span><span class="p">();</span>
</pre></div>
</div>
<p>Attempting to call <code class="docutils literal notranslate"><span class="pre">Py_InitializeRuntime()</span></code> again when
<code class="docutils literal notranslate"><span class="pre">Py_IsRuntimeInitialized()</span></code> is already true is reported as a user
configuration error. (TBC, as existing public initialisation APIs support being
called multiple times without error, and simply ignore changes to any
write-once settings. It may make sense to keep that behaviour rather than trying
to make the new API stricter than the old one)</p>
<p>As frozen bytecode may now be legitimately run in an interpreter which is not
yet fully initialized, <code class="docutils literal notranslate"><span class="pre">sys.flags</span></code> will gain a new <code class="docutils literal notranslate"><span class="pre">initialized</span></code> flag.</p>
<p>With the core runtime initialised, the main interpreter and most of the CPython
C API should be fully functional except that:</p>
<ul class="simple">
<li>compilation is not allowed (as the parser and compiler are not yet
configured properly)</li>
<li>creation of subinterpreters is not allowed</li>
<li>creation of additional thread states is not allowed</li>
<li>The following attributes in the <code class="docutils literal notranslate"><span class="pre">sys</span></code> module are all either missing or
<code class="docutils literal notranslate"><span class="pre">None</span></code>:
* <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.argv</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.executable</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.base_exec_prefix</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.base_prefix</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.exec_prefix</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.warnoptions</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.dont_write_bytecode</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.stdin</span></code>
* <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code></li>
<li>The filesystem encoding is not yet defined</li>
<li>The IO encoding is not yet defined</li>
<li>CPython signal handlers are not yet installed</li>
<li>Only builtin and frozen modules may be imported (due to above limitations)</li>
<li><code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code> is set to a temporary IO object using unbuffered binary
mode</li>
<li>The <code class="docutils literal notranslate"><span class="pre">sys.flags</span></code> attribute exists, but the individual flags may not yet
have their final values.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">sys.flags.initialized</span></code> attribute is set to <code class="docutils literal notranslate"><span class="pre">0</span></code></li>
<li>The <code class="docutils literal notranslate"><span class="pre">warnings</span></code> module is not yet initialized</li>
<li>The <code class="docutils literal notranslate"><span class="pre">__main__</span></code> module does not yet exist</li>
</ul>
<p>&lt;TBD: identify any other notable missing functionality&gt;</p>
<p>The main things made available by this step will be the core Python
data types, in particular dictionaries, lists and strings. This allows them
to be used safely for all of the remaining configuration steps (unlike the
status quo).</p>
<p>In addition, the current thread will possess a valid Python thread state,
allowing any further configuration data to be stored on the main interpreter
object rather than in C process globals.</p>
<p>Any call to <code class="docutils literal notranslate"><span class="pre">Py_InitializeRuntime()</span></code> must have a matching call to
<code class="docutils literal notranslate"><span class="pre">Py_Finalize()</span></code>. It is acceptable to skip calling
<code class="docutils literal notranslate"><span class="pre">Py_InitializeMainInterpreter()</span></code> in between (e.g. if attempting to build the
main interpreter configuration settings fails).</p>
</section>
<section id="determining-the-remaining-configuration-settings">
<h3><a class="toc-backref" href="#determining-the-remaining-configuration-settings" role="doc-backlink">Determining the remaining configuration settings</a></h3>
<p>The next step in the initialization sequence is to determine the remaining
settings needed to complete the process. No changes are made to the
interpreter state at this point. The core APIs for this step are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">Py_BuildPythonConfig</span><span class="p">(</span>
<span class="w">    </span><span class="n">PyConfigAsObjects</span><span class="w"> </span><span class="o">*</span><span class="n">py_config</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">PyConfig</span><span class="w"> </span><span class="o">*</span><span class="n">c_config</span>
<span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">Py_BuildPythonConfigFromArgs</span><span class="p">(</span>
<span class="w">    </span><span class="n">PyConfigAsObjects</span><span class="w"> </span><span class="o">*</span><span class="n">py_config</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">PyConfig</span><span class="w"> </span><span class="o">*</span><span class="n">c_config</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span>
<span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">Py_BuildPythonConfigFromWideArgs</span><span class="p">(</span>
<span class="w">    </span><span class="n">PyConfigAsObjects</span><span class="w"> </span><span class="o">*</span><span class="n">py_config</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">PyConfig</span><span class="w"> </span><span class="o">*</span><span class="n">c_config</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">py_config</span></code> argument should be a pointer to a PyConfigAsObjects struct
(which may be a temporary one stored on the C stack). For any already configured
value (i.e. any non-NULL pointer), CPython will sanity check the supplied value,
but otherwise accept it as correct.</p>
<p>A struct is used rather than a Python dictionary as the struct is easier
to work with from C, the list of supported fields is fixed for a given
CPython version and only a read-only view needs to be exposed to Python
code (which is relatively straightforward, thanks to the infrastructure
already put in place to expose <code class="docutils literal notranslate"><span class="pre">sys.implementation</span></code>).</p>
<p>Unlike <code class="docutils literal notranslate"><span class="pre">Py_InitializeRuntime</span></code>, this call will raise a Python exception and
report an error return rather than returning a Python initialization specific
C struct if a problem is found with the config data.</p>
<p>Any supported configuration setting which is not already set will be
populated appropriately in the supplied configuration struct. The default
configuration can be overridden entirely by setting the value <em>before</em>
calling <code class="docutils literal notranslate"><span class="pre">Py_BuildPythonConfig</span></code>. The provided value will then also be
used in calculating any other settings derived from that value.</p>
<p>Alternatively, settings may be overridden <em>after</em> the
<code class="docutils literal notranslate"><span class="pre">Py_BuildPythonConfig</span></code> call (this can be useful if an embedding
application wants to adjust a setting rather than replace it completely,
such as removing <code class="docutils literal notranslate"><span class="pre">sys.path[0]</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">c_config</span></code> argument is an optional pointer to a <code class="docutils literal notranslate"><span class="pre">PyConfig</span></code> structure,
as defined in <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>. If provided, it is used in preference to reading settings
directly from the environment or process global state.</p>
<p>Merely reading the configuration has no effect on the interpreter state: it
only modifies the passed in configuration struct. The settings are not
applied to the running interpreter until the <code class="docutils literal notranslate"><span class="pre">Py_InitializeMainInterpreter</span></code>
call (see below).</p>
</section>
<section id="supported-configuration-settings">
<h3><a class="toc-backref" href="#supported-configuration-settings" role="doc-backlink">Supported configuration settings</a></h3>
<p>The interpreter configuration is split into two parts: settings which are
either relevant only to the main interpreter or must be identical across the
main interpreter and all subinterpreters, and settings which may vary across
subinterpreters.</p>
<p>NOTE: For initial implementation purposes, only the flag indicating whether
or not the interpreter is the main interpreter will be configured on a per
interpreter basis. Other fields will be reviewed for whether or not they can
feasibly be made interpreter specific over the course of the implementation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The list of config fields below is currently out of sync with <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>.
Where they differ, <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> takes precedence.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">PyConfigAsObjects</span></code> struct mirrors the <code class="docutils literal notranslate"><span class="pre">PyConfig</span></code> struct from <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>,
but uses full Python objects to store values, rather than C level data types.
It adds <code class="docutils literal notranslate"><span class="pre">raw_argv</span></code> and <code class="docutils literal notranslate"><span class="pre">argv</span></code> list fields, so later initialisation steps
don’t need to accept those separately.</p>
<p>Fields are always pointers to Python data types, with unset values indicated by
<code class="docutils literal notranslate"><span class="pre">NULL</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Argument processing */</span>
<span class="w">    </span><span class="n">PyListObject</span><span class="w"> </span><span class="o">*</span><span class="n">raw_argv</span><span class="p">;</span>
<span class="w">    </span><span class="n">PyListObject</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">;</span>
<span class="w">    </span><span class="n">PyListObject</span><span class="w"> </span><span class="o">*</span><span class="n">warnoptions</span><span class="p">;</span><span class="w"> </span><span class="cm">/* -W switch, PYTHONWARNINGS */</span>
<span class="w">    </span><span class="n">PyDictObject</span><span class="w"> </span><span class="o">*</span><span class="n">xoptions</span><span class="p">;</span><span class="w">    </span><span class="cm">/* -X switch */</span>

<span class="w">    </span><span class="cm">/* Filesystem locations */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">program_name</span><span class="p">;</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">executable</span><span class="p">;</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">prefix</span><span class="p">;</span><span class="w">           </span><span class="cm">/* PYTHONHOME */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">exec_prefix</span><span class="p">;</span><span class="w">      </span><span class="cm">/* PYTHONHOME */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">base_prefix</span><span class="p">;</span><span class="w">      </span><span class="cm">/* pyvenv.cfg */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">base_exec_prefix</span><span class="p">;</span><span class="w"> </span><span class="cm">/* pyvenv.cfg */</span>

<span class="w">    </span><span class="cm">/* Site module */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">enable_site_config</span><span class="p">;</span><span class="w">  </span><span class="cm">/* -S switch (inverted) */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">no_user_site</span><span class="p">;</span><span class="w">        </span><span class="cm">/* -s switch, PYTHONNOUSERSITE */</span>

<span class="w">    </span><span class="cm">/* Import configuration */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">dont_write_bytecode</span><span class="p">;</span><span class="w"> </span><span class="cm">/* -B switch, PYTHONDONTWRITEBYTECODE */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">ignore_module_case</span><span class="p">;</span><span class="w">  </span><span class="cm">/* PYTHONCASEOK */</span>
<span class="w">    </span><span class="n">PyListObject</span><span class="w"> </span><span class="o">*</span><span class="n">import_path</span><span class="p">;</span><span class="w">        </span><span class="cm">/* PYTHONPATH (etc) */</span>

<span class="w">    </span><span class="cm">/* Standard streams */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w">    </span><span class="o">*</span><span class="n">use_unbuffered_io</span><span class="p">;</span><span class="w"> </span><span class="cm">/* -u switch, PYTHONUNBUFFEREDIO */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">stdin_encoding</span><span class="p">;</span><span class="w">    </span><span class="cm">/* PYTHONIOENCODING */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">stdin_errors</span><span class="p">;</span><span class="w">      </span><span class="cm">/* PYTHONIOENCODING */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">stdout_encoding</span><span class="p">;</span><span class="w">   </span><span class="cm">/* PYTHONIOENCODING */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">stdout_errors</span><span class="p">;</span><span class="w">     </span><span class="cm">/* PYTHONIOENCODING */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">stderr_encoding</span><span class="p">;</span><span class="w">   </span><span class="cm">/* PYTHONIOENCODING */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">stderr_errors</span><span class="p">;</span><span class="w">     </span><span class="cm">/* PYTHONIOENCODING */</span>

<span class="w">    </span><span class="cm">/* Filesystem access */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">fs_encoding</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Debugging output */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">debug_parser</span><span class="p">;</span><span class="w">    </span><span class="cm">/* -d switch, PYTHONDEBUG */</span>
<span class="w">    </span><span class="n">PyLongObject</span><span class="w"> </span><span class="o">*</span><span class="n">verbosity</span><span class="p">;</span><span class="w">       </span><span class="cm">/* -v switch */</span>

<span class="w">    </span><span class="cm">/* Code generation */</span>
<span class="w">    </span><span class="n">PyLongObject</span><span class="w"> </span><span class="o">*</span><span class="n">bytes_warnings</span><span class="p">;</span><span class="w">  </span><span class="cm">/* -b switch */</span>
<span class="w">    </span><span class="n">PyLongObject</span><span class="w"> </span><span class="o">*</span><span class="n">optimize</span><span class="p">;</span><span class="w">        </span><span class="cm">/* -O switch */</span>

<span class="w">    </span><span class="cm">/* Signal handling */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">install_signal_handlers</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Implicit execution */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">startup_file</span><span class="p">;</span><span class="w">  </span><span class="cm">/* PYTHONSTARTUP */</span>

<span class="w">    </span><span class="cm">/* Main module</span>
<span class="cm">     *</span>
<span class="cm">     * If prepare_main is set, at most one of the main_* settings should</span>
<span class="cm">     * be set before calling PyRun_PrepareMain (Py_ReadMainInterpreterConfig</span>
<span class="cm">     * will set one of them based on the command line arguments if</span>
<span class="cm">     * prepare_main is non-zero when that API is called).</span>
<span class="cm">    PyBoolObject    *prepare_main;</span>
<span class="cm">    PyUnicodeObject *main_source; /* -c switch */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">main_path</span><span class="p">;</span><span class="w">   </span><span class="cm">/* filesystem path */</span>
<span class="w">    </span><span class="n">PyUnicodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">main_module</span><span class="p">;</span><span class="w"> </span><span class="cm">/* -m switch */</span>
<span class="w">    </span><span class="n">PyCodeObject</span><span class="w">    </span><span class="o">*</span><span class="n">main_code</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Run directly from a code object */</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w">        </span><span class="o">*</span><span class="n">main_stream</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Run from stream */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w">    </span><span class="o">*</span><span class="n">run_implicit_code</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Run implicit code during prep */</span>

<span class="w">    </span><span class="cm">/* Interactive main</span>
<span class="cm">     *</span>
<span class="cm">     * Note: Settings related to interactive mode are very much in flux.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">prompt_stream</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Output interactive prompt */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">show_banner</span><span class="p">;</span><span class="w">    </span><span class="cm">/* -q switch (inverted) */</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">inspect_main</span><span class="p">;</span><span class="w">   </span><span class="cm">/* -i switch, PYTHONINSPECT */</span>

<span class="p">}</span><span class="w"> </span><span class="n">PyConfigAsObjects</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">PyInterpreterConfig</span></code> struct holds the settings that may vary between
the main interpreter and subinterpreters. For the main interpreter, these
settings are automatically populated by <code class="docutils literal notranslate"><span class="pre">Py_InitializeMainInterpreter()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PyBoolObject</span><span class="w"> </span><span class="o">*</span><span class="n">is_main_interpreter</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Easily check for subinterpreters */</span>
<span class="p">}</span><span class="w"> </span><span class="n">PyInterpreterConfig</span><span class="p">;</span>
</pre></div>
</div>
<p>As these structs consist solely of object pointers, no explicit initializer
definitions are needed - C99’s default initialization of struct memory to zero
is sufficient.</p>
</section>
<section id="completing-the-main-interpreter-initialization">
<h3><a class="toc-backref" href="#completing-the-main-interpreter-initialization" role="doc-backlink">Completing the main interpreter initialization</a></h3>
<p>The final step in the initialization process is to actually put the
configuration settings into effect and finish bootstrapping the main
interpreter up to full operation:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">Py_InitializeMainInterpreter</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">PyConfigAsObjects</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
<p>Like <code class="docutils literal notranslate"><span class="pre">Py_BuildPythonConfig</span></code>, this call will raise an exception and
report an error return rather than exhibiting fatal errors if a problem is
found with the config data. (TBC, as existing public initialisation APIs support
being called multiple times without error, and simply ignore changes to any
write-once settings. It may make sense to keep that behaviour rather than trying
to make the new API stricter than the old one)</p>
<p>All configuration settings are required - the configuration struct
should always be passed through <code class="docutils literal notranslate"><span class="pre">Py_BuildPythonConfig</span></code> to ensure it
is fully populated.</p>
<p>After a successful call <code class="docutils literal notranslate"><span class="pre">Py_IsInitialized()</span></code> will become true and
<code class="docutils literal notranslate"><span class="pre">Py_IsInitializing()</span></code> will become false. The caveats described above for the
interpreter during the phase where only the core runtime is initialized will
no longer hold.</p>
<p>Attempting to call <code class="docutils literal notranslate"><span class="pre">Py_InitializeMainInterpreter()</span></code> again when
<code class="docutils literal notranslate"><span class="pre">Py_IsInitialized()</span></code> is true is an error.</p>
<p>However, some metadata related to the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> module may still be
incomplete:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">sys.argv[0]</span></code> may not yet have its final value<ul>
<li>it will be <code class="docutils literal notranslate"><span class="pre">-m</span></code> when executing a module or package with CPython</li>
<li>it will be the same as <code class="docutils literal notranslate"><span class="pre">sys.path[0]</span></code> rather than the location of
the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> module when executing a valid <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> entry
(typically a zipfile or directory)</li>
<li>otherwise, it will be accurate:<ul>
<li>the script name if running an ordinary script</li>
<li><code class="docutils literal notranslate"><span class="pre">-c</span></code> if executing a supplied string</li>
<li><code class="docutils literal notranslate"><span class="pre">-</span></code> or the empty string if running from stdin</li>
</ul>
</li>
</ul>
</li>
<li>the metadata in the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> module will still indicate it is a
builtin module</li>
</ul>
<p>This function will normally implicitly import site as its final operation
(after <code class="docutils literal notranslate"><span class="pre">Py_IsInitialized()</span></code> is already set). Setting the
“enable_site_config” flag to <code class="docutils literal notranslate"><span class="pre">Py_False</span></code> in the configuration settings will
disable this behaviour, as well as eliminating any side effects on global
state if <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">site</span></code> is later explicitly executed in the process.</p>
</section>
<section id="preparing-the-main-module">
<h3><a class="toc-backref" href="#preparing-the-main-module" role="doc-backlink">Preparing the main module</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>, <code class="docutils literal notranslate"><span class="pre">PyRun_PrepareMain</span></code> and <code class="docutils literal notranslate"><span class="pre">PyRun_ExecMain</span></code> are not
exposed separately, and are instead accessed through a <code class="docutils literal notranslate"><span class="pre">Py_RunMain</span></code> API
that both prepares and executes main, and then finalizes the Python
interpreter.</p>
</div>
<p>This subphase completes the population of the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> module
related metadata, without actually starting execution of the <code class="docutils literal notranslate"><span class="pre">__main__</span></code>
module code.</p>
<p>It is handled by calling the following API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">PyRun_PrepareMain</span><span class="p">();</span>
</pre></div>
</div>
<p>This operation is only permitted for the main interpreter, and will raise
<code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> when invoked from a thread where the current thread state
belongs to a subinterpreter.</p>
<p>The actual processing is driven by the main related settings stored in
the interpreter state as part of the configuration struct.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">prepare_main</span></code> is zero, this call does nothing.</p>
<p>If all of <code class="docutils literal notranslate"><span class="pre">main_source</span></code>, <code class="docutils literal notranslate"><span class="pre">main_path</span></code>, <code class="docutils literal notranslate"><span class="pre">main_module</span></code>,
<code class="docutils literal notranslate"><span class="pre">main_stream</span></code> and <code class="docutils literal notranslate"><span class="pre">main_code</span></code> are NULL, this call does nothing.</p>
<p>If more than one of <code class="docutils literal notranslate"><span class="pre">main_source</span></code>, <code class="docutils literal notranslate"><span class="pre">main_path</span></code>, <code class="docutils literal notranslate"><span class="pre">main_module</span></code>,
<code class="docutils literal notranslate"><span class="pre">main_stream</span></code> or <code class="docutils literal notranslate"><span class="pre">main_code</span></code> are set, <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> will be reported.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">main_code</span></code> is already set, then this call does nothing.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">main_stream</span></code> is set, and <code class="docutils literal notranslate"><span class="pre">run_implicit_code</span></code> is also set, then
the file identified in <code class="docutils literal notranslate"><span class="pre">startup_file</span></code> will be read, compiled and
executed in the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> namespace.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">main_source</span></code>, <code class="docutils literal notranslate"><span class="pre">main_path</span></code> or <code class="docutils literal notranslate"><span class="pre">main_module</span></code> are set, then this
call will take whatever steps are needed to populate <code class="docutils literal notranslate"><span class="pre">main_code</span></code>:</p>
<ul class="simple">
<li>For <code class="docutils literal notranslate"><span class="pre">main_source</span></code>, the supplied string will be compiled and saved to
<code class="docutils literal notranslate"><span class="pre">main_code</span></code>.</li>
<li>For <code class="docutils literal notranslate"><span class="pre">main_path</span></code>:<ul>
<li>if the supplied path is recognised as a valid <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> entry, it
is inserted as <code class="docutils literal notranslate"><span class="pre">sys.path[0]</span></code>, <code class="docutils literal notranslate"><span class="pre">main_module</span></code> is set
to <code class="docutils literal notranslate"><span class="pre">__main__</span></code> and processing continues as for <code class="docutils literal notranslate"><span class="pre">main_module</span></code> below.</li>
<li>otherwise, path is read as a CPython bytecode file</li>
<li>if that fails, it is read as a Python source file and compiled</li>
<li>in the latter two cases, the code object is saved to <code class="docutils literal notranslate"><span class="pre">main_code</span></code>
and <code class="docutils literal notranslate"><span class="pre">__main__.__file__</span></code> is set appropriately</li>
</ul>
</li>
<li>For <code class="docutils literal notranslate"><span class="pre">main_module</span></code>:<ul>
<li>any parent package is imported</li>
<li>the loader for the module is determined</li>
<li>if the loader indicates the module is a package, add <code class="docutils literal notranslate"><span class="pre">.__main__</span></code> to
the end of <code class="docutils literal notranslate"><span class="pre">main_module</span></code> and try again (if the final name segment
is already <code class="docutils literal notranslate"><span class="pre">.__main__</span></code> then fail immediately)</li>
<li>once the module source code is located, save the compiled module code
as <code class="docutils literal notranslate"><span class="pre">main_code</span></code> and populate the following attributes in <code class="docutils literal notranslate"><span class="pre">__main__</span></code>
appropriately: <code class="docutils literal notranslate"><span class="pre">__name__</span></code>, <code class="docutils literal notranslate"><span class="pre">__loader__</span></code>, <code class="docutils literal notranslate"><span class="pre">__file__</span></code>,
<code class="docutils literal notranslate"><span class="pre">__cached__</span></code>, <code class="docutils literal notranslate"><span class="pre">__package__</span></code>.</li>
</ul>
</li>
</ul>
<p>(Note: the behaviour described in this section isn’t new, it’s a write-up
of the current behaviour of the CPython interpreter adjusted for the new
configuration system)</p>
</section>
<section id="executing-the-main-module">
<h3><a class="toc-backref" href="#executing-the-main-module" role="doc-backlink">Executing the main module</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a>, <code class="docutils literal notranslate"><span class="pre">PyRun_PrepareMain</span></code> and <code class="docutils literal notranslate"><span class="pre">PyRun_ExecMain</span></code> are not
exposed separately, and are instead accessed through a <code class="docutils literal notranslate"><span class="pre">Py_RunMain</span></code> API
that both prepares and executes main, and then finalizes the Python
interpreter.</p>
</div>
<p>This subphase covers the execution of the actual <code class="docutils literal notranslate"><span class="pre">__main__</span></code> module code.</p>
<p>It is handled by calling the following API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">PyRun_ExecMain</span><span class="p">();</span>
</pre></div>
</div>
<p>This operation is only permitted for the main interpreter, and will raise
<code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> when invoked from a thread where the current thread state
belongs to a subinterpreter.</p>
<p>The actual processing is driven by the main related settings stored in
the interpreter state as part of the configuration struct.</p>
<p>If both <code class="docutils literal notranslate"><span class="pre">main_stream</span></code> and <code class="docutils literal notranslate"><span class="pre">main_code</span></code> are NULL, this call does nothing.</p>
<p>If both <code class="docutils literal notranslate"><span class="pre">main_stream</span></code> and <code class="docutils literal notranslate"><span class="pre">main_code</span></code> are set, <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> will
be reported.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">main_stream</span></code> and <code class="docutils literal notranslate"><span class="pre">prompt_stream</span></code> are both set, main execution will
be delegated to a new internal API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">_PyRun_InteractiveMain</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">);</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">main_stream</span></code> is set and <code class="docutils literal notranslate"><span class="pre">prompt_stream</span></code> is NULL, main execution will
be delegated to a new internal API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">_PyRun_StreamInMain</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">);</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">main_code</span></code> is set, main execution will be delegated to a new internal
API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">_PyRun_CodeInMain</span><span class="p">(</span><span class="n">PyCodeObject</span><span class="w"> </span><span class="o">*</span><span class="n">code</span><span class="p">);</span>
</pre></div>
</div>
<p>After execution of main completes, if <code class="docutils literal notranslate"><span class="pre">inspect_main</span></code> is set, or
the <code class="docutils literal notranslate"><span class="pre">PYTHONINSPECT</span></code> environment variable has been set, then
<code class="docutils literal notranslate"><span class="pre">PyRun_ExecMain</span></code> will invoke
<code class="docutils literal notranslate"><span class="pre">_PyRun_InteractiveMain(sys.__stdin__,</span> <span class="pre">sys.__stdout__)</span></code>.</p>
</section>
<section id="internal-storage-of-configuration-data">
<h3><a class="toc-backref" href="#internal-storage-of-configuration-data" role="doc-backlink">Internal Storage of Configuration Data</a></h3>
<p>The interpreter state will be updated to include details of the configuration
settings supplied during initialization by extending the interpreter state
object with at least an embedded copy of the <code class="docutils literal notranslate"><span class="pre">PyConfigAsObjects</span></code> and
<code class="docutils literal notranslate"><span class="pre">PyInterpreterConfig</span></code> structs.</p>
<p>For debugging purposes, the configuration settings will be exposed as
a <code class="docutils literal notranslate"><span class="pre">sys._configuration</span></code> simple namespace (similar to <code class="docutils literal notranslate"><span class="pre">sys.flags</span></code> and
<code class="docutils literal notranslate"><span class="pre">sys.implementation</span></code>. The attributes will be themselves by simple namespaces
corresponding to the two levels of configuration setting:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">all_interpreters</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">active_interpreter</span></code></li>
</ul>
<p>Field names will match those in the configuration structs, except for
<code class="docutils literal notranslate"><span class="pre">hash_seed</span></code>, which will be deliberately excluded.</p>
<p>An underscored attribute is chosen deliberately, as these configuration
settings are part of the CPython implementation, rather than part of the
Python language definition. If new settings are needed to support
cross-implementation compatibility in the standard library, then those
should be agreed with the other implementations and exposed as new required
attributes on <code class="docutils literal notranslate"><span class="pre">sys.implementation</span></code>, as described in <a class="pep reference internal" href="../pep-0421/" title="PEP 421 – Adding sys.implementation">PEP 421</a>.</p>
<p>These are <em>snapshots</em> of the initial configuration settings. They are not
modified by the interpreter during runtime (except as noted above).</p>
</section>
<section id="creating-and-configuring-subinterpreters">
<h3><a class="toc-backref" href="#creating-and-configuring-subinterpreters" role="doc-backlink">Creating and Configuring Subinterpreters</a></h3>
<p>As the new configuration settings are stored in the interpreter state, they
need to be initialised when a new subinterpreter is created. This turns out
to be trickier than one might expect due to <code class="docutils literal notranslate"><span class="pre">PyThreadState_Swap(NULL);</span></code>
(which is fortunately exercised by CPython’s own embedding tests, allowing
this problem to be detected during development).</p>
<p>To provide a straightforward solution for this case, the PEP proposes to
add a new API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Py_InterpreterState</span><span class="w"> </span><span class="o">*</span><span class="nf">Py_InterpreterState_Main</span><span class="p">();</span>
</pre></div>
</div>
<p>This will be a counterpart to <code class="docutils literal notranslate"><span class="pre">Py_InterpreterState_Head()</span></code>, only reporting the
oldest currently existing interpreter rather than the newest. If
<code class="docutils literal notranslate"><span class="pre">Py_NewInterpreter()</span></code> is called from a thread with an existing thread
state, then the interpreter configuration for that thread will be
used when initialising the new subinterpreter. If there is no current
thread state, the configuration from <code class="docutils literal notranslate"><span class="pre">Py_InterpreterState_Main()</span></code>
will be used.</p>
<p>While the existing <code class="docutils literal notranslate"><span class="pre">Py_InterpreterState_Head()</span></code> API could be used instead,
that reference changes as subinterpreters are created and destroyed, while
<code class="docutils literal notranslate"><span class="pre">PyInterpreterState_Main()</span></code> will always refer to the initial interpreter
state created in <code class="docutils literal notranslate"><span class="pre">Py_InitializeRuntime()</span></code>.</p>
<p>A new constraint is also added to the embedding API: attempting to delete
the main interpreter while subinterpreters still exist will now be a fatal
error.</p>
</section>
<section id="stable-abi">
<h3><a class="toc-backref" href="#stable-abi" role="doc-backlink">Stable ABI</a></h3>
<p>Most of the APIs proposed in this PEP are excluded from the stable ABI, as
embedding a Python interpreter involves a much higher degree of coupling
than merely writing an extension module.</p>
<p>The only newly exposed APIs that will be part of the stable ABI are the
<code class="docutils literal notranslate"><span class="pre">Py_IsInitializing()</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_IsRuntimeInitialized()</span></code> queries.</p>
</section>
<section id="build-time-configuration">
<h3><a class="toc-backref" href="#build-time-configuration" role="doc-backlink">Build time configuration</a></h3>
<p>This PEP makes no changes to the handling of build time configuration
settings, and thus has no effect on the contents of <code class="docutils literal notranslate"><span class="pre">sys.implementation</span></code>
or the result of <code class="docutils literal notranslate"><span class="pre">sysconfig.get_config_vars()</span></code>.</p>
</section>
<section id="backwards-compatibility">
<h3><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h3>
<p>Backwards compatibility will be preserved primarily by ensuring that
<code class="docutils literal notranslate"><span class="pre">Py_BuildPythonConfig()</span></code> interrogates all the previously defined
configuration settings stored in global variables and environment variables,
and that <code class="docutils literal notranslate"><span class="pre">Py_InitializeMainInterpreter()</span></code> writes affected settings back to
the relevant locations.</p>
<p>One acknowledged incompatibility is that some environment variables which
are currently read lazily may instead be read once during interpreter
initialization. As the reference implementation matures, these will be
discussed in more detail on a case-by-case basis. The environment variables
which are currently known to be looked up dynamically are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">PYTHONCASEOK</span></code>: writing to <code class="docutils literal notranslate"><span class="pre">os.environ['PYTHONCASEOK']</span></code> will no longer
dynamically alter the interpreter’s handling of filename case differences
on import (TBC)</li>
<li><code class="docutils literal notranslate"><span class="pre">PYTHONINSPECT</span></code>: <code class="docutils literal notranslate"><span class="pre">os.environ['PYTHONINSPECT']</span></code> will still be checked
after execution of the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> module terminates</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code> style of initialization will continue to be
supported. It will use (at least some elements of) the new API
internally, but will continue to exhibit the same behaviour as it
does today, ensuring that <code class="docutils literal notranslate"><span class="pre">sys.argv</span></code> is not populated until a subsequent
<code class="docutils literal notranslate"><span class="pre">PySys_SetArgv</span></code> call (TBC). All APIs that currently support being called
prior to <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code> will
continue to do so, and will also support being called prior to
<code class="docutils literal notranslate"><span class="pre">Py_InitializeRuntime()</span></code>.</p>
</section>
</section>
<section id="a-system-python-executable">
<h2><a class="toc-backref" href="#a-system-python-executable" role="doc-backlink">A System Python Executable</a></h2>
<p>When executing system utilities with administrative access to a system, many
of the default behaviours of CPython are undesirable, as they may allow
untrusted code to execute with elevated privileges. The most problematic
aspects are the fact that user site directories are enabled,
environment variables are trusted and that the directory containing the
executed file is placed at the beginning of the import path.</p>
<p>Issue 16499 <a class="footnote-reference brackets" href="#id18" id="id8">[6]</a> added a <code class="docutils literal notranslate"><span class="pre">-I</span></code> option to change the behaviour of
the normal CPython executable, but this is a hard to discover solution (and
adds yet another option to an already complex CLI). This PEP proposes to
instead add a separate <code class="docutils literal notranslate"><span class="pre">system-python</span></code> executable</p>
<p>Currently, providing a separate executable with different default behaviour
would be prohibitively hard to maintain. One of the goals of this PEP is to
make it possible to replace much of the hard to maintain bootstrapping code
with more normal CPython code, as well as making it easier for a separate
application to make use of key components of <code class="docutils literal notranslate"><span class="pre">Py_Main</span></code>. Including this
change in the PEP is designed to help avoid acceptance of a design that
sounds good in theory but proves to be problematic in practice.</p>
<p>Cleanly supporting this kind of “alternate CLI” is the main reason for the
proposed changes to better expose the core logic for deciding between the
different execution modes supported by CPython:</p>
<ul class="simple">
<li>script execution</li>
<li>directory/zipfile execution</li>
<li>command execution (“-c” switch)</li>
<li>module or package execution (“-m” switch)</li>
<li>execution from stdin (non-interactive)</li>
<li>interactive stdin</li>
</ul>
<p>Actually implementing this may also reveal the need for some better
argument parsing infrastructure for use during the initializing phase.</p>
</section>
<section id="open-questions">
<h2><a class="toc-backref" href="#open-questions" role="doc-backlink">Open Questions</a></h2>
<ul class="simple">
<li>Error details for <code class="docutils literal notranslate"><span class="pre">Py_BuildPythonConfig</span></code> and
<code class="docutils literal notranslate"><span class="pre">Py_InitializeMainInterpreter</span></code> (these should become clearer as the
implementation progresses)</li>
</ul>
</section>
<section id="implementation">
<h2><a class="toc-backref" href="#implementation" role="doc-backlink">Implementation</a></h2>
<p>The reference implementation is being developed as a private API refactoring
within the CPython reference interpreter (as attempting to maintain it as an
independent project proved impractical).</p>
<p><a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> extracts a subset of the proposal that is considered sufficiently stable
to be worth proposing as a public API for Python 3.8.</p>
</section>
<section id="the-status-quo-as-of-python-3-6">
<h2><a class="toc-backref" href="#the-status-quo-as-of-python-3-6" role="doc-backlink">The Status Quo (as of Python 3.6)</a></h2>
<p>The current mechanisms for configuring the interpreter have accumulated in
a fairly ad hoc fashion over the past 20+ years, leading to a rather
inconsistent interface with varying levels of documentation.</p>
<p>Also see <a class="pep reference internal" href="../pep-0587/" title="PEP 587 – Python Initialization Configuration">PEP 587</a> for further discussion of the existing settings and their
handling.</p>
<p>(Note: some of the info below could probably be cleaned up and added to the
C API documentation for 3.x - it’s all CPython specific, so it
doesn’t belong in the language reference)</p>
<section id="ignoring-environment-variables">
<h3><a class="toc-backref" href="#ignoring-environment-variables" role="doc-backlink">Ignoring Environment Variables</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">-E</span></code> command line option allows all environment variables to be
ignored when initializing the Python interpreter. An embedding application
can enable this behaviour by setting <code class="docutils literal notranslate"><span class="pre">Py_IgnoreEnvironmentFlag</span></code> before
calling <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code>.</p>
<p>In the CPython source code, the <code class="docutils literal notranslate"><span class="pre">Py_GETENV</span></code> macro implicitly checks this
flag, and always produces <code class="docutils literal notranslate"><span class="pre">NULL</span></code> if it is set.</p>
<p>&lt;TBD: I believe PYTHONCASEOK is checked regardless of this setting &gt;
&lt;TBD: Does -E also ignore Windows registry keys? &gt;</p>
</section>
<section id="randomised-hashing">
<h3><a class="toc-backref" href="#randomised-hashing" role="doc-backlink">Randomised Hashing</a></h3>
<p>The randomised hashing is controlled via the <code class="docutils literal notranslate"><span class="pre">-R</span></code> command line option (in
releases prior to 3.3), as well as the <code class="docutils literal notranslate"><span class="pre">PYTHONHASHSEED</span></code> environment
variable.</p>
<p>In Python 3.3, only the environment variable remains relevant. It can be
used to disable randomised hashing (by using a seed value of 0) or else
to force a specific hash value (e.g. for repeatability of testing, or
to share hash values between processes)</p>
<p>However, embedding applications must use the <code class="docutils literal notranslate"><span class="pre">Py_HashRandomizationFlag</span></code>
to explicitly request hash randomisation (CPython sets it in <code class="docutils literal notranslate"><span class="pre">Py_Main()</span></code>
rather than in <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code>).</p>
<p>The new configuration API should make it straightforward for an
embedding application to reuse the <code class="docutils literal notranslate"><span class="pre">PYTHONHASHSEED</span></code> processing with
a text based configuration setting provided by other means (e.g. a
config file or separate environment variable).</p>
</section>
<section id="locating-python-and-the-standard-library">
<h3><a class="toc-backref" href="#locating-python-and-the-standard-library" role="doc-backlink">Locating Python and the standard library</a></h3>
<p>The location of the Python binary and the standard library is influenced
by several elements. The algorithm used to perform the calculation is
not documented anywhere other than in the source code <a class="footnote-reference brackets" href="#id15" id="id9">[3]</a>, <a class="footnote-reference brackets" href="#id16" id="id10">[4]</a>. Even that
description is incomplete, as it failed to be updated for the virtual
environment support added in Python 3.3 (detailed in <a class="pep reference internal" href="../pep-0405/" title="PEP 405 – Python Virtual Environments">PEP 405</a>).</p>
<p>These calculations are affected by the following function calls (made
prior to calling <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code>) and environment variables:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_SetProgramName()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Py_SetPythonHome()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PYTHONHOME</span></code></li>
</ul>
<p>The filesystem is also inspected for <code class="docutils literal notranslate"><span class="pre">pyvenv.cfg</span></code> files (see <a class="pep reference internal" href="../pep-0405/" title="PEP 405 – Python Virtual Environments">PEP 405</a>) or,
failing that, a <code class="docutils literal notranslate"><span class="pre">lib/os.py</span></code> (Windows) or <code class="docutils literal notranslate"><span class="pre">lib/python$VERSION/os.py</span></code>
file.</p>
<p>The build time settings for <code class="docutils literal notranslate"><span class="pre">PREFIX</span></code> and <code class="docutils literal notranslate"><span class="pre">EXEC_PREFIX</span></code> are also relevant,
as are some registry settings on Windows. The hardcoded fallbacks are
based on the layout of the CPython source tree and build output when
working in a source checkout.</p>
</section>
<section id="configuring-sys-path">
<h3><a class="toc-backref" href="#configuring-sys-path" role="doc-backlink">Configuring <code class="docutils literal notranslate"><span class="pre">sys.path</span></code></a></h3>
<p>An embedding application may call <code class="docutils literal notranslate"><span class="pre">Py_SetPath()</span></code> prior to
<code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code> to completely override the calculation of
<code class="docutils literal notranslate"><span class="pre">sys.path</span></code>. It is not straightforward to only allow <em>some</em> of the
calculations, as modifying <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> after initialization is
already complete means those modifications will not be in effect
when standard library modules are imported during the startup sequence.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">Py_SetPath()</span></code> is not used prior to the first call to <code class="docutils literal notranslate"><span class="pre">Py_GetPath()</span></code>
(implicit in <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code>), then it builds on the location data
calculations above to calculate suitable path entries, along with
the <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> environment variable.</p>
<p>&lt;TBD: On Windows, there’s also a bunch of stuff to do with the registry&gt;</p>
<p>The <code class="docutils literal notranslate"><span class="pre">site</span></code> module, which is implicitly imported at startup (unless
disabled via the <code class="docutils literal notranslate"><span class="pre">-S</span></code> option) adds additional paths to this initial
set of paths, as described in its documentation <a class="footnote-reference brackets" href="#id17" id="id11">[5]</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-s</span></code> command line option can be used to exclude the user site
directory from the list of directories added. Embedding applications
can control this by setting the <code class="docutils literal notranslate"><span class="pre">Py_NoUserSiteDirectory</span></code> global variable.</p>
<p>The following commands can be used to check the default path configurations
for a given Python executable on a given system:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">./python</span> <span class="pre">-c</span> <span class="pre">&quot;import</span> <span class="pre">sys,</span> <span class="pre">pprint;</span> <span class="pre">pprint.pprint(sys.path)&quot;</span></code>
- standard configuration</li>
<li><code class="docutils literal notranslate"><span class="pre">./python</span> <span class="pre">-s</span> <span class="pre">-c</span> <span class="pre">&quot;import</span> <span class="pre">sys,</span> <span class="pre">pprint;</span> <span class="pre">pprint.pprint(sys.path)&quot;</span></code>
- user site directory disabled</li>
<li><code class="docutils literal notranslate"><span class="pre">./python</span> <span class="pre">-S</span> <span class="pre">-c</span> <span class="pre">&quot;import</span> <span class="pre">sys,</span> <span class="pre">pprint;</span> <span class="pre">pprint.pprint(sys.path)&quot;</span></code>
- all site path modifications disabled</li>
</ul>
<p>(Note: you can see similar information using <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">site</span></code> instead of <code class="docutils literal notranslate"><span class="pre">-c</span></code>,
but this is slightly misleading as it calls <code class="docutils literal notranslate"><span class="pre">os.abspath</span></code> on all of the
path entries, making relative path entries look absolute. Using the <code class="docutils literal notranslate"><span class="pre">site</span></code>
module also causes problems in the last case, as on Python versions prior to
3.3, explicitly importing site will carry out the path modifications <code class="docutils literal notranslate"><span class="pre">-S</span></code>
avoids, while on 3.3+ combining <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">site</span></code> with <code class="docutils literal notranslate"><span class="pre">-S</span></code> currently fails)</p>
<p>The calculation of <code class="docutils literal notranslate"><span class="pre">sys.path[0]</span></code> is comparatively straightforward:</p>
<ul class="simple">
<li>For an ordinary script (Python source or compiled bytecode),
<code class="docutils literal notranslate"><span class="pre">sys.path[0]</span></code> will be the directory containing the script.</li>
<li>For a valid <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> entry (typically a zipfile or directory),
<code class="docutils literal notranslate"><span class="pre">sys.path[0]</span></code> will be that path</li>
<li>For an interactive session, running from stdin or when using the <code class="docutils literal notranslate"><span class="pre">-c</span></code> or
<code class="docutils literal notranslate"><span class="pre">-m</span></code> switches, <code class="docutils literal notranslate"><span class="pre">sys.path[0]</span></code> will be the empty string, which the import
system interprets as allowing imports from the current directory</li>
</ul>
</section>
<section id="configuring-sys-argv">
<h3><a class="toc-backref" href="#configuring-sys-argv" role="doc-backlink">Configuring <code class="docutils literal notranslate"><span class="pre">sys.argv</span></code></a></h3>
<p>Unlike most other settings discussed in this PEP, <code class="docutils literal notranslate"><span class="pre">sys.argv</span></code> is not
set implicitly by <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code>. Instead, it must be set via an
explicitly call to <code class="docutils literal notranslate"><span class="pre">Py_SetArgv()</span></code>.</p>
<p>CPython calls this in <code class="docutils literal notranslate"><span class="pre">Py_Main()</span></code> after calling <code class="docutils literal notranslate"><span class="pre">Py_Initialize()</span></code>. The
calculation of <code class="docutils literal notranslate"><span class="pre">sys.argv[1:]</span></code> is straightforward: they’re the command line
arguments passed after the script name or the argument to the <code class="docutils literal notranslate"><span class="pre">-c</span></code> or
<code class="docutils literal notranslate"><span class="pre">-m</span></code> options.</p>
<p>The calculation of <code class="docutils literal notranslate"><span class="pre">sys.argv[0]</span></code> is a little more complicated:</p>
<ul class="simple">
<li>For an ordinary script (source or bytecode), it will be the script name</li>
<li>For a <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> entry (typically a zipfile or directory) it will
initially be the zipfile or directory name, but will later be changed by
the <code class="docutils literal notranslate"><span class="pre">runpy</span></code> module to the full path to the imported <code class="docutils literal notranslate"><span class="pre">__main__</span></code> module.</li>
<li>For a module specified with the <code class="docutils literal notranslate"><span class="pre">-m</span></code> switch, it will initially be the
string <code class="docutils literal notranslate"><span class="pre">&quot;-m&quot;</span></code>, but will later be changed by the <code class="docutils literal notranslate"><span class="pre">runpy</span></code> module to the
full path to the executed module.</li>
<li>For a package specified with the <code class="docutils literal notranslate"><span class="pre">-m</span></code> switch, it will initially be the
string <code class="docutils literal notranslate"><span class="pre">&quot;-m&quot;</span></code>, but will later be changed by the <code class="docutils literal notranslate"><span class="pre">runpy</span></code> module to the
full path to the executed <code class="docutils literal notranslate"><span class="pre">__main__</span></code> submodule of the package.</li>
<li>For a command executed with <code class="docutils literal notranslate"><span class="pre">-c</span></code>, it will be the string <code class="docutils literal notranslate"><span class="pre">&quot;-c&quot;</span></code></li>
<li>For explicitly requested input from stdin, it will be the string <code class="docutils literal notranslate"><span class="pre">&quot;-&quot;</span></code></li>
<li>Otherwise, it will be the empty string</li>
</ul>
<p>Embedding applications must call Py_SetArgv themselves. The CPython logic
for doing so is part of <code class="docutils literal notranslate"><span class="pre">Py_Main()</span></code> and is not exposed separately.
However, the <code class="docutils literal notranslate"><span class="pre">runpy</span></code> module does provide roughly equivalent logic in
<code class="docutils literal notranslate"><span class="pre">runpy.run_module</span></code> and <code class="docutils literal notranslate"><span class="pre">runpy.run_path</span></code>.</p>
</section>
<section id="other-configuration-settings">
<h3><a class="toc-backref" href="#other-configuration-settings" role="doc-backlink">Other configuration settings</a></h3>
<p>TBD: Cover the initialization of the following in more detail:</p>
<ul class="simple">
<li>Completely disabling the import system</li>
<li>The initial warning system state:<ul>
<li><code class="docutils literal notranslate"><span class="pre">sys.warnoptions</span></code></li>
<li>(-W option, PYTHONWARNINGS)</li>
</ul>
</li>
<li>Arbitrary extended options (e.g. to automatically enable <code class="docutils literal notranslate"><span class="pre">faulthandler</span></code>):<ul>
<li><code class="docutils literal notranslate"><span class="pre">sys._xoptions</span></code></li>
<li>(-X option)</li>
</ul>
</li>
<li>The filesystem encoding used by:<ul>
<li><code class="docutils literal notranslate"><span class="pre">sys.getfsencoding</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">os.fsencode</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">os.fsdecode</span></code></li>
</ul>
</li>
<li>The IO encoding and buffering used by:<ul>
<li><code class="docutils literal notranslate"><span class="pre">sys.stdin</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code></li>
<li>(-u option, PYTHONIOENCODING, PYTHONUNBUFFEREDIO)</li>
</ul>
</li>
<li>Whether or not to implicitly cache bytecode files:<ul>
<li><code class="docutils literal notranslate"><span class="pre">sys.dont_write_bytecode</span></code></li>
<li>(-B option, PYTHONDONTWRITEBYTECODE)</li>
</ul>
</li>
<li>Whether or not to enforce correct case in filenames on case-insensitive
platforms<ul>
<li><code class="docutils literal notranslate"><span class="pre">os.environ[&quot;PYTHONCASEOK&quot;]</span></code></li>
</ul>
</li>
<li>The other settings exposed to Python code in <code class="docutils literal notranslate"><span class="pre">sys.flags</span></code>:<ul>
<li><code class="docutils literal notranslate"><span class="pre">debug</span></code> (Enable debugging output in the pgen parser)</li>
<li><code class="docutils literal notranslate"><span class="pre">inspect</span></code> (Enter interactive interpreter after __main__ terminates)</li>
<li><code class="docutils literal notranslate"><span class="pre">interactive</span></code> (Treat stdin as a tty)</li>
<li><code class="docutils literal notranslate"><span class="pre">optimize</span></code> (__debug__ status, write .pyc or .pyo, strip doc strings)</li>
<li><code class="docutils literal notranslate"><span class="pre">no_user_site</span></code> (don’t add the user site directory to sys.path)</li>
<li><code class="docutils literal notranslate"><span class="pre">no_site</span></code> (don’t implicitly import site during startup)</li>
<li><code class="docutils literal notranslate"><span class="pre">ignore_environment</span></code> (whether environment vars are used during config)</li>
<li><code class="docutils literal notranslate"><span class="pre">verbose</span></code> (enable all sorts of random output)</li>
<li><code class="docutils literal notranslate"><span class="pre">bytes_warning</span></code> (warnings/errors for implicit str/bytes interaction)</li>
<li><code class="docutils literal notranslate"><span class="pre">quiet</span></code> (disable banner output even if verbose is also enabled or
stdin is a tty and the interpreter is launched in interactive mode)</li>
</ul>
</li>
<li>Whether or not CPython’s signal handlers should be installed</li>
</ul>
<p>Much of the configuration of CPython is currently handled through C level
global variables:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Py_BytesWarningFlag</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
<span class="n">Py_DebugFlag</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">option</span><span class="p">)</span>
<span class="n">Py_InspectFlag</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="n">PYTHONINSPECT</span><span class="p">)</span>
<span class="n">Py_InteractiveFlag</span><span class="w"> </span><span class="p">(</span><span class="n">property</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stdin</span><span class="p">,</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">overridden</span><span class="p">)</span>
<span class="n">Py_OptimizeFlag</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="n">PYTHONOPTIMIZE</span><span class="p">)</span>
<span class="n">Py_DontWriteBytecodeFlag</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">B</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="n">PYTHONDONTWRITEBYTECODE</span><span class="p">)</span>
<span class="n">Py_NoUserSiteDirectory</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="n">PYTHONNOUSERSITE</span><span class="p">)</span>
<span class="n">Py_NoSiteFlag</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">option</span><span class="p">)</span>
<span class="n">Py_UnbufferedStdioFlag</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">PYTHONUNBUFFEREDIO</span><span class="p">)</span>
<span class="n">Py_VerboseFlag</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="n">PYTHONVERBOSE</span><span class="p">)</span>
</pre></div>
</div>
<p>For the above variables, the conversion of command line options and
environment variables to C global variables is handled by <code class="docutils literal notranslate"><span class="pre">Py_Main</span></code>,
so each embedding application must set those appropriately in order to
change them from their defaults.</p>
<p>Some configuration can only be provided as OS level environment variables:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PYTHONSTARTUP</span>
<span class="n">PYTHONCASEOK</span>
<span class="n">PYTHONIOENCODING</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Py_InitializeEx()</span></code> API also accepts a boolean flag to indicate
whether or not CPython’s signal handlers should be installed.</p>
<p>Finally, some interactive behaviour (such as printing the introductory
banner) is triggered only when standard input is reported as a terminal
connection by the operating system.</p>
<p>TBD: Document how the “-x” option is handled (skips processing of the
first comment line in the main script)</p>
<p>Also see detailed sequence of operations notes at <a class="footnote-reference brackets" href="#id13" id="id12">[1]</a>.</p>
</section>
</section>
<section id="references">
<h2><a class="toc-backref" href="#references" role="doc-backlink">References</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id13" role="doc-footnote">
<dt class="label" id="id13">[1]<em> (<a href='#id6'>1</a>, <a href='#id12'>2</a>) </em></dt>
<dd>CPython interpreter initialization notes
(<a class="reference external" href="http://wiki.python.org/moin/CPythonInterpreterInitialization">http://wiki.python.org/moin/CPythonInterpreterInitialization</a>)</aside>
<aside class="footnote brackets" id="id14" role="doc-footnote">
<dt class="label" id="id14">[<a href="#id7">2</a>]</dt>
<dd>BitBucket Sandbox
(<a class="reference external" href="https://bitbucket.org/ncoghlan/cpython_sandbox/compare/pep432_modular_bootstrap..default#commits">https://bitbucket.org/ncoghlan/cpython_sandbox/compare/pep432_modular_bootstrap..default#commits</a>)</aside>
<aside class="footnote brackets" id="id15" role="doc-footnote">
<dt class="label" id="id15">[<a href="#id9">3</a>]</dt>
<dd>*nix getpath implementation
(<a class="reference external" href="http://hg.python.org/cpython/file/default/Modules/getpath.c">http://hg.python.org/cpython/file/default/Modules/getpath.c</a>)</aside>
<aside class="footnote brackets" id="id16" role="doc-footnote">
<dt class="label" id="id16">[<a href="#id10">4</a>]</dt>
<dd>Windows getpath implementation
(<a class="reference external" href="http://hg.python.org/cpython/file/default/PC/getpathp.c">http://hg.python.org/cpython/file/default/PC/getpathp.c</a>)</aside>
<aside class="footnote brackets" id="id17" role="doc-footnote">
<dt class="label" id="id17">[<a href="#id11">5</a>]</dt>
<dd>Site module documentation
(<a class="reference external" href="http://docs.python.org/3/library/site.html">http://docs.python.org/3/library/site.html</a>)</aside>
<aside class="footnote brackets" id="id18" role="doc-footnote">
<dt class="label" id="id18">[6]<em> (<a href='#id2'>1</a>, <a href='#id8'>2</a>) </em></dt>
<dd>Proposed CLI option for isolated mode
(<a class="reference external" href="http://bugs.python.org/issue16499">http://bugs.python.org/issue16499</a>)</aside>
<aside class="footnote brackets" id="id19" role="doc-footnote">
<dt class="label" id="id19">[<a href="#id3">7</a>]</dt>
<dd>Adding to sys.path on the command line
(<a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2010-October/008299.html">https://mail.python.org/pipermail/python-ideas/2010-October/008299.html</a>)
(<a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2012-September/016128.html">https://mail.python.org/pipermail/python-ideas/2012-September/016128.html</a>)</aside>
<aside class="footnote brackets" id="id20" role="doc-footnote">
<dt class="label" id="id20">[<a href="#id4">8</a>]</dt>
<dd>Control sys.path[0] initialisation
(<a class="reference external" href="http://bugs.python.org/issue13475">http://bugs.python.org/issue13475</a>)</aside>
<aside class="footnote brackets" id="id21" role="doc-footnote">
<dt class="label" id="id21">[<a href="#id5">9</a>]</dt>
<dd>Enabling code coverage in subprocesses when testing
(<a class="reference external" href="http://bugs.python.org/issue14803">http://bugs.python.org/issue14803</a>)</aside>
<aside class="footnote brackets" id="id22" role="doc-footnote">
<dt class="label" id="id22">[<a href="#id1">10</a>]</dt>
<dd>Problems with PYTHONIOENCODING in Blender
(<a class="reference external" href="http://bugs.python.org/issue16129">http://bugs.python.org/issue16129</a>)</aside>
</aside>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0432.rst">https://github.com/python/peps/blob/main/peps/pep-0432.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0432.rst">2025-02-01 08:59:27 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#pep-withdrawal">PEP Withdrawal</a></li>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a></li>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#key-concerns">Key Concerns</a><ul>
<li><a class="reference internal" href="#maintainability">Maintainability</a></li>
<li><a class="reference internal" href="#testability">Testability</a></li>
<li><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#required-configuration-settings">Required Configuration Settings</a></li>
<li><a class="reference internal" href="#implementation-strategy">Implementation Strategy</a></li>
<li><a class="reference internal" href="#design-details">Design Details</a><ul>
<li><a class="reference internal" href="#interpreter-initialization-phases">Interpreter Initialization Phases</a></li>
<li><a class="reference internal" href="#invocation-of-phases">Invocation of Phases</a></li>
<li><a class="reference internal" href="#uninitialized-state">Uninitialized State</a></li>
<li><a class="reference internal" href="#runtime-pre-initialization-phase">Runtime Pre-Initialization Phase</a></li>
<li><a class="reference internal" href="#determining-the-remaining-configuration-settings">Determining the remaining configuration settings</a></li>
<li><a class="reference internal" href="#supported-configuration-settings">Supported configuration settings</a></li>
<li><a class="reference internal" href="#completing-the-main-interpreter-initialization">Completing the main interpreter initialization</a></li>
<li><a class="reference internal" href="#preparing-the-main-module">Preparing the main module</a></li>
<li><a class="reference internal" href="#executing-the-main-module">Executing the main module</a></li>
<li><a class="reference internal" href="#internal-storage-of-configuration-data">Internal Storage of Configuration Data</a></li>
<li><a class="reference internal" href="#creating-and-configuring-subinterpreters">Creating and Configuring Subinterpreters</a></li>
<li><a class="reference internal" href="#stable-abi">Stable ABI</a></li>
<li><a class="reference internal" href="#build-time-configuration">Build time configuration</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-system-python-executable">A System Python Executable</a></li>
<li><a class="reference internal" href="#open-questions">Open Questions</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#the-status-quo-as-of-python-3-6">The Status Quo (as of Python 3.6)</a><ul>
<li><a class="reference internal" href="#ignoring-environment-variables">Ignoring Environment Variables</a></li>
<li><a class="reference internal" href="#randomised-hashing">Randomised Hashing</a></li>
<li><a class="reference internal" href="#locating-python-and-the-standard-library">Locating Python and the standard library</a></li>
<li><a class="reference internal" href="#configuring-sys-path">Configuring <code class="docutils literal notranslate"><span class="pre">sys.path</span></code></a></li>
<li><a class="reference internal" href="#configuring-sys-argv">Configuring <code class="docutils literal notranslate"><span class="pre">sys.argv</span></code></a></li>
<li><a class="reference internal" href="#other-configuration-settings">Other configuration settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0432.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>