
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 325 – Resource-Release Support for Generators | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0325/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 325 – Resource-Release Support for Generators | peps.python.org'>
    <meta property="og:description" content="Generators allow for natural coding and abstraction of traversal over data.  Currently if external resources needing proper timely release are involved, generators are unfortunately not adequate. The typical idiom for timely release is not supported, a ...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0325/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Generators allow for natural coding and abstraction of traversal over data.  Currently if external resources needing proper timely release are involved, generators are unfortunately not adequate. The typical idiom for timely release is not supported, a ...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 325</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 325 – Resource-Release Support for Generators</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Samuele Pedroni &lt;pedronis&#32;&#97;t&#32;python.org&gt;</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Formally declined and will not be accepted">Rejected</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">25-Aug-2003</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">2.4</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pronouncement">Pronouncement</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#possible-semantics">Possible Semantics</a></li>
<li><a class="reference internal" href="#remarks">Remarks</a></li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#alternative-ideas">Alternative Ideas</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Generators allow for natural coding and abstraction of traversal
over data.  Currently if external resources needing proper timely
release are involved, generators are unfortunately not adequate.
The typical idiom for timely release is not supported, a yield
statement is not allowed in the try clause of a try-finally
statement inside a generator.  The finally clause execution can be
neither guaranteed nor enforced.</p>
<p>This PEP proposes that the built-in generator type implement a
close method and destruction semantics, such that the restriction
on yield placement can be lifted, expanding the applicability of
generators.</p>
</section>
<section id="pronouncement">
<h2><a class="toc-backref" href="#pronouncement" role="doc-backlink">Pronouncement</a></h2>
<p>Rejected in favor of <a class="pep reference internal" href="../pep-0342/" title="PEP 342 – Coroutines via Enhanced Generators">PEP 342</a> which includes substantially all of
the requested behavior in a more refined form.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>Python generators allow for natural coding of many data traversal
scenarios.  Their instantiation produces iterators,
i.e. first-class objects abstracting traversal (with all the
advantages of first- classness).  In this respect they match in
power and offer some advantages over the approach using iterator
methods taking a (smalltalkish) block.  On the other hand, given
current limitations (no yield allowed in a try clause of a
try-finally inside a generator) the latter approach seems better
suited to encapsulating not only traversal but also exception
handling and proper resource acquisition and release.</p>
<p>Let’s consider an example (for simplicity, files in read-mode are
used):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">all_lines</span><span class="p">(</span><span class="n">index_path</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">file</span><span class="p">(</span><span class="n">index_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;r&quot;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">line</span>
</pre></div>
</div>
<p>this is short and to the point, but the try-finally for timely
closing of the files cannot be added.  (While instead of a path, a
file, whose closing then would be responsibility of the caller,
could be passed in as argument, the same is not applicable for the
files opened depending on the contents of the index).</p>
<p>If we want timely release, we have to sacrifice the simplicity and
directness of the generator-only approach: (e.g.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AllLines</span><span class="p">:</span>

     <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">index_path</span> <span class="o">=</span> <span class="n">index_path</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="kc">None</span>

     <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">:</span>
             <span class="k">yield</span> <span class="n">line</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="kc">None</span>

     <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>to be used as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">all_lines</span> <span class="o">=</span> <span class="n">AllLines</span><span class="p">(</span><span class="s2">&quot;index.txt&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">all_lines</span><span class="p">:</span>
        <span class="o">...</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">all_lines</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>The more convoluted solution implementing timely release, seems
to offer a precious hint.  What we have done is encapsulate our
traversal in an object (iterator) with a close method.</p>
<p>This PEP proposes that generators should grow such a close method
with such semantics that the example could be rewritten as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Today this is not valid Python: yield is not allowed between</span>
<span class="c1"># try and finally, and generator type instances support no</span>
<span class="c1"># close method.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">all_lines</span><span class="p">(</span><span class="n">index_path</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">index_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">document</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">line</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">index</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nb">all</span> <span class="o">=</span> <span class="n">all_lines</span><span class="p">(</span><span class="s2">&quot;index.txt&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">all</span><span class="p">:</span>
        <span class="o">...</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="nb">all</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close on generator</span>
</pre></div>
</div>
<p>Currently <a class="pep reference internal" href="../pep-0255/" title="PEP 255 – Simple Generators">PEP 255</a> disallows yield inside a try clause of a
try-finally statement, because the execution of the finally clause
cannot be guaranteed as required by try-finally semantics.</p>
<p>The semantics of the proposed close method should be such that
while the finally clause execution still cannot be guaranteed, it
can be enforced when required.  Specifically, the close method
behavior should trigger the execution of the finally clauses
inside the generator, either by forcing a return in the generator
frame or by throwing an exception in it.  In situations requiring
timely resource release, close could then be explicitly invoked.</p>
<p>The semantics of generator destruction on the other hand should be
extended in order to implement a best-effort policy for the
general case.  Specifically, destruction should invoke <code class="docutils literal notranslate"><span class="pre">close()</span></code>.
The best-effort limitation comes from the fact that the
destructor’s execution is not guaranteed in the first place.</p>
<p>This seems to be a reasonable compromise, the resulting global
behavior being similar to that of files and closing.</p>
</section>
<section id="possible-semantics">
<h2><a class="toc-backref" href="#possible-semantics" role="doc-backlink">Possible Semantics</a></h2>
<p>The built-in generator type should have a close method
implemented, which can then be invoked as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gen</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">gen</span></code> is an instance of the built-in generator type.
Generator destruction should also invoke close method behavior.</p>
<p>If a generator is already terminated, close should be a no-op.</p>
<p>Otherwise, there are two alternative solutions, Return or
Exception Semantics:</p>
<p>A - Return Semantics: The generator should be resumed, generator
execution should continue as if the instruction at the re-entry
point is a return.  Consequently, finally clauses surrounding the
re-entry point would be executed, in the case of a then allowed
try-yield-finally pattern.</p>
<p>Issues: is it important to be able to distinguish forced
termination by close, normal termination, exception propagation
from generator or generator-called code?  In the normal case it
seems not, finally clauses should be there to work the same in all
these cases, still this semantics could make such a distinction
hard.</p>
<p>Except-clauses, like by a normal return, are not executed, such
clauses in legacy generators expect to be executed for exceptions
raised by the generator or by code called from it.  Not executing
them in the close case seems correct.</p>
<p>B - Exception Semantics: The generator should be resumed and
execution should continue as if a special-purpose exception
(e.g. CloseGenerator) has been raised at re-entry point.  Close
implementation should consume and not propagate further this
exception.</p>
<p>Issues: should <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> be reused for this purpose?  Probably
not.  We would like close to be a harmless operation for legacy
generators, which could contain code catching <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> to
deal with other generators/iterators.</p>
<p>In general, with exception semantics, it is unclear what to do if
the generator does not terminate or we do not receive the special
exception propagated back.  Other different exceptions should
probably be propagated, but consider this possible legacy
generator code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">yield</span> <span class="o">...</span>
    <span class="o">...</span>
<span class="k">except</span><span class="p">:</span> <span class="c1"># or except Exception:, etc</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;boom&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If close is invoked with the generator suspended after the yield,
the except clause would catch our special purpose exception, so we
would get a different exception propagated back, which in this
case ought to be reasonably consumed and ignored but in general
should be propagated, but separating these scenarios seems hard.</p>
<p>The exception approach has the advantage to let the generator
distinguish between termination cases and have more control.  On
the other hand, clear-cut semantics seem harder to define.</p>
</section>
<section id="remarks">
<h2><a class="toc-backref" href="#remarks" role="doc-backlink">Remarks</a></h2>
<p>If this proposal is accepted, it should become common practice to
document whether a generator acquires resources, so that its close
method ought to be called.  If a generator is no longer used,
calling close should be harmless.</p>
<p>On the other hand, in the typical scenario the code that
instantiated the generator should call close if required by it.
Generic code dealing with iterators/generators instantiated
elsewhere should typically not be littered with close calls.</p>
<p>The rare case of code that has acquired ownership of and need to
properly deal with all of iterators, generators and generators
acquiring resources that need timely release, is easily solved:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
    <span class="n">iterator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="open-issues">
<h2><a class="toc-backref" href="#open-issues" role="doc-backlink">Open Issues</a></h2>
<p>Definitive semantics ought to be chosen.  Currently Guido favors
Exception Semantics.  If the generator yields a value instead of
terminating, or propagating back the special exception, a special
exception should be raised again on the generator side.</p>
<p>It is still unclear whether spuriously converted special
exceptions (as discussed in Possible Semantics) are a problem and
what to do about them.</p>
<p>Implementation issues should be explored.</p>
</section>
<section id="alternative-ideas">
<h2><a class="toc-backref" href="#alternative-ideas" role="doc-backlink">Alternative Ideas</a></h2>
<p>The idea that the yield placement limitation should be removed and
that generator destruction should trigger execution of finally
clauses has been proposed more than once.  Alone it cannot
guarantee that timely release of resources acquired by a generator
can be enforced.</p>
<p><a class="pep reference internal" href="../pep-0288/" title="PEP 288 – Generators Attributes and Exceptions">PEP 288</a> proposes a more general solution, allowing custom
exception passing to generators.  The proposal in this PEP
addresses more directly the problem of resource release.  Were
<a class="pep reference internal" href="../pep-0288/" title="PEP 288 – Generators Attributes and Exceptions">PEP 288</a> implemented, Exceptions Semantics for close could be layered
on top of it, on the other hand <a class="pep reference internal" href="../pep-0288/" title="PEP 288 – Generators Attributes and Exceptions">PEP 288</a> should make a separate
case for the more general functionality.</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0325.rst">https://github.com/python/peps/blob/main/peps/pep-0325.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0325.rst">2025-02-01 08:59:27 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pronouncement">Pronouncement</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#possible-semantics">Possible Semantics</a></li>
<li><a class="reference internal" href="#remarks">Remarks</a></li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#alternative-ideas">Alternative Ideas</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0325.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
</body>
</html>