
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 787 – Safer subprocess usage using t-strings | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0787/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 787 – Safer subprocess usage using t-strings | peps.python.org'>
    <meta property="og:description" content="PEP 750 introduced template strings (t-strings) as a generalization of f-strings, providing a way to safely handle string interpolation in various contexts. This PEP proposes extending the subprocess and shlex modules to natively support t-strings, enab...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0787/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="PEP 750 introduced template strings (t-strings) as a generalization of f-strings, providing a way to safely handle string interpolation in various contexts. This PEP proposes extending the subprocess and shlex modules to natively support t-strings, enab...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 787</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 787 – Safer subprocess usage using t-strings</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Nick Humrich &lt;nick&#32;&#97;t&#32;humrich.us&gt;, Alyssa Coghlan &lt;ncoghlan&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Discussions-To<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/pep-787-safer-subprocess-usage-using-t-strings/88311">Discourse thread</a></dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Inactive draft that may be taken up again at a later time">Deferred</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-odd">Requires<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="../pep-0750/">750</a></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">13-Apr-2025</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.15</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/pep-787-safer-subprocess-usage-using-t-strings/88311" title="Discourse thread">14-Apr-2025</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pep-deferral">PEP Deferral</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#renderer-for-shell-escaping-added-to-shlex">Renderer for shell escaping added to <a class="reference external" href="https://docs.python.org/3/library/shlex.html#module-shlex" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shlex</span></code></a></a></li>
<li><a class="reference internal" href="#changes-to-subprocess-module">Changes to subprocess module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a><ul>
<li><a class="reference internal" href="#deferring-escaped-rendering-support-for-non-posix-shells">Deferring escaped rendering support for non-POSIX shells</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p><a class="pep reference internal" href="../pep-0750/" title="PEP 750 – Template Strings">PEP 750</a> introduced template strings (t-strings) as a generalization of f-strings,
providing a way to safely handle string interpolation in various contexts. This PEP
proposes extending the <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> and <a class="reference external" href="https://docs.python.org/3/library/shlex.html#module-shlex" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shlex</span></code></a> modules to natively support t-strings, enabling
safer and more ergonomic shell command execution with interpolated values, as well as
serving as a reference implementation for the t-string feature to improve API ergonomics.</p>
</section>
<section id="pep-deferral">
<h2><a class="toc-backref" href="#pep-deferral" role="doc-backlink">PEP Deferral</a></h2>
<p>During the discussions of the initial draft of the PEP, it became clear that t-strings provide
a potential opportunity to offer <code class="docutils literal notranslate"><span class="pre">shell=True</span></code> levels of syntactic convenience for complex
subprocess invocations without all of the security and cross-platform compatibility concerns
that arise with giving user provided text access to a full system shell.</p>
<p>To that end, the PEP authors now plan to work on an experimental <a class="extlink-pypi reference external" href="https://pypi.org/project/tstrprocess/">t-string
based subprocess invocation library</a> through the Python 3.14 beta
period (and beyond), before preparing a revised draft of the proposal for Python 3.15.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>Despite the safety benefits and flexibility that template strings offer in PEP 750,
they lack a concrete consumer implementation in the standard library that demonstrates
their practical application. One of the most compelling use cases for t-strings is safer
shell command execution, as noted in the withdrawn <a class="pep reference internal" href="../pep-0501/" title="PEP 501 – General purpose template literal strings">PEP 501</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Unsafe with f-strings:</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="n">message_from_user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Also unsafe with f-strings</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="n">message_from_user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Fails with f-strings</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="n">message_from_user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Safe with t-strings and POSIX-compliant shell quoting:</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;echo </span><span class="si">{message_from_user}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Safe on all platforms with t-strings:</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;echo </span><span class="si">{message_from_user}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Safe on all platforms without t-strings:</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message_from_user</span><span class="p">)])</span>
</pre></div>
</div>
<p>Currently, developers must choose between convenience (using f-strings with potential
security risks) and safety (using more verbose, list-based APIs). By adding native t-string
support to the <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> module, we provide a consumer reference implementation that
demonstrates the value of t-strings while addressing a common security concern.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>The subprocess module is an ideal candidate for t-string support for several reasons:</p>
<ul class="simple">
<li>Command injection vulnerabilities in shell commands are a well-known security risk.</li>
<li>The <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> module already supports both string and list-based command specifications.</li>
<li>There’s a natural mapping between t-strings and proper shell escaping that provides both convenience and safety.</li>
<li>It serves as a practical showcase for t-strings that developers can immediately understand and appreciate.</li>
</ul>
<p>By extending subprocess to handle t-strings natively, we make it easier to write secure code without sacrificing
the convenience that led many developers to use potentially unsafe f-strings.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>This PEP proposes two main additions to the standard library:</p>
<ol class="arabic simple">
<li>A new <code class="docutils literal notranslate"><span class="pre">sh()</span></code> renderer function in the <a class="reference external" href="https://docs.python.org/3/library/shlex.html#module-shlex" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shlex</span></code></a> module for safe shell command construction</li>
<li><dl class="simple">
<dt>Adding t-string support to the <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> module’s core functions,</dt><dd>particularly <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">subprocess.Popen</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.run" title="(in Python v3.14)"><code class="xref py py-func docutils literal notranslate"><span class="pre">subprocess.run()</span></code></a>, and other related functions
that accept a command argument</dd>
</dl>
</li>
</ol>
<section id="renderer-for-shell-escaping-added-to-shlex">
<h3><a class="toc-backref" href="#renderer-for-shell-escaping-added-to-shlex" role="doc-backlink">Renderer for shell escaping added to <a class="reference external" href="https://docs.python.org/3/library/shlex.html#module-shlex" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shlex</span></code></a></a></h3>
<p>As a reference implementation, a renderer for safe POSIX shell escaping will be added to
the <a class="reference external" href="https://docs.python.org/3/library/shlex.html#module-shlex" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shlex</span></code></a> module. This renderer would be called <code class="docutils literal notranslate"><span class="pre">sh</span></code> and would be equivalent to
calling <code class="docutils literal notranslate"><span class="pre">shlex.quote</span></code> on each field value in the template literal.</p>
<p>Thus:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{myfile}</span><span class="s2">&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>would have the same behavior as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;cat &quot;</span> <span class="o">+</span> <span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">myfile</span><span class="p">)))</span>
</pre></div>
</div>
<p>The addition of <code class="docutils literal notranslate"><span class="pre">shlex.sh</span></code> will NOT change the existing admonishments in the
<a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> documentation that passing <code class="docutils literal notranslate"><span class="pre">shell=True</span></code> is best avoided, nor the
reference from the <a class="reference external" href="https://docs.python.org/3/library/os.html#os.system" title="(in Python v3.14)"><code class="xref py py-func docutils literal notranslate"><span class="pre">os.system()</span></code></a> documentation to the higher level <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> APIs.</p>
<p>The t-string processor implementation would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">string.templatelib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span><span class="p">,</span> <span class="n">Interpolation</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sh</span><span class="p">(</span><span class="n">template</span><span class="p">:</span> <span class="n">Template</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Interpolation</span><span class="p">):</span>
            <span class="c1"># shlex.sh implementation, so shlex.quote can be used directly</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="c1"># shlex.sh implementation, so `join` references shlex.join</span>
    <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</pre></div>
</div>
<p>This allows for explicit escaping of t-strings for shell usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
<span class="c1"># Safe POSIX-compliant shell command construction</span>
<span class="n">command</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{filename}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="changes-to-subprocess-module">
<h3><a class="toc-backref" href="#changes-to-subprocess-module" role="doc-backlink">Changes to subprocess module</a></h3>
<p>With the additional renderer in the shlex module, and the addition of template strings,
the <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.14)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> module can be changed to handle accepting template strings
as an additional input type to <code class="docutils literal notranslate"><span class="pre">Popen</span></code>, as it already accepts a sequence, or a string,
with different behavior for each. In return, all <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">subprocess.Popen</span></code></a> higher level
functions such as <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.run" title="(in Python v3.14)"><code class="xref py py-func docutils literal notranslate"><span class="pre">subprocess.run()</span></code></a> could accept strings in a safe way
(on all systems for <code class="docutils literal notranslate"><span class="pre">shell=False</span></code> and on <a class="reference internal" href="#pep-0787-defer-non-posix-shells"><span class="std std-ref">POSIX systems</span></a> for <code class="docutils literal notranslate"><span class="pre">shell=True</span></code>).</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{myfile}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>would automatically use the <code class="docutils literal notranslate"><span class="pre">shlex.sh</span></code> renderer provided in this PEP. Therefore, using
<code class="docutils literal notranslate"><span class="pre">shlex</span></code> inside a <code class="docutils literal notranslate"><span class="pre">subprocess.run</span></code> call like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{myfile}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>would be redundant, as <code class="docutils literal notranslate"><span class="pre">run</span></code> would automatically render any template literals
through <code class="docutils literal notranslate"><span class="pre">shlex.sh</span></code></p>
<p>When <code class="docutils literal notranslate"><span class="pre">subprocess.Popen</span></code> is called without <code class="docutils literal notranslate"><span class="pre">shell=True</span></code>, t-string support would still
provide subprocess with a more ergonomic syntax. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{myfile}</span><span class="s2"> --flag </span><span class="si">{value}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>would be equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="n">myfile</span><span class="p">,</span> <span class="s2">&quot;--flag&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
</pre></div>
</div>
<p>or, more accurately:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cat </span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">myfile</span><span class="p">)</span><span class="si">}</span><span class="s2"> --flag </span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>It would do this by first using the <code class="docutils literal notranslate"><span class="pre">shlex.sh</span></code> renderer, as above, then using
<code class="docutils literal notranslate"><span class="pre">shlex.split</span></code> on the result.</p>
<p>The implementation inside <code class="docutils literal notranslate"><span class="pre">subprocess.Popen._execute_child</span></code> would check for t-strings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">string.templatelib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">Template</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
    <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>This change is fully backwards compatible as it only adds new functionality without altering existing behavior.
The subprocess module will continue to handle strings and lists in the same way it currently does.</p>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications" role="doc-backlink">Security Implications</a></h2>
<p>This PEP is explicitly designed to improve security by providing a safer alternative to using
f-strings with shell commands. By automatically applying appropriate escaping based on context
(shell or non-shell), it helps prevent command injection vulnerabilities.</p>
<p>However, it’s worth noting that when <code class="docutils literal notranslate"><span class="pre">shell=True</span></code> is used, the safety is limited to
POSIX-compliant shells. On Windows systems where cmd.exe or PowerShell may be used as the shell,
the escaping mechanism provided by <a class="reference external" href="https://docs.python.org/3/library/shlex.html#shlex.quote" title="(in Python v3.14)"><code class="xref py py-func docutils literal notranslate"><span class="pre">shlex.quote()</span></code></a> is not sufficient to prevent all forms
of command injection.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>This feature can be taught as a natural extension of t-strings that demonstrates their practical value:</p>
<ol class="arabic">
<li>Introduce the problem of command injection and why f-strings are dangerous with shell commands</li>
<li>Show the traditional solutions (list-based commands, manual escaping)</li>
<li>Introduce the <code class="docutils literal notranslate"><span class="pre">shlex.sh</span></code> renderer for explicit shell escaping:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Unsafe:</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cat </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Potential command injection!</span>

<span class="c1"># Safe using shlex.sh:</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{filename}</span><span class="s2">&quot;</span><span class="p">))</span>  <span class="c1"># Explicitly escaping for shell</span>
</pre></div>
</div>
</li>
<li>Introduce the subprocess module’s native t-string support:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Unsafe:</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cat </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Potential command injection!</span>

<span class="c1"># Safe but verbose:</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">])</span>

<span class="c1"># Safe and readable with t-strings:</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{filename}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Automatically escapes filename</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{filename}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Automatically converts to list form</span>
</pre></div>
</div>
</li>
</ol>
<p>The implementation should be added to both the shlex and subprocess module documentation with clear
examples and security advisories.</p>
<section id="deferring-escaped-rendering-support-for-non-posix-shells">
<span id="pep-0787-defer-non-posix-shells"></span><h3><a class="toc-backref" href="#deferring-escaped-rendering-support-for-non-posix-shells" role="doc-backlink">Deferring escaped rendering support for non-POSIX shells</a></h3>
<p><a class="reference external" href="https://docs.python.org/3/library/shlex.html#shlex.quote" title="(in Python v3.14)"><code class="xref py py-func docutils literal notranslate"><span class="pre">shlex.quote()</span></code></a> works by classifying the regex character set <code class="docutils literal notranslate"><span class="pre">[\w&#64;%+=:,./-]</span></code> to be
safe, deeming all other characters to be unsafe, and hence requiring quoting of the string
containing them. The quoting mechanism used is then specific to the way that string quoting
works in POSIX shells, so it cannot be trusted when running a shell that doesn’t follow
POSIX shell string quoting rules.</p>
<p>For example, running <code class="docutils literal notranslate"><span class="pre">subprocess.run(f&quot;echo</span> <span class="pre">{shlex.quote(sys.argv[1])}&quot;,</span> <span class="pre">shell=True)</span></code> is
safe when using a shell that follows POSIX quoting rules:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&gt;<span class="w"> </span>run_quoted.py
<span class="go">import sys, shlex, subprocess</span>
<span class="go">subprocess.run(f&quot;echo {shlex.quote(sys.argv[1])}&quot;, shell=True)</span>
<span class="gp">$ </span>python3<span class="w"> </span>run_quoted.py<span class="w"> </span><span class="nb">pwd</span>
<span class="go">pwd</span>
<span class="gp">$ </span>python3<span class="w"> </span>run_quoted.py<span class="w"> </span><span class="s1">&#39;; pwd&#39;</span>
<span class="go">; pwd</span>
<span class="gp">$ </span>python3<span class="w"> </span>run_quoted.py<span class="w"> </span><span class="s2">&quot;&#39;pwd&#39;&quot;</span>
<span class="go">&#39;pwd&#39;</span>
</pre></div>
</div>
<p>but remains unsafe when running a shell from Python invokes <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> (or Powershell):</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">S</span><span class="p">:\&gt;</span> <span class="nb">echo </span><span class="n">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">shlex</span><span class="p">,</span> <span class="n">subprocess</span> <span class="p">&gt;</span> <span class="n">run_quoted</span><span class="p">.</span><span class="n">py</span>
<span class="n">S</span><span class="p">:\&gt;</span> <span class="nb">echo </span><span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;echo {shlex.quote(sys.argv[1])}&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="p">=</span><span class="n">True</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">run_quoted</span><span class="p">.</span><span class="n">py</span>
<span class="n">S</span><span class="p">:\&gt;</span> <span class="nb">type </span><span class="n">run_quoted</span><span class="p">.</span><span class="n">py</span>
<span class="n">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">shlex</span><span class="p">,</span> <span class="n">subprocess</span>
<span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;echo {shlex.quote(sys.argv[1])}&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="p">=</span><span class="n">True</span><span class="p">)</span>
<span class="n">S</span><span class="p">:\&gt;</span> <span class="n">python3</span> <span class="n">run_quoted</span><span class="p">.</span><span class="n">py</span> <span class="s2">&quot;echo OK&quot;</span>
<span class="s1">&#39;echo OK&#39;</span>
<span class="n">S</span><span class="p">:\&gt;</span> <span class="n">python3</span> <span class="n">run_quoted</span><span class="p">.</span><span class="n">py</span> <span class="s2">&quot;&#39;&amp; echo Oh no!&quot;</span>
<span class="s1">&#39;&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;</span>
<span class="s1">Oh no!&#39;</span>
</pre></div>
</div>
<p>Resolving this standard library limitation is beyond the scope of this PEP.</p>
</section>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0787.rst">https://github.com/python/peps/blob/main/peps/pep-0787.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0787.rst">2025-04-27 15:17:24 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pep-deferral">PEP Deferral</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#renderer-for-shell-escaping-added-to-shlex">Renderer for shell escaping added to <code class="xref py py-mod docutils literal notranslate"><span class="pre">shlex</span></code></a></li>
<li><a class="reference internal" href="#changes-to-subprocess-module">Changes to subprocess module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a><ul>
<li><a class="reference internal" href="#deferring-escaped-rendering-support-for-non-posix-shells">Deferring escaped rendering support for non-POSIX shells</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0787.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
</body>
</html>