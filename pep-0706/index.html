
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 706 – Filter for tarfile.extractall | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0706/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 706 – Filter for tarfile.extractall | peps.python.org'>
    <meta property="og:description" content="The extraction methods in tarfile gain a filter argument, which allows rejecting files or modifying metadata as the archive is extracted. Three built-in named filters are provided, aimed at limiting features that might be surprising or dangerous. These ...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0706/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="The extraction methods in tarfile gain a filter argument, which allows rejecting files or modifying metadata as the archive is extracted. Three built-in named filters are provided, aimed at limiting features that might be surprising or dangerous. These ...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1 data-pagefind-ignore>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 706</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        
        <div id="mobile-search" class="mobile-search-container"></div>
        
        <article data-pagefind-body>
            
            <span data-pagefind-meta="title:PEP 706 – Filter for tarfile.extractall" data-pagefind-weight="10" class="visually-hidden">PEP 706 – Filter for tarfile.extractall</span>
            <section id="pep-content">
<h1 class="page-title">PEP 706 – Filter for tarfile.extractall</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Petr Viktorin &lt;encukou&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Discussions-To<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/23903">Discourse thread</a></dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Accepted and implementation complete, or no longer active">Final</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-odd">Created<span class="colon">:</span></dt>
<dd class="field-odd">09-Feb-2023</dd>
<dt class="field-even">Python-Version<span class="colon">:</span></dt>
<dd class="field-even">3.12</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/23149" title="Discourse thread">25-Jan-2023</a>,
<a class="reference external" href="https://discuss.python.org/t/23903" title="Discourse thread">15-Feb-2023</a></dd>
<dt class="field-even">Resolution<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/23903/10">Discourse message</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#setting-a-precedent">Setting a precedent</a></li>
<li><a class="reference internal" href="#full-disclosure-redistributor-info">Full disclosure &amp; redistributor info</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#modifying-and-forgetting-member-metadata">Modifying and forgetting member metadata</a></li>
<li><a class="reference internal" href="#filters">Filters</a></li>
<li><a class="reference internal" href="#defaults-and-their-configuration">Defaults and their configuration</a></li>
<li><a class="reference internal" href="#filtererror">FilterError</a></li>
<li><a class="reference internal" href="#errorlevel-and-fatal-non-fatal-errors">Errorlevel, and fatal/non-fatal errors</a></li>
<li><a class="reference internal" href="#hints-for-further-verification">Hints for further verification</a></li>
<li><a class="reference internal" href="#tarinfo-identity-and-offset">TarInfo identity, and <code class="docutils literal notranslate"><span class="pre">offset</span></code></a></li>
<li><a class="reference internal" href="#tarfile-cli">tarfile CLI</a></li>
<li><a class="reference internal" href="#other-archive-libraries">Other archive libraries</a></li>
<li><a class="reference internal" href="#shutil">Shutil</a></li>
<li><a class="reference internal" href="#complex-filters">Complex filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#backporting-forward-compatibility">Backporting &amp; Forward Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#safetarfile">SafeTarFile</a></li>
<li><a class="reference internal" href="#add-absolute-path-option-to-tarfile">Add absolute_path option to tarfile</a></li>
<li><a class="reference internal" href="#other-names-for-the-tar-filter">Other names for the <code class="docutils literal notranslate"><span class="pre">'tar'</span></code> filter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#possible-further-work">Possible Further Work</a><ul>
<li><a class="reference internal" href="#adding-filters-to-zipfile-and-shutil-unpack-archive">Adding filters to zipfile and shutil.unpack_archive</a></li>
</ul>
</li>
<li><a class="reference internal" href="#thanks">Thanks</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<div class="pep-banner canonical-doc sticky-banner admonition important">
<p class="admonition-title">Important</p>
<p>This PEP is a historical document. The up-to-date, canonical documentation can now be found at <a class="reference external" href="https://docs.python.org/3/library/tarfile.html#tarfile-extraction-filter" title="(in Python v3.14)"><span class="xref std std-ref">tarfile documentation</span></a>.</p>
<p class="close-button">×</p>
<p>See <a class="pep reference internal" href="../pep-0001/" title="PEP 1 – PEP Purpose and Guidelines">PEP 1</a> for how to propose changes.</p>
</div>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>The extraction methods in <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#module-tarfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tarfile</span></code></a> gain a <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument,
which allows rejecting files or modifying metadata as the archive is extracted.
Three built-in named filters are provided, aimed at limiting features that
might be surprising or dangerous.
These can be used as-is, or serve as a base for custom filters.</p>
<p>After a deprecation period, a strict (but safer) filter will become the default.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tar</span></code> format is used for several use cases, many of which have different
needs. For example:</p>
<ul class="simple">
<li>A backup of a UNIX workstation should faithfully preserve all kinds of
details like file permissions, symlinks to system configuration, and various
kinds of special files.</li>
<li>When unpacking a data bundle, it’s much more important that the unpacking
will not have unintended consequences – like exposing a password file by
symlinking it to a public place.</li>
</ul>
<p>To support all its use cases, the <code class="docutils literal notranslate"><span class="pre">tar</span></code> format has many features.
In many cases, it’s best to ignore or disallow some of them when extracting
an archive.</p>
<p>Python allows extracting <code class="docutils literal notranslate"><span class="pre">tar</span></code> archives using
<a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.extractall" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">tarfile.TarFile.extractall()</span></code></a>, whose docs warn to
<em>never extract archives from untrusted sources without prior inspection</em>.
However, it’s not clear what kind of inspection should be done.
Indeed, it’s quite tricky to do such an inspection correctly.
As a result, many people don’t bother, or do the check incorrectly, resulting in
security issues such as <a class="reference external" href="https://nvd.nist.gov/vuln/detail/CVE-2007-4559">CVE-2007-4559</a>.</p>
<p>Since <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#module-tarfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tarfile</span></code></a> was first written, it’s become more
accepted that warnings in documentation are not enough.
Whenever possible, an unsafe operation should be <em>explicitly requested</em>;
potentially dangerous operations should <em>look</em> dangerous.
However, <code class="docutils literal notranslate"><span class="pre">TarFile.extractall</span></code> looks benign in a code review.</p>
<p>Tarfile extraction is also exposed via <a class="reference external" href="https://docs.python.org/3.11/library/shutil.html#shutil.unpack_archive" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">shutil.unpack_archive()</span></code></a>,
which allows the user to not care about the kind of archive they’re
dealing with.
The API is very inviting for extracting archives without prior inspection,
even though the docs again warn against it.</p>
<p>It has been argued that Python is not wrong – it behaves exactly as
documented – but that’s beside the point.
Let’s improve the situation rather than assign/avoid blame.
Python and its docs are the best place to improve things.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>How do we improve things?
Unfortunately, we will need to change the defaults, which implies
breaking backwards compatibility. <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.extractall" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TarFile.extractall</span></code></a>
is what people reach for when they need to extract a tarball.
Its default behaviour needs to change.</p>
<p>What would be the best behaviour? That depends on the use case.
So, we’ll add several general “policies” to control extraction.
They are based on <em>use cases</em>, and ideally they should have straightforward
security implications:</p>
<ul class="simple">
<li>Current behavior: trusting the archive. Suitable e.g. as a building block
for libraries that do the check themselves, or extracting an archive you just
made yourself.</li>
<li>Unpacking a UNIX archive: roughly following GNU <code class="docutils literal notranslate"><span class="pre">tar</span></code>, e.g. stripping
leading <code class="docutils literal notranslate"><span class="pre">/</span></code> from filenames.</li>
<li>Unpacking a general data archive: the <a class="reference external" href="https://docs.python.org/3.11/library/shutil.html#shutil.unpack_archive" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">shutil.unpack_archive()</span></code></a>
use case,
where it’s not important to preserve details specific to <code class="docutils literal notranslate"><span class="pre">tar</span></code> or
Unix-like filesystems.</li>
</ul>
<p>After a deprecation period, the last option – the most limited
but most secure one – will become the default.</p>
<p>Even with better general defaults, users should still verify the archives
they extract, and perhaps modify some of the metadata.
Superficially, the following looks like a reasonable way to do this today:</p>
<ul class="simple">
<li>Call <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.getmembers" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TarFile.getmembers</span></code></a></li>
<li>Verify or modify each member’s <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarInfo" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TarInfo</span></code></a></li>
<li>Pass the result to <code class="docutils literal notranslate"><span class="pre">extractall</span></code>’s <code class="docutils literal notranslate"><span class="pre">members</span></code></li>
</ul>
<p>However, there are some issues with this approach:</p>
<ul class="simple">
<li>It’s possible to modify <code class="docutils literal notranslate"><span class="pre">TarInfo</span></code> objects, but the changes to them
affect all subsequent operations on the same <code class="docutils literal notranslate"><span class="pre">TarFile</span></code> object.
This behavior is fine for most uses, but despite that, it would be very
surprising if <code class="docutils literal notranslate"><span class="pre">TarFile.extractall</span></code> did this by default.</li>
<li>Calling <code class="docutils literal notranslate"><span class="pre">getmembers</span></code> can be expensive and it
<a class="reference external" href="https://github.com/python/cpython/issues/45385#issuecomment-1255615199">requires a seekable archive</a>.</li>
<li>When verifying members in advance, it may be necessary to track how each
member would have changed the filesystem, e.g. how symlinks are being set up.
This is hard. We can’t expect users to do it.</li>
</ul>
<p>To solve these issues we’ll:</p>
<ul class="simple">
<li>Provide a supported way to “clone” and modify <code class="docutils literal notranslate"><span class="pre">TarInfo</span></code> objects.
A <code class="docutils literal notranslate"><span class="pre">replace</span></code> method, similar to <a class="reference external" href="https://docs.python.org/3.11/library/dataclasses.html#dataclasses.replace" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">dataclasses.replace()</span></code></a>
or <a class="reference external" href="https://docs.python.org/3.11/library/collections.html#collections.somenamedtuple._replace" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">namedtuple._replace</span></code></a>
should do the trick.</li>
<li>Provide a “filter” hook in <code class="docutils literal notranslate"><span class="pre">extractall</span></code>’s loop that can modify or discard
members before they are processed.</li>
<li>Require that this hook is called just before extracting each member,
so it can scan the <em>current</em> state of the disk. This will greatly simplify
the implementation of policies (both in stdlib and user code),
at the cost of not being able to do a precise “dry run”.</li>
</ul>
<p>The hook API will be very similar to the existing <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument
for <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.add" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TarFile.add</span></code></a>.
We’ll also name it <code class="docutils literal notranslate"><span class="pre">filter</span></code>.
(In some cases “policy” would be a more fitting name,
but the API can be used for more than security policies.)</p>
<p>The built-in policies/filters described above will be implemented using the
public filter API, so they can be used as building blocks or examples.</p>
<section id="setting-a-precedent">
<h3><a class="toc-backref" href="#setting-a-precedent" role="doc-backlink">Setting a precedent</a></h3>
<p>If and when other libraries for archive extraction, such as <a class="reference external" href="https://docs.python.org/3.11/library/zipfile.html#module-zipfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">zipfile</span></code></a>,
gain similar functionality, they should mimic this API as much as it’s
reasonable.</p>
<p>To enable this for simple cases, the built-in filters will have string names;
e.g. users can pass <code class="docutils literal notranslate"><span class="pre">filter='data'</span></code> instead of a specific function that deals
with <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarInfo" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TarInfo</span></code></a> objects.</p>
<p>The <a class="reference external" href="https://docs.python.org/3.11/library/shutil.html#shutil.unpack_archive" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">shutil.unpack_archive()</span></code></a> function will get a
<code class="docutils literal notranslate"><span class="pre">filter</span></code> argument, which it will pass to <code class="docutils literal notranslate"><span class="pre">extractall</span></code>.</p>
<p>Adding function-based API that would work across archive formats is
out of scope of this PEP.</p>
</section>
<section id="full-disclosure-redistributor-info">
<h3><a class="toc-backref" href="#full-disclosure-redistributor-info" role="doc-backlink">Full disclosure &amp; redistributor info</a></h3>
<p>The PEP author works for Red Hat, a redistributor of Python with different
security needs and support periods than CPython in general.
Such redistributors may want to carry vendor patches to:</p>
<ul class="simple">
<li>Allow configuring the defaults system-wide, and</li>
<li>Change the default as soon as possible, even in older Python versions.</li>
</ul>
<p>The proposal makes this easy to do, and it allows users to query
the settings.</p>
</section>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<section id="modifying-and-forgetting-member-metadata">
<h3><a class="toc-backref" href="#modifying-and-forgetting-member-metadata" role="doc-backlink">Modifying and forgetting member metadata</a></h3>
<p>The <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarInfo" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TarInfo</span></code></a> class will gain a new method,
<code class="docutils literal notranslate"><span class="pre">replace()</span></code>, which will work similarly to <code class="docutils literal notranslate"><span class="pre">dataclasses.replace</span></code>.
It will return a copy of the <code class="docutils literal notranslate"><span class="pre">TarInfo</span></code> object with attributes
replaced as specified by keyword-only arguments:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">name</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mtime</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mode</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">linkname</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">uid</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">gid</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">uname</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">gname</span></code></li>
</ul>
<p>Any of these, except <code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">linkname</span></code>, will be allowed to be set
to <code class="docutils literal notranslate"><span class="pre">None</span></code>.
When <code class="docutils literal notranslate"><span class="pre">extract</span></code> or <code class="docutils literal notranslate"><span class="pre">extractall</span></code> encounters such a <code class="docutils literal notranslate"><span class="pre">None</span></code>, it will not
set that piece of metadata.
(If <code class="docutils literal notranslate"><span class="pre">uname</span></code> or <code class="docutils literal notranslate"><span class="pre">gname</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>, it will fall back to <code class="docutils literal notranslate"><span class="pre">uid</span></code> or <code class="docutils literal notranslate"><span class="pre">gid</span></code>
as if the name wasn’t found.)
When <code class="docutils literal notranslate"><span class="pre">addfile</span></code> or <code class="docutils literal notranslate"><span class="pre">tobuf</span></code> encounters such a <code class="docutils literal notranslate"><span class="pre">None</span></code>, it will raise a
<code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.
When <code class="docutils literal notranslate"><span class="pre">list</span></code> encounters such a <code class="docutils literal notranslate"><span class="pre">None</span></code>, it will print a placeholder string.</p>
<p>The documentation will mention why the method is there:
<code class="docutils literal notranslate"><span class="pre">TarInfo</span></code> objects retrieved from <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.getmembers" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TarFile.getmembers</span></code></a>
are “live”; modifying them directly will affect subsequent unrelated
operations.</p>
</section>
<section id="filters">
<h3><a class="toc-backref" href="#filters" role="doc-backlink">Filters</a></h3>
<p><a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.extract" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TarFile.extract</span></code></a> and
<a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.extractall" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TarFile.extractall</span></code></a> methods
will grow a <code class="docutils literal notranslate"><span class="pre">filter</span></code> keyword-only parameter,
which takes a callable that can be called as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">filter</span><span class="p">(</span><span class="o">/</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="n">TarInfo</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TarInfo</span><span class="o">|</span><span class="kc">None</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">member</span></code> is the member to be extracted, and <code class="docutils literal notranslate"><span class="pre">path</span></code> is the path to
where the archive is extracted (i.e., it’ll be the same for every member).</p>
<p>When used it will be called on each member as it is extracted,
and extraction will work with the result.
If it returns <code class="docutils literal notranslate"><span class="pre">None</span></code>, the member will be skipped.</p>
<p>The function can also raise an exception.
This can, depending on <code class="docutils literal notranslate"><span class="pre">TarFile.errorlevel</span></code>,
abort the extraction or cause the member to be skipped.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If extraction is aborted, the archive may be left partially
extracted. It is the user’s responsibility to clean up.</p>
</div>
<p>We will also provide a set of defaults for common use cases.
In addition to a function, the <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument can be one
of the following strings:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code>: Current behavior: honor the metadata as is.
Should be used if the user trusts the archive completely, or implements their
own complex verification.</li>
<li><code class="docutils literal notranslate"><span class="pre">'tar'</span></code>: Roughly follow defaults of the GNU <code class="docutils literal notranslate"><span class="pre">tar</span></code> command
(when run as a normal user):<ul>
<li>Strip leading <code class="docutils literal notranslate"><span class="pre">'/'</span></code> and <code class="docutils literal notranslate"><span class="pre">os.sep</span></code> from filenames</li>
<li>Refuse to extract files with absolute paths (after the <code class="docutils literal notranslate"><span class="pre">/</span></code> stripping
above, e.g. <code class="docutils literal notranslate"><span class="pre">C:/foo</span></code> on Windows).</li>
<li>Refuse to extract files whose absolute path (after following symlinks)
would end up outside the destination.
(Note that GNU <code class="docutils literal notranslate"><span class="pre">tar</span></code> instead delays creating some links.)</li>
<li>Clear high mode bits (setuid, setgid, sticky) and group/other write bits
(<a class="reference external" href="https://docs.python.org/3.11/library/stat.html#stat.S_IWGRP" title="(in Python v3.11)"><code class="xref py py-data docutils literal notranslate"><span class="pre">S_IWGRP|S_IWOTH</span></code></a>).
(This is an approximation of GNU <code class="docutils literal notranslate"><span class="pre">tar</span></code>’s default, which limits the mode
by the current <code class="docutils literal notranslate"><span class="pre">umask</span></code> setting.)</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">'data'</span></code>:  Extract a “data” archive, disallowing common attack vectors
but limiting functionality.
In particular, many features specific to UNIX-style filesystems (or
equivalently, to the <code class="docutils literal notranslate"><span class="pre">tar</span></code> archive format) are ignored, making this a good
filter for cross-platform archives.
In addition to <code class="docutils literal notranslate"><span class="pre">tar</span></code>:<ul>
<li>Refuse to extract links (hard or soft) that link to absolute paths.</li>
<li>Refuse to extract links (hard or soft) which end up linking to a path
outside of the destination.
(On systems that don’t support links, <code class="docutils literal notranslate"><span class="pre">tarfile</span></code> will, in most cases,
fall back to creating regular files.
This proposal doesn’t change that behaviour.)</li>
<li>Refuse to extract device files (including pipes).</li>
<li>For regular files and hard links:<ul>
<li>Set the owner read and write permissions (<a class="reference external" href="https://docs.python.org/3.11/library/stat.html#stat.S_IRUSR" title="(in Python v3.11)"><code class="xref py py-data docutils literal notranslate"><span class="pre">S_IRUSR|S_IWUSR</span></code></a>).</li>
<li>Remove the group &amp; other <em>executable</em> permission (<a class="reference external" href="https://docs.python.org/3.11/library/stat.html#stat.S_IXGRP" title="(in Python v3.11)"><code class="xref py py-data docutils literal notranslate"><span class="pre">S_IXGRP|S_IXOTH</span></code></a>)
if the owner doesn’t have it (<a class="reference external" href="https://docs.python.org/3.11/library/stat.html#stat.S_IXUSR" title="(in Python v3.11)"><code class="xref py py-data docutils literal notranslate"><span class="pre">S_IXUSR</span></code></a>).</li>
</ul>
</li>
<li>For other files (directories), ignore mode entirely (set it to <code class="docutils literal notranslate"><span class="pre">None</span></code>).</li>
<li>Ignore user and group info (set <code class="docutils literal notranslate"><span class="pre">uid</span></code>, <code class="docutils literal notranslate"><span class="pre">gid</span></code>, <code class="docutils literal notranslate"><span class="pre">uname</span></code>, <code class="docutils literal notranslate"><span class="pre">gname</span></code>
to <code class="docutils literal notranslate"><span class="pre">None</span></code>).</li>
</ul>
</li>
</ul>
<p>Any other string will cause a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
<p>The corresponding filter functions will be available as
<code class="docutils literal notranslate"><span class="pre">tarfile.fully_trusted_filter()</span></code>, <code class="docutils literal notranslate"><span class="pre">tarfile.tar_filter()</span></code>, etc., so
they can be easily used in custom policies.</p>
<p>Note that these filters never return <code class="docutils literal notranslate"><span class="pre">None</span></code>.
Skipping members this way is a feature for user-defined filters.</p>
</section>
<section id="defaults-and-their-configuration">
<h3><a class="toc-backref" href="#defaults-and-their-configuration" role="doc-backlink">Defaults and their configuration</a></h3>
<p><a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TarFile</span></code></a> will gain a new attribute,
<code class="docutils literal notranslate"><span class="pre">extraction_filter</span></code>, to allow configuring the default filter.
By default it will be <code class="docutils literal notranslate"><span class="pre">None</span></code>, but users can set it to a callable
that will be used if the <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument is missing or <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>String names won’t be accepted here. That would encourage code like
<code class="docutils literal notranslate"><span class="pre">my_tarfile.extraction_filter</span> <span class="pre">=</span> <span class="pre">'data'</span></code>.
On Python versions without this feature, this would do nothing,
silently ignoring a security-related request.</p>
</div>
<p>If both the argument and attribute are <code class="docutils literal notranslate"><span class="pre">None</span></code>:</p>
<ul class="simple">
<li>In Python 3.12-3.13, a <code class="docutils literal notranslate"><span class="pre">DeprecationWarning</span></code> will be emitted and
extraction will use the <code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code> filter.</li>
<li>In Python 3.14+, it will use the <code class="docutils literal notranslate"><span class="pre">'data'</span></code> filter.</li>
</ul>
<p>Applications and system integrators may wish to change <code class="docutils literal notranslate"><span class="pre">extraction_filter</span></code>
of the <code class="docutils literal notranslate"><span class="pre">TarFile</span></code> class itself to set a global default.
When using a function, they will generally want to wrap it in <code class="docutils literal notranslate"><span class="pre">staticmethod()</span></code>
to prevent injection of a <code class="docutils literal notranslate"><span class="pre">self</span></code> argument.</p>
<p>Subclasses of <code class="docutils literal notranslate"><span class="pre">TarFile</span></code> can also override <code class="docutils literal notranslate"><span class="pre">extraction_filter</span></code>.</p>
</section>
<section id="filtererror">
<h3><a class="toc-backref" href="#filtererror" role="doc-backlink">FilterError</a></h3>
<p>A new exception, <code class="docutils literal notranslate"><span class="pre">FilterError</span></code>, will be added to the <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#module-tarfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tarfile</span></code></a>
module.
It’ll have several new subclasses, one for each of the refusal reasons above.
<code class="docutils literal notranslate"><span class="pre">FilterError</span></code>’s <code class="docutils literal notranslate"><span class="pre">member</span></code> attribute will contain the relevant <code class="docutils literal notranslate"><span class="pre">TarInfo</span></code>.</p>
<p>In the lists above, “refusing” to extract a file means that a <code class="docutils literal notranslate"><span class="pre">FilterError</span></code>
will be raised.
As with other extraction errors, if the <code class="docutils literal notranslate"><span class="pre">TarFile.errorlevel</span></code>
is 1 or more, this will abort the extraction; with <code class="docutils literal notranslate"><span class="pre">errorlevel=0</span></code> the error
will be logged and the member will be ignored, but extraction will continue.
Note that <code class="docutils literal notranslate"><span class="pre">extractall()</span></code> may leave the archive partially extracted;
it is the user’s responsibility to clean up.</p>
</section>
<section id="errorlevel-and-fatal-non-fatal-errors">
<h3><a class="toc-backref" href="#errorlevel-and-fatal-non-fatal-errors" role="doc-backlink">Errorlevel, and fatal/non-fatal errors</a></h3>
<p>Currently, <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TarFile</span></code></a> has an <em>errorlevel</em>
argument/attribute, which specifies how errors are handled:</p>
<ul>
<li>With <code class="docutils literal notranslate"><span class="pre">errorlevel=0</span></code>, documentation says that “all errors are ignored
when using <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.extract" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">extract()</span></code></a> and
<a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.extractall" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">extractall()</span></code></a>”.
The code only ignores <em>non-fatal</em> and <em>fatal</em> errors (see below),
so, for example, you still get <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> if you pass <code class="docutils literal notranslate"><span class="pre">None</span></code> as the
destination path.</li>
<li>With <code class="docutils literal notranslate"><span class="pre">errorlevel=1</span></code> (the default), all <em>non-fatal</em> errors are ignored.
(They may be logged to <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code> by setting the <em>debug</em>
argument/attribute.)
Which errors are <em>non-fatal</em> is not defined in documentation, but code treats
<code class="docutils literal notranslate"><span class="pre">ExtractionError</span></code> as such. Specifically, it’s these issues:<ul class="simple">
<li>“unable to resolve link inside archive” (raised on systems that do not
support symlinks)</li>
<li>“fifo/special devices not supported by system” (not used for failures if
the system supports these, e.g. for a <code class="docutils literal notranslate"><span class="pre">PermissionError</span></code>)</li>
<li>“could not change owner/mode/modification time”</li>
</ul>
<p>Note that, for example, <em>file name too long</em> or <em>out of disk space</em> don’t
qualify.
The <em>non-fatal</em> errors are not very likely to appear on a Unix-like system.</p>
</li>
<li>With <code class="docutils literal notranslate"><span class="pre">errorlevel=2</span></code>, all errors are raised, including <em>fatal</em> ones.
Which errors are <em>fatal</em> is, again, not defined; in practice it’s
<code class="docutils literal notranslate"><span class="pre">OSError</span></code>.</li>
</ul>
<p>A filter refusing to extract a member does not fit neatly into the
<em>fatal</em>/<em>non-fatal</em> categories.</p>
<ul class="simple">
<li>This PEP does not change existing behavior. (Ideas for improvements are
welcome in <a class="reference external" href="https://discuss.python.org/t/25970">Discourse topic 25970</a>.)</li>
<li>When a filter refuses to extract a member, the error should not pass
silently by default.</li>
</ul>
<p>To satisfy this, <code class="docutils literal notranslate"><span class="pre">FilterError</span></code> will be considered a <em>fatal</em> error, that is,
it’ll be ignored only with <code class="docutils literal notranslate"><span class="pre">errorlevel=0</span></code>.</p>
<p>Users that want to ignore <code class="docutils literal notranslate"><span class="pre">FilterError</span></code> but not other <em>fatal</em> errors should
create a custom filter function, and call another filter in a <code class="docutils literal notranslate"><span class="pre">try</span></code> block.</p>
</section>
<section id="hints-for-further-verification">
<h3><a class="toc-backref" href="#hints-for-further-verification" role="doc-backlink">Hints for further verification</a></h3>
<p>Even with the proposed changes, <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#module-tarfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tarfile</span></code></a> will not be
suited for extracting untrusted files without prior inspection.
Among other issues, the proposed policies don’t prevent denial-of-service
attacks.
Users should do additional checks.</p>
<p>New docs will tell users to consider:</p>
<ul class="simple">
<li>extracting to a new empty directory,</li>
<li>using external (e.g. OS-level) limits on disk, memory and CPU usage,</li>
<li>checking filenames against an allow-list of characters (to filter out control
characters, confusables, etc.),</li>
<li>checking that filenames have expected extensions (discouraging files that
execute when you “click on them”, or extension-less files like Windows
special device names),</li>
<li>limiting the number of extracted files, total size of extracted data,
and size of individual files,</li>
<li>checking for files that would be shadowed on case-insensitive filesystems.</li>
</ul>
<p>Also, the docs will note that:</p>
<ul class="simple">
<li>tar files commonly contain multiple versions of the same file: later ones are
expected to overwrite earlier ones on extraction,</li>
<li><code class="docutils literal notranslate"><span class="pre">tarfile</span></code> does not protect against issues with “live” data, e.g. an attacker
tinkering with the destination directory while extracting (or adding) is
going on (see the <a class="reference external" href="https://www.gnu.org/software/tar/manual/html_node/Live-untrusted-data.html#Live-untrusted-data">GNU tar manual</a>
for more info).</li>
</ul>
<p>This list is not comprehensive, but the documentation is a good place to
collect such general tips.
It can be moved into a separate document if grows too long or if it needs to
be consolidated with <a class="reference external" href="https://docs.python.org/3.11/library/zipfile.html#module-zipfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">zipfile</span></code></a> or <a class="reference external" href="https://docs.python.org/3.11/library/shutil.html#module-shutil" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shutil</span></code></a>
(which is out of scope for this proposal).</p>
</section>
<section id="tarinfo-identity-and-offset">
<span id="offset"></span><h3><a class="toc-backref" href="#tarinfo-identity-and-offset" role="doc-backlink">TarInfo identity, and <code class="docutils literal notranslate"><span class="pre">offset</span></code></a></h3>
<p>With filters that use <code class="docutils literal notranslate"><span class="pre">replace()</span></code>, the <code class="docutils literal notranslate"><span class="pre">TarInfo</span></code> objects handled
by the extraction machinery will not necessarily be the same objects
as those present in <code class="docutils literal notranslate"><span class="pre">members</span></code>.
This may affect <code class="docutils literal notranslate"><span class="pre">TarInfo</span></code> subclasses that override methods like
<code class="docutils literal notranslate"><span class="pre">makelink</span></code> and rely on object identity.</p>
<p>Such code can switch to comparing <code class="docutils literal notranslate"><span class="pre">offset</span></code>, the position of the member
header inside the file.</p>
<p>Note that both the overridable methods and <code class="docutils literal notranslate"><span class="pre">offset</span></code> are only
documented in source comments.</p>
</section>
<section id="tarfile-cli">
<h3><a class="toc-backref" href="#tarfile-cli" role="doc-backlink">tarfile CLI</a></h3>
<p>The CLI (<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">tarfile</span></code>) will gain a <code class="docutils literal notranslate"><span class="pre">--filter</span></code> option
that will take the name of one of the provided default filters.
It won’t be possible to specify a custom filter function.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">--filter</span></code> is not given, the CLI will use the default filter
(<code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code> with a deprecation warning now, and <code class="docutils literal notranslate"><span class="pre">'data'</span></code> from
Python 3.14 on).</p>
<p>There will be no short option. (<code class="docutils literal notranslate"><span class="pre">-f</span></code> would be confusingly similar to
the filename option of GNU <code class="docutils literal notranslate"><span class="pre">tar</span></code>.)</p>
</section>
<section id="other-archive-libraries">
<h3><a class="toc-backref" href="#other-archive-libraries" role="doc-backlink">Other archive libraries</a></h3>
<p>If and when other archive libraries, such as <a class="reference external" href="https://docs.python.org/3.11/library/zipfile.html#module-zipfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">zipfile</span></code></a>,
grow similar functionality, their extraction functions should use a <code class="docutils literal notranslate"><span class="pre">filter</span></code>
argument that takes, at least, the strings <code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code> (which should
disable any security precautions) and <code class="docutils literal notranslate"><span class="pre">'data'</span></code> (which should avoid features
that might surprise users).</p>
<p>Standardizing a function-based filter API is out of scope of this PEP.</p>
</section>
<section id="shutil">
<h3><a class="toc-backref" href="#shutil" role="doc-backlink">Shutil</a></h3>
<p><a class="reference external" href="https://docs.python.org/3.11/library/shutil.html#shutil.unpack_archive" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">shutil.unpack_archive()</span></code></a> will gain a <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument.
If it’s given, it will be passed to the underlying extraction function.
Passing it for a <code class="docutils literal notranslate"><span class="pre">zip</span></code> archive will fail for now (until <a class="reference external" href="https://docs.python.org/3.11/library/zipfile.html#module-zipfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">zipfile</span></code></a>
gains a <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument, if it ever does).</p>
<p>If <code class="docutils literal notranslate"><span class="pre">filter</span></code> is not specified (or left as <code class="docutils literal notranslate"><span class="pre">None</span></code>), it won’t be passed
on, so extracting a tarball will use the default filter
(<code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code> with a deprecation warning now, and <code class="docutils literal notranslate"><span class="pre">'data'</span></code> from
Python 3.14 on).</p>
</section>
<section id="complex-filters">
<h3><a class="toc-backref" href="#complex-filters" role="doc-backlink">Complex filters</a></h3>
<p>Note that some user-defined filters need, for example,
to count extracted members of do post-processing.
This requires a more complex API than a <code class="docutils literal notranslate"><span class="pre">filter</span></code> callable.
However, that complex API need not be exposed to <code class="docutils literal notranslate"><span class="pre">tarfile</span></code>.
For example, with a hypothetical <code class="docutils literal notranslate"><span class="pre">StatefulFilter</span></code> users would write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">StatefulFilter</span><span class="p">()</span> <span class="k">as</span> <span class="n">filter_func</span><span class="p">:</span>
    <span class="n">my_tar</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">filter_func</span><span class="p">)</span>
</pre></div>
</div>
<p>A simple <code class="docutils literal notranslate"><span class="pre">StatefulFilter</span></code> example will be added to the docs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The need for stateful filters is a reason against allowing
registration of custom filter names in addition to <code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code>,
<code class="docutils literal notranslate"><span class="pre">'tar'</span></code> and <code class="docutils literal notranslate"><span class="pre">'data'</span></code>.
With such a mechanism, API for (at least) set-up and tear-down would need
to be set in stone.</p>
</div>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>The default behavior of <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.extract" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TarFile.extract</span></code></a>
and <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarFile.extractall" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TarFile.extractall</span></code></a>
will change, after raising <code class="docutils literal notranslate"><span class="pre">DeprecationWarning</span></code> for 2 releases
(shortest deprecation period allowed in Python’s
<a class="pep reference internal" href="../pep-0387/" title="PEP 387 – Backwards Compatibility Policy">backwards compatibility policy</a>).</p>
<p>Additionally, code that relies on <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarInfo" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tarfile.TarInfo</span></code></a>
object identity may break, see <a class="reference internal" href="#offset"><span class="std std-ref">TarInfo identity, and offset</span></a>.</p>
</section>
<section id="backporting-forward-compatibility">
<h2><a class="toc-backref" href="#backporting-forward-compatibility" role="doc-backlink">Backporting &amp; Forward Compatibility</a></h2>
<p>This feature may be backported to older versions of Python.</p>
<p>In CPython, we don’t add warnings to patch releases, so the default
filter should be changed to <code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code> in backports.</p>
<p>Other than that, <em>all</em> of the changes to <code class="docutils literal notranslate"><span class="pre">tarfile</span></code> should be backported, so
<code class="docutils literal notranslate"><span class="pre">hasattr(tarfile,</span> <span class="pre">'data_filter')</span></code> becomes a reliable check for all
of the new functionality.</p>
<p>Note that CPython’s usual policy is to avoid adding new APIs in security
backports.
This feature does not make sense without a new API
(<code class="docutils literal notranslate"><span class="pre">TarFile.extraction_filter</span></code> and the <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument),
so we’ll make an exception.
(See <a class="reference external" href="https://discuss.python.org/t/23149/16">Discourse comment 23149/16</a>
for details.)</p>
<p>Here are examples of code that takes into account that <code class="docutils literal notranslate"><span class="pre">tarfile</span></code> may or may
not have the proposed feature.</p>
<p>When copying these snippets, note that setting <code class="docutils literal notranslate"><span class="pre">extraction_filter</span></code>
will affect subsequent operations.</p>
<ul>
<li>Fully trusted archive:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_tarfile</span><span class="o">.</span><span class="n">extraction_filter</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">member</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">member</span><span class="p">)</span>
<span class="n">my_tarfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li>Use the <code class="docutils literal notranslate"><span class="pre">'data'</span></code> filter if available, but revert to Python 3.11 behavior
(<code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code>) if this feature is not available:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_tarfile</span><span class="o">.</span><span class="n">extraction_filter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tarfile</span><span class="p">,</span> <span class="s1">&#39;data_filter&#39;</span><span class="p">,</span>
                                       <span class="p">(</span><span class="k">lambda</span> <span class="n">member</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">member</span><span class="p">))</span>
<span class="n">my_tarfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre></div>
</div>
<p>(This is an unsafe operation, so it should be spelled out explicitly,
ideally with a comment.)</p>
</li>
<li>Use the <code class="docutils literal notranslate"><span class="pre">'data'</span></code> filter; <em>fail</em> if it is not available:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_tarfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">data_filter</span><span class="p">)</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_tarfile</span><span class="o">.</span><span class="n">extraction_filter</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">data_filter</span>
<span class="n">my_tarfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li>Use the <code class="docutils literal notranslate"><span class="pre">'data'</span></code> filter; <em>warn</em> if it is not available:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tarfile</span><span class="p">,</span> <span class="s1">&#39;data_filter&#39;</span><span class="p">):</span>
    <span class="n">my_tarfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># remove this when no longer needed</span>
    <span class="n">warn_the_user</span><span class="p">(</span><span class="s1">&#39;Extracting may be unsafe; consider updating Python&#39;</span><span class="p">)</span>
    <span class="n">my_tarfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications" role="doc-backlink">Security Implications</a></h2>
<p>This proposal improves security, at the expense of backwards compatibility.
In particular, it will help users avoid <a class="reference external" href="https://nvd.nist.gov/vuln/detail/CVE-2007-4559">CVE-2007-4559</a>.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>The API, usage notes and tips for further verification will be added to
the documentation.
These should be usable for users who are familiar with archives in general, but
not with the specifics of UNIX filesystems nor the related security issues.</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>See <a class="reference external" href="https://github.com/python/cpython/pull/102953">pull request #102953</a> on GitHub.</p>
</section>
<section id="rejected-ideas">
<h2><a class="toc-backref" href="#rejected-ideas" role="doc-backlink">Rejected Ideas</a></h2>
<section id="safetarfile">
<h3><a class="toc-backref" href="#safetarfile" role="doc-backlink">SafeTarFile</a></h3>
<p>An initial idea from Lars Gustäbel was to provide a separate class that
implements security checks (see <a class="reference external" href="https://github.com/python/cpython/issues/65308">gh-65308</a>).
There are two major issues with this approach:</p>
<ul class="simple">
<li>The name is misleading. General archive operations can never be made “safe”
from all kinds of unwanted behavior, without impacting legitimate use cases.</li>
<li>It does not solve the problem of unsafe defaults.</li>
</ul>
<p>However, many of the ideas behind SafeTarFile were reused in this PEP.</p>
</section>
<section id="add-absolute-path-option-to-tarfile">
<h3><a class="toc-backref" href="#add-absolute-path-option-to-tarfile" role="doc-backlink">Add absolute_path option to tarfile</a></h3>
<p>Issue <a class="reference external" href="https://github.com/python/cpython/issues/73974">gh-73974</a> asks for adding an <code class="docutils literal notranslate"><span class="pre">absolute_path</span></code> option to extraction
methods. This would be a minimal change to formally resolve <a class="reference external" href="https://nvd.nist.gov/vuln/detail/CVE-2007-4559">CVE-2007-4559</a>.
It doesn’t go far enough to protect the unaware, nor to empower the diligent
and curious.</p>
</section>
<section id="other-names-for-the-tar-filter">
<h3><a class="toc-backref" href="#other-names-for-the-tar-filter" role="doc-backlink">Other names for the <code class="docutils literal notranslate"><span class="pre">'tar'</span></code> filter</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">'tar'</span></code> filter exposes features specific to UNIX-like filesystems,
so it could be named <code class="docutils literal notranslate"><span class="pre">'unix'</span></code>.
Or <code class="docutils literal notranslate"><span class="pre">'unix-like'</span></code>, <code class="docutils literal notranslate"><span class="pre">'nix'</span></code>, <code class="docutils literal notranslate"><span class="pre">'*nix'</span></code>, <code class="docutils literal notranslate"><span class="pre">'posix'</span></code>?</p>
<p>Feature-wise, <em>tar format</em> and <em>UNIX-like filesystem</em> are essentially
equivalent, so <code class="docutils literal notranslate"><span class="pre">tar</span></code> is a good name.</p>
</section>
</section>
<section id="possible-further-work">
<h2><a class="toc-backref" href="#possible-further-work" role="doc-backlink">Possible Further Work</a></h2>
<section id="adding-filters-to-zipfile-and-shutil-unpack-archive">
<h3><a class="toc-backref" href="#adding-filters-to-zipfile-and-shutil-unpack-archive" role="doc-backlink">Adding filters to zipfile and shutil.unpack_archive</a></h3>
<p>For consistency, <a class="reference external" href="https://docs.python.org/3.11/library/zipfile.html#module-zipfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">zipfile</span></code></a> and
<a class="reference external" href="https://docs.python.org/3.11/library/shutil.html#shutil.unpack_archive" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">shutil.unpack_archive()</span></code></a> could gain support
for a <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument.
However, this would require research that this PEP’s author can’t promise
for Python 3.12.</p>
<p>Filters for <code class="docutils literal notranslate"><span class="pre">zipfile</span></code> would probably not help security.
Zip is used primarily for cross-platform data bundles, and correspondingly,
<a class="reference external" href="https://docs.python.org/3.11/library/zipfile.html#zipfile.ZipFile.extract" title="(in Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ZipFile.extract</span></code></a>’s defaults
are already similar to what a <code class="docutils literal notranslate"><span class="pre">'data'</span></code> filter would do.
A <code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code> filter, which would <em>newly allow</em> absolute paths and
<code class="docutils literal notranslate"><span class="pre">..</span></code> path components, might not be useful for much except
a unified <code class="docutils literal notranslate"><span class="pre">unpack_archive</span></code> API.</p>
<p>Filters should be useful for use cases other than security, but those
would usually need custom filter functions, and those would need API that works
with both <a class="reference external" href="https://docs.python.org/3.11/library/tarfile.html#tarfile.TarInfo" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TarInfo</span></code></a> and
<a class="reference external" href="https://docs.python.org/3.11/library/zipfile.html#zipfile.ZipInfo" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ZipInfo</span></code></a>.
That is <em>definitely</em> out of scope of this PEP.</p>
<p>If only this PEP is implemented and nothing changes for <code class="docutils literal notranslate"><span class="pre">zipfile</span></code>,
the effect for callers of <code class="docutils literal notranslate"><span class="pre">unpack_archive</span></code> is that the default
for <em>tar</em> files is changing from <code class="docutils literal notranslate"><span class="pre">'fully_trusted'</span></code> to
the more appropriate <code class="docutils literal notranslate"><span class="pre">'data'</span></code>.
In the interim period, Python 3.12-3.13 will emit <code class="docutils literal notranslate"><span class="pre">DeprecationWarning</span></code>.
That’s annoying, but there are several ways to handle it: e.g. add a
<code class="docutils literal notranslate"><span class="pre">filter</span></code> argument conditionally, set <code class="docutils literal notranslate"><span class="pre">TarFile.extraction_filter</span></code>
globally, or ignore/suppress the warning until Python 3.14.</p>
<p>Also, since many calls to <code class="docutils literal notranslate"><span class="pre">unpack_archive</span></code> are likely to be unsafe,
there’s hope that the <code class="docutils literal notranslate"><span class="pre">DeprecationWarning</span></code> will often turn out to be
a helpful hint to review affected code.</p>
</section>
</section>
<section id="thanks">
<h2><a class="toc-backref" href="#thanks" role="doc-backlink">Thanks</a></h2>
<p>This proposal is based on prior work and discussions by many people,
in particular Lars Gustäbel, Gregory P. Smith, Larry Hastings, Joachim Wagner,
Jan Matejek, Jakub Wilk, Daniel Garcia, Lumír Balhar, Miro Hrončok,
and many others.</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0706.rst">https://github.com/python/peps/blob/main/peps/pep-0706.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0706.rst">2025-02-01 08:55:40 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <div id="search"></div>
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#setting-a-precedent">Setting a precedent</a></li>
<li><a class="reference internal" href="#full-disclosure-redistributor-info">Full disclosure &amp; redistributor info</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#modifying-and-forgetting-member-metadata">Modifying and forgetting member metadata</a></li>
<li><a class="reference internal" href="#filters">Filters</a></li>
<li><a class="reference internal" href="#defaults-and-their-configuration">Defaults and their configuration</a></li>
<li><a class="reference internal" href="#filtererror">FilterError</a></li>
<li><a class="reference internal" href="#errorlevel-and-fatal-non-fatal-errors">Errorlevel, and fatal/non-fatal errors</a></li>
<li><a class="reference internal" href="#hints-for-further-verification">Hints for further verification</a></li>
<li><a class="reference internal" href="#tarinfo-identity-and-offset">TarInfo identity, and <code class="docutils literal notranslate"><span class="pre">offset</span></code></a></li>
<li><a class="reference internal" href="#tarfile-cli">tarfile CLI</a></li>
<li><a class="reference internal" href="#other-archive-libraries">Other archive libraries</a></li>
<li><a class="reference internal" href="#shutil">Shutil</a></li>
<li><a class="reference internal" href="#complex-filters">Complex filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#backporting-forward-compatibility">Backporting &amp; Forward Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#safetarfile">SafeTarFile</a></li>
<li><a class="reference internal" href="#add-absolute-path-option-to-tarfile">Add absolute_path option to tarfile</a></li>
<li><a class="reference internal" href="#other-names-for-the-tar-filter">Other names for the <code class="docutils literal notranslate"><span class="pre">'tar'</span></code> filter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#possible-further-work">Possible Further Work</a><ul>
<li><a class="reference internal" href="#adding-filters-to-zipfile-and-shutil-unpack-archive">Adding filters to zipfile and shutil.unpack_archive</a></li>
</ul>
</li>
<li><a class="reference internal" href="#thanks">Thanks</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0706.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            // Ranking configuration to boost exact title matches
            const searchOptions = {
                ranking: {
                    termSimilarity: 9.0, // Higher values favor exact matches
                    termFrequency: 0.5, // Lower values reduce penalty for low term frequency
                    pageLength: 0.2, // Lower values reduce the impact of page length
                }
            };

            // Initialize pagefind for either mobile or desktop, not both
            if (window.innerWidth <= 640) {
                new PagefindUI({ element: "#mobile-search", ...searchOptions, showSubResults: false });
            } else {
                new PagefindUI({ element: "#search", ...searchOptions, showSubResults: true });
            }
        });
    </script>
</body>
</html>