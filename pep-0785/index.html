
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 785 – New methods for easier handling of ExceptionGroups | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0785/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 785 – New methods for easier handling of ExceptionGroups | peps.python.org'>
    <meta property="og:description" content="As PEP 654 ExceptionGroup has come into widespread use across the Python community, some common but awkward patterns have emerged. We therefore propose adding two new methods to exception objects:">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0785/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="As PEP 654 ExceptionGroup has come into widespread use across the Python community, some common but awkward patterns have emerged. We therefore propose adding two new methods to exception objects:">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 785</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 785 – New methods for easier handling of <code class="docutils literal notranslate"><span class="pre">ExceptionGroup</span></code>s</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Zac Hatfield-Dodds &lt;zac&#32;&#97;t&#32;zhd.dev&gt;</dd>
<dt class="field-even">Sponsor<span class="colon">:</span></dt>
<dd class="field-even">Gregory P. Smith &lt;greg&#32;&#97;t&#32;krypto.org&gt;</dd>
<dt class="field-odd">Discussions-To<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/88244">Discourse thread</a></dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">08-Apr-2025</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.14</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/88244" title="Discourse thread">13-Apr-2025</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a><ul>
<li><a class="reference internal" href="#a-leaf-exceptions-helper-function">A <code class="docutils literal notranslate"><span class="pre">leaf_exceptions()</span></code> helper function</a></li>
<li><a class="reference internal" href="#a-preserve-context-context-manager">A <code class="docutils literal notranslate"><span class="pre">preserve_context()</span></code> context manager</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#add-utility-functions-instead-of-methods">Add utility functions instead of methods</a></li>
<li><a class="reference internal" href="#add-baseexception-as-group-or-group-methods">Add <code class="docutils literal notranslate"><span class="pre">BaseException.as_group()</span></code> (or group methods)</a></li>
<li><a class="reference internal" href="#add-e-raise-with-preserved-context-instead-of-a-context-manager">Add <code class="docutils literal notranslate"><span class="pre">e.raise_with_preserved_context()</span></code> instead of a context manager</a></li>
<li><a class="reference internal" href="#preserve-additional-attributes">Preserve additional attributes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#footnotes">Footnotes</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>As <a class="pep reference internal" href="../pep-0654/" title="PEP 654 – Exception Groups and except*">PEP 654</a> <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ExceptionGroup" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a> has come into widespread use across the
Python community, some common but awkward patterns have emerged. We therefore
propose adding two new methods to exception objects:</p>
<ul class="simple">
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">BaseExceptionGroup.leaf_exceptions()</span></code>, returning the ‘leaf’ exceptions as
a list, with each traceback composited from any intermediate groups.</li>
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">BaseException.preserve_context()</span></code>, a context manager which
saves and restores the <code class="xref py py-attr docutils literal notranslate"><span class="pre">self.__context__</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">self</span></code>,
so that re-raising the exception within another handler does not overwrite
the existing context.</li>
</ul>
<p>We expect this to enable more concise expression of error handling logic in
many medium-complexity cases. Without them, exception-group handlers will
continue to discard intermediate tracebacks and mis-handle <code class="docutils literal notranslate"><span class="pre">__context__</span></code>
exceptions, to the detriment of anyone debugging async code.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>As exception groups come into widespread use, library authors and end users
often write code to process or respond to individual leaf exceptions, for
example when implementing middleware, error logging, or response handlers in
a web framework.</p>
<p><a class="reference external" href="https://github.com/search?q=%2Ffor+%5Cw%2B+in+%5Beg%5D%5Cw*%5C.exceptions%3A%2F+language%3APython&amp;type=code">Searching GitHub</a> found four implementations of <code class="xref py py-meth docutils literal notranslate"><span class="pre">leaf_exceptions()</span></code> by
various names in the first sixty hits, of which none handle
tracebacks.<a class="footnote-reference brackets" href="#numbers" id="id1">[1]</a>  The same search found thirteen cases where
<code class="xref py py-meth docutils literal notranslate"><span class="pre">.leaf_exceptions()</span></code> could be used.  We therefore believe that providing
a method on the <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#BaseException" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseException</span></code></a> type with proper traceback preservation
will improve error-handling and debugging experiences across the ecosystem.</p>
<p>The rise of exception groups has also made re-raising exceptions caught by an
earlier handler much more common: for example, web-server middleware might
unwrap <code class="docutils literal notranslate"><span class="pre">HTTPException</span></code> if that is the sole leaf of a group:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">except</span><span class="o">*</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">group</span><span class="p">:</span>
    <span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">leaf_exceptions</span><span class="p">()</span>  <span class="c1"># get the whole traceback :-)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rest</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">first</span>
    <span class="k">raise</span>
</pre></div>
</div>
<p>However, this innocent-seeming code has a problem: <code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">first</span></code> will do
<code class="docutils literal notranslate"><span class="pre">first.__context__</span> <span class="pre">=</span> <span class="pre">group</span></code> as a side effect. This discards the original
context of the error, which may contain crucial information to understand why
the exception was raised. In many production apps it also causes tracebacks
to balloon from hundreds of lines, to tens or even <a class="reference external" href="https://github.com/python-trio/trio/issues/2001#issuecomment-931928509">hundreds of thousands of
lines</a> - a volume which makes understanding errors far more difficult than
it should be.</p>
<p>A new <code class="xref py py-meth docutils literal notranslate"><span class="pre">BaseException.preserve_context()</span></code> method would be a discoverable,
readable, and easy-to-use solution for these cases.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>A new method <code class="docutils literal notranslate"><span class="pre">leaf_exceptions()</span></code> will be added to <code class="docutils literal notranslate"><span class="pre">BaseExceptionGroup</span></code>, with the
following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">leaf_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fix_tracebacks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a flat list of all &#39;leaf&#39; exceptions in the group.</span>

<span class="sd">    If fix_tracebacks is True, each leaf will have the traceback replaced</span>
<span class="sd">    with a composite so that frames attached to intermediate groups are</span>
<span class="sd">    still visible when debugging. Pass fix_tracebacks=False to disable</span>
<span class="sd">    this modification, e.g. if you expect to raise the group unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>A new method <code class="docutils literal notranslate"><span class="pre">preserve_context()</span></code> will be added to <code class="docutils literal notranslate"><span class="pre">BaseException</span></code>, with the
following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">preserve_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">AbstractContextManager</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager that preserves the exception&#39;s __context__ attribute.</span>

<span class="sd">    When entering the context, the current values of __context__ is saved.</span>
<span class="sd">    When exiting, the saved value is restored, which allows raising an</span>
<span class="sd">    exception inside an except block without changing its context chain.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Usage example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;re an async web framework, where user code can raise an HTTPException</span>
<span class="c1"># to return a particular HTTP error code to the client. However, it may</span>
<span class="c1"># (or may not) be raised inside a TaskGroup, so we need to use `except*`;</span>
<span class="c1"># and if there are *multiple* such exceptions we&#39;ll treat that as a bug.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">user_code_here</span><span class="p">()</span>
<span class="k">except</span><span class="o">*</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">group</span><span class="p">:</span>
    <span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">leaf_exceptions</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">:</span>
        <span class="k">raise</span>  <span class="c1"># handled by internal-server-error middleware</span>
    <span class="o">...</span> <span class="c1"># logging, cache updates, etc.</span>
    <span class="k">with</span> <span class="n">first</span><span class="o">.</span><span class="n">preserve_context</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">first</span>
</pre></div>
</div>
<p>Without <code class="docutils literal notranslate"><span class="pre">.preserve_context()</span></code>, this code would have to either:</p>
<ul class="simple">
<li>arrange for the exception to be raised <em>after</em> the <code class="docutils literal notranslate"><span class="pre">except*</span></code> block,
making code difficult to follow in nontrivial cases, or</li>
<li>discard the existing <code class="docutils literal notranslate"><span class="pre">__context__</span></code> of the <code class="docutils literal notranslate"><span class="pre">first</span></code> exception, replacing
it with an <code class="docutils literal notranslate"><span class="pre">ExceptionGroup</span></code> which is simply an implementation detail, or</li>
<li>use <code class="docutils literal notranslate"><span class="pre">try/except</span></code> instead of <code class="docutils literal notranslate"><span class="pre">except*</span></code>, handling the possibility that the
group doesn’t contain an <code class="docutils literal notranslate"><span class="pre">HTTPException</span></code> at all,<a class="footnote-reference brackets" href="#catch-raw-group" id="id4">[2]</a> or</li>
<li>implement the semantics of <code class="docutils literal notranslate"><span class="pre">.preserve_context()</span></code> inline; while this is not
<em>literally unheard-of</em>, it remains very rare.</li>
</ul>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>Adding new methods to built-in classes, especially those as widely used as
<code class="docutils literal notranslate"><span class="pre">BaseException</span></code>, can have substantial impacts. However, GitHub search shows
no collisions for these method names (<a class="reference external" href="https://github.com/search?q=%2F%5C.leaf_exceptions%5C%28%2F+language%3APython&amp;type=code">zero hits</a><a class="footnote-reference brackets" href="#naming" id="id5">[3]</a> and
<a class="reference external" href="https://github.com/search?q=%2F%5C.preserve_context%5C%28%2F+language%3APython&amp;type=code">three unrelated hits</a> respectively). If user-defined methods with these
names exist in private code they will shadow those proposed in the PEP,
without changing runtime behavior.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>Working with exception groups is an intermediate-to-advanced topic, unlikely
to arise for beginning programmers. We therefore suggest teaching this topic
via documentation, and via just-in-time feedback from static analysis tools.
In intermediate classes, we recommend teaching <code class="docutils literal notranslate"><span class="pre">.leaf_exceptions()</span></code> together
with the <code class="docutils literal notranslate"><span class="pre">.split()</span></code> and <code class="docutils literal notranslate"><span class="pre">.subgroup()</span></code> methods, and mentioning
<code class="docutils literal notranslate"><span class="pre">.preserve_context()</span></code> as an advanced option to address specific pain points.</p>
<p>Both the API reference and the existing <a class="reference external" href="https://docs.python.org/3/tutorial/errors.html#raising-and-handling-multiple-unrelated-exceptions">ExceptionGroup tutorial</a>
should be updated to demonstrate and explain the new methods. The tutorial
should include examples of common patterns where <code class="docutils literal notranslate"><span class="pre">.leaf_exceptions()</span></code> and
<code class="docutils literal notranslate"><span class="pre">.preserve_context()</span></code> help simplify error handling logic. Downstream
libraries which often use exception groups could include similar docs.</p>
<p>We have also designed lint rules for inclusion in <code class="docutils literal notranslate"><span class="pre">flake8-async</span></code> which will
suggest using <code class="docutils literal notranslate"><span class="pre">.leaf_exceptions()</span></code> when iterating over <code class="docutils literal notranslate"><span class="pre">group.exceptions</span></code>
or re-raising a leaf exception, and suggest using <code class="docutils literal notranslate"><span class="pre">.preserve_context()</span></code> when
re-raising a leaf exception inside an <code class="docutils literal notranslate"><span class="pre">except*</span></code> block would override any
existing context.</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>While the methods on built-in exceptions will be implemented in C if this PEP
is accepted, we hope that the following Python implementation will be useful
on older versions of Python, and can demonstrate the intended semantics.</p>
<p>We have found these helper functions quite useful when working with
<a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ExceptionGroup" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a>s in a large production codebase.</p>
<section id="a-leaf-exceptions-helper-function">
<h3><a class="toc-backref" href="#a-leaf-exceptions-helper-function" role="doc-backlink">A <code class="docutils literal notranslate"><span class="pre">leaf_exceptions()</span></code> helper function</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">types</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracebackType</span>


<span class="k">def</span><span class="w"> </span><span class="nf">leaf_exceptions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">BaseExceptionGroup</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fix_traceback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a flat list of all &#39;leaf&#39; exceptions.</span>

<span class="sd">    If fix_tracebacks is True, each leaf will have the traceback replaced</span>
<span class="sd">    with a composite so that frames attached to intermediate groups are</span>
<span class="sd">    still visible when debugging. Pass fix_tracebacks=False to disable</span>
<span class="sd">    this modification, e.g. if you expect to raise the group unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_flatten</span><span class="p">(</span><span class="n">group</span><span class="p">:</span> <span class="n">BaseExceptionGroup</span><span class="p">,</span> <span class="n">parent_tb</span><span class="p">:</span> <span class="n">TracebackType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">group_tb</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">__traceback__</span>
        <span class="n">combined_tb</span> <span class="o">=</span> <span class="n">_combine_tracebacks</span><span class="p">(</span><span class="n">parent_tb</span><span class="p">,</span> <span class="n">group_tb</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">BaseExceptionGroup</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_flatten</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">combined_tb</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">fix_tracebacks</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">_combine_tracebacks</span><span class="p">(</span><span class="n">combined_tb</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">_flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_combine_tracebacks</span><span class="p">(</span>
    <span class="n">tb1</span><span class="p">:</span> <span class="n">TracebackType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tb2</span><span class="p">:</span> <span class="n">TracebackType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TracebackType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine two tracebacks, putting tb1 frames before tb2 frames.</span>

<span class="sd">    If either is None, return the other.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tb1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tb2</span>
    <span class="k">if</span> <span class="n">tb2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tb1</span>

    <span class="c1"># Convert tb1 to a list of frames</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">tb1</span>
    <span class="k">while</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current</span><span class="o">.</span><span class="n">tb_frame</span><span class="p">,</span> <span class="n">current</span><span class="o">.</span><span class="n">tb_lasti</span><span class="p">,</span> <span class="n">current</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">))</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">tb_next</span>

    <span class="c1"># Create a new traceback starting with tb2</span>
    <span class="n">new_tb</span> <span class="o">=</span> <span class="n">tb2</span>

    <span class="c1"># Add frames from tb1 to the beginning (in reverse order)</span>
    <span class="k">for</span> <span class="n">frame</span><span class="p">,</span> <span class="n">lasti</span><span class="p">,</span> <span class="n">lineno</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
        <span class="n">new_tb</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">TracebackType</span><span class="p">(</span>
            <span class="n">tb_next</span><span class="o">=</span><span class="n">new_tb</span><span class="p">,</span> <span class="n">tb_frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">tb_lasti</span><span class="o">=</span><span class="n">lasti</span><span class="p">,</span> <span class="n">tb_lineno</span><span class="o">=</span><span class="n">lineno</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">new_tb</span>
</pre></div>
</div>
</section>
<section id="a-preserve-context-context-manager">
<h3><a class="toc-backref" href="#a-preserve-context-context-manager" role="doc-backlink">A <code class="docutils literal notranslate"><span class="pre">preserve_context()</span></code> context manager</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">preserve_context</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__exc</span> <span class="o">=</span> <span class="n">exc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__context</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">__context__</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exc</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">exc_value</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exc</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;did not raise the expected exception </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__exc</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="n">exc_value</span><span class="o">.</span><span class="n">__context__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__context</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__context</span>  <span class="c1"># break gc cycle</span>
</pre></div>
</div>
</section>
</section>
<section id="rejected-ideas">
<h2><a class="toc-backref" href="#rejected-ideas" role="doc-backlink">Rejected Ideas</a></h2>
<section id="add-utility-functions-instead-of-methods">
<h3><a class="toc-backref" href="#add-utility-functions-instead-of-methods" role="doc-backlink">Add utility functions instead of methods</a></h3>
<p>Rather than adding methods to exceptions, we could provide utility functions
like the reference implementations above.
There are however several reasons to prefer methods: there’s no obvious place
where helper functions should live, they take exactly one argument which must
be an instance of <code class="docutils literal notranslate"><span class="pre">BaseException</span></code>, and methods are both more convenient and
more discoverable.</p>
</section>
<section id="add-baseexception-as-group-or-group-methods">
<h3><a class="toc-backref" href="#add-baseexception-as-group-or-group-methods" role="doc-backlink">Add <code class="docutils literal notranslate"><span class="pre">BaseException.as_group()</span></code> (or group methods)</a></h3>
<p>Our survey of <code class="docutils literal notranslate"><span class="pre">ExceptionGroup</span></code>-related error handling code also observed
many cases of duplicated logic to handle both a bare exception, and the same
kind of exception inside a group (often incorrectly, motivating
<code class="docutils literal notranslate"><span class="pre">.leaf_exceptions()</span></code>).</p>
<p>We briefly <a class="reference external" href="https://github.com/python/cpython/issues/125825">proposed</a>
adding <code class="docutils literal notranslate"><span class="pre">.split(...)</span></code> and <code class="docutils literal notranslate"><span class="pre">.subgroup(...)</span></code> methods too all exceptions,
before considering <code class="docutils literal notranslate"><span class="pre">.leaf_exceptions()</span></code> made us feel this was too clumsy.
As a cleaner alternative, we sketched out an <code class="docutils literal notranslate"><span class="pre">.as_group()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">as_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">BaseExceptionGroup</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BaseExceptionGroup</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p>However, applying this method to refactor existing code was a negligible
improvement over writing the trivial inline version. We also hope that many
current uses for such a method will be addressed by <code class="docutils literal notranslate"><span class="pre">except*</span></code> as older
Python versions reach end-of-life.</p>
<p>We recommend documenting a “convert to group” recipe for de-duplicated error
handling, instead of adding group-related methods to <code class="docutils literal notranslate"><span class="pre">BaseException</span></code>.</p>
</section>
<section id="add-e-raise-with-preserved-context-instead-of-a-context-manager">
<h3><a class="toc-backref" href="#add-e-raise-with-preserved-context-instead-of-a-context-manager" role="doc-backlink">Add <code class="docutils literal notranslate"><span class="pre">e.raise_with_preserved_context()</span></code> instead of a context manager</a></h3>
<p>We prefer the context-manager form because it allows <code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">...</span> <span class="pre">from</span> <span class="pre">...</span></code>
if the user wishes to (re)set the <code class="docutils literal notranslate"><span class="pre">__cause__</span></code>, and is overall somewhat
less magical and tempting to use in cases where it would not be appropriate.
We could be argued around though, if others prefer this form.</p>
</section>
<section id="preserve-additional-attributes">
<h3><a class="toc-backref" href="#preserve-additional-attributes" role="doc-backlink">Preserve additional attributes</a></h3>
<p>We decided against preserving the <code class="docutils literal notranslate"><span class="pre">__cause__</span></code> and <code class="docutils literal notranslate"><span class="pre">__suppress_context__</span></code>
attributes, because they are not changed by re-raising the exception, and we
prefer to support <code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">exc</span> <span class="pre">from</span> <span class="pre">None</span></code> or <code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">exc</span> <span class="pre">from</span> <span class="pre">cause_exc</span></code>
together with <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">exc.preserve_context():</span></code>.</p>
<p>Similarly, we considered preserving the <code class="docutils literal notranslate"><span class="pre">__traceback__</span></code> attribute, and
decided against because the additional <code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">...</span></code> statement may be an
important clue when understanding some error. If end users wish to pop a
frame from the traceback, they can do with a separate context manager.</p>
</section>
</section>
<section id="footnotes">
<h2><a class="toc-backref" href="#footnotes" role="doc-backlink">Footnotes</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="numbers" role="doc-footnote">
<dt class="label" id="numbers">[<a href="#id1">1</a>]</dt>
<dd>From the first sixty <a class="reference external" href="https://github.com/search?q=%2Ffor+%5Cw%2B+in+%5Beg%5D%5Cw*%5C.exceptions%3A%2F+language%3APython&amp;type=code">GitHub search results</a>
for <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">\w+</span> <span class="pre">in</span> <span class="pre">[eg]\w*\.exceptions:</span></code>, we find:<ul class="simple">
<li>Four functions implementing <code class="docutils literal notranslate"><span class="pre">leaf_exceptions()</span></code> semantics, none of
which preserve tracebacks:
(<a class="reference external" href="https://github.com/nonebot/nonebot2/blob/570bd9587af99dd01a7d5421d3105d8a8e2aba32/nonebot/utils.py#L259-L266">one</a>,
<a class="reference external" href="https://github.com/HypothesisWorks/hypothesis/blob/7c49f2daf602bc4e51161b6c0bc21720d64de9eb/hypothesis-python/src/hypothesis/core.py#L763-L770">two</a>,
<a class="reference external" href="https://github.com/BCG-X-Official/pytools/blob/9d6d37280b72724bd64f69fe7c98d687cbfa5317/src/pytools/asyncio/_asyncio.py#L269-L280">three</a>,
<a class="reference external" href="https://github.com/M-o-a-T/moat/blob/ae174b0947288364f3ae580cb05522624f4f6f39/moat/util/exc.py#L10-L18">four</a>)</li>
<li>Six handlers which raise the first exception in a group, discarding
any subsequent errors; these would benefit from both proposed methods.
(<a class="reference external" href="https://github.com/Lancetnik/FastDepends/blob/239cd1a58028782a676934f7d420fbecf5cb6851/fast_depends/core/model.py#L488-L490">one</a>,
<a class="reference external" href="https://github.com/estuary/connectors/blob/677824209290c0a107e63d5e2fccda7c8388101e/source-hubspot-native/source_hubspot_native/buffer_ordered.py#L108-L111">two</a>,
<a class="reference external" href="https://github.com/MobileTeleSystems/data-rentgen/blob/7525f7ecafe5994a6eb712d9e66b8612f31436ef/data_rentgen/consumer/__init__.py#L65-L67">three</a>,
<a class="reference external" href="https://github.com/ljmf00/simbabuild/blob/ac7e0999563b3a1b13f4e445a99285ea71d4c7ab/simbabuild/builder_async.py#L22-L24">four</a>,
<a class="reference external" href="https://github.com/maxjo020418/BAScraper/blob/cd5c2ef24f45f66e7f0fb26570c2c1529706a93f/BAScraper/BAScraper_async.py#L170-L174">five</a>,
<a class="reference external" href="https://github.com/sobolevn/faststream/blob/0d6c9ee6b7703efab04387c51c72876e25ad91a7/faststream/app.py#L54-L56">six</a>)</li>
<li>Seven cases which mishandle nested exception groups, and would thus
benefit from <code class="docutils literal notranslate"><span class="pre">leaf_exceptions()</span></code>. We were surprised to note that only
one of these cases could straightforwardly be replaced by use of an
<code class="docutils literal notranslate"><span class="pre">except*</span></code> clause or <code class="docutils literal notranslate"><span class="pre">.subgroup()</span></code> method.
(<a class="reference external" href="https://github.com/vertexproject/synapse/blob/ed8148abb857d4445d727768d4c57f4f11b0d20a/synapse/lib/stormlib/iters.py#L82-L88">one</a>,
<a class="reference external" href="https://github.com/mhdzumair/MediaFusion/blob/ff906378f32fb8419ef06c6f1610c08946dfaeee/scrapers/base_scraper.py#L375-L386">two</a>,
<a class="reference external" href="https://github.com/SonySemiconductorSolutions/local-console/blob/51f5af806336e169d3dd9b9f8094a29618189f5e/local-console/src/local_console/commands/server.py#L61-L67">three</a>,
<a class="reference external" href="https://github.com/SonySemiconductorSolutions/local-console/blob/51f5af806336e169d3dd9b9f8094a29618189f5e/local-console/src/local_console/commands/broker.py#L66-L69">four</a>,
<a class="reference external" href="https://github.com/HexHive/Tango/blob/5c8472d1679068daf0f041dbbda21e05281b10a3/tango/fuzzer.py#L143-L160">five</a>,
<a class="reference external" href="https://github.com/PaLora16/ExceptionsGroupsValidators/blob/41152a86eec695168fdec74653694658ddc788fc/main.py#L39-L44">six</a>,
<a class="reference external" href="https://github.com/reactive-python/reactpy/blob/178fc05de7756f7402ed2ee1e990af0bdad42d9e/src/reactpy/backend/starlette.py#L164-L170">seven</a>)</li>
</ul>
<p>indicating that more than a quarter of <em>all</em> hits for this fairly general
search would benefit from the methods proposed in this PEP.</p>
</aside>
<aside class="footnote brackets" id="catch-raw-group" role="doc-footnote">
<dt class="label" id="catch-raw-group">[<a href="#id4">2</a>]</dt>
<dd>This remains very rare, and most cases duplicate logic across
<code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">FooError:</span></code> and <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">ExceptionGroup:</span>&#160; <span class="pre">#</span> <span class="pre">containing</span> <span class="pre">FooError</span></code>
clauses rather than using something like the <code class="docutils literal notranslate"><span class="pre">as_group()</span></code> trick.
We expect that <code class="docutils literal notranslate"><span class="pre">except*</span></code> will be widely used in such cases by the time
that the methods proposed by this PEP are widely available.</aside>
<aside class="footnote brackets" id="naming" role="doc-footnote">
<dt class="label" id="naming">[<a href="#id5">3</a>]</dt>
<dd>The name <code class="docutils literal notranslate"><span class="pre">leaf_exceptions()</span></code> was <a class="reference external" href="https://github.com/python-trio/exceptiongroup/pull/13">first proposed</a> in an early
precursor to <a class="pep reference internal" href="../pep-0654/" title="PEP 654 – Exception Groups and except*">PEP 654</a>. If the prototype had matched <code class="docutils literal notranslate"><span class="pre">except*</span></code>
in wrapping bare exceptions in a group, we might even have included
a <code class="docutils literal notranslate"><span class="pre">.leaf_exceptions()</span></code> method in that earlier PEP!</aside>
</aside>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the CC0-1.0-Universal license,
whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0785.rst">https://github.com/python/peps/blob/main/peps/pep-0785.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0785.rst">2025-04-17 17:42:59 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a><ul>
<li><a class="reference internal" href="#a-leaf-exceptions-helper-function">A <code class="docutils literal notranslate"><span class="pre">leaf_exceptions()</span></code> helper function</a></li>
<li><a class="reference internal" href="#a-preserve-context-context-manager">A <code class="docutils literal notranslate"><span class="pre">preserve_context()</span></code> context manager</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#add-utility-functions-instead-of-methods">Add utility functions instead of methods</a></li>
<li><a class="reference internal" href="#add-baseexception-as-group-or-group-methods">Add <code class="docutils literal notranslate"><span class="pre">BaseException.as_group()</span></code> (or group methods)</a></li>
<li><a class="reference internal" href="#add-e-raise-with-preserved-context-instead-of-a-context-manager">Add <code class="docutils literal notranslate"><span class="pre">e.raise_with_preserved_context()</span></code> instead of a context manager</a></li>
<li><a class="reference internal" href="#preserve-additional-attributes">Preserve additional attributes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#footnotes">Footnotes</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0785.rst?plain=1">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
    <script src="https://analytics.python.org/js/script.outbound-links.js"
            data-domain="peps.python.org" defer></script>
</body>
</html>